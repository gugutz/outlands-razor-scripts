sysmsg '#########################' 90
sysmsg '>>> T-Chest Unlocker and Looter' 55
sysmsg 'by gugutz' 45
sysmsg 'version 0.0.3' 31
sysmsg '########################' 90
#
#################################
# DESCRIPTION
#################################
#
# This script will search for treasure chests in the ground within 2 tiles of the char, and if it finds any
# it will remove traps, unlock and then loot the chests
#

################################
# SCRIPT CONFIGURATION
################################

setvar! action_delay 600
setvar! use_tools_instead_of_chest_gump 1
setvar! loot_chest 1
setvar! auto_hide 1
setvar! only_start_chest_if_hidden 1


################################
# NON-CONFIG RELATED VARIABLES
################################

setvar! unlock_chest 1
if not varexist locked_chest_gump
    @setvar locked_chest_gump 736038070
endif


###################################
# TIMERS
###################################

sysmsg 'Creating timers...'

createlist 'open_and_loot_tchests_script_timers'
pushlist 'open_and_loot_tchests_script_timers' 'wait_for_progress'
pushlist 'open_and_loot_tchests_script_timers' 'char_heavy_warning_msg_timer'

foreach timer in 'open_and_loot_tchests_script_timers'
    if not timerexists timer
        createtimer timer
        settimer timer 0
    endif
endfor


#################################
# PREPARING ALL ITEMS LISTS
#################################

# MASTERY CHAIN LINKS
if not listexists 'links'
    createlist 'links'
    pushlist 'links' 'chain link'
endif

# RARES
if not listexists 'rares'
    sysmsg 'Creating rares list...' 51
    createlist 'rares'
    pushlist 'rares' 'folded cloth' //rare_cloths
    pushlist 'rares' 'aspect core'
    pushlist 'rares' 'map'
    pushlist 'rares' 5359 //spell_hue_deeds
    pushlist 'rares' 22336 //skill_orbs
    pushlist 'rares' 17087 //mcds
    pushlist 'rares' 'research materials' //research_materials
    pushlist 'rares' 'scroll of calling' //skill_scrolls
    pushlist 'rares' 3836 //aspect_extract
    pushlist 'rares' 'phylactery'
    pushlist 'rares' 3838 //runebook_dye
    pushlist 'rares' 3839 //backpack_dye
    pushlist 'rares' 3842 //headwear_dye
    pushlist 'rares' 3843 //facial_hair_dye
    pushlist 'rares' 3843 //acessory_dye
    pushlist 'rares' 29025 //fortuniture_dye
    pushlist 'rares' 29036 //carpet_dye
endif

# ARCANE RUNES
if not listexists 'arcane_runes'
    sysmsg 'Creating arcane runes list...' 51
    createlist 'arcane_runes'
    pushlist 'arcane_runes' 39891
    pushlist 'arcane_runes' 39892
    pushlist 'arcane_runes' 39917
    pushlist 'arcane_runes' 39909
    pushlist 'arcane_runes' 39912
    pushlist 'arcane_runes' 39905
    pushlist 'arcane_runes' 39911
    pushlist 'arcane_runes' 39897
    pushlist 'arcane_runes' 39918
    pushlist 'arcane_runes' 39889
    pushlist 'arcane_runes' 39898
    pushlist 'arcane_runes' 39896
    pushlist 'arcane_runes' 39916
endif

# MISC TCHEST ITEMS
if not listexists 'tchest_items'
    sysmsg 'Creating regular tchest items list...' 51
    createlist 'tchest_items'

    pushlist 'tchest_items' 'blank scroll%s%' //arcane_scrolls
    pushlist 'tchest_items' 29030 //plant_chemicals
    pushlist 'tchest_items' 'gold coin'
    pushlist 'tchest_items' 'bow'
    pushlist 'tchest_items' 'seed of renewal'
    pushlist 'tchest_items' 'bag of seeds'


    # gems
    @pushlist 'tchest_items' 'rub%ies/y%'
    @pushlist 'tchest_items' 'tourmaline%s%'
    @pushlist 'tchest_items' 'emerald%s%'
    @pushlist 'tchest_items' 'diamond%s%'
    @pushlist 'tchest_items' 'piece%s% of amber'
    @pushlist 'tchest_items' 'amethyst%s%'
    @pushlist 'tchest_items' 'star sapphire%s%'
    @pushlist 'tchest_items' 'citrine%s%'
    @pushlist 'tchest_items' 'sapphire%s%'


    pushlist 'tchest_items' 'spellbook'

    pushlist 'tchest_items' 'martial arts scroll' //wrestle_martial_manual

    # ARCHERY WEAPONS
    pushlist 'tchest_items' 'bow'
    pushlist 'tchest_items' 'crossbow'
    pushlist 'tchest_items' 'heavy crossbow'

    # SWORDS WEAPONS
    pushlist 'tchest_items' 'cutlass'
    pushlist 'tchest_items' 'katana'
    pushlist 'tchest_items' 'viking sword'
    pushlist 'tchest_items' 'broadsword'
    pushlist 'tchest_items' 'longsword'
    pushlist 'tchest_items' 'double axe'
    pushlist 'tchest_items' 'two handed axe'
    pushlist 'tchest_items' 'battle axe'
    pushlist 'tchest_items' 'bardiche'
    pushlist 'tchest_items' 'halberd'
    pushlist 'tchest_items' "executioner's axe"

    # MACING WEAPONS
    pushlist 'tchest_items' 'club'
    pushlist 'tchest_items' 'mace'
    pushlist 'tchest_items' 'war mace'
    pushlist 'tchest_items' 'war axe'
    pushlist 'tchest_items' 'hammer pick'
    pushlist 'tchest_items' 'black staff'
    pushlist 'tchest_items' 'gnarled staff'
    pushlist 'tchest_items' 'quarter staff'
    pushlist 'tchest_items' 5177 //war_hammer
    pushlist 'tchest_items' 'maul'
    # sheps crook
    pushlist 'tchest_items' 3713 //sheps_crook

    # FENCING WEAPONS
    pushlist 'tchest_items' 'kryss'
    pushlist 'tchest_items' 'war fork'
    pushlist 'tchest_items' 'short spear'
    pushlist 'tchest_items' 'Long Spear'
    pushlist 'tchest_items' 'pitchfork'
    pushlist 'tchest_items' 'bladed staff'

    # SHIELDs
    pushlist 'tchest_items' 7027 //bucker
    pushlist 'tchest_items' 'buckler'
    pushlist 'tchest_items' 'wooden shield'
    pushlist 'tchest_items' 'metal shield'
    pushlist 'tchest_items' 7026 //bronze_shield
    pushlist 'tchest_items' 7033 //kite_shield
    pushlist 'tchest_items' 7029 //metal_kite_shield
    pushlist 'tchest_items' 'heater shield'

    # HATS
    pushlist 'tchest_items' "wizard's hat"

    # BONE SET
    pushlist 'tchest_items' 'bone armor'
    pushlist 'tchest_items' 'bone gorget'
    pushlist 'tchest_items' 'bone arms'
    pushlist 'tchest_items' 'bone gloves'
    pushlist 'tchest_items' 'bone legs'

    # LEATHER SET
    pushlist 'tchest_items' 'leather cap'
    pushlist 'tchest_items' 'leather tunic'
    pushlist 'tchest_items' 'leather gorget'
    pushlist 'tchest_items' 'leather sleeves'
    pushlist 'tchest_items' 'leather gloves'
    pushlist 'tchest_items' 'leather leggings'
    pushlist 'tchest_items' 'leather skirt'
    pushlist 'tchest_items' 'leather bustier'
    pushlist 'tchest_items' 'leather shorts'
    pushlist 'tchest_items' 'leather armor'


    # STUDDED SET
    pushlist 'tchest_items' 'studded tunic'
    # studded armor (doenst work with only name)
    pushlist 'tchest_items' 7170
    pushlist 'tchest_items' 'studded armor'
    pushlist 'tchest_items' 'studded sleeves'
    pushlist 'tchest_items' 'studded leggings'
    pushlist 'tchest_items' 'studded gorget'
    pushlist 'tchest_items' 'studded gloves'
    pushlist 'tchest_items' 'studded bustier'

    # HELMETS
    pushlist 'tchest_items' 'helmet'
    pushlist 'tchest_items' 'norse helm'
    pushlist 'tchest_items' 'close helm'
    # bascinet doenst work with name appearantly
    pushlist 'tchest_items' 5135
    pushlist 'tchest_items' 'bascinet'
    pushlist 'tchest_items' 'bone helmet'
    pushlist 'tchest_items' 'plate helm'

    # PLATEMAIL SET
    pushlist 'tchest_items' 'platemail'
    pushlist 'tchest_items' 'platemail arms'
    pushlist 'tchest_items' 'platemail legs'
    pushlist 'tchest_items' 'platemail gorget'
    pushlist 'tchest_items' 'platemail gloves'

    # CHAINMAIL SET
    pushlist 'tchest_items' 'chainmail coif'
    pushlist 'tchest_items' 'chainmail tunic'
    pushlist 'tchest_items' 'chainmail arms'
    pushlist 'tchest_items' 'chainmail leggings'
    pushlist 'tchest_items' 'chainmail gorget'
    pushlist 'tchest_items' 'chainmail gloves'

    # CHAINMAIL SET
    pushlist 'tchest_items' 'ringmail tunic'
    # sleeves
    pushlist 'tchest_items' 'ringmail sleeves'
    pushlist 'tchest_items' 5103
    pushlist 'tchest_items' 'ringmail leggings'
    pushlist 'tchest_items' 'ringmail gorget'
    pushlist 'tchest_items' 'ringmail gloves'

    # INSTRUMENTS
    pushlist 'tchest_items' 'bamboo flute'
    pushlist 'tchest_items' 'lute'
    pushlist 'tchest_items' 'drum'
    # tambourine doenst work with name appearantly
    pushlist 'tchest_items' 3742
    pushlist 'tchest_items' 'tambourine'
    pushlist 'tchest_items' 'lap harp'

    # MISC & MAGERY SCROLLS
    pushlist 'tchest_items' 'clean bandage%s%'
    pushlist 'tchest_items' 'arrow'
    # bolt doenst work with name appearantly
    pushlist 'tchest_items' 7163
    pushlist 'tchest_items' 'crossbow bolt'


    # REAGENTS
    pushlist 'tchest_items' 'Blood Moss'
    pushlist 'tchest_items' 'Black Pearl%s%'
    pushlist 'tchest_items' 'Garlic'
    pushlist 'tchest_items' 'Mandrake Root%s%'
    pushlist 'tchest_items' 'Ginseng'
    pushlist 'tchest_items' 'Nightshade'
    pushlist 'tchest_items' 'Sulfurous Ash'
    pushlist 'tchest_items' "Spider's Silk"


    pushlist 'tchest_items' 'Recall Scroll'
    pushlist 'tchest_items' 'ManaDrain Scroll'
    pushlist 'tchest_items' 'Greater Heal Scroll'
    pushlist 'tchest_items' 'Lightning Scroll'
endif



###################################
# SEARCH FOR CHESTS IN GROUND
###################################

unsetvar chest

# check if chest nearby is already opened
if findtype 29087 ground any any 2 as open_chest
    setvar! chest open_chest
    setvar! found_open_chest true
elseif findtype 29089 ground any any 2 as open_chest
    setvar! chest open_chest
    setvar! found_open_chest true
elseif findtype 29076 ground any any 2 as open_chest
    setvar! chest open_chest
    setvar! found_open_chest true
endif

if varexist found_open_chest
    unsetvar! found_open_chest
    overhead 'FOUND OPEN CHEST!' 90
    sysmsg 'CHEST ON GROUND IS ALREADY OPENED!'

    # set script to not try to unlock chest, only loot it
    unsetvar! unlock_chest
endif

# search for tchests in the ground to start the whole process
if not varexist chest

    if findtype 'metal chest' ground any any 2 as tchest
        setvar! chest tchest
    elseif findtype 'wooden chest' ground any any 2 as tchest
        setvar! chest tchest
    else
        overhead 'NO CHESTS NEARBY!' 43
        sysmsg 'Cant find any Treasure Chest nearby!' 43
        sto
    endif

endif


###################################
# START WORKING CHEST
###################################

clearsysmsg

if varexist chest
    if unlock_chest == 1

        while not gumpexists locked_chest_gump
            sysmsg 'Opening chest first time...' 53
            dclick chest
            waitforgump locked_chest_gump 600
            wait action_delay
        endwhile

        #################################
        # REMOVE CHEST TRAPS
        #################################


        while not dead and not insysmsg 'You have successfully cleared it of traps'

            if auto_hide == 1
                if only_start_chest_if_hidden == 1
                    while not hidden
                        if skill 'hiding' >= 70
                            useskill 'hiding'
                            wait 1000
                        elseif skill 'magery' >= 75
                            cast 'invisibility'
                            wft 3500
                            if targetexists 'neutral'
                                target 'self'
                            endif
                            wait action_delay
                        endif
                    endwhile
                else
                    if not hidden
                        if skill 'hiding' >= 70
                            useskill 'hiding'
                            wait 1000
                        elseif skill 'magery' >= 75
                            cast 'invisibility'
                            wft 3500
                            if targetexists 'neutral'
                                target 'self'
                            endif
                            wait action_delay
                        endif
                    endif
                endif
            endif


            # Skip ahead if devoid of traps
            if insysmsg 'You have successfully cleared it of traps'
                overhead '* TRAPS CLEARED * ' 72
                break
            endif


            if findtype drill as tool
                # unlock using tool instead of using the chest gump (this allows the char to remain hidden)
                if use_tools_instead_of_chest_gump == 1
                    sysmsg 'Removing Chest Traps...' 54
                    dclick tool
                    waitfortarget action_delay
                    target chest

                    wait action_delay

                # unlock using the chest gump instead of directly clicking tool
                elseif use_tools_instead_of_chest_gump == 0
                    if not gumpexists locked_chest_gump
                        sysmsg 'Clicking chest to open gump...'
                        dclick chest
                        waitforgump locked_chest_gump action_delay
                    else
                        gumpresponse 7 736038070
                        wait action_delay
                    endif
                endif

                if ingump 'Cleared of Traps' 736038070 or insysmsg 'appears to be devoid'
                    sysmsg 'CHEST ALREADY CLARED OF TRAPS....'
                    break
                endif


                if insysmsg 'You do not have any trap tools of that material on hand'
                    if use_tools_instead_of_chest_gump == 1
                        overhead 'NO MORE DRILLS' 55
                        stop
                    elseif use_tools_instead_of_chest_gump == 0
                        sysmsg '> Switching Tool Material Color...' 54
                        gumpresponse 5 736038070
                        waitforgump locked_chest_gump action_delay
                else
                    while not insysmsg 'You make some progress' and not insysmsg 'You fail to make any progress'
                        wait 100
                        if timer 'wait_for_progress' >= 5000 or insysmsg 'You make some progress' or insysmsg 'You fail to make any progress' or insysmsg 'cleared it of traps'
                            settimer 'wait_for_progress' 0
                            break
                        endif
                    endwhile
                endif
            else
                overhead 'NO MORE DRILLS' 37
                stop
            endif


        endwhile

        #################################
        # LOCKPICK CHEST
        #################################

        while not dead and not insysmsg 'You successfully pick the lock.'
            #
            if findtype 'lockpicks' as tool

                # unlock using tool instead of using the chest gump (this allows the char to remain hidden)
                if use_tools_instead_of_chest_gump == 1
                    sysmsg 'Lockpicking Chest...'
                    dclick tool
                    waitfortarget action_delay
                    target chest

                    wait action_delay

                # unlock using the chest gump instead of directly clicking tool
                elseif use_tools_instead_of_chest_gump == 0
                    if not gumpexists locked_chest_gump
                        sysmsg 'Clicking chest to open gump...'
                        dclick chest
                        waitforgump locked_chest_gump action_delay
                    else
                        gumpresponse 4 736038070
                        wait action_delay
                    endif
                endif

                if insysmsg 'You do not have any lockpicks of that material on hand'
                    if use_tools_instead_of_chest_gump == 1
                        overhead 'NO MORE LOCKPICKS' 55
                        stop
                    elseif use_tools_instead_of_chest_gump == 0
                        sysmsg '> Switching Tool Material Color...' 54
                        gumpresponse 2 736038070
                        waitforgump locked_chest_gump 1000
                else
                    settimer 'wait_for_progress' 0
                    while not insysmsg 'You make some progress' and not insysmsg 'You fail to make any progress'
                        wait 100
                        if timer 'wait_for_progress' >= 5000 or insysmsg 'You make some progress' or insysmsg 'You fail to make any progress' or insysmsg 'You successfully pick the lock.'
                            settimer 'wait_for_progress' 0
                            break
                        endif
                    endwhile
                endif

            else
                overhead 'NO MORE LOCKPICKS' 37
                stop
            endif

            if findtype 29076 ground any any 2 or findtype  29089 ground any any 2
                break
            endif

        endwhile

        if insysmsg 'You successfully pick the lock' or findtype 29076 ground any any 2 or findtype  29089 ground any any 2
            overhead 'chest opened!' 54
            sysmsg '>>> Chest Opened!' 54
        else
            sysmsg 'Couldnt confirm if chest really opened. Stopping...' 54
            stop
        endif
    endif



    #################################
    # LOOT THE CHEST
    #################################

    if varexist loot_chest
        # if script is set to not open this chest, we might need to dclick it,
        # it could be an already open chest the player wants to loot
        if not varexist unlock_chest
            dclick chest
            wait action_delay
        endif

        foreach item in 'links'
            while findtype item chest any any as item_to_unload
                sysmsg '>>> FOUND A LINK! LOOTING IT...' 53

                getlabel item_to_unload link_label
                overhead 'found a link: {{link_label}}' 51 'self'
                sysmsg 'FOUND A LINK: {{link_label}}' 51 'self'

                if varexist CHAR_LOOT_POUCH
                    setvar! destination_container CHAR_LOOT_POUCH
                else
                    setvar! destination_container backpack
                endif

                hotkey "Set Grab Item HotBag"
                wft action_delay
                target destination_container

                hotkey 'Grab Item'
                wft 600
                target item_to_unload
                wait 100

                while queued
                    sysmsg '>>> queued'
                    wait 20
                endwhile

                # check char container limit
                if insysmsg 'That container cannot hold more weight'
                    if timer 'char_heavy_warning_msg_timer' >= 5000
                        overhead 'BACKPACK FULL! UNLOAD!' 37
                        settimer 'char_heavy_warning_msg_timer' 0
                    endif
                endif

            endwhile
        endfor

        foreach item in 'rares'
            while findtype item chest any any as item_to_unload
                overhead item 51 'self'
                sysmsg item 52

                if varexist CHAR_LOOT_POUCH
                    setvar! destination_container CHAR_LOOT_POUCH
                else
                    setvar! destination_container backpack
                endif

                hotkey "Set Grab Item HotBag"
                wft action_delay
                target destination_container

                hotkey 'Grab Item'
                wft 600
                target item_to_unload
                wait 100

                while queued
                    sysmsg '>>> queued'
                    wait 20
                endwhile

                # check char container limit
                if insysmsg 'That container cannot hold more weight'
                    if timer 'char_heavy_warning_msg_timer' >= 5000
                        overhead 'BACKPACK FULL! UNLOAD!' 37
                        settimer 'char_heavy_warning_msg_timer' 0
                    endif
                endif
            endwhile
        endfor

        foreach item in 'arcane_runes'
            while findtype item chest any any as item_to_unload
                overhead item 51 'self'
                sysmsg item 52

                if listexists 'char_loot_pouch'
                    if atlist 'char_loot_pouch' 0 as char_loot_pouch
                        lift item_to_unload 9999
                        wait action_delay
                        drop char_loot_pouch
                        wait action_delay
                    endif
                else
                    hotkey 'Grab Item'
                    wft 600
                    target item_to_unload
                    wait action_delay
                endif

                # check char container limit
                if insysmsg 'That container cannot hold more weight'
                    if timer 'char_heavy_warning_msg_timer' >= 5000
                        overhead 'BACKPACK FULL! UNLOAD!' 37
                        settimer 'char_heavy_warning_msg_timer' 0
                    endif
                endif

            endwhile
        endfor

        foreach item in 'tchest_items'
            while findtype item chest any any as item_to_unload
                overhead item 51 'self'
                sysmsg item 52

                if varexist char_loot_pouch
                    lift item_to_unload 60000
                    wait action_delay
                    drop char_loot_pouch
                    wait action_delay
                else
                    hotkey 'Grab Item'
                    wft 600
                    target item_to_unload
                    wait action_delay
                endif

                # check char container limit
                if insysmsg 'That container cannot hold more weight'
                    if timer 'char_heavy_warning_msg_timer' >= 5000
                        overhead 'BACKPACK FULL! UNLOAD!' 37
                        settimer 'char_heavy_warning_msg_timer' 0
                    endif
                endif
            endwhile
        endfor

        sysmsg 'LOOT CHEST FINISHED'
        overhead '*exploding chest*' 90
        menu chest 1

    endif

    @clearignore
    @clearsysmsg

endif

while findtype 'map' backpack 0 any as tmap
    getlabel tmap tmap_label
    if "completed by" in tmap_label
        lift tmap 1
        wait action_delay
        overhead "dropping completed map"
        if findtype 'barrel' ground 0 1 2 as trashcan
            sysmsg "Dropping Completed Map On Trash Barrel" sysmsgs_color
            drop trashcan -1 -1 0
        else
            sysmsg "Dropping Completed Map On The Ground" sysmsgs_color
            droprelloc 0 0
        endif
    endif
endwhile

sysmsg '>>> Open Locked Chests Script finished!' 53


#################################
# CHANGELOG
#################################
#
# (unreleased)
# - Switches list config to setvar! variables
#
# v0.0.3
# - Removes the hiding part so it doenst stop char from starting
# - Checks if char has trap_loot_pouch and if so use it to hide the chest loot
# - In case no trap_loot_pouch is found, use 'Grab' hotkey + wft to get chest items
# - Handles cases when backpack too full to loot
# - Adds gump serial to all gumpresponse calls
# - Adds SEVERAL missing item types from items list
# - Loots opened chests if finds one on ground
# - Explodes chest when finishes looting
# - Fixed gold lift amount (was 1, changed to 60000)
# - Reorganized rares list to priorize cloth > cores > skill scrolls
# - Fixed wrong variable name for action_delay that was resulting in lift and drop actions happening at the same time
#
# v0.0.2
# - Adds clearsysmsg at the beginning of the macro to avoid detecting sysmsgs from previous executions
#
# v0.0.1
# - Initial release
#
#
