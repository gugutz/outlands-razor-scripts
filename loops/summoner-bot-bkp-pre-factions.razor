sysmsg '#########################' 90
overhead 'ðŸ¤– SUMMONER BOT ðŸ¤–' 55
overhead 'by gugutz' 55
overhead 'version 3.0' 56

sysmsg '>>> SUMMONER BOT' 55
sysmsg 'by gugutz' 55
sysmsg 'version 3.0' 56
sysmsg '########################' 90


if not timerexists 'execution_timer'
    createtimer 'execution_timer'
endif
settimer 'execution_timer' 0


if not timerexists 'script_settings_timer'
    createtimer 'script_settings_timer'
endif
settimer 'script_settings_timer' 0


# CONFIGURE SCRIPT VERBOSITY
setvar! debug 1
setvar! stack_trace 0
setvar! verbose_mode 1
setvar! use_script_overhead_messages 1



if stack_trace == 1
    sysmsg '$$$ Setting General Configuration...' script_msg_color
endif

setvar! auto_configure_script_based_on_skills 1

# GENERAL SETTINGS
setvar! boating_mode 1
setvar! auto_defuse_bombs 1
setvar! auto_repair_ship 1
setvar! auto_reload_cannons 1
setvar! auto_fire_cannons 1
setvar! auto_heal_crew 1
setvar! auto_open_enemy_boat_holds 1
setvar! auto_dock_when_close_to_dockmaster 1
setvar! hold_targets 0

setvar! dockmaster_gump_id 3287496917
setvar! boarding_gump_id 2881168634
setvar! search_ships_gump_id 2890020940

if stack_trace == 1
    sysmsg '$$$ Setting Targeting Configuration...' script_msg_color
endif

setvar! auto_get_new_targets 0
setvar! auto_attack_targets 1
setvar! keep_getting_closest_target 1
setvar! get_players_on_auto_target 0
setvar! lure_mobs_closer_before_killing 1
setvar! lure_mobs_distance_to_lure 2
setvar! offensive_mode 1
setvar! hide_valuables_in_char_loot_pouch 1
setvar! auto_escape_pks 1
setvar! auto_unload_items_in_pack_animal 1
setvar! auto_unload_reagents_in_pack_animal 1
setvar! auto_heal 1
setvar! auto_cure_poison 1
setvar! auto_move_regs_to_satchel 1
setvar! auto_meditate 1


# SUMMON SETTINGS
setvar! auto_summon 1
setvar! use_undead_summons 1
setvar! auto_all_guard 1

if stack_trace == 1
    sysmsg '$$$ Setting Summons Options...' script_msg_color
endif

setvar! cast_summons_delay 3300
setvar! auto_vampiric_embrace 1
setvar! auto_patrol_when_no_active_lasttarget 0
setvar! patrol_first_relative_direction 0
setvar! patrol_second_relative_direction -10

if stack_trace == 1
    sysmsg '$$$ Setting up Char Summons...' script_msg_color
endif

if not listexists 'summons'
    createlist 'summons'
    pushlist 'summons' 'an earth elemental'
    pushlist 'summons' 'a fire elemental'
    pushlist 'summons' 'summ. creature'
endif

if stack_trace == 1
    sysmsg '$$$ Setting Grimoire Spells Used...' script_msg_color
endif
# SPELL SETTINGS
setvar! use_mana_drain 1
setvar! use_curse 1
setvar! use_mass_curse 0
setvar! use_ma 1
setvar! use_harm 1
setvar! use_fireball 0
setvar! use_lightning 1
setvar! use_mind_blast 1
setvar! use_eb 0
setvar! use_flamestrike 1
setvar! use_pain_spike 0
setvar! use_chain_lightning 1
setvar! use_meteor_swarm 1
setvar! use_earthquake 0

if stack_trace == 1
    sysmsg '$$$ CONFIGURING GRIMOIRE SPELL DELAYS...' script_msg_color
endif
# GRIMOIRE SPELL DELAYS
setvar! use_mushroom_delay 60000
setvar! mana_drain_delay 60000
setvar! curse_delay 60000
setvar! eb_delay 10000
setvar! ma_delay 60000
setvar! harm_delay 60000
setvar! fireball_delay 60000
setvar! lightning_delay 60000
setvar! chain_lightning_delay 60000
setvar! meteor_swarm_delay 60000
setvar! earthquake_delay 60000

# BOATING DELAYS
setvar! search_ships_delay 15000
setvar! reload_cannons_delay 10000
setvar! fire_cannons_delay 12000
setvar! repair_boat_parts_delay 10000
setvar! heal_boat_crew_delay 30000


if stack_trace == 1
    sysmsg '$$$ Setting Spell Buffs Configuration...' script_msg_color
endif
# SPELL BUFFS
setvar! auto_reactive_armor_buff 1
setvar! auto_magic_reflection_buff 1
setvar! auto_protection_buff 1
setvar! auto_arch_protection_buff 0
setvar! auto_strength_buff 1
setvar! auto_incognito 0


# VARS PLAYER DOENST NEED TO SETUP
setvar! auto_escape_ground_burning_flames 0
setvar! find_last_target_max_range 18
setvar! find_enemy_boats_max_range 15
setvar! find_summon_range 8
setvar! juggle_mode 0


if stack_trace == 1
    sysmsg '$$$ Setting Necromancer Related Configuration...' script_msg_color
endif


# sysmsg '$$$ Configuring General Delays...' script_msg_color
setvar! action_delay 550
setvar! spell_recovery_delay 120
setvar! all_guard_delay 5000
setvar! all_patrol_delay 6000


# AUTO RAIL OPTIONS
# if not varexist summoner_bot_first_run_done
setvar! auto_rail 0

clearlist rail_directions
createlist rail_directions
pushlist rail_directions 2
pushlist rail_directions 6
pushlist rail_directions 4
pushlist rail_directions 4
pushlist rail_directions 10
pushlist rail_directions 10

clearlist rail_x_positions
createlist rail_x_positions
pushlist rail_x_positions 5644
pushlist rail_x_positions 5641
pushlist rail_x_positions 5641
pushlist rail_x_positions 5641
pushlist rail_x_positions 5641
pushlist rail_x_positions 5641


clearlist rail_y_positions
createlist rail_y_positions
pushlist rail_y_positions 1010
pushlist rail_y_positions 1010
pushlist rail_y_positions 1019
pushlist rail_y_positions 1029
pushlist rail_y_positions 1021
pushlist rail_y_positions 1010

sysmsg '>> FINISHED PLAYER SETTINGS IN {{script_settings_timer}} ms' script_msg_color



# SCRIPT RELATED VARIABLES AND LISTS (PLAYER DOENST NEED TO MESS WITH THESE)
if not timerexists 'script_related_settings_timer'
    createtimer 'script_related_settings_timer'
endif
settimer 'script_related_settings_timer' 0

if stack_trace == 1
    sysmsg '$$$ Setting Skill Buffs Configuration...' script_msg_color
endif

# SKILL BUFFS
setvar! auto_campfire_buff 0
setvar! auto_tasteid_buff 0
setvar! auto_delectable 0
setvar! auto_spirit_speak 0
setvar! auto_skin_corpses 0
setvar! auto_herd_mobs 0

if stack_trace == 1
    sysmsg '$$$ Configuring Diffhits Limits Before Actions...' script_msg_color
endif

setvar! max_diffhits_before_healing 10
setvar! max_diffhits_before_buffing 5
setvar! max_diffhits_before_meditating 5
setvar! max_diffhits_before_heal_pot 40
setvar! max_diffhits_before_greater_heal 20
setvar! min_mana_to_attack 52
setvar! mana_limit_to_medit 40
setvar! mana_limit_to_eat_mushroom 70
setvar! mushroom_limit_before_creating_more 2
setvar! mushroom_stock_size 15


if stack_trace == 1
    sysmsg '$$$ Setting Pack Animal Unload Configuration...' script_msg_color
endif
setvar! move_gold 1
setvar! move_resources 1
setvar! move_gems 1
setvar! move_food 1
setvar! move_reagents 1
setvar! min_reagents_to_leave_on_char 160
setvar! amount_of_regs_to_move 40








setvar! script_msg_color 50
# sysmsg '$$$ Setting Messages Color Variables...' script_msg_color
setvar! default_sysmsg_color 54
setvar! default_overhead_color 54
setvar! debug_sysmsg_color 91
setvar! spell_msg_color 49
setvar! buff_msg_color 92
setvar! warning_msg_color 54
setvar! alert_msg_color 38
setvar! success_msg_color 69
setvar! action_msg_color 90
setvar! rail_msg_color 116

setvar! on_cooldown_msg_color 53
setvar! reset_timer_msg_color 48

setvar! boating_msg_color 84

# sysmsg '$$$ Creating Constants For In-Game Types...' script_msg_color
# in game types/graphics
setvar! LANTERN_ON_TYPE 2594
setvar! LANTERN_OFF_TYPE 2597
setvar! TORCH_ON_TYPE 2578
setvar! TORCH_OFF_TYPE 3947
setvar! YULETIDE_CANDLE_ON_TYPE 22432
setvar! YULETIDE_CANDLE_OFF_TYPE 22433
# dungeon torches only have a 'on' graphic, they cant be turned off
setvar! DUNGEON_TORCH_TYPE 30580
setvar! SHIP_BOMB 5188
setvar! HULL_STATUS_BAR_COLOR 150




# if summ creature is one of players summons, change limit to 5 so even with 4 followers, we still make the char cast to summon the fifth creature
# if not, then we just want 2 elementals so limit should be 4, since they take up 2 slots each and the fifth wouldnt be possible
if inlist 'summons' 'summ. creature'
    setvar! summon_max_limit 5
else
    setvar! summon_max_limit 4
endif





################################################


if stack_trace == 1
    sysmsg '$$$ Creating Summon Spell Lists...' script_msg_color
endif

if not listexists 'summonspells'
    createlist 'summonspells'
else
    clearlist 'summonspells'
endif

if inlist 'summons' 'an air elemental'
    @pushlist 'summonspells' 'air elemental'
endif
if inlist 'summons' 'an earth elemental'
    @pushlist 'summonspells' 'earth elemental'
endif
if inlist 'summons' 'a water elemental'
    @pushlist 'summonspells' 'water elemental'
endif
if inlist 'summons' 'a fire elemental'
    @pushlist 'summonspells' 'fire elemental'
endif
if inlist 'summons' 'a daemon'
    @pushlist 'summonspells' 'summon daemon'
endif
if inlist 'summons' 'an energy vortex'
    @pushlist 'summonspells' 'energy vortex'
endif
if inlist 'summons' 'a blade spirit'
    @pushlist 'summonspells' 'blade spirits'
endif
if inlist 'summons' 'summ. creature'
    @pushlist 'summonspells' 'summ. creature'
endif

################################################
# UNLOAD ITEMS IN PACKIE SETUP


if stack_trace == 1
    sysmsg '$$$ Creating pack animal unloading lists...' script_msg_color
endif

if not listexists 'open_pack_animal_backpack'
    createlist 'open_pack_animal_backpack'
else
    clearlist 'open_pack_animal_backpack'
endif


if stack_trace == 1
    sysmsg '[DEBUG] MID FIRST RUN'
endif

if stack_trace == 1
    sysmsg '$$$ Populating pack animal unload item lists...' 90
endif

#####################################
# CREATE ITEMS TO MOVE TO PACKIE LISTS
#####################################

if not listexists 'items_to_move_to_llama'
    @createlist 'items_to_move_to_llama'

    if move_gold == 1
        @pushlist 'items_to_move_to_llama' 'gold coin'
    endif

    if move_resources == 1
        @pushlist 'items_to_move_to_llama' 'cut up leather'
        @pushlist 'items_to_move_to_llama' 'log%s'
        @pushlist 'items_to_move_to_llama' 'board%s'
        @pushlist 'items_to_move_to_llama' 'ingot%s'
    endif

    # gems
    if move_gems == 1
        @pushlist 'items_to_move_to_llama' 'rub%ies/y%'
        @pushlist 'items_to_move_to_llama' 'tourmaline%s%'
        @pushlist 'items_to_move_to_llama' 'emerald%s%'
        @pushlist 'items_to_move_to_llama' 'diamond%s%'
        @pushlist 'items_to_move_to_llama' 'piece%s% of amber'
        @pushlist 'items_to_move_to_llama' 'amethyst%s%'
        @pushlist 'items_to_move_to_llama' 'star sapphire%s%'
        @pushlist 'items_to_move_to_llama' 'citrine%s%'
        @pushlist 'items_to_move_to_llama' 'sapphire%s%'
    endif
    #
    # foods
    if move_food == 1
        @pushlist 'items_to_move_to_llama' 'sliced ham'
        @pushlist 'items_to_move_to_llama' 'raw chicken leg%s%'
        @pushlist 'items_to_move_to_llama' 'raw leg%s% of lamb'
        @pushlist 'items_to_move_to_llama' 'slab%s% of bacon'
        @pushlist 'items_to_move_to_llama' 'sausage%s%'
        @pushlist 'items_to_move_to_llama' 'ham%s%'
        @pushlist 'items_to_move_to_llama' 'cut%s% of raw ribs'
    endif
    #
    # foods
endif

if move_reagents == 1 and not listexists 'reagents'
    @createlist 'reagents'
    @pushlist 'reagents' 'Blood Moss'
    @pushlist 'reagents' 'Black Pearl%s%'
    @pushlist 'reagents' 'Garlic'
    @pushlist 'reagents' 'Mandrake Root%s%'
    @pushlist 'reagents' 'Ginseng'
    @pushlist 'reagents' 'Nightshade'
    @pushlist 'reagents' 'Sulfurous Ash'
    @pushlist 'reagents' "Spider's Silk"
endif


# ITEMS LIST
if not listexists 'loot_items'
    createlist 'loot_items'
    pushlist 'loot_items' 'chain link'
    pushlist 'loot_items' 'map'
    # focis
    pushlist 'loot_items' 48261
    # bolt and arrow bundle
    pushlist 'loot_items' 'bold and arrow keg'
    # skill balls
    pushlist 'loot_items' 'void orb'
    pushlist 'loot_items' 'research materials'
    # skill scroll
    pushlist 'loot_items' 'scroll of calling'
    pushlist 'loot_items' 22336
    # # mcd (this goes into the resource stockpile)
    pushlist 'loot_items' 'Book of Truth'
    # spell hue deeds
    pushlist 'loot_items' 5359
    # rare cloth
    pushlist 'loot_items' 'folded cloth'
    # sandals
    pushlist 'loot_items' 'sandals'
    # skill scrolls
    pushlist 'loot_items' 'aspect core'
    # aspect extract
    pushlist 'loot_items' 3836
    # destils
    pushlist 'loot_items' 17686
    # collectable cards
    pushlist 'loot_items' 'parchment'
    pushlist 'loot_items' 'carpet'
    # greater paragon chests
    pushlist 'loot_items' 29833
    # runebook dye
    pushlist 'loot_items' 3838
    # backpack dye
    pushlist 'loot_items' 3839
    # headwear dye
    pushlist 'loot_items' 3842
    # facial hair dye
    pushlist 'loot_items' 3843
    # hair, shield and quiver dye
    pushlist 'loot_items' 3843
    # fortuniture dye
    pushlist 'loot_items' 29025
    # carpet dye
    pushlist 'loot_items' 29036
    # arcane scroll
    pushlist 'loot_items' 'blank scroll%s%'
    # plant chemicals
    pushlist 'loot_items' 29030
    # magic mushrooms
    # pushlist 'loot_items' 'mushroom'
    # adventurers rope (any rope really, but the intetion is to hide my adventurers rope)
    pushlist 'loot_items' 'rope'
    # adventurers rope (any rope really, but the intetion is to hide my adventurers rope)
    pushlist 'loot_items' 'elven spellblade'
endif



####################################
# BOATING LISTS

createlist 'my_boat_cannons'
clearlist 'my_boat_cannons'

# cannons north
if findtypelist 'my_boat_cannons' 'Light Cannon (North)' ground any any 10
endif
# cannons south
if findtypelist 'my_boat_cannons' 'Light Cannon (South)' ground any any 10
endif
# cannons west
if findtypelist 'my_boat_cannons' 'Light Cannon (West)' ground any any 10
endif
# cannons east
if findtypelist 'my_boat_cannons' 'Light Cannon (East)' ground any any 10
endif

# createlist 'ships_sails_types'
# clearlist 'ships_sails_types'
# pushlist 'ships_sails_types' 16387
# # carrack sails
# pushlist 'ships_sails_types' 16466
# pushlist 'ships_sails_types' 16467
# pushlist 'ships_sails_types' 16468
# pushlist 'ships_sails_types' 16469

# MY BOAT HULL STATUS BAR
if varexist my_boat_status_bar
    sysmsg 'CHAR STATUS BAR VAR EXISTS: {{my_boat_status_bar}}!' boating_msg_color
    if find my_boat_status_bar ground any any 12
        sysmsg 'CHAR SAVED BOAT FOUND!' boating_msg_color
    else
        sysmsg 'CHAR SAVED BOAT CANT BE FOUND. TRYING TO SPIN THE BOAT!' boating_msg_color
        say 'turn right'
        wait action_delay
        if not find my_boat_status_bar ground any any 12
            unsetvar my_boat_status_bar
        endif
    endif
endif

if not varexist my_boat_status_bar
    sysmsg 'CHAR BOAT VAR DONT EXIST!' boating_msg_color
    if debug == 1
        sysmsg 'SEARCHING STATUS BARS ' boating_msg_color
    endif
    createlist 'status_bars'
    clearlist 'status_bars'

    if findtype 'status bar' ground HULL_STATUS_BAR_COLOR any as found
        sysmsg 'FOUND CHAR BOAT STATUS BAR {{found}}' boating_msg_color
        setvar my_boat_status_bar found
    else
        sysmsg 'CANT FINDTYPE STATUS BAR. SELECT YOUR BOAT HULL STATUS BAR' 90
        setvar my_boat_status_bar
        wft action_delay
        while targetexists 'neutral'
            wait 10
            sysmsg 'waiting to select boat status bar' 54
        endwhile

        if not varexist my_boat_status_bar and boating_mode == 1
            sysmsg 'CANT FIND BOAT. DISABLING BOAT MODE'
            setvar! boating_mode 0
        else
            sysmsg 'BOAT STATUS BAR SET!'
            setvar! boating_mode 1
        endif
    endif
endif


# MY BOAT HATCH
if boating_mode == 1
    if varexist my_boat_hatch_bar
        sysmsg 'CHAR STATUS BAR VAR EXISTS: {{my_boat_status_bar}}!' boating_msg_color
        if find my_boat_hatch ground any any 12
            sysmsg 'CHAR SAVED HATCH FOUND!' boating_msg_color
        else
            sysmsg 'CHAR SAVED HATCH CANT BE FOUND. TRYING TO SPIN THE BOAT!' boating_msg_color
            say 'turn right'
            wait action_delay
            if not find my_boat_hatch ground any any 12
                unsetvar my_boat_hatch
            endif
        endif
    endif
    
    if not varexist my_boat_hatch
        sysmsg 'CHAR BOAT HATCH VAR DONT EXIST!' boating_msg_color
        if debug == 1
            sysmsg 'SEARCHING HATCH' boating_msg_color
        endif
        createlist 'boat_hatches'
        clearlist 'boat_hatches'
    
        if findtype 'hatch' ground any any as found
            sysmsg 'FOUND CHAR BOAT HATCH {{found}}' boating_msg_color
            setvar my_boat_hatch found
        else
            sysmsg 'CANT FINDTYPE HATCH. SELECT YOUR BOAT HATCH' 90
            setvar my_boat_hatch
            wft action_delay

            while targetexists 'neutral'
                wait 10
                sysmsg 'waiting to select boat status bar' 54
            endwhile
    
            if not varexist my_boat_hatch and boating_mode == 1
                sysmsg 'CANT FIND BOAT HATCH!!!!!'
            else
                sysmsg 'BOAT HATCH SET: {my_boat_hatch}!'
                setvar! boating_mode 1
            endif
        endif
    endif
endif





# NPC Ship Hues
createlist npcshiphues
clearlist npcshiphues
# druid
pushlist npcshiphues 2845
# Vile
pushlist npcshiphues 2841
# Ossurary
pushlist npcshiphues 2840
# pirate
pushlist npcshiphues 2269
# merchant
pushlist npcshiphues 2766
# ghost
pushlist npcshiphues 2955
# orc reaver
pushlist npcshiphues 2141
# raider
pushlist npcshiphues 2927
# tradesman
pushlist npcshiphues 2347
# Lizardman
pushlist npcshiphues 2363
# explorer
pushlist npcshiphues 2845
# fisherman
pushlist npcshiphues 2076
# daemon
pushlist npcshiphues 2740
# submerged
pushlist npcshiphues 2826


#create list of tillermen
#if not listexists tillermen_list
createlist tillermen_list
clearlist tillermen_list
@pushlist tillermen_list 15952
@pushlist tillermen_list 15955
@pushlist tillermen_list 15950
@pushlist tillermen_list 15947

createlist 'dockmasters_serials'
clearlist 'dockmasters_serials'
# shelter docks Uriah the Dockmaster
pushlist 'dockmasters_serials' 0x11A32F


################################################
# UNLOAD ITEMS IN PACKIE SETUP
#
# lists to control which corpses have been drained and skinned
# update: with necro you dont need to be draining corpses, summons loose hp until they die instead of lasting a duration in time

# used to control which mobs i already used herding on
@createlist 'herdened_mobs'

if skill 'necromancy' == 0
    if skill 'spirit' > 0 and not listexists 'drained_corpses'
        sysmsg '$$$ Creating list to control drained corpses...' script_msg_color
        createlist 'drained_corpses'
    endif
endif

if skill 'forensic' > 0 and auto_skin_corpses == 1 and not listexists 'skinned_corpses'
    sysmsg '$$$ Creating list to control skinned corpses...' script_msg_color
    createlist 'skinned_corpses'
endif


# if summ creature is one of players summons, change limit to 5 so even with 4 followers, we still make the char cast to summon the fifth creature
# if not, then we just want 2 elementals so limit should be 4, since they take up 2 slots each and the fifth wouldnt be possible
if inlist 'summons' 'summ. creature'
    setvar! summon_max_limit 5
else
    setvar! summon_max_limit 4
endif



setvar! summoner_bot_first_run_done 1
# END FIRST RUN
# HAVE TO BREAK FIRST RUN INTO TWO PARTS HERE
# CAUSE THE atlist VARIABLES BEFORE HAVE TO BE
# INITIALIZED ON EVERY RUN
sysmsg '>> FINISHED SCRIPT RELATED VARIABLES AND LISTS IN  {{script_settings_timer}} ms' script_msg_color


# endif



if not timerexists 'setup_timers_timer'
    createtimer 'setup_timers_timer'
endif
settimer 'setup_timers_timer' 0

if not varexist timers_setup_done

    setvar! current_rail_index 0


    #################################
    # CREATE ALL TIMERS
    #################################
    
    if stack_trace == 1
        sysmsg '$$$ Creating And Setting Timers...' script_msg_color
    endif
    
    createlist 'summoner_bot_timers'
    # pushlist 'summoner_bot_timers' 'loop_on_warning_msg'
    pushlist 'summoner_bot_timers' 'script_running_warning_msg_timer'
    pushlist 'summoner_bot_timers' 'script_stats_msg_timer'
    # pushlist 'summoner_bot_timers' 'waiting_save'
    # pushlist 'summoner_bot_timers' 'last_sysmsg_timer'
    # pushlist 'summoner_bot_timers' 'out_of_item_warning_msg'
    # pushlist 'summoner_bot_timers' 'bandage_timer'
    # pushlist 'summoner_bot_timers' 'waiting_dress_timer'
    pushlist 'summoner_bot_timers' 'spirit_speak_cooldown_timer'
    pushlist 'summoner_bot_timers' 'use_mushroom_timer'
    # SPELL CAST TIMERS
    pushlist 'summoner_bot_timers' 'mana_drain_timer'
    pushlist 'summoner_bot_timers' 'curse_timer'
    pushlist 'summoner_bot_timers' 'mass_curse_timer'
    pushlist 'summoner_bot_timers' 'ma_timer'
    pushlist 'summoner_bot_timers' 'harm_timer'
    pushlist 'summoner_bot_timers' 'fireball_timer'
    pushlist 'summoner_bot_timers' 'lightning_timer'
    pushlist 'summoner_bot_timers' 'eb_timer'
    pushlist 'summoner_bot_timers' 'chain_lightning_timer'
    pushlist 'summoner_bot_timers' 'meteor_swarm_timer'
    pushlist 'summoner_bot_timers' 'earthquake_timer'
    pushlist 'summoner_bot_timers' 'medit_msg_timer'
    pushlist 'summoner_bot_timers' 'auto_get_new_targets_timer'
    pushlist 'summoner_bot_timers' 'get_new_target_msg'
    pushlist 'summoner_bot_timers' 'all_guard_timer'
    pushlist 'summoner_bot_timers' 'all_patrol_timer'
    pushlist 'summoner_bot_timers' 'holding_target_warning_msg'
    pushlist 'summoner_bot_timers' 'waiting_summon_timer'
    pushlist 'summoner_bot_timers' 'waiting_spell_timer'
    pushlist 'summoner_bot_timers' 'waiting_target_timer'
    pushlist 'summoner_bot_timers' 'lure_mob_closer_timer'
    pushlist 'summoner_bot_timers' 'low_mana_for_summoning_warning_msg_timer'
    pushlist 'summoner_bot_timers' 'fun_timer'
    # BOATING TIMERS
    pushlist 'summoner_bot_timers' 'search_ships_timer'
    pushlist 'summoner_bot_timers' 'repair_ship_timer'
    pushlist 'summoner_bot_timers' 'reload_cannons_timer'
    pushlist 'summoner_bot_timers' 'fire_cannons_timer'



    
    
    foreach timer in 'summoner_bot_timers'
        if not timerexists timer
            createtimer timer
            settimer timer 99999
        endif
    endfor
    
    
    # SET ALL TIMERS DEFAULT VALUES
    settimer 'mana_drain_timer' mana_drain_delay
    settimer 'curse_timer' curse_delay
    settimer 'ma_timer' ma_delay
    settimer 'harm_timer' harm_delay
    settimer 'fireball_timer' fireball_delay
    settimer 'lightning_timer' lightning_delay
    settimer 'chain_lightning_timer' lightning_delay
    settimer 'meteor_swarm_timer' lightning_delay
    settimer 'earthquake_timer' lightning_delay
    settimer 'eb_timer' eb_delay
    settimer 'medit_msg_timer' 1000
    settimer 'auto_get_new_targets_timer' 1000
    settimer 'get_new_target_msg' 120000
    settimer 'all_guard_timer' all_guard_delay
    settimer 'all_patrol_timer' all_patrol_delay
    settimer 'holding_target_warning_msg' 0
    settimer 'waiting_summon_timer' 0
    settimer 'waiting_spell_timer' 0
    settimer 'waiting_target_timer' 0
    settimer 'lure_mob_closer_timer' 5000
    settimer 'script_running_warning_msg_timer' 2000
    settimer 'script_stats_msg_timer' 0
    settimer 'use_mushroom_timer' use_mushroom_delay
    settimer 'spirit_speak_cooldown_timer' 1000
    
    
    # --------------------------------------------
    # NECROMANCY TIMERS
    if skill 'necromancy' > 0
        if stack_trace == 1
            sysmsg '$$$ Creating Necro Spell Timers...' script_msg_color
        endif

        if not timerexists 'vengeful_spirit_timer'
            createtimer 'vengeful_spirit_timer'
            settimer 'vengeful_spirit_timer' 30001
        endif
    
        createtimer 'vampiric_embrace_cooldown_timer'
        settimer 'vampiric_embrace_cooldown_timer' 1000
    endif

    setvar! timers_setup_done 1

    sysmsg '>> FINISHED TIMERS IN {{setup_timers_timer}} ms' script_msg_color
    setvar! setup_timers_execution_time setup_timers_timer

endif


#######################################################
# CHAR BASED CUSTOMIZATIONS
if name == 'Neron'
    sysmsg '$$$ [OPTIONS] Applying config for Neron' script_msg_color
    setvar! auto_incognito 0
    setvar! juggle_mode 0
    setvar! auto_patrol_when_no_active_lasttarget 1
    setvar! auto_rail 0
    setvar! lure_mobs_closer_before_killing 1
endif

if name == 'Yorixiriamori-'
# BUGUEI SETTINGS
# if self == 0xAA60D
    sysmsg '$$$ [OPTIONS] Applying custom config for Yorixiriamori-' script_msg_color
    setvar! use_mind_blast 0
    setvar! use_fireball 1
    setvar! auto_incognito 1
    setvar! auto_get_new_targets 0
    setvar! kill_close_to_loot 0
endif



#######################################################
## MAKE FINAL ADJUSTMENTS IN SETTINGS BEFORE STARTING MAIN ROUTINE

# if were on a boat, activate boat mode if its not already on
if not varexist tillerman or varexist tillerman and not find tillerman ground any any 15
    foreach tillerman in tillermen_list
        if findtype tillerMenVar ground as found
            sysmsg 'TILLERMAN SET!' success_msg_color
            overhead "tillerman set!" success_msg_color
            setvar tillerman found
            setvar! boating_mode 1

            dclick tillerman
            wait action_delay
        endif
    endfor
endif

if auto_configure_script_based_on_skills == 1
    # boating mode related options
    if boating_mode == 1
        sysmsg 'OPTIMIZING SCRIPT FOR BOATING' warning_msg_color
        setvar! use_curse 0
        setvar! use_mass_curse 1

        setvar! auto_protection_buff 0
        setvar! kill_close_to_loot 0
        setvar! auto_arch_protection_buff 1
        clearlist 'summons'
        pushlist 'summons' 'a fire elemental'
        pushlist 'summons' 'summ. creature'
    endif

    if skill 'herding' == 0 and auto_herd_mobs == 1
        sysmsg '$$$ [OPTIONS] DISABLING auto_herd_mobs' script_msg_color
        setvar! auto_herd_mobs 0
    elseif skill 'herding' > 0 and auto_herd_mobs == 0
        sysmsg '$$$ [OPTIONS] ENABLING auto_herd_mobs' script_msg_color
        setvar! auto_herd_mobs 1
    endif

    if skill 'necromancy' == 0 use_undead_summons == 1
        sysmsg '$$$ [OPTIONS] DISABLING use_undead_summons' script_msg_color
        setvar! use_undead_summons 0
    elseif skill 'necromancy' > 0 and use_undead_summons == 0
        sysmsg '$$$ [OPTIONS] ENABLING auto_herd_mobs' script_msg_color
        setvar! use_undead_summons 1
    endif

    if skill 'camping' == 0 and auto_campfire_buff == 1
        sysmsg '$$$ [OPTIONS] DISABLING auto_campfire_buff' script_msg_color
        setvar! auto_campfire_buff 0
    elseif skill 'camping' > 0 and auto_campfire_buff == 0
        sysmsg '$$$ [OPTIONS] ENABLING auto_campfire_buff' script_msg_color
        setvar! auto_campfire_buff 1
    endif

    if skill 'forensic' == 0 and auto_skin_corpses == 1
        sysmsg '$$$ [OPTIONS] DISABLING auto_skin_corpses' script_msg_color
        setvar! auto_skin_corpses 0
    elseif skill 'forensic' > 0 and auto_skin_corpses == 0
        sysmsg '$$$ [OPTIONS] ENABLING auto_skin_corpses' script_msg_color
        setvar! auto_skin_corpses 1
    endif

    if skill 'taste identification' == 0 and auto_tasteid_buff == 1
        sysmsg '$$$ [OPTIONS] DISABLING auto_tasteid_buff' script_msg_color
        setvar! auto_tasteid_buff 0
    elseif skill 'taste identification' > 0 and auto_tasteid_buff == 0
        sysmsg '$$$ [OPTIONS] ENABLING auto_tasteid_buff' script_msg_color
        setvar! auto_tasteid_buff 1
    endif

endif

#######################################################
## CHECK SETTINGS AND DO WHAT NEEDS TO BE DONE BEFORE START

# -------------------------------------
if hide_valuables_in_char_loot_pouch == 1
    if not varexist char_loot_pouch
        sysmsg 'LOOT POUCH IS NOT SET. PLEASE SELECT A POUCH TO HIDE VALUABLE LOOT:' warning_msg_color
        setvar char_loot_pouch
    elseif varexist char_loot_pouch and not find char_loot_pouch backpack
        sysmsg 'CANT FIND PREVIOUSLY SET LOOT POUCH. PLEASE SELECT A NEW ONE:' warning_msg_color
        setvar char_loot_pouch
    endif
endif


# -------------------------------------
# open necro hotbar on start
# @setvar necromancy_hotbar_gump_id 622436516
if skill 'necromancy' > 0 and not gumpexists 622436516
    sysmsg 'Opening Necro Hotbar...' 100
    say '[necromancyhotbar'
endif



# -------------------------------------
# check if we already found and saved a packie, and if so, if its still around. if not, recreate packies list
if varexist pack_animal
    if not find pack_animal ground 0 any 5
        setvar! recreate_packies_list true
    endif
else
    setvar! recreate_packies_list true
endif


# only start this routine if char has followers and we find either a pack llama or horse nearby
if followers > 0 and findtype 292 ground 0 any 5 as llama or findtype 291 ground 0 any 5 as horse
    if varexist recreate_packies_list
        if debug == 1
            sysmsg '[DEBUG] RECREATING PACKIES LIST' debug_sysmsg_color
        endif
    
        unsetvar! recreate_packies_list
        unsetvar! pack_animal
    
        # FIND AND SAVE PLAYER LLAMA
        if findtype 292 ground 0 any 5 as llama
            overhead 'scanning' 55 llama
            if noto llama == noto 'self'
                setvar pack_animal llama
                overhead 'found player llama' 55 pack_animal
            endif
        elseif findtype 291 ground 0 any 5 as horse
            overhead 'scanning' 55 horse
            if noto horse == noto 'self'
                setvar pack_animal horse
            endif
        endif
    
        if varexist pack_animal
            sysmsg "FOUND PLAYER PACK LLAMA" 55
            overhead "found and saving llama!" 55 'self'
            overhead 'found player llama' 55 pack_animal
    
            overhead '*renaming*' 55 pack_animal
            rename pack_animal 'i'
            menu pack_animal 4
            sysmsg '>>> Comanding pack animal to follow char...' 56
            say 'i follow me'
        else
            sysmsg '>>> COULD NOT FIND ANY PACK ANIMALS CLOSE.' 56
            sysmsg '****** IMPORTANT: ******' 90
            sysmsg '>>> YOU SHOULD BE WITHIN 5 TILES OF YOUR LLAMA SO THE SCRIPT CAN FIND AND SAVE IT!' 56
        endif
    endif
endif


# -------------------------------------
# if offensive mode is on, try to get a target so we can skip the buffs and attack asap

if offensive_mode == 1 and auto_get_new_targets == 1 and keep_getting_closest_target == 1
    if verbose_mode == 1
        sysmsg '[OFFENSIVE MODE] GETTING CLOSEST TARGET' action_msg_color
    endif

    hotkey 'Target Closest Non-Friendly Monster'
endif


# -------------------------------------
# this is because sometimes i turn on the macro in the middle of a fight
# i want my pets to immeditally attack my last target
say 'all guard me'



#######################################################
## BEGIN MAIN ROUTINE
#######################################################

sysmsg '### STARTING MAIN LOOP AT {{execution_timer}} ms' success_msg_color

while not dead 'self'
    setvar! iteration_number index
    # sysmsg 'Summoner Bot - Iteration: {{index}} '

    if timer 'script_running_warning_msg_timer' >= 8000
        if verbose_mode == 1
            sysmsg 'â˜… SUMMONER BOT by gugutz â™¥' script_msg_color
        endif

        settimer 'script_running_warning_msg_timer' 0
    endif

    if timer 'script_stats_msg_timer' >= 10000
        if verbose_mode == 1
            sysmsg '#########################' 90
            sysmsg '# SCRIPT STATS:' warning_msg_color
            sysmsg 'âˆž Uptime: {{execution_timer}} ms' script_msg_color
            sysmsg 'âˆž Iterations: {{iteration_number}} ms' script_msg_color

            if use_mana_drain == 1
                sysmsg 'â–· Mana Drain Timer: {{mana_drain_timer}} ms' script_msg_color
            endif
            if use_curse == 1
                sysmsg 'â–· Curse Timer: {{curse_timer}} ms' 36
            endif
            if use_lightning == 1
                sysmsg 'â–· Lightning Timer: {{lightning_timer}} ms' 36
            endif
            if use_ma == 1
                sysmsg 'â–· Magic Arrow Timer: {{ma_timer}} ms' 36
            endif
            if use_harm == 1
                sysmsg 'â–· Harm Timer: {{harm_timer}} ms' 36
            endif
            if use_fireball == 1
                sysmsg 'â–· Fireball Timer: {{fireball_timer}} ms' 36
            endif
            if use_eb == 1
                sysmsg 'â–· Energy Bolt Timer: {{eb_timer}} ms' 36
            endif
            if use_eb == 1
                sysmsg 'â–· Energy Bolt Timer: {{eb_timer}} ms' 36
            endif
            if use_chain_lightning == 1
                sysmsg 'â–· Chain Lightning Timer: {{chain_lightning_timer}} ms' 36
            endif
            if use_meteor_swarm == 1
                sysmsg 'â–· Meteor Swarm Timer: {{meteor_swarm_timer}} ms' 36
            endif
            if use_earthquake == 1
                sysmsg 'â–· Earthquake Timer: {{earthquake_timer}} ms' 36
            endif


            if offensive_mode == 1
                sysmsg 'â–· Offensive Mode ON' success_msg_color
            endif
            if boating_mode == 1
                sysmsg 'â–· Boating Mode ON' boating_msg_color
                if varexist my_boat_status_bar
                    sysmsg 'â–· Char boat status bar found: {{my_boat_sail_bar}} ms' boating_msg_color
                else
                    sysmsg 'â–· Char boat status bar NOT FOUND' alert_msg_color
                endif
            endif

            sysmsg '#########################' 90
        endif

        settimer 'script_stats_msg_timer' 0
    endif


    ########################################
    # TOGGLE OPTIONS IN GAME BY TURNING CHAR LIGHTSOURCE ON/OFF


    if findtype 2594|2598|2578|30580 self
        # sysmsg 'FOUND LIGHTSOURCE ON' debug_msg_color
        if auto_get_new_targets == 0
            sysmsg '$$$ [OPTIONS] TURNING AUTO GET NEW TARGETS ON' script_msg_color
            setvar! auto_get_new_targets 1
        endif

    # LIGHT SOURCES OFF
    # dungeon torches have to be undressed (they have to be in the backpack since they cant be turned off)
    elseif findtype 2597|3947 self and not findtype 2597|3947 backpack or findtype 'dungeon torch' backpack
        # sysmsg 'FOUND LIGHTSOURCE OFF' debug_msg_color
        if auto_get_new_targets == 1
            sysmsg '$$$ [OPTIONS] TURNING AUTO GET NEW TARGETS OFF' script_msg_color
            setvar! auto_get_new_targets 0
        endif
    endif


    # satchel equiped
    if findtype 'reagent satchel' self and not findtype 'reagent satchel' backpack
        # sysmsg '>>>>>> FOUND SATCHEL ON SELF' warning_msg_color
        if debug == 0
            sysmsg '$$$ [OPTIONS] TURNING debug ON' script_msg_color
            setvar! debug 1
        endif
        if verbose_mode == 0
            sysmsg '$$$ [OPTIONS] TURNING verbose_mode ON' default_sysmsg_color
            setvar! verbose_mode 1
        endif
    # satchel not equiped (in backpack)
    elseif findtype 'reagent satchel' self and findtype 'reagent satchel' backpack
        # sysmsg '>>>>>> FOUND SATCHEL ON BACKPACK' debug_msg_color
        if debug == 1
            sysmsg '$$$ [OPTIONS] TURNING debug OFF' script_msg_color
            setvar! debug 0
        endif
        if verbose_mode == 1
            sysmsg '$$$ [OPTIONS] TURNING verbose_mode OFF' script_msg_color
            setvar! verbose_mode 0
        endif
    endif

    ########################################
    # IF THERE ARE TARGETS OPENED, SPEND THEM
    # ACCORDING TO THEIR TYPE

    if targetexists 'beneficial'
        if auto_get_new_targets == 1 or hold_targets == 0
            overhead 'spending beneficial target' warning_msg_color
           hotkey 'Target Self'
        else
            overhead 'holding beneficial target' warning_msg_color
            while targetexists 'beneficial'
                if timer 'holding_target_warning_msg' > 2000
                    settimer 'holding_target_warning_msg' 0
                    sysmsg '>>> HOLDING BENEFICIAL TARGET' warning_msg_color
                    # hotkey 'Target Self'
                endif
            endwhile
        endif
    endif

    if targetexists 'neutral'
        # if auto target is on, we dont want any stuck open neutral target stopping the actions on the script so we spend the target
        if auto_get_new_targets == 1 or hold_targets == 1
            overhead 'canceling neutral target' warning_msg_color
            sysmsg '>>> CANCELING NEUTRAL TARGET' warning_msg_color
            hotkey 'Cancel Current Target'
        else
            overhead 'holding neutral target' warning_msg_color
            while targetexists 'neutral'
                if timer 'holding_target_warning_msg' > 2000
                    settimer 'holding_target_warning_msg' 0
                    sysmsg '>>> HOLDING NEUTRAL TARGET' warning_msg_color
                endif
            endwhile
        endif
    endif

    if targetexists 'harmful'
        if not dead 'last'
            if noto 'last' == hostile or noto 'last' == murderer or noto 'last' == criminal
                overhead 'spending harmful target' warning_msg_color
                sysmsg '>>> SPENDING HARMFUL TARGET' 99
                hotkey 'Last Target'
            endif
        else
            if auto_get_new_targets == 1
                overhead 'spending harmful target (dead last)' warning_msg_color
               hotkey 'Target Self'
            else
                overhead 'holding harmful target'
                while targetexists 'harmful'
                    if timer 'holding_target_warning_msg' > 2000
                        settimer 'holding_target_warning_msg' 0
                        sysmsg '>>> HOLDING HARMFUL TARGET' warning_msg_color
                        # targetrelloc 0 1
                    endif
    
                    # copied this part from bottom of script to get new targets if option is set
                    if auto_get_new_targets == 1 and timer 'auto_get_new_targets_timer' > 1000
                        if use_script_overhead_messages
                            overhead '*searching monsters to use target*' action_msg_color
                        endif
                        if verbose_mode == 1
                            sysmsg '> SEARCHING MONSTERS TO USE HARMFUL TARGET...' action_msg_color
                        endif

                        hotkey 'Target Closest Non-Friendly Monster'

                        if get_players_on_auto_target == 1
                            overhead '*searching players*' action_msg_color
                            sysmsg '> SEARCHING PLAYERS...' action_msg_color
                            hotkey 'Next Grey Player Target'
                            # wait action_delay
                        endif
                        settimer 'auto_get_new_targets_timer' 0
                    elseif auto_get_new_targets == 0 and timer 'get_new_target_msg' > 4000
                        overhead 'waiting for new target' alert_msg_color
                        settimer 'get_new_target_msg' 0
                    endif
    
                    if not dead 'last' and noto 'last' == hostile or noto 'last' == criminal
                        hotkey 'Last Target'
                    endif
                endwhile
            endif
        endif
    endif


    ########################################
    # MOST IMPORTANT ROUTINE - KEEP SUMMONS UP!


    # CHOOSE CHARACTER SUMMONS

    # this is just a print to inform char is under summon_limit and is getting ready to summon up
    if auto_summon == 1 and followers < summon_max_limit
        if debug == 1
            sysmsg '[DEBUG] PREPARING TO RESUMMON' debug_sysmsg_color
        endif

        if verbose_mode == 1
            sysmsg 'UNDER SUMMON LIMIT. PREPARING TO SUMMON...' alert_msg_color
        endif




        foreach summon in 'summons'

            if verbose_mode == 1
                sysmsg 'CHECKING {{summon}}: {{index}}' default_sysmsg_color
            endif

            if list 'summons' == 1 and followers == 4
                sysmsg 'SUMMONS LIST ONLY HAS 1 SUMMON TYPE AND CHAR ALREADY HAVE 4 HAVE FOLLOWERS {{summon}}' warning_msg_color
                break
            elseif list 'summons' > 1 and followers == 5
                sysmsg 'SUMMONS LIST ONLY HAS 1 SUMMON TYPE AND CHAR ALREADY HAVE 5 HAVE FOLLOWERS {{summon}}' warning_msg_color
                sysmsg 'BREAKING ON CHECKING SUMMON {{summon}}' warning_msg_color
                break
            endif

            unsetvar! found_summon
            unsetvar! cast_summon_spell
    
            # determine summon name by whether char has necromancy or not
            if use_undead_summons == 1
                # on each iteration, clear and populate this list to set the undead alternative summon based on current summon
                if not listexists 'undead_summons'
                    createlist 'undead_summons'
                endif
                clearlist 'undead_summons'
    
                if 'earth' in summon
                    pushlist 'undead_summons' 'an ancient mummy'
                elseif 'fire' in summon
                    pushlist 'undead_summons' 'a lich'
                elseif 'air' in summon
                    pushlist 'undead_summons' 'a skeletal fiend'
                elseif 'daemon' in summon
                    pushlist 'undead_summons' 'a vampire thrall'
                elseif 'water' in summon
                    pushlist 'undead_summons' 'a rag witch'
                endif
            endif
    
            # if char is necro, make sure vengeful spirit is activated before summoning
            if list 'undead_summons' > 0
                if timer 'vengeful_spirit_timer' >= 30000
                    if verbose_mode == 1
                        sysmsg '>>> VENGEFUL SPIRIT...' spell_msg_color
                    endif
                    say '[vengefulspirit'

                    wait action_delay

                    if verbose_mode == 1
                        sysmsg '>>> WITHER...' spell_msg_color
                    endif

                    say '[wither'
                    settimer 'vengeful_spirit_timer' 0
                else
                    if verbose_mode == 1
                        sysmsg 'Vengeful Spirit Cooldown..' on_cooldown_msg_color
                    endif
                endif
            endif
    
            #########################
            # try to find a similir creature summon to see if we need to cast this one or skip to next one
    
    
            if findtype summon ground any 1 find_summon_range as summonserial
                if noto summonserial = friend
                    if verbose_mode == 1
                        overhead '*found {{summon}}*' 91 summonserial
                    endif

                    setvar! found_summon true
                endif
            # if the 'undead_summons' list has elements, we need to check for those undead summons as well
            elseif list 'undead_summons' > 0
                foreach necro_summon in 'undead_summons'
                    if findtype necro_summon ground any 1 find_summon_range as summonserial
                        if noto summonserial = friend
                            overhead '*found {{summon}}*' 91 summonserial
                            setvar! found_summon true

                            # TESTING HERE (this break was disabled before)
                            # break
                        endif
                    endif
                endfor
            endif
    
            # even if we found this summon type, we still might need to cast it (if only 1 summon in list for instance)
            if varexist found_summon
                # clearlist 'found_summon'

                # if theres only one summon in the 'summons' list, even if we found the summon above,
                # we still need to cast it again
                if list 'summons' == 1 and followers < 4
                    setvar! cast_summon_spell true
                # if one of our summons is summ creature and we only have 3 followers, we can still cast another more usefull
                # summon before actually casting summ.creature
                elseif list 'summons' == 2 and followers <= 3 and inlist 'summons' 'summ. creature'
                    setvar! cast_summon_spell true
                elseif list 'summons' >= 3 and followers <= 1
                    setvar! cast_summon_spell true
                # else if theres more than one summon in 'summons' list and we didnt find this specific summon
                # we need to cast ig
                endif
            else
                if debug == 1
                    sysmsg '[DEBUG] setting to cast summon spell (summon not found)' debug_sysmsg_color
                endif
                setvar! cast_summon_spell true
            endif
    
            #########################
            # prepare to cast the summon spell for this summon
            if varexist cast_summon_spell

    
                foreach summonspell in 'summonspells'

                    if summonspell in summon

                        unsetvar! summon_spell_required_mana
    
                        # first make a mana check for this specific summon spell
                        if 'creature' in summonspell or 'blade' in summonspell
                            setvar! 'summon_spell_required_mana' 14
                        else
                            setvar! 'summon_spell_required_mana' 50
                        endif
    
                        if varexist summon_spell_required_mana
                            if mana < summon_spell_required_mana

                                if timer 'low_mana_for_summoning_warning_msg_timer' >= 2000
                                    if verbose_mode == 1
                                        sysmsg "!!! LOW MANA FOR SUMMONING {{summon}}. (NEEDS {{summon_spell_required_mana}})..." alert_msg_color
                                        overhead "low mana for summoning" alert_msg_color
                                    endif

                                    settimer 'low_mana_for_summoning_warning_msg_timer' 0
                                endif
                            else
                                if verbose_mode == 1
                                    sysmsg ">>> SUMMONING {{summon}}..." action_msg_color
                                endif
                                cast summonspell

                                if 'blade' in summonspell or 'vortex' in summonspell
                                    if verbose_mode == 1
                                        sysmsg 'WAITING FOR {{summonspell}} TARGET..' alert_msg_color
                                        overhead 'Waiting for {{summonspell}} target..' alert_msg_color
                                    endif
    
                                    @settimer 'waiting_summon_timer' 0
                                    while not targetexists 'neutral' and timer 'waiting_summon_timer' < cast_summons_delay
                                        wft 10
                                        if insysmsg 'disturbed'
                                            @settimer 'waiting_summon_timer' 0
                                            if verbose_mode == 1
                                                sysmsg 'BREAKING WHILE WAITING FOR SUMMONING {{summon}}' alert_msg_color
                                            endif

                                            wait spell_recovery_delay
                                            break
                                        endif
                                    endwhile
    
                                    if targetexists 'neutral'
                                        if verbose_mode == 1
                                            sysmsg 'CASTING BLADE OR VORTEX IN GROUND' 55
                                        endif

                                        targetrelloc 0 1
                                        break
                                    endif
                                else
                                    @settimer 'waiting_summon_timer' 0
                                    while timer 'waiting_summon_timer' < cast_summons_delay
                                        wait 10
                                        if insysmsg 'disturbed'
                                            @settimer 'waiting_summon_timer' 0
                                            if verbose_mode == 1
                                                sysmsg 'BREAKING WHILE WAITING FOR SUMMONING {{summon}}' alert_msg_color
                                            endif

                                            wait spell_recovery_delay
                                            break
                                        endif
                                    endwhile

                                    say 'all guard me'
                                endif

                                break

                            endif
                        endif


                    endif

                endfor
            endif


        endfor
    endif

    # if debug == 1
        # sysmsg '[DEBUG] AFTER AUTO-SUMMON ROUTINE' debug_sysmsg_color
    # endif

    # keep draining corpses within 10 tile range
    if followers >= summon_max_limit and diffhits < max_diffhits_before_buffing
        if offensive_mode == 1 and dead lasttarget or offensive_mode == 0
            if auto_spirit_speak == 1 and skill 'spirit' > 0 and use_undead_summons == 0
                if timer 'spirit_speak_cooldown_timer' > 1000
                    settimer 'spirit_speak_cooldown_timer' 0
                    if findtype 'corpse' ground any any 10 as body
                        if not inlist 'drained_corpses' body
                            if verbose_mode == 1
                                sysmsg '>>> DRANING NEARBY CORPSES' action_msg_color
                                overhead '*spirit speak*' action_msg_color
                            endif

                            skill 'spirit'
                            # avoiding using global ignore here, switching to list control to avoid imprevisiblities
                            @pushlist 'drained_corpses' body
                            wait action_delay
                            # @ignore body
                        endif
                    endif
                endif
            endif
        else
            if verbose_mode == 1
                sysmsg '[OFFENSIVE MODE] SKIPPING SPIRIT SPEAK...' warning_msg_color
            endif
        endif
    endif

    # keep draining corpses within 10 tile range
    if followers >= summon_max_limit and diffhits < max_diffhits_before_buffing
        if offensive_mode == 1 and dead lasttarget or offensive_mode == 0
            if auto_vampiric_embrace == 1 and skill 'necromancy' > 0
                # if timer 'vampiric_embrace_cooldown_timer' >= 30000
                if not cooldown 'Necro Ability'
                    if findtype 'corpse' ground any any 10 as body
                        if verbose_mode == 1
                            sysmsg '>>> VAMPIRIC EMBRACE' spell_msg_color
                        endif

                        say '[vampiricembrace'
                        wft action_delay
                        if targetexists 'neutral'
                            if verbose_mode == 1
                                sysmsg '>>> CONSUMING NEARBY CORPSE...' action_msg_color
                                overhead '*consuming corpse*' default_overhead_color
                            endif
                            # target body
                            # TESTING trade target body to target self to avoid locking char trying to consume an out of sight body like one in another room
                            hotkey 'Target Self'
                            wait action_delay
                            settimer 'vampiric_embrace_cooldown_timer' 0

                            if debug == 1
                                sysmsg 'RESETING LAST AFTER CONSUMING CORPSE' reset_timer_msg_color
                            endif

                            hotkey 'Set Last Target (Harmful)'
                            wft action_delay
                            target last_target_serial
                        endif
        
                    endif
                else
                    # if verbose_mode == 1
                    #     sysmsg '... VAMPIRIC EMBRACE COOLDOWN' on_cooldown_msg_color
                    # endif
                endif
            endif
        else
            if verbose_mode == 1
                sysmsg '[OFFENSIVE MODE] SKIPPING VAMPIRIC EMBRACE...' warning_msg_color
            endif
        endif
    endif


    ########################################
    # KEEP CHAR BUFFED UP


    # reflect buff
    if followers >= summon_max_limit and diffhits < max_diffhits_before_buffing
        if offensive_mode == 1 and dead lasttarget or offensive_mode == 0
            if auto_magic_reflection_buff == 1 and not findbuff 'magic reflection'
                if verbose_mode == 1
                    sysmsg '>>> MAGIC REFLECT' spell_msg_color
                endif
                cast 'magic reflection'
    
                @settimer 'waiting_spell_timer' 0
                while not findbuff 'magic reflection' and timer 'waiting_spell_timer' < 3000
                    wait 10
                    if insysmsg 'disturbed' or insysmsg 'spell will not adhere' or insysmsg 'cannot cast a spell'
                        if verbose_mode == 1
                            sysmsg 'BREAKING WHILE WAITING FOR MAGIC REFLECTION' warning_msg_color
                        endif
                        wait spell_recovery_delay
                        break
                    endif
                endwhile

                wait spell_recovery_delay
    
                if findbuff 'magic reflection'
                    overhead '+MAGIC REFLECT' buff_msg_color
                endif
            endif
        else
            if verbose_mode == 1
                sysmsg '[OFFENSIVE MODE] SKIPPING MAGIC REFLECTION...' warning_msg_color
            endif
        endif
    endif

    # reactive armor buff
    if followers >= summon_max_limit and diffhits < max_diffhits_before_buffing
        if offensive_mode == 1 and dead lasttarget or offensive_mode == 0
            if auto_reactive_armor_buff == 1 and not findbuff 'reactive armor'
                if verbose_mode == 1
                    sysmsg '>>> REACTIVE ARMOR' spell_msg_color
                endif

                cast 'reactive armor'
                @settimer 'waiting_spell_timer' 0
                while not findbuff 'reactive armor' and timer 'waiting_spell_timer' < 2000
                    wait 10
                    if insysmsg 'disturbed' or insysmsg 'spell will not adhere' or insysmsg 'cannot cast a spell'
                        if verbose_mode == 1
                            sysmsg 'BREAKING WHILE WAITING FOR REACTIVE ARMOR' warning_msg_color
                        endif

                        wait spell_recovery_delay
                        break
                    endif
                endwhile
    
                wait spell_recovery_delay
    
                if findbuff 'reactive armor'
                    overhead '+reactive' buff_msg_color
                endif
            endif
        else
            if verbose_mode == 1
                sysmsg '[OFFENSIVE MODE] SKIPPING REACTIVE ARMOR...' warning_msg_color
            endif
        endif
    endif

    # PROTECTION ARMOR BUFF
    if followers >= summon_max_limit and diffhits < max_diffhits_before_buffing
        if offensive_mode == 1 and dead lasttarget or offensive_mode == 0
            if auto_protection_buff == 1 and not findbuff 'protection'
                if verbose_mode == 1
                    sysmsg '>>> PROTECTION' spell_msg_color
                endif

                cast 'protection'
    
                @settimer 'waiting_spell_timer' 0
                while not findbuff 'protection' and timer 'waiting_spell_timer' < 1500
                    wait 10
                    if insysmsg 'disturbed' or insysmsg 'spell will not adhere' or insysmsg 'cannot cast a spell'
                        if verbose_mode == 1
                            sysmsg 'BREAKING WHILE WAITING FOR PROTECTION' warning_msg_color
                        endif

                        wait spell_recovery_delay
                        break
                    endif
                endwhile

                wait spell_recovery_delay
    
                if findbuff 'protection'
                    overhead '+PROTECTION' buff_msg_color
                endif
            # OR ARCH PROTECTION
            elseif auto_arch_protection_buff == 1 and not findbuff 'protection'
    
                @settimer 'waiting_target_timer' 0
                while not targetexists 'neutral' and timer 'waiting_spell_timer' < 4000
                    wft 100
                    if insysmsg 'disturbed' or insysmsg 'spell will not adhere' or insysmsg 'cannot cast a spell'
                        if verbose_mode == 1
                            sysmsg 'BREAKING WHILE WAITING FOR ARCH PROTECTION TARGET' warning_msg_color
                        endif

                        wait spell_recovery_delay
                        break
                    endif
                endwhile
    
                if targetexists 'neutral'
                    hotkey 'Target Self'
                    wait 100
                endif
    
                wait 150
                if findbuff 'protection'
                    if verbose_mode == 1
                        overhead '+arch protection' buff_msg_color
                    endif
                endif
            endif
        else
            if verbose_mode == 1
                sysmsg '[OFFENSIVE MODE] SKIPPING PROTECTION...' warning_msg_color
            endif
        endif
    endif

    # keep str above 100
    if followers >= summon_max_limit and diffhits < max_diffhits_before_healing
        if offensive_mode == 1 and dead lasttarget or offensive_mode == 0
            if auto_strength_buff == 1 and not findbuff 'Strength' or str < 110
                if verbose_mode == 1
                    sysmsg '>>> STRENGTH' spell_msg_color
                endif

                cast 'Strength'
    
                @settimer 'waiting_target_timer' 0
                while not findbuff 'strength' and not targetexists 'beneficial' and not insysmsg 'disturbed' and not insysmsg 'cannot cast a spell' and timer 'waiting_target_timer' < 1500
                    wft 10
                    if insysmsg 'disturbed' or insysmsg 'spell will not adhere' or insysmsg 'cannot cast a spell'
                        if verbose_mode == 1
                            sysmsg 'BREAKING WHILE WAITING FOR STRENGTH TARGET' warning_msg_color
                        endif

                        wait spell_recovery_delay
                        break
                    endif
                endwhile
    
                if targetexists 'beneficial'
                    hotkey 'Target Self'
                    wait spell_recovery_delay
                endif
    
                if findbuff 'strength'
                    overhead '+strength' buff_msg_color
                endif
            endif
        else
            if verbose_mode == 1
                sysmsg '[OFFENSIVE MODE] SKIPPING STRENGTH...' warning_msg_color
            endif
        endif
    endif


    # CAMPFIRE BUFF
    if auto_campfire_buff == 1 and not findbuff 'campfire visit'
        if not findtype campfire ground any any 7
            if findtype 'kindling' backpack as firestarter
                if verbose_mode == 1
                    sysmsg '>>> STARTING CAMPFIRE*' action_msg_color
                    overhead '*starting campfire*' action_msg_color
                endif

                dclick firestarter
            else
                if verbose_mode == 1
                    overhead 'no kindling' alert_msg_color
                endif
            endif
        elseif findtype campfire ground any any 2 as fire
            dclick fire
        endif
    endif


    # DELECTABLE
    if auto_delectable == 1 and not findbuff 'food satisfaction'
        if findtype 'tray' as delectable
            overhead '*eating deletable*'
            dclick delectable
        else
            overhead '*no delectable*'
        endif
    endif


    # TASTE BUFF
    if not findbuff 'herbal poultice'
        if auto_tasteid_buff == 1 and skill 'taste identification' > 50
            if skill 'taste identification' > 50
                skill 'tasteid'
                wft action_delay

                if findtype 'dagger' backpack as knife
                    target knife
                elseif findtype 'spellbook' backpack as book
                    target book
                else
                    targetrelloc 1 1
                endif

                wait spell_recovery_delay

                if findbuff 'herbal poultice'
                    if verbose_mode == 1
                        sysmsg '+++ CREATED HERBAL POULTICE' buff_msg_color
                    endif

                    if use_script_overhead_messages == 1
                        overhead '*herbal poultice*' buff_msg_color
                    endif
                endif
            endif

        endif
    endif

    if not findbuff 'Forensic Eval Bonus'
        if auto_forensic_buff == 1 and skill 'forensic' > 50
            if findtype 'elven spellblade' backpack as knife
                useobject knife
                wft action_delay

                if targetexists 'neutral'
                    hotkey 'Target Self'
                    if use_script_overhead_messages == 1
                        overhead '*skinning corpses*' action_msg_color
                    endif

                    if verbose_mode == 1
                        sysmsg '>>> SKINNING CORPSES NEARBY' action_msg_color
                    endif

                    wait action_delay

                    if findbuff 'Forensic Eval Bonus'
                        if verbose_mode == 1
                            sysmsg '+++ FORENSIC EVAL BONUS' buff_msg_color
                        endif

                        if use_script_overhead_messages == 1
                            overhead '+ FORENSIC BUFF +' buff_msg_color
                        endif
                    endif

                endif
            endif
        endif
    endif

    # AUTO CURE POISON
    if auto_cure_poison == 1 and poisoned
        # if diffhits is too high, better guarantee and use a gheal pot
        if findtype 'orange potion' backpack as pot
            if verbose_mode == 1
                sysmsg '>>> CURE POTION! ' action_msg_color
            endif

            useobject pot
        else
            if verbose_mode == 1
                sysmsg '>>> ARCH CURING!' spell_msg_color
            endif

            cast 'arch cure'

            @settimer 'waiting_spell_timer' 0
            while not targetexists 'beneficial' and not insysmsg 'disturbed' and not insysmsg 'cannot cast a spell' and timer 'waiting_target_timer' < 4000
                wft 10
                if insysmsg 'disturbed' or insysmsg 'spell will not adhere'
                    if verbose_mode == 1
                        sysmsg 'BREAKING WHILE WAITING FOR ARCH CURE TARGET' warning_msg_color
                    endif

                    wait spell_recovery_delay
                    break
                endif
            endwhile

            if targetexists 'neutral'
                hotkey 'Target Self'
                wait spell_recovery_delay
            endif
        endif
    endif


    # KEEP CHAR HITS UP
    if auto_heal == 1 and diffhits > 0
        # if diffhits is too high, better guarantee and use a gheal pot
        if diffhits >= max_diffhits_before_heal_pot
            if findtype 'yellow potion' backpack as pot
                if verbose_mode == 1
                    sysmsg '>>> LOW HP! USING HEAL POTION.. ' action_msg_color
                endif

                if use_script_overhead_messages == 1
                    overhead '*using heal potion*' action_msg_color
                endif

                useobject pot
                wait action_delay
            endif
        endif

        if diffhits >= max_diffhits_before_greater_heal
            if verbose_mode == 1
                sysmsg '>>> GREATER HEALING...' 76
            endif

            hotkey 'Clear Target Queue'
            cast 'greater heal'

            @settimer 'waiting_target_timer' 0
            while not targetexists 'beneficial' and not insysmsg 'disturbed' and not insysmsg 'cannot cast a spell' and timer 'waiting_target_timer' < 4000
                wft 10
                if insysmsg 'disturbed' or insysmsg 'spell will not adhere' or insysmsg 'cannot cast a spell'
                    sysmsg 'BREAKING WHILE WAITING FOR GREATER HEAL TARGET' warning_msg_color
                    wait spell_recovery_delay
                    break
                endif
            endwhile

            if targetexists 'beneficial' and hits < maxhits
                hotkey 'Target Self'
                wait spell_recovery_delay

                if debug == 1
                    sysmsg 'RESETING LAST AFTER GHEAL' debug_sysmsg_color
                endif
                hotkey 'Set Last Target (Harmful)'
                wft action_delay
                target last_target_serial
            endif
        elseif diffhits >= max_diffhits_before_healing
            sysmsg '>>> MINI HEALING...' 78
            hotkey 'Clear Target Queue'
            cast 'heal'

            @settimer 'waiting_target_timer' 0
            while not targetexists 'beneficial' and not insysmsg 'disturbed' and not insysmsg 'cannot cast a spell' and timer 'waiting_target_timer' < 1500
                wft 10
                if insysmsg 'disturbed' or insysmsg 'spell will not adhere' or insysmsg 'cannot cast a spell'
                    sysmsg 'BREAKING WHILE WAITING FOR HEAL TARGET' warning_msg_color
                    wait spell_recovery_delay
                    break
                endif
            endwhile

            if targetexists 'beneficial' and hits < maxhits
                hotkey 'Target Self'
                wait spell_recovery_delay

                if debug == 1
                    sysmsg 'RESETING LAST AFTER MINI HEAL' debug_sysmsg_color
                endif

                hotkey 'Set Last Target (Harmful)'
                wft action_delay
                target last_target_serial
            endif
        endif
    endif

    # keep mushrooms stock in backpack
    # if not dead lasttarget
    setvar! create_mushrooms_now 0
    if dead lasttarget or not dead lasttarget and counttype 'mushroom' < mushroom_limit_before_creating_more
        setvar! create_mushrooms_now 1
    endif

    if create_mushrooms_now == 1
        if verbose_mode == 1
            sysmsg '>>> CREATING MUSHROOMS' action_msg_color
        endif

        if use_script_overhead_messages == 1
            overhead '*creating mushrooms*' action_msg_color
        endif

        while counttype 'mushroom' < mushroom_stock_size
            # if we loose hits while creating mushrooms, a new target might have been got and we need to break to heal
            if diffhits > max_diffhits_before_healing
                if verbose_mode == 1
                    sysmsg 'BREAKING WHILE CREATING MUSHROOMS TO HEAL!' warning_msg_color
                endif
                break
            endif

            # if now we have a live target and already have the min mushroom limit, break to attack
            if not dead lasttarget and counttype 'mushroom' < mushroom_limit_before_creating_more
                if verbose_mode == 1
                    sysmsg 'BREAKING WHILE CREATING MUSHROOMS TO ATTACK LAST TARGET!' warning_msg_color
                endif
                break
            endif


            cast 'create food'
            wait action_delay
        endwhile
    endif

    # eat mushroom on its timer
    if mana < mana_limit_to_eat_mushroom and timer 'use_mushroom_timer' >= use_mushroom_delay
        if findtype 'mushroom' backpack as mush
            useobject mush
            wait action_delay

            if insysmsg 'you consume'
                sysmsg '+++ RESETING MUSHROOM TIMER...' reset_timer_msg_color
                settimer 'use_mushroom_timer' 0
            endif
        else
            sysmsg "!!! NO MUSHROOM!" warning_msg_color
        endif
    endif

    # meditate when needed
    if diffhits < max_diffhits_before_meditating
        if auto_meditate == 1 and mana < mana_limit_to_medit and not findbuff 'actively meditating'
            # TESTING: removing toggle peace so pets wont stop attacking and come close to char
            # hotkey 'Toggle Peace Only'
            skill 'meditation'
            waitforsysmsg 'You start meditating' 200
    
            if findbuff 'actively meditating'
                if use_script_overhead_messages == 1
                    overhead 'meditating' 56
                endif
                while findbuff 'actively meditating' and diffhits < max_diffhits_before_meditating and mana < min_mana_to_attack
                    if mana < mana_limit_to_eat_mushroom and timer 'use_mushroom_timer' >= use_mushroom_delay
                        if findtype 'mushroom' backpack as mush
                            useobject mush
                            if insysmsg 'you consume'
                                sysmsg '>>> RESETTING MUSHROOM TIMER...' reset_timer_msg_color
                                settimer 'use_mushroom_timer' 0
                            endif
                        else
                            sysmsg ">>> NO MUSHROOM!" warning_msg_color
                        endif
                    endif
                    if timer 'medit_msg_timer' >= 2000
                        sysmsg '>>> MEDITATING...'
                        if use_script_overhead_messages == 1
                            overhead 'meditating...'
                        endif
                        settimer 'medit_msg_timer' 0
                    endif
                endwhile
            endif
        endif
    endif


    # SKIN CORPSES/FORENSIC
    if followers >= summon_max_limit and diffhits < max_diffhits_before_healing
        if offensive_mode == 1 and dead lasttarget or offensive_mode == 0
            if auto_skin_corpses == 1 and skill 'forensic' > 0 and not findbuff 'Actively Meditating'
                # trying this: only skin if there isnt a active target to attack
                if dead 'last' or not find 'last' ground any any 20
                    if findtype corpse ground any any 2 as body
                        if not inlist 'skinned_corpses' body
                            if not findtype 'elven spellblade' backpack
                                if verbose_mode == 1
                                    sysmsg 'NO SKINNING KNIFE!!!' alert_msg_color
                                endif
                            endif

                            if findtype 'elven spellblade' backpack as knife
                                useobject knife
                                wft action_delay
                                if targetexists 'neutral'
                                    hotkey 'Target Self'

                                    if use_script_overhead_messages == 1
                                        overhead '*skinning corpses*' action_msg_color
                                    endif

                                    if verbose_mode == 1
                                        sysmsg '>>> SKINNING CORPSES NEARBY' action_msg_color
                                    endif

                                    @pushlist 'skinned_corpses' body
                                    wait action_delay
                                endif
        
        
        
                                if insysmsg 'dont see anything'
                                    if use_script_overhead_messages == 1
                                        overhead '*NOTHING TO CARVE*' 41
                                    endif

                                    @ignore body
                                elseif insysmsg 'carve materials'
                                    if use_script_overhead_messages == 1
                                        overhead '*carved materials!*' success_msg_color
                                    endif

                                    # switched ignore to list control cause spirit speak will ignore corpses and then razor wont skin it anymore since it would be globally ignored
                                    # @ignore body
                                    @pushlist 'skinned_corpses' body
                                elseif insysmsg 'must wait'
                                    if verbose_mode == 1
                                        sysmsg '>>> SKILL COOLDOWN (FORENSIC)' on_cooldown_msg_color
                                    endif

                                    if use_script_overhead_messages == 1
                                        overhead ':: FORENSIC COOLDOWN ::' on_cooldown_msg_color
                                    endif
                                    wait action_delay
                                endif
                            endif
                        endif
                    endif
                endif
            endif
        else
            if verbose_mode == 1
                sysmsg '[OFFENSIVE MODE] SKIPPING SKINNING...' warning_msg_color
            endif
        endif
    endif


    # INCOGNITO
    if followers >= summon_max_limit and diffhits < max_diffhits_before_buffing
        if offensive_mode == 1 and dead lasttarget or offensive_mode == 0
            if auto_incognito == 1 and not findbuff 'incognito'
                if verbose_mode == 1
                    sysmsg '>>> INCOGNITO' spell_msg_color
                endif

                cast 'incognito'
    
                @settimer 'waiting_spell_timer' 0
                while not findbuff 'incognito' and timer 'waiting_spell_timer' < 3000
                    wait 10
                    if insysmsg 'disturbed' or insysmsg 'spell will not adhere' or insysmsg 'cannot cast a spell'
                        if verbose_mode == 1
                            sysmsg 'BREAKING WHILE WAITING FOR INCOGNITO' warning_msg_color
                        endif

                        wait spell_recovery_delay
                        break
                    endif
                endwhile

                wait spell_recovery_delay
    
                if findbuff 'incognito'
                    if use_script_overhead_messages == 1
                        overhead '+INCOGNITO' buff_msg_color
                    endif
                endif
            endif
        else
            if verbose_mode == 1
                sysmsg '[OFFENSIVE MODE] SKIPPING MAGIC REFLECTION...' warning_msg_color
            endif
        endif
    endif

    if debug == 1
        # sysmsg '[DEBUG] AFTER AUTO-BUFFS' debug_sysmsg_color
    endif


    # monitor sysmsgs to know when we can reset time spell timers
    if insysmsg 'You may now cast a wizardry harm'
        if verbose_mode == 1
            sysmsg '+++ RESETING HARM TIMER...' reset_timer_msg_color
        endif

        settimer 'harm_timer' 0
    endif
    if insysmsg 'You may now cast a wizardry magic arrow'
        if verbose_mode == 1
            sysmsg '+++ RESETING MAGIC ARROW TIMER. NEXT IN {{ma_delay}}...' reset_timer_msg_color
        endif

        settimer 'magic arrow_timer' 0
    endif
    if insysmsg 'You may now cast a wizardry fireball'
        if verbose_mode == 1
            sysmsg '+++ RESETING FIREBALL TIMER...' reset_timer_msg_color
        endif

        settimer 'fireball_timer' 0
    endif
    if insysmsg 'You may now cast a wizardry lightning'
        if verbose_mode == 1
            sysmsg '+++ RESETING LIGHTNING TIMER. NEXT IN {{lightning_delay}}...' reset_timer_msg_color
        endif

        settimer 'lightning_timer' 0
    endif

    if auto_escape_pks == 1
        hotkey 'Next Murderer Player Target'
        wait action_delay
        if not dead lasttarget
            if noto lasttarget  == murderer
            # if findtype 400 ground any any 20 as player
                if verbose_mode == 1
                    sysmsg '!!!!!!! FOUND PK! RUN!!!!!!!' alert_msg_color
                    sysmsg '!!!!!!! FOUND PK! RUN!!!!!!!' alert_msg_color
                    sysmsg '!!!!!!! FOUND PK! RUN!!!!!!!' alert_msg_color
                    sysmsg '!!!!!!! FOUND PK! RUN!!!!!!!' alert_msg_color
                endif
    
                # say 'time to go...'
                # cast 'recall'
                # wft 3500
                # target escape_runetome
                # wait 2000
                # sysmsg '>>> STOPPING MACRO'
                # stop
            endif
        endif

        if insysmsg 'Attacking you'
            if verbose_mode == 1
                sysmsg '>>> BEING ATTACKED! TRYING TO ESCAPE...' alert_msg_color
                sysmsg '>>> BEING ATTACKED! TRYING TO ESCAPE...' alert_msg_color
                sysmsg '>>> BEING ATTACKED! TRYING TO ESCAPE...' alert_msg_color
                sysmsg '>>> BEING ATTACKED! TRYING TO ESCAPE...' alert_msg_color
            endif
            # say 'time to go...'
            # cast 'recall'
            # wft 3500
            # target escape_runetome
            # wait 2000
            # sysmsg '>>> STOPPING MACRO'
            # stop
        endif
    endif

    # if debug == 1
        # sysmsg '[DEBUG] AFTER ESCAPE PK' debug_sysmsg_color
    # endif

    #####################################
    # MOVE ITEMS TO PACKIE MAIN ROUTINE
    #####################################

    if followers >= summon_max_limit and diffhits < max_diffhits_before_healing
        if auto_unload_items_in_pack_animal == 1 or auto_unload_reagents_in_pack_animal == 1
            if diffweight <= 15 or weight >= maxweight


                    if varexist pack_animal and find pack_animal 'ground' 0 any 7
                        unsetvar! found_item_to_unload
                        # make one more search with range reduced to 2 to see if we need to call the llama close
                        while not find pack_animal 'ground' 0 1 2
                            wait 10

                            if timer 'call_packie_closer_timer' >= 1000
                                settimer 'call_packie_closer_timer' 0
                                overhead "calling packie closer!" 40 'self'
                                overhead "too far to unload!" 40 pack_animal

                                # say 'all follow me'
                                menu pack_animal 5
                            endif
                        endwhile


                        dclick pack_animal
                        wait action_delay

                        if verbose_mode == 1
                            sysmsg 'SEARCHING ITEMS TO UNLOAD...' 56
                        endif

                        foreach item_graphic in 'items_to_move_to_llama'
                            if findtype item_graphic backpack as item
                                # set the variable so we know we found something in the end of the script
                                # if this var is not set, we warn the player there was nothing to move
                                if not varexist found_item_to_unload
                                    setvar! found_item_to_unload true
                                endif

                                sysmsg ">  Unloading Items In Pack Animal..." 56 'self'
                                sysmsg item_graphic 56

                                # overhead "*unloading char*" 56 'self'
                                # overhead "*unloading items*" 56 pack_animal
                                while findtype item_graphic backpack as item
                                    getlabel item item_label
                                    overhead "unloading {{item_label}}" 56 pack_animal
                                    lift item 60000
                                    wait action_delay
                                    drop pack_animal -1 -1 0
                                    wait action_delay
                                endwhile
                            endif
                        endfor

                        if move_reagents == 1
                            sysmsg 'SEARCHING REAGENTS TO UNLOAD...' 56
                            foreach reagent_graphic in 'reagents'

                                # set an initial amount of regs to leave on char
                                setvar! min_amount_to_leave_on_char 100
                                if counttype reagent_graphic backpack > min_amount_to_leave_on_char
                                    # set the variable so we know we found something in the end of the script
                                    # if this var is not set, we warn the player there was nothing to move
                                    sysmsg ">  Unloading {{reagent_graphic}} In Pack Animal..." 56 'self'
                                    # overhead "*unloading reagents*" 56 'self'
                                    while counttype reagent_graphic > min_amount_to_leave_on_char

                                        # set the variable so we know we found something in the end of the script
                                        # if this var is not set, we warn the player there was nothing to move
                                        setvar! found_item_to_unload true

                                        # decide how many regs to move based on current amount
                                        unsetvar! amount_of_regs_to_move
                                        if counttype reagent_graphic backpack >= 600
                                            setvar! amount_of_regs_to_move 500
                                        elseif counttype reagent_graphic backpack >= 500
                                            setvar! amount_of_regs_to_move 400
                                        elseif counttype reagent_graphic backpack >= 400
                                            setvar! amount_of_regs_to_move 300
                                        elseif counttype reagent_graphic backpack >= 300
                                            setvar! amount_of_regs_to_move 200
                                        elseif counttype reagent_graphic backpack >= 200
                                            setvar! amount_of_regs_to_move 100
                                        elseif counttype reagent_graphic backpack >= 200
                                            setvar! amount_of_regs_to_move 100
                                        elseif counttype reagent_graphic backpack > min_amount_to_leave_on_char
                                            setvar! amount_of_regs_to_move 40
                                        endif

                                        # get packie closer if it gets too far to unload (more than 2 tiles away)
                                        if not find pack_animal ground any any 2
                                            while not find pack_animal ground any any 2
                                                if timer 'call_packie_closer_timer' >= 1000
                                                    settimer 'call_packie_closer_timer' 0
                                                    overhead "calling packie closer!" 40 'self'
                                                    overhead "too far to unload!" 40 pack_animal

                                                    # say 'all follow me'
                                                    menu pack_animal 5
                                                endif
                                                wait 10
                                            endwhile
                                            # break
                                        endif

                                        overhead 'unloading {{amount_of_regs_to_move}} {{reagent_graphic}}' 53 pack_animal

                                        lifttype reagent_graphic amount_of_regs_to_move backpack
                                        wait action_delay
                                        drop pack_animal -1 -1 0
                                        wait action_delay

                                    endwhile
                                endif
                            endfor
                        endif

                        if not varexist found_item_to_unload
                            overhead '*no items to unload*' 41
                            sysmsg '> No Items To Unload To Packie' 41
                            stop
                        endif

                    else
                        sysmsg "!!!!!! CHAR HEAVY AND NO PACKIES NEARBY" alert_msg_color
                        if use_script_overhead_messages == 1
                            overhead "CHAR HEAVY AND NO PACKIES"
                        endif
                        if str < 120 and findtype 'white potion' backpack
                            sysmsg 'HEAVY! DRINKING STR POT TO INCREASE MAX WEIGHT.' alert_msg_color
                            hotkey 'Drink Strength'
                            wait action_delay
                        endif
                    endif
                endif
            endif
        endif
    endif


    #####################################
    # KEEP REGS STACKED INSIDE CHAR SATCHEL
    #####################################

    if followers >= summon_max_limit and diffhits < max_diffhits_before_healing
        if offensive_mode == 1 and dead lasttarget or offensive_mode == 0
            if auto_move_regs_to_satchel == 1

                # CHAR WIZARDS SATCHEL
                if not varexist char_reg_bag or not find char_reg_bag backpack and not find char_reg_bag self
                    if findtype 'reagent satchel' as satchel
                        setvar! char_reg_bag satchel
                        if verbose_mode == 1
                            sysmsg 'FOUND AND SAVED CHAR REG SATCHEL' script_msg_color
                        endif

                        dclick char_reg_bag
                    endif
                endif

                while findtype "Blood Moss|Black Pearl%s%|Garlic|Mandrake Root%s%|Ginseng|Nightshade|Sulfurous Ash|Spider's Silk" backpack as reg
                # while findtype "Blood Moss|Black Pearl%s%" backpack as reg
                    if not find reg char_reg_bag
                        # temporarily set the razor grab hotbag to char_loot_pouch if it exists so instrument gets retrieved into it
                        # if varexist char_reg_bag
                        #     sysmsg 'SETTING RAZOR GRAB HOTBAG TO CHAR LOOT POUCH...' warning_msg_color
                        #     hotkey "Set Grab Item HotBag"
                        #     wft action_delay
                        #     target char_reg_bag
                        #     wft action_delay
                        # endif


                        getlabel reg reg_label
                        while find reg backpack and not find reg char_reg_bag
                            if verbose_mode  == 1
                                sysmsg '>>> MOVING {{reg_label}} TO SATCHEL.' action_msg_color
                            endif

                            # hotkey 'Grab Item'
                            lift reg 999
                            wft action_delay
                            drop char_reg_bag
                            # target reg
                            wait action_delay
                        endwhile

                        if not find reg backpack
                            if verbose_mode  == 1
                                sysmsg 'MOVED {{reg_label}}!' success_msg_color
                            endif

                            # # reset razor grab hotbag to char main backpack
                            # sysmsg 'RE-SETTING RAZOR GRAB HOTBAG TO CHAR BACKPACK...' warning_msg_color
                            # hotkey "Set Grab Item HotBag"
                            # wft action_delay
                            # target backpack
                        endif

                    endif
                    @ignore reg
                endwhile
                @clearignore
            endif

        else
            if verbose_mode == 1
                sysmsg '[OFFENSIVE MODE] SKIPPING ORGANIZE REGS...' warning_msg_color
            endif
        endif
    endif

    # if debug == 1
        # sysmsg '[DEBUG] AFTER PACKIES UNLOADING' debug_sysmsg_color
    # endif

    #####################################
    # KEEP MOBS GUARDING PLAYER
    #####################################

    # TESTING also checking if dead so it doenst all guard before the 2 all follows for luring current lasttarget
    # if auto_all_guard == 1 and timer 'all_guard_timer' >= all_guard_delay
    if auto_all_guard == 1 and timer 'all_guard_timer' >= all_guard_delay
        if lure_mobs_closer_before_killing == 1 and not dead lasttarget
            if verbose_mode == 1
                sysmsg 'SKIPPING ALL GUARD IN FAVOR OF LURING' warning_msg_color
            endif
        elseif auto_patrol_when_no_active_lasttarget == 1 and dead lasttarget
            if verbose_mode == 1
                sysmsg 'SKIPPING ALL GUARD IN FAVOR OF PATROL' warning_msg_color
            endif
        else
            say 'all guard me'
            settimer 'all_guard_timer' 0
        endif
    endif


    sysmsg 'BEFORE HIDE ITENS' debug_msg_color
    #############################
    # HIDE ITENS IN CHOOSEN POUCH
    #############################

    if hide_valuables_in_char_loot_pouch == 1 and varexist char_loot_pouch
        # if offensive_mode == 1 and dead lasttarget or offensive_mode == 0
            @clearignore
            unsetvar! found_something_to_hide_in_pouch
    
            ##################################
            # CHAR SHEPS CROOK
    
            # sysmsg "****************************" 90
            # sysmsg "> LOOT POUCH SECURED ITEMS:" 90
    
            # hide char sheps crook is char has one (thiefs love to steal sheps crook)
            if hide_sheps_crook == 1
                if findtype 3713 backpack as crook
    
                    getlabel crook crook_label
                    if find crook char_loot_pouch
                        sysmsg " > {{crook_label}}!" 52
                    endif
    
                    # make sure were not just finding the crook inside the loot_pouch already
                    if not find crook char_loot_pouch
                        # lets assume here crook is with aspect activated so the recycler doenst pull it it
                        if hue crook != 0
                            overhead '*hiding crook in loot pouch!' 63
                            sysmsg '> Hiding {{crook_label}}' 63
                            lift crook 1
                            wait action_delay
                            drop char_loot_pouch -1 -1 0
                            wait action_delay
                            setvar! found_something_to_hide_in_pouch true
                        endif
                    endif
                endif
            endif
    
            ##################################
            # CHAR INSTRUMENT
    
            # check if there is a saved instrument already, and if its still in char's backpack
            if skill 'musicianship' > 0
                if varexist char_instrument
                    if not find char_instrument backpack
                        overhead '! cant find saved instrument !' 39
                        unsetvar! char_instrument
                    endif
                endif
    
    
                # FIND AND SAVE CHAR INSTRUMENT IF NEEDED
                if not varexist char_instrument
                    foreach instrument_type in 'instruments'
                        if findtype instrument_type backpack as instrument
                            getlabel instrument instrument_label
    
                            unsetvar! found_char_instrument
                            foreach magical_instrument_type in 'magical_instruments_types'
                                if magical_instrument_type in instrument_label
                                    setvar! found_something_to_hide_in_pouch true
                                    setvar! found_char_instrument true
                                    setvar! char_instrument instrument
                                    break
                                endif
                            endfor
                        endif
    
                        if varexist found_char_instrument
                            break
                        endif
                    endfor
                endif
    
                if varexist char_instrument
                    getlabel char_instrument instrument_label
    
                    if find char_instrument char_loot_pouch
                        # sysmsg " > {{instrument_label}} Secured In Pouch!" 52
                        @ignore char_instrument
                    endif
    
                    while find char_instrument backpack and not find char_instrument char_loot_pouch
    
                        # razor will always find the item in backpack, even if its already on loot pouch
                        # so we make sure we dont try to move it again if its already in the pouch
                        # overhead 'hiding {{instrument_label}} in trap pouch' 51 'self'
                        overhead '*hiding instrument*' 91 'self'
                        sysmsg '> Hiding {{instrument_label}}' 91
    
                        setvar! found_something_to_hide_in_pouch true
    
                        lift char_instrument 9999
                        wait action_delay
                        drop char_loot_pouch -1 -1 0
                        wait action_delay
    
                    endwhile
                endif
            endif
    
    
#             ##################################
#             # HIDE GENERAL LOOT ITEMS
#             foreach item in 'loot_items'
#                 sysmsg 'DEBUG FOR LOOP AQUI: {{item}} {{index}}'
#                 while findtype item backpack any any as item_to_unload
#                     sysmsg 'DEBUG WHILE LOOP AQUI'
# 
#                     getlabel item_to_unload item_label
# 
#                     if 'blessed' in item_label
#                         sysmsg '!!!! IGNORING BLESSED {{item_label}} ON MOVE ITEMS' alert_msg_color
#                         continue
#                     endif
#                         # @ignore item_to_unload
#                         # if find item_to_unload char_loot_pouch
#                             # sysmsg " > {{item_label}} Secured In Pouch!" 54
#                         # endif
#         
#                     if find item_to_unload backpack and not find item_to_unload char_loot_pouch
#                         sysmsg 'SETTING RAZOR GRAB HOTBAG TO CHAR LOOT POUCH...' warning_msg_color
#                         hotkey "Set Grab Item HotBag"
#                         wft action_delay
#                         target char_loot_pouch
# 
#                         while find item_to_unload backpack and not find item_to_unload char_loot_pouch
#         
#                             # razor will always find the item in backpack, even if its already on loot pouch
#                             # so we make sure we dont try to move it again if its already in the pouch
#                             sysmsg 'Hiding {{item_label}}' 54 'self'
#                             overhead 'hiding {{item_label}}' 91 'self'
#         
#                             setvar! found_something_to_hide_in_pouch true
#         
#                             hotkey 'Grab Item'
#                             wft 600
#                             target item_to_unload
#                             wait action_delay
# 
#                             # lift item_to_unload 9999
#                             # wait action_delay
#                             # drop char_loot_pouch -1 -1 0
#                             # wait action_delay
#                         endwhile
# 
#                     endif
#     
#                     # ignore so we dont circle back to this item again
#                     @ignore item_to_unload
# 
# 
#                 endwhile
# 
#                 # sysmsg 'RE-SETTING RAZOR GRAB HOTBAG TO CHAR BACKPACK...' warning_msg_color
#                 # hotkey "Set Grab Item HotBag"
#                 # wft action_delay
#                 # target backpack
#             endfor
    
            # clear all ignored items so we can find them again on next script execution
            @clearignore
    
            # sysmsg "***************************" 90
    
            if varexist found_something_to_hide_in_pouch
                unsetvar! found_something_to_hide_in_pouch
                sysmsg 'Secured All Items Found!' success_msg_color
            # else
            #     overhead 'found nothing to hide in pouch!' 54
            endif
        # else
        #     sysmsg '[OFFENSIVE MODE] SKIPPING SPIRIT SPEAK...' warning_msg_color
        # endif
    endif


    if auto_escape_ground_burning_flames == 1
    # mausoleum forgotten soul flames
        while findtype 28016 ground 2264 any 0
            sysmsg '>>> BURNING FLAME UNDER CHAR!!!!!! MOVING CHAR'

            random 8
            if insysmsg 'Random: 1'
                walk 'south'
                walk 'south'
            elseif insysmsg  'Random: 2'
                walk 'down'
                walk 'down'
            elseif insysmsg  'Random: 3'
                walk 'east'
                walk 'east'
            elseif insysmsg  'Random: 4'
                walk 'right'
                walk 'right'
            elseif insysmsg  'Random: 5'
                walk 'north'
                walk 'north'
            elseif insysmsg  'Random: 6'
                walk 'up'
                walk 'up'
            elseif insysmsg  'Random: 7'
                walk 'west'
                walk 'west'
            elseif insysmsg  'Random: 8'
                walk 'left'
                walk 'left'
            endif
        endwhile
    endif


    # INCOGNITO
    if followers >= summon_max_limit and diffhits < max_diffhits_before_buffing
        if offensive_mode == 1 and dead lasttarget or offensive_mode == 0
            if dead lasttarget and diffhits == 0 and diffmana == 0 and diffstam == 0
                if juggle_mode == 1
                    if timer 'fun_timer' > 120000
                        clearsysmsg
                        random 3
                        if insysmsg 'Random: 1'
                            if findtype 'juggling torches' backpack
                                dclicktype 'juggling torches' backpack
                                wait action_delay
                            endif
                        elseif insysmsg  'Random: 2'
                            if findtype 'juggling bottles' backpack
                                dclicktype 'juggling bottles'
                                wait action_delay
                            endif
                        elseif insysmsg  'Random: 3'
                            if findtype 45285 backpack 2466
                                dclicktype 45285
                                wait action_delay
                            endif
                        endif

                        settimer 'fun_timer' 0
                    endif
                endif
            endif
        endif
    endif



    #########################################
    # BOATING STUFF
    #########################################

    if stack_trace == 1
        sysmsg 'BEFORE BOATING ROUTINE' debug_msg_color
    endif

    # save my boats hatch so i can tell it apart from enemy ships to detect enemy ships on screen
    if boating_mode == 1

        # if we are boating, first thing before any other we need to check if theres an enemy ship on screen
        # FIND NEARBY ENEMY BOATS AND SAVE ITS HATCH TO VARIABLE
        setvar! enemy_boat_present 0
        if varexist target_boat_status_bar
            if target_boat_status_bar != my_boat_status_bar and find target_boat_status_bar ground any any find_enemy_boats_max_range
                sysmsg 'ENEMY BOAT SAVED FOUND AND PRESENT IN SCREEN: {{target_boat_status_bar}}!' boating_msg_color
                setvar! enemy_boat_present 1
            else
                sysmsg 'ENEMY BOAT SAVED CANT BE FOUND IN SCREEN. UNSETING!' boating_msg_color
                unsetvar target_boat_status_bar
            endif
        endif

        # if saved boat hatch is not found, we need to search for another
        if enemy_boat_present == 0
            sysmsg 'SEARCHING FOR NEW ENEMY BOATS' boating_msg_color
            overhead '*searching enemy boats*' boating_msg_color


            # foreach sail_type in 'ships_sails_types'
            if debug == 1
                sysmsg 'SEARCHING STATUS BARS' boating_msg_color
            endif

            if stack_trace == 1
                sysmsg 'ITERATING SHIP SAILS TYPES'
            endif
            createlist 'status_bars'
            clearlist 'status_bars'

            if findtypelist 'status_bars' 'status bar' ground HULL_STATUS_BAR_COLOR any 12
            endif
        
            if list status_bars > 0
                foreach bar in 'status_bars'
    
                    if findtype 'status bar' ground HULL_STATUS_BAR_COLOR any find_enemy_boats_max_range as found
                        sysmsg 'FOUND STATUS BAR : {{found}} COMPARING TO {{my_boat_status_bar}} ' boating_msg_color
        
                        if found != my_boat_status_bar
                            sysmsg 'FOUND SAIL {{found}} AND SAVING AS ENEMY BOAT SAIL' success_msg_color
                            setvar! target_boat_status_bar found
                            setvar! enemy_boat_present 1
                            break
                        endif
                    endif
                endfor
            endif

        endif
    

        # search ships on spyglass if no enemy boats present in screen
        if enemy_boat_present == 0 and not gumpexists search_ships_gump_id
            if timer 'search_ships_timer' >= search_ships_delay
                sysmsg 'SEARCHING SHIPS WITH SPYGLASS' boating_msg_color
                if findtype 'spyglass' backpack as tool
                    dclick tool
                    waitfortarget 600
                    if targetexists 'neutral'
                        overhead '*opening searching ships*' boating_msg_color
                        sysmsg 'OPENING SEARCH SHIPS GUMP' boating_msg_color
                        hotkey 'Target Self'
                        waitforgump 2890020940 action_delay
                        # if gumpexists 2890020940
                            # sysmsg 'Searching Ships...' 89
                            # overhead 'searching ships...' 89
                            # gumpresponse 4
                            # waitforgump 2890020940 600
                        # endif
                    endif
                endif
            endif
        endif

        # auto dock boat when find a known dockmaster nearby
        if auto_dock_when_close_to_dockmaster == 1
            foreach dockmaster in 'dockmasters_serials'
                if find dockmaster ground any any 8
                    sysmsg '>> FOUND DOCKMASTER!' success_msg_color
                    menu dockmaster 0
                    waitforgump dockmaster_gump_id action_delay
    
                    if gumpexists dockmaster_gump_id
                        sysmsg '>>> DOCKING SHIP!' warning_msg_color
                    endif
                endif
            endfor
        endif
    
          #try to find tillerman
        if not varexist tillerman or varexist tillerman and not find tillerman ground any any 15
            foreach tillerman in tillermen_list
                if findtype tillerMenVar ground as found
                    sysmsg 'TILLERMAN SET!' success_msg_color
                    overhead "Tillerman Set"
                    setvar tillerman found
                    dclick tillerman
                    wait 500
                endif
            endfor
        endif
    
        #Check if we are on NPC ship AGAIN
        #
        if boating_mode == 1 and auto_board_enemy_ships == 1
            if not gumpexists boarding_gump_id
                if findtype 'rope' backpack 0 as rop
                    useobject rop
                    waitforgump boarding_gump_id action_delay
                else
                    overhead 'no boarding rope!'
                    stop
                endif
            endif
    
            if gumpexists boarding_gump_id
                gumpresponse 5 boarding_gump_id
                wft action_delay
    
                if targetexists 'neutral'
                    overhead 'board which ship?' 64
                    while targetexists  'neutral'
                        wait 100
                    endwhile
                endif
            endif
        endif
    
        if insysmsg "You board the ship"
            @setvar is_boarded 1
            settimer 'boarded_timer' 0
            @setvar stopWalking 0
            if sayLess = 0
                wait 500
                overhead "***Lets Gooooo! (Lets Gooooo!) / If you want it you can get it let me know (let me know)**" 44
            endif
        endif
    
    
        #check for bombs nearby and defuses them
        if boating_mode == 1 and auto_defuse_bombs = 1
            if findtype '5188' ground -1 -1 2
                sysmsg 'DEFUSING BOMB!' action_msg_color
                dclicktype SHIP_BOMB
                say "[embark"
                wait 600
                say "[embarkfollowers"
                wait 600
                setvar! is_boarded 1
            endif
    
            if findtype '5188' ground
                sysmsg 'DEFUSING BOMB!' action_msg_color
                dclicktype SHIP_BOMB
                say "[embark"
                wait 600
                say "[embarkfollowers"
                wait 600
    
                setvar! is_boarded 1
            endif
        endif
    
        if boating_mode == 1 and auto_repair_ship == 1
            if timer 'repair_ship_timer' > repair_boat_parts_delay
                sysmsg 'REPAIRING SHIP HULL' action_msg_color
                say '[RepairHull'
                wait action_delay
    
                if insysmsg 'hull does not need'
                    if verbose_mode == 1
                        # sysmsg 'HULL DONT NEED REPAIRING!' warning_msg_color
                    endif
                else
                    if verbose_mode == 1
                        sysmsg 'REPAIRED HULLS! NEXT IN {{repair_boat_parts_delay}}ms' reset_timer_msg_color
                    endif
                    settimer 'repair_ship_timer' 0
                endif
            endif

            # if timer 'repair_ship_sails_timer' > repair_boat_parts_delay
            if timer 'repair_ship_timer' > repair_boat_parts_delay
                if verbose_mode == 1
                    sysmsg 'REPAIRING SHIP SAILS' action_msg_color
                endif

                say '[RepairSails'
                wait action_delay
    
                if insysmsg 'sails do not need'
                    # sysmsg 'SAILS DONT NEED REPAIRING!' warning_msg_color
                else
                    sysmsg 'REPAIRED SAILS! NEXT IN {{repair_boat_parts_delay}}ms' reset_timer_msg_color
                    settimer 'repair_ship_timer' 0
                endif
            endif

            # if timer 'repair_ship_guns_timer' > repair_boat_parts_delay
            if timer 'repair_ship_timer' > repair_boat_parts_delay
                sysmsg 'REPAIRING SHIP GUNS' action_msg_color
                say '[RepairGuns'
                wait action_delay
    
                if insysmsg "guns do not need"
                    # sysmsg 'GUNS DONT NEED REPAIRING!' warning_msg_color
                else
                    sysmsg 'REPAIRED GUNS! NEXT IN {{repair_boat_parts_delay}}ms' reset_timer_msg_color
                    settimer 'repair_ship_timer' 0
                endif
            endif
        endif
    
    

    # closes if boating_mode == 1
    endif


    #########################################
    # MAIN ATTACK ROUTINE
    #########################################

    # make sure char has high hp and mana for FS before attacking

    if followers >= summon_max_limit and diffhits < max_diffhits_before_healing
        # if auto_attack_targets == 1 and diffhits < max_diffhits_before_healing and mana >= min_mana_to_attack
        if auto_attack_targets == 1
            # if targetr queue is active, we need to clear it here or else the script cant detect the first target opened (for mana drain) cause its queued
            # make sure char is always max summon before attacking
            # if not dead 'last' and followers >= summon_max_limit and find 'last' ground any any find_last_target_max_range as last_target_serial_found
            while not dead lasttarget or enemy_boat_present == 1

                #----------------------------------------
                # BOAT ATTACK ROUTINE
                if boating_mode == 1 and enemy_boat_present == 1
                    if not find target_boat_status_bar ground any any 2
                       sysmsg 'CANT FIND SAVED ENEMY BOAT INSIDE ATTACK ROUTINE' alert_msg_color
                    endif

                    # reload cannons
                    if auto_reload_cannons == 1 and timer 'reload_cannons_timer' >= reload_cannons_delay
                        foreach cannon in 'my_boat_cannons'
                            getlabel cannon cannon_label
            
                            if '4/10' in cannon_label or '3/10' in cannon_label or '2/10' in cannon_label or '1/10' in cannon_label
                                sysmsg 'RELOADING CANNONS'
                                say '[reloadcannons'
                                wait action_delay
                
                                if not insysmsg 'No cannons require reloading at the moment'
                                    sysmsg 'REALODING CANNONS AND RESETING RELOAD TIMER' reset_timer_msg_color
                                    settimer 'reload_cannons_timer' 0
                                endif
                            endif
            
                        endfor
                    endif

                    # fire cannons
                    if auto_fire_cannons == 1 and timer 'fire_cannons_timer' >= fire_cannons_delay
                        if varexist target_boat_status_bar and find target_boat_status_bar ground any any find_enemy_boats_max_range
                
                            sysmsg 'FIRING CANNONS!' warning_msg_color
                            say '[firecannons'
                            wft action_delay
                    
                    
                            if targetexists 'any'
                                sysmsg 'TARGETING ENEMY CANNON {{target_boat_status_bar}}' action_msg_color
                                target target_boat_status_bar
                                wait action_delay
                                if not insysmsg 'You may not fire onto your own ship' and not insysmsg 'Your cannons cannot reach that location'
                                    sysmsg 'CANNONS FIRED! RESETING FIRE CANNONS TIMER' reset_timer_msg_color
                                    settimer 'fire_cannons_timer' 0
                                endif
                            endif
                        endif
                    endif
                endif


                #----------------------------------------
                # ENEMY/MONSTER ATTACK ROUTINE
                if not dead last target
                    if followers < summon_max_limit
                        if verbose_mode == 1
                            sysmsg 'BREAKING ATTACK LOOP TO SUMMON' alert_msg_color
                        endif
                        break
                    endif
    
                    if diffhits > max_diffhits_before_healing
                        if verbose_mode == 1
                            sysmsg 'BREAKING ATTACK LOOP TO HEAL' alert_msg_color
                        endif
                        break
                    endif
    
    
    
                    if mana < min_mana_to_attack
                        if verbose_mode == 1
                            sysmsg 'BREAKING ATTACK LOOP TO MEDITATE' alert_msg_color
                        endif
                        break
    
                    endif
    
                    if findtype '0x54A4' ground any any 4 as eldrich_proc
                        getlabel eldrich_proc proc_label
                        overhead '*using eldrich mana well*' success_msg_color
                        sysmsg 'Using ElDRICH MANA WELL: {{proc_label}}' success_msg_color
                        cooldown 'Proc' 5000
                    endif
    
    
                    hotkey 'Clear Target Queue'
    
                    if debug == 1
                        sysmsg '>>> FOUND ALIVE LAST && MAX SUMMONS' debug_sysmsg_color
                    endif
    
                    # save current target to compare with last saved last_target_serial to see if we have a new mob or just a old mob that went off screen of hid itself
                    if find 'last' ground any any find_last_target_max_range as serial
                        setvar! current_target_serial serial
                    else
                        if verbose_mode == 1
                            sysmsg '!!!!!! BREAKING ATTACK LOOP BECAUSE CANT FIND LASTTARGET' alert_msg_color
                            hotkey '> Interrupt'
                        endif
    
                        break
                    endif
    
                    if noto 'last' == hostile or noto 'last' == murderer or noto 'last' == criminal
                        if debug == 1
                            if noto 'last' == hostile
                                sysmsg 'NOTO LAST HOSTILE!!!' debug_msg_color
                            endif
    
                            sysmsg '>>> FOUND HOSTILE LASTTARGET' debug_sysmsg_color
                        endif
        
                        # # save last target serial on custom var to re-set after healing friendly targets
    
                        if last_target_serial != current_target_serial
                            if verbose_mode == 1
                                sysmsg '+++ RESETING LAST TARGET SERIAL VAR (NEW MOB)' alert_msg_color
                            endif
    
                            unsetvar last_target_serial
                            setvar! last_target_serial current_target_serial
    
                            if verbose_mode == 1
                                sysmsg '+++ RESETING ALL TIMERS!' reset_timer_msg_color
                            endif
    
                            settimer 'mana_drain_timer' mana_drain_delay
                            settimer 'curse_timer' mana_drain_delay
                            settimer 'medit_msg_timer' 6000
                            settimer 'auto_get_new_targets_timer' 1000
                            settimer 'all_guard_timer' all_guard_delay
                            settimer 'all_patrol_timer' all_patrol_delay
                        elseif last_target_serial == current_target_serial
                            if verbose_mode == 1
                                sysmsg '+++ MOB IS SAME AS LAST TARGET FOUND' alert_msg_color
                            endif
                        endif
        
                        # use crook on last target
                        if auto_herd_mobs == 1
                            if not dead 'last' and find 'last' ground any any find_last_target_max_range and noto 'last' == hostile or noto 'last' == murderer or noto 'last' == criminal
                                if varexist last_target_serial
                                    if not inlist 'herdened_mobs' last_target_serial
                                        if skill 'herding' > 20
                                            if findtype 3713 as crook
                                                while not targetexists 'harmful'
                                                    useobject crook
                                                    wft action_delay
                                                endwhile
                
                                                if targetexists 'harmful'
                                                    if verbose_mode == 1
                                                        sysmsg 'USING CROOK' actions_msg_color
                                                    endif
                                                    hotkey 'Last Target'
                                                    wait action_delay
    
                                                    if insysmsg 'You focus your follower'
                                                        if use_script_overhead_messages == 1
                                                            overhead 'focused pets agression' actions_msg_color 'last'
                                                        endif
    
                                                        pushlist 'herdened_mobs' last_target_serial
                                                    endif
                                                endif
                
                                                say 'all kill'
                                                wft action_delay
                                                if targetexists 'harmful'
                                                    hotkey "Last Target"
                                                    wait action_delay
                                                endif
                
                                            else
                                                overhead "no sheperd's crook!"
                                            endif
                                        endif
                                    endif
                                endif
                            endif
                        endif
        
        
                        # kill close to loot mob easier
                        if lure_mobs_closer_before_killing == 1 and timer 'lure_mob_closer_timer' > 4000
                            if not find 'last' ground any any lure_mobs_distance_to_lure
                                if verbose_mode == 1
                                    sysmsg '>>> LURING MOB CLOSE TO CHAR' default_sysmsg_color
                                endif
                                # say 'all kill'
                                # wft 600
                                # target 'last'
                                # this wait is just to avoid speech throttle from the server
                                wait 250
    
                                say 'all follow me'
    
                                settimer 'waiting_mob_to_approach_timer' 0
                                while timer 'waiting_mob_to_approach_timer' < 1500
                                    wait 10
                                    if find 'last' ground any any lure_mobs_distance_to_lure
                                        sysmsg 'MOB IS NOW AT {{lure_mobs_distance_to_lure}} TILES' success_msg_color
                                        break
                                    endif
                                endwhile
    
    
                                hotkey 'Toggle Peace Only'
                                settimer 'lure_mob_closer_timer' 0
                                say 'all guard me'
                            else
                                if verbose_mode == 1
                                    sysmsg '>>> MOB IS CLOSE, NO NEED TO LURE' warning_msg_color
                                endif
                            endif
                        endif
        
                        # safe clause to not attack self or friendsa
                        if noto 'last' = friend or noto 'last' = friendly or noto 'last' = innocent
                            sysmsg 'CANCELING FRIENDLY TARGET'
                            target 'clear'
                            hotkey 'Cancel Current Target'
                        endif
        
                        # before each spell and every attack, we first check 2 things:
                        # if the followers number is 4 or more, indicating we have all summons up
                        # and if diffhits is under 10, indicating character is not under threat of dying and doenst need heal
                        # only if all checks pass we start attacking the target
                        if followers >= summon_max_limit and noto 'last' != friend and noto 'last' != friendly
                            if noto 'last' == hostile or noto 'last' == murderer or noto 'last' == criminal
                                attack 'last'
        
                                if auto_all_guard == 1 and timer 'all_guard_timer' >= 5000
                                    say 'all guard me'
                                    settimer 'all_guard_timer' 0
                                endif
        
        
                                # GRIMOIRE SPELLS
    
                                # mana drain
                                if followers >= summon_max_limit and diffhits < max_diffhits_before_healing
                                    if use_mana_drain == 1
                                        if not dead 'last' and find 'last' ground any any find_last_target_max_range
    
                                            if last_target_serial == last_mana_drained_serial and timer 'mana_drain_timer' <= mana_drain_delay
                                                if verbose_mode == 1
                                                    sysmsg '!!! THIS MOB WAS MANA DRAINED {{mana_drain_timer}}ms AGO' warning_msg_color
                                                endif
                                            elseif last_target_serial != last_mana_drained_serial and timer 'mana_drain_timer' >= mana_drain_delay
                                                # overhead '> mana drain <' spell_overhead_color
                                                if verbose_mode == 1
                                                    sysmsg '>>> MANA DRAIN (NEW MOB)' spell_msg_color
                                                endif
                                                cast 'mana drain'
            
                                                @settimer 'waiting_target_timer' 0
                                                @clearsysmsg
                                                while not targetexists 'harmful' and not insysmsg 'disturbed' and not insysmsg 'cannot cast a spell' and timer 'waiting_target_timer' < 3500
                                                    wait 10
    
                                                    if insysmsg 'disturbed' or insysmsg 'cannot cast a spell'
                                                        if verbose_mode == 1
                                                            sysmsg 'BREAKING WHILE WAITING FOR MANA DRAIN TARGET' warning_msg_color
                                                        endif
    
                                                        wait spell_recovery_delay
                                                        break
                                                    endif
                                                endwhile
            
                                                if targetexists 'harmful'
                                                    @clearsysmsg
                                                    hotkey 'Last Target'
                                                    wait spell_recovery_delay
    
                                                    if not insysmsg 'Target cannot be seen'
                                                        if debug == 1
                                                            sysmsg '+++ RESETING MANA DRAIN TIMER' reset_timer_msg_color
                                                        endif
    
                                                        settimer 'mana_drain_timer' 0
                                                        cooldown 'Mana Drained Mob' mana_drain_delay
                                                        setvar! last_mana_drained_serial lasttarget
                                                    endif
                                                endif
                                            endif
                                        endif
                                    endif
                                endif
        
                                # curse
                                if followers >= summon_max_limit and diffhits < max_diffhits_before_healing
                                    if use_curse == 1 and timer 'curse_timer' >= curse_delay
                                        if not dead 'last' and find 'last' ground any any find_last_target_max_range
    
                                            if last_target_serial == last_cursed_serial and timer 'curse_timer' <= curse_delay
                                                if verbose_mode == 1
                                                    sysmsg '!!! THIS MOB WAS CURSED {{curse_timer}}ms AGO' warning_msg_color
                                                endif
                                            elseif last_target_serial != last_cursed_serial and timer 'curse_timer' >= curse_delay
                                                if verbose_mode == 1
                                                    sysmsg '>>> CURSE' spell_msg_color
                                                endif
                                                cast 'curse'
            
                                                @settimer 'waiting_target_timer' 0
                                                clearsysmsg
                                                while not targetexists 'harmful' and not insysmsg 'disturbed' and not insysmsg 'cannot cast a spell' and timer 'waiting_target_timer' < 3500
                                                    wait 10
    
                                                    if insysmsg 'disturbed' or insysmsg 'cannot cast a spell'
                                                        if verbose_mode == 1
                                                            sysmsg 'BREAKING WHILE WAITING FOR CURSE TARGET' warning_msg_color
                                                        endif
    
                                                        wait spell_recovery_delay
                                                        break
                                                    endif
                                                endwhile
            
                                                if targetexists 'harmful'
                                                    clearsysmsg
                                                    hotkey 'Last Target'
                                                    wait spell_recovery_delay
    
                                                    if not insysmsg 'Target cannot be seen'
                                                        if verbose_mode == 1
                                                            sysmsg '+++ RESETING CURSE TIMER' reset_timer_msg_color
                                                        endif
    
                                                        settimer 'curse_timer' 0
                                                        cooldown 'Cursed Mob' curse_delay
                                                        setvar! last_cursed_serial lasttarget
                                                    endif
                                                endif
                                            endif
                                        endif
                                    endif
                                endif
    
                                # mass curse
                                if followers >= summon_max_limit and diffhits < max_diffhits_before_healing
                                    if use_mass_curse == 1 and timer 'mass_curse_timer' >= curse_delay
                                        if not dead 'last' and find 'last' ground any any find_last_target_max_range
    
                                            if last_target_serial == last_cursed_serial and timer 'mass_curse_timer' <= curse_delay
                                                if verbose_mode == 1
                                                    sysmsg '!!! THIS MOB WAS MASS CURSED {{curse_timer}}ms AGO' warning_msg_color
                                                endif
                                            elseif last_target_serial != last_cursed_serial and timer 'mass_curse_timer' >= curse_delay
                                                if verbose_mode == 1
                                                    sysmsg '>>> MASS CURSE' spell_msg_color
                                                endif
                                                cast 'mass curse'
            
                                                @settimer 'waiting_target_timer' 0
                                                clearsysmsg
                                                while not targetexists 'harmful' and not insysmsg 'disturbed' and not insysmsg 'cannot cast a spell' and timer 'waiting_target_timer' < 3500
                                                    wait 10
    
                                                    if insysmsg 'disturbed' or insysmsg 'cannot cast a spell'
                                                        if verbose_mode == 1
                                                            sysmsg 'BREAKING WHILE WAITING FOR CURSE TARGET' warning_msg_color
                                                        endif
    
                                                        wait spell_recovery_delay
                                                        break
                                                    endif
                                                endwhile
            
                                                if targetexists 'harmful'
                                                    clearsysmsg
                                                    hotkey 'Last Target'
                                                    wait spell_recovery_delay
    
                                                    if not insysmsg 'Target cannot be seen'
                                                        if verbose_mode == 1
                                                            sysmsg '+++ RESETING MASS CURSE TIMER' reset_timer_msg_color
                                                        endif
    
                                                        settimer 'mass_curse_timer' 0
                                                        cooldown 'Mass Cursed Mob' curse_delay
                                                        setvar! last_cursed_serial lasttarget
                                                    endif
                                                endif
                                            endif
                                        endif
                                    endif
                                endif
        
                                # energy bolt
                                if followers >= summon_max_limit and diffhits < max_diffhits_before_healing and not dead 'last' and find 'last' ground any any find_last_target_max_range
                                    if use_eb == 1 and timer 'eb_timer' > eb_delay
                                        if verbose_mode == 1
                                            sysmsg '>>> ENERGY BOLT' spell_msg_color
                                        endif
                                        cast 'energy bolt' 40
        
                                        @settimer 'waiting_target_timer' 0
                                        while not targetexists 'harmful' and not insysmsg 'disturbed' and not insysmsg 'cannot cast a spell' and timer 'waiting_target_timer' < 4000
                                            wft 10
                                            if insysmsg 'disturbed' or insysmsg 'cannot cast a spell'
                                                if verbose_mode == 1
                                                    sysmsg 'BREAKING WHILE WAITING FOR EB TARGET' warning_msg_color
                                                endif
    
                                                wait spell_recovery_delay
                                                break
                                            endif
                                        endwhile
        
                                        if targetexists 'harmful'
                                            clearsysmsg
                                            hotkey 'Last Target'
                                            wait spell_recovery_delay
    
                                            if not insysmsg 'Target cannot be seen'
                                                if verbose_mode == 1
                                                    sysmsg '+++ RESETING ENERGY BOLT TIMER' reset_timer_msg_color
                                                endif
    
                                                settimer 'eb_timer' 0
                                            endif
                                        endif
                                    endif
                                endif
        
                                # magic arrow
                                if followers >= summon_max_limit and diffhits < max_diffhits_before_healing and not dead 'last' and find 'last' ground any any find_last_target_max_range
                                    if use_ma == 1 and timer 'ma_timer' > ma_delay
                                        if verbose_mode == 1
                                            sysmsg '>>> MAGIC ARROW' spell_msg_color
                                        endif
                                        cast 'magic arrow'
        
                                        @settimer 'waiting_target_timer' 0
                                        while not targetexists 'harmful' and not insysmsg 'disturbed' and not insysmsg 'cannot cast a spell' and timer 'waiting_target_timer' < 1500
                                            wft 10
                                            if insysmsg 'disturbed' or insysmsg 'cannot cast a spell'
                                                if verbose_mode == 1
                                                    sysmsg 'BREAKING WHILE WAITING FOR MA TARGET' warning_msg_color
                                                endif
                                                wait spell_recovery_delay
                                                break
                                            endif
                                        endwhile
        
                                        if targetexists 'harmful'
                                            hotkey 'Last Target'
                                            wait spell_recovery_delay
                                            settimer 'ma_timer' 0
                                        endif
                                    endif
                                endif
        
                                # harm
                                if followers >= summon_max_limit and diffhits < max_diffhits_before_healing and not dead 'last' and find 'last' ground any any find_last_target_max_range
                                    if use_harm == 1 and timer 'harm_timer' > harm_delay
                                        if verbose_mode == 1
                                            sysmsg '>>> HARM' spell_msg_color
                                        endif
                                        cast 'harm'
        
                                        @settimer 'waiting_target_timer' 0
                                        while not targetexists 'harmful' and not insysmsg 'disturbed' and not insysmsg 'cannot cast a spell' and timer 'waiting_target_timer' < 1500
                                            wft 10
                                            if insysmsg 'disturbed' or insysmsg 'cannot cast a spell'
                                                if verbose_mode == 1
                                                    sysmsg 'BREAKING WHILE WAITING FOR HARM TARGET' warning_msg_color
                                                endif
                                                wait spell_recovery_delay
                                                break
                                            endif
                                        endwhile
        
                                        if targetexists 'harmful'
                                            hotkey 'Last Target'
                                            wait spell_recovery_delay
                                            settimer 'harm_timer' 0
                                        endif
                                    endif
                                endif
        
                                # fireball
                                if followers >= summon_max_limit and diffhits < max_diffhits_before_healing and not dead 'last' and find 'last' ground any any find_last_target_max_range
                                    if use_fireball == 1 and timer 'fireball_timer' > fireball_delay
                                        if verbose_mode == 1
                                            sysmsg '>>> FIREBALL' spell_msg_color
                                        endif
    
                                        cast 'fireball'
        
                                        @settimer 'waiting_target_timer' 0
                                        while not targetexists 'harmful' and not insysmsg 'disturbed' and not insysmsg 'cannot cast a spell' and timer 'waiting_target_timer' < 1500
                                            wft 10
                                            if insysmsg 'disturbed' or insysmsg 'cannot cast a spell'
                                                if verbose_mode == 1
                                                    sysmsg 'BREAKING WHILE WAITING FOR FIREBALl TARGET' warning_msg_color
                                                endif
    
                                                wait spell_recovery_delay
                                                break
                                            endif
                                        endwhile
        
                                        if targetexists 'harmful'
                                            hotkey 'Last Target'
                                            wait spell_recovery_delay
                                            settimer 'fireball_timer' 0
                                        endif
                                    endif
                                endif
    
                                # kill close to loot mob easier (duplicate from above snippet)
                                if lure_mobs_closer_before_killing == 1 and timer 'lure_mob_closer_timer' > 4000
                                    if not find 'last' ground any any lure_mobs_distance_to_lure
                                        if verbose_mode == 1
                                            sysmsg '>>> LURING MOB CLOSE TO CHAR' default_sysmsg_color
                                        endif
                                        # say 'all kill'
                                        # wft 600
                                        # target 'last'
                                        # this wait is just to avoid speech throttle from the server
                                        wait 250
            
                                        say 'all follow me'
    
                                        settimer 'waiting_mob_to_approach_timer' 0
                                        while timer 'waiting_mob_to_approach_timer' < 1500
                                            wait 10
                                            if find 'last' ground any any lure_mobs_distance_to_lure
                                                sysmsg 'MOB IS NOW AT {{lure_mobs_distance_to_lure}} TILES' success_msg_color
                                                break
                                            endif
                                        endwhile
    
            
                                        hotkey 'Toggle Peace Only'
                                        settimer 'lure_mob_closer_timer' 0
                                        say 'all guard me'
                                    else
                                        if verbose_mode == 1
                                            sysmsg '>>> MOB IS CLOSE, NO NEED TO LURE' warning_msg_color
                                        endif
                                    endif
                                endif
        
                                if followers >= summon_max_limit and diffhits < max_diffhits_before_healing and not dead 'last' and find 'last' ground any any find_last_target_max_range
                                    if use_lightning == 1
                                        if timer 'lightning_timer' > lightning_delay
                                            if verbose_mode == 1
                                                sysmsg '>>> LIGHTNING' spell_msg_color
                                            endif
                                            cast 'lightning'
            
                                            @settimer 'waiting_target_timer' 0
                                            while not targetexists 'harmful' and not insysmsg 'disturbed' and not insysmsg 'cannot cast a spell' and timer 'waiting_target_timer' < 2500
                                                wft 10
                                                if insysmsg 'disturbed' or insysmsg 'cannot cast a spell'
                                                    if verbose_mode == 1
                                                        sysmsg 'BREAKING WHILE WAITING FOR LIGHTNING TARGET' warning_msg_color
                                                    endif
        
                                                    wait spell_recovery_delay
                                                    break
                                                endif
                                            endwhile
            
                                            if targetexists 'harmful'
                                                hotkey 'Last Target'
                                                wait spell_recovery_delay
                                                settimer 'lightning_timer' 0
                                            endif
                                        else
                                            if verbose_mode == 1
                                                sysmsg 'LIGHTNING NOT READY! TIMER: {{lightning_timer}}' warning_msg_color
                                            endif
                                        endif
                                    endif
                                endif
        
    
                                # USE MIND BLAST
                                if followers >= summon_max_limit and diffhits < max_diffhits_before_healing and not dead 'last' and find 'last' ground any any find_last_target_max_range
                                    if use_mind_blast == 1
                                        if verbose_mode == 1
                                            sysmsg '>>> MIND BLAST' spell_msg_color
                                        endif
                                        cast 'mind blast'
            
                                        @settimer 'waiting_target_timer' 0
                                        while not targetexists 'harmful' and not insysmsg 'disturbed' and not insysmsg 'cannot cast a spell' and timer 'waiting_target_timer' < 4500
                                            wft 10
                                            if insysmsg 'disturbed' or insysmsg 'cannot cast a spell'
                                                if debug == 1
                                                    sysmsg 'BREAKING WHILE WAITING FOR MIND BLAST TARGET' warning_msg_color
                                                endif
    
                                                wait spell_recovery_delay
                                                break
                                            endif
                                        endwhile
            
                                        if targetexists 'harmful'
                                            hotkey 'Last Target'
                                            wait spell_recovery_delay
                                        endif
                                    endif
                                endif
        
                                if followers >= summon_max_limit and diffhits < max_diffhits_before_healing and not dead 'last' and find 'last' ground any any find_last_target_max_range
                                    if use_flamestrike == 1
                                        if verbose_mode == 1
                                            sysmsg '>>> FLAMESTRIKE' spell_msg_color
                                        endif
                                        cast 'flamestrike'
            
                                        @settimer 'waiting_target_timer' 0
                                        while not targetexists 'harmful' and not insysmsg 'disturbed' and not insysmsg 'cannot cast a spell' and timer 'waiting_target_timer' < 4500
                                            wft 10
                                            if insysmsg 'disturbed' or insysmsg 'cannot cast a spell'
                                                if debug == 1
                                                    sysmsg 'BREAKING WHILE WAITING FOR FLAMESTRIKE TARGET' warning_msg_color
                                                endif
        
                                                wait spell_recovery_delay
                                                break
                                            endif
                                        endwhile
            
                                        if targetexists 'harmful'
                                            hotkey 'Last Target'
                                            wait spell_recovery_delay
                                        endif
                                    endif
                                endif
    
    
                                # ###############################
                                # # CHAIN LIGHTNING
                                # ###############################
    
                                if followers >= summon_max_limit and diffhits < max_diffhits_before_healing and not dead 'last' and find 'last' ground any any find_last_target_max_range
                                    if use_chain_lightning == 1
                                        if timer 'chain_lightning_timer' > chain_lightning_delay
                                            if verbose_mode == 1
                                                sysmsg '>>> CHAIN LIGHTNING' spell_msg_color
                                            endif
                                            cast 'chain lightning'
            
                                            @settimer 'waiting_target_timer' 0
                                            while not targetexists 'harmful' and not insysmsg 'disturbed' and not insysmsg 'cannot cast a spell' and timer 'waiting_target_timer' < 2500
                                                wft 10
                                                if insysmsg 'disturbed' or insysmsg 'cannot cast a spell'
                                                    if verbose_mode == 1
                                                        sysmsg 'BREAKING WHILE WAITING FOR CHAIN LIGHTNING TARGET' warning_msg_color
                                                    endif
        
                                                    wait spell_recovery_delay
                                                    break
                                                endif
                                            endwhile
            
                                            if targetexists 'harmful'
                                                hotkey 'Last Target'
                                                wait spell_recovery_delay
    
                                                if not insysmsg 'Target cannot be seen'
                                                    if verbose_mode == 1
                                                        sysmsg '+++ RESETING CHAIN LIGHTNING TIMER' reset_timer_msg_color
                                                    endif
        
                                                    settimer 'chain_lightning_timer' 0
                                                    cooldown 'Chain Lightning' chain_lightning_delay
                                                endif
                                            endif
    
                                        else
                                            if verbose_mode == 1
                                                sysmsg 'CHAIN LIGHTNING NOT READY! TIMER: {{lightning_timer}}' warning_msg_color
                                            endif
                                        endif
                                    endif
                                endif
    
    
                                # ###############################
                                # # METEOR SWARM
                                # ###############################
    
                                if followers >= summon_max_limit and diffhits < max_diffhits_before_healing and not dead 'last' and find 'last' ground any any find_last_target_max_range
                                    if use_meteor_swarm == 1 and timer 'meteor_swarm_timer' > meteor_swarm_delay
                                        if verbose_mode == 1
                                            sysmsg '>>> METEOR SWARM ' spell_msg_color
                                        endif
                                        cast 'meteor swarm'
        
                                        @settimer 'waiting_target_timer' 0
                                        while not targetexists 'harmful' and not insysmsg 'disturbed' and not insysmsg 'cannot cast a spell' and timer 'waiting_target_timer' < 2500
                                            wft 10
                                            if insysmsg 'disturbed' or insysmsg 'cannot cast a spell'
                                                if verbose_mode == 1
                                                    sysmsg 'BREAKING WHILE WAITING FOR METEOR SWARM TARGET' warning_msg_color
                                                endif
    
                                                wait spell_recovery_delay
                                                break
                                            endif
                                        endwhile
        
                                        if targetexists 'harmful'
                                            hotkey 'Last Target'
                                            wait spell_recovery_delay
    
                                            if not insysmsg 'Target cannot be seen'
                                                if verbose_mode == 1
                                                    sysmsg '+++ RESETING METEOR SWARM TIMER' reset_timer_msg_color
                                                endif
    
                                                settimer 'chain_lightning_timer' 0
                                                settimer 'meteor_swarm_timer' 0
                                                cooldown 'Meteor Swarm' meteor_swarm_delay
                                            endif
                                        endif
                                        endif
                                    endif
                                endif
    
                                # ###############################
                                # # EARTHQUAKE
                                # ###############################
    
                                if followers >= summon_max_limit and diffhits < max_diffhits_before_healing and not dead 'last' and find 'last' ground any any find_last_target_max_range
                                    if use_meteor_swarm == 1 and timer 'earthquake_timer' > earthquake_delay
                                        if verbose_mode == 1
                                            sysmsg '>>> EARTHQUAKE' spell_msg_color
                                        endif
                                        cast 'earthquake'
        
                                        @settimer 'waiting_target_timer' 0
                                        while not insysmsg 'disturbed' and not insysmsg 'cannot cast a spell' and timer 'waiting_target_timer' < 2500
                                            wft 10
                                            if insysmsg 'disturbed' or insysmsg 'cannot cast a spell'
                                                if verbose_mode == 1
                                                    sysmsg 'BREAKING WHILE WAITING FOR EARTHQUAKE' warning_msg_color
                                                endif
    
                                                wait spell_recovery_delay
                                                break
                                            endif
                                        endwhile
        
                                        if targetexists 'harmful'
                                            hotkey 'Last Target'
                                            wait spell_recovery_delay
                                            settimer 'earthquake_timer' 0
                                        endif
                                    endif
                                endif
    
    
    
    
                                # ###############################
                                # # PAIN SPIKE
                                # ###############################
    
                                if use_pain_spike == 1
                                    if not timerexists 'painspike_timer'
                                        createtimer 'painspike_timer'
                                        settimer 'painspike_timer' 30001
                                    endif
    
    
    
                                    if skill 'necromancy' > 20 and findtype 'corpse' ground any any 30
                                        if timer 'painspike_timer' >= 30000
                                            if verbose_mode == 1
                                                sysmsg '>>> Using pain spike...'
                                            endif
    
                                            say '[painspike'
                                            wft action_delay
                                            if targetexists 'neutral'
                                                if verbose_mode == 1
                                                    sysmsg '>>> PAIN SPIKE!' 89
                                                endif
    
                                                hotkey 'Last Target'
                                                wait action_delay
                                                if insysmsg 'Unholy symbols remaining'
                                                    if verbose_mode == 1
                                                        sysmsg '>>> EXPLODED CORPSE!' 30
                                                    endif
    
                                                    if use_script_overhead_messages == 1
                                                        overhead '*exploded corpse*' 30
                                                    endif
    
                                                    settimer 'painspike_timer' 0
                                                endif
                                            endif
                                            wait action_delay
                                        else
                                            if verbose_mode == 1
                                                sysmsg 'Pain spike cooldown...' 56
                                            endif
                                        endif
                                    endif
                                endif
    
                            endif
        
                        else
                            if debug == 1
                                sysmsg 'NAO ENTROU NOTO AQUI 2'
                                overhead 'LAST BUGADO' 90 'last'
                            endif
                        endif
                    else
                        if debug == 1
                            sysmsg 'NAO ENTROU NOTO AQUI 1'
                            overhead 'LAST BUGADO' 90 'last'
                        endif
                    endif
                # closes if not dead last target inside main while loop of main attack routine
                endif
            # end while not dead lasttarget or enemy_boat_present == 1
            endwhile
        endif
    endif

    # if debug == 1
    #     sysmsg '[DEBUG] AFTER MAIN ATTACK ROUTINE' debug_sysmsg_color
    # endif

    if insysmsg 'You have received a Dungeon Torch!'
        sysmsg '!!!!!! DUNGEON TORCH!!!!!!!!!!!!!!!!!!!' 90
        sysmsg '!!!!!! DUNGEON TORCH!!!!!!!!!!!!!!!!!!!' 90
        sysmsg '!!!!!! DUNGEON TORCH!!!!!!!!!!!!!!!!!!!' 90
        sysmsg '!!!!!! DUNGEON TORCH!!!!!!!!!!!!!!!!!!!' 90
        sysmsg '!!!!!! DUNGEON TORCH!!!!!!!!!!!!!!!!!!!' 90
        overhead '!!!!!! DUNGEON TORCH!!!!!!!!!!!!!!!!!!!' 90
        overhead '!!!!!! DUNGEON TORCH!!!!!!!!!!!!!!!!!!!' 90
        overhead '!!!!!! DUNGEON TORCH!!!!!!!!!!!!!!!!!!!' 90
        overhead '!!!!!! DUNGEON TORCH!!!!!!!!!!!!!!!!!!!' 90
        overhead '!!!!!! DUNGEON TORCH!!!!!!!!!!!!!!!!!!!' 90
    endif

    if findtype 'an elusive rabbit' ground any any 30 as rabbit
        overhead '!! RABBIT !!' 90
        overhead '!! RABBIT !!' 90 rabbit
    endif



    if auto_get_new_targets == 1 and keep_getting_closest_target == 1
        if verbose_mode == 1
            sysmsg 'RE-GETTING CLOSEST TARGET' action_msg_color
        endif

        hotkey 'Target Closest Non-Friendly Monster'
    endif

    if not dead 'last' and not find 'last' ground any any find_last_target_max_range
        sysmsg 'LASTTARGET NOT FOUND. CANCELLING CURRENT TARGET' alert_msg_color
        unsetvar lasttarget
        unsetvar 'last'
        clearsysmsg
        clearall
    endif

    setvar! last_target_serial lasttarget

    if auto_rail == 1
        if debug == 1
           sysmsg '[DEBUG] ENTERED RAIL' debug_msg_color
        endif

        setvar! do_rail_now 0

        hotkey 'Target Closest Non-Friendly Monster'
        hotkey 'Set Last Target'
        wft action_delay
        hotkey 'Last Target'
        wait spell_recovery_delay

        if dead last_target_serial
            if verbose_mode == 1
                sysmsg 'LAST TARGET DEAD. DOING RAIL' debug_msg_color
            endif

            setvar! do_rail_now 1
        elseif insysmsg 'Target cannot be seen'
            if verbose_mode == 1
              sysmsg 'LAST TARGET CANNOT BE SEEN. DOING RAIL' debug_msg_color
            endif

            setvar! do_rail_now 1
        elseif insysmsg 'The requested target is out of range'
            if verbose_mode == 1
                sysmsg 'TARGET IS OUT OF RANGE. DOING RAIL' alert_msg_color
            endif

            setvar! do_rail_now 1
        endif


        if do_rail_now == 1
            sysmsg 'DOING RAIL INDEX {{current_rail_index}}' rail_msg_color

            if current_rail_index >= list 'rail_directions'
                sysmsg 'GOT TO END OF RAIL LIST. RESETING RAIL INDEX' rail_msg_color
                setvar! current_rail_index 0
            endif

            unsetvar rail_direction
            unsetvar rail_x
            unsetvar rail_y

            if atlist 'rail_directions' current_rail_index as direction
                if direction == 10
                    # sysmsg 'SETTING DIRECTION TO 0'
                    setvar! rail_direction 0
                else
                    setvar! rail_direction direction
                    # sysmsg 'SETTING DIRECTION TO {{rail_direction}}'
                endif
            endif
            if atlist 'rail_x_positions' current_rail_index as x
                setvar! rail_x x
                # sysmsg 'SETTING X POSITION TO {{rail_x}}'
            endif
            if atlist 'rail_y_positions' current_rail_index as y
                setvar! rail_y y
                # sysmsg 'SETTING Y POSITION TO {{rail_y}}'
            endif
            # endfor

            # WALK THE RAIL!
            if varexist rail_direction and varexist rail_x and varexist rail_y
                while not position rail_x rail_y 
                    sysmsg 'RAIL {{current_rail_index}}: DIRECTION: {{rail_direction}} | X: {{rail_x}} | Y: {{rail_y}}' rail_msg_color
                    walk rail_direction
    
                    if dead lasttarget
                        hotkey 'Target Closest Non-Friendly Monster'
                    endif
    
                    if not dead lasttarget
                        sysmsg '[RAIL] CHECKING LASTTARGET DISTANCE' rail_msg_color
                        hotkey 'Set Last Target'
                        wft action_delay
                        hotkey 'Last Target'
                    endif
    
                    wait 400
    
                    if not dead lastarget and not insysmsg 'not be seen' and not insysmsg 'out of range'
                        sysmsg 'BREAKING ON RAIL' alert_msg_color
                        break
                    endif
                endwhile
            else
                sysmsg 'COUNDNT SET RAIL VARIABLES' alert_msg_color
            endif

            if varexist rail_direction and varexist rail_x and varexist rail_y
                if position rail_x rail_y
                    sysmsg 'RAIL {{current_rail_index}} COMPLETE...' success_msg_color
    
                        # lift trap_pouch
                    if current_rail_index == 0
                        setvar! current_rail_index 1
                    elseif current_rail_index == 1
                        setvar! current_rail_index 2
                    elseif current_rail_index == 2
                        setvar! current_rail_index 3
                    elseif current_rail_index == 3
                        setvar! current_rail_index 4
                    elseif current_rail_index == 4
                        setvar! current_rail_index 5
                    elseif current_rail_index == 5
                        setvar! current_rail_index 6
                    elseif current_rail_index == 6
                        setvar! current_rail_index 7
                    elseif current_rail_index == 7
                        setvar! current_rail_index 8
                    elseif current_rail_index == 8
                        setvar! current_rail_index 9
                    elseif current_rail_index == 9
                        setvar! current_rail_index 10
                    elseif current_rail_index == 10
                        setvar! current_rail_index 11
                    elseif current_rail_index == 11
                        setvar! current_rail_index 11
                    elseif current_rail_index == 12
                        setvar! current_rail_index 13
                    endif
    
                    sysmsg 'SETTING NEXT RAIL INDEX TO {{current_rail_index}}' success_msg_color
                endif
            endif

        endif
    endif


    if auto_patrol_when_no_active_lasttarget == 1 and timer 'all_patrol_timer' > all_patrol_delay
        say 'all patrol'
        wft action_delay
        targetrelloc patrol_first_relative_direction patrol_second_relative_direction

        if verbose_mode == 1
            sysmsg '+++ RESETING PATROL AND GUARD TIMERS' reset_timer_msg_color
        endif

        settimer 'all_patrol_timer' 0
        # also reset guard to wait a bit longer to call pets back in
        settimer 'all_guard_timer' 0
    endif

    if auto_get_new_targets == 1 and timer 'auto_get_new_targets_timer' > 1000
        if verbose_mode == 1
            sysmsg '> SEARCHING MONSTERS TARGETS...' action_msg_color
        endif

        if use_script_overhead_messages == 1
            overhead '*searching monsters*' action_msg_color
        endif

        hotkey 'Target Closest Non-Friendly Monster'
        if get_players_on_auto_target == 1
            if verbose_mode == 1
                sysmsg '> SEARCHING PLAYER TARGETS...' action_msg_color
            endif

            if use_script_overhead_messages == 1
                overhead '*searching players*' action_msg_color
            endif

            hotkey 'Next Grey Humanoid Target'
            # TESTING removing wait
            # wait action_delay
        endif

        settimer 'auto_get_new_targets_timer' 0
    elseif auto_get_new_targets == 0 && timer 'get_new_target_msg' > 4000
        overhead 'waiting for new target' overhead_color
        settimer 'get_new_target_msg' 0
    endif
    

    # putting the clear here to reset all possible msgs i caught during the previous iteration
    clearsysmsg

#random 10

endwhile
