setvar! script_version 300

sysmsg '#########################' 90
# overhead 'ðŸ¤– MAGE BOT ðŸ¤–' 55
# overhead 'by gugutz' 55
# overhead 'version 3.0' 56
sysmsg 'â˜…â˜… MAGE BOT Â®' 55
sysmsg 'â†’ by gugutz â„¢' 55
sysmsg 'Version: {{script_version}}' 56
sysmsg '########################' 90
sysmsg '.' instructions_msg_color

if not timerexists 'execution_timer'
    createtimer 'execution_timer'
endif
settimer 'execution_timer' 0



############################################################################
# INSTRUCTIONS
############################################################################

if printed_instructions_once != 1
    setvar! instructions_msg_color 1161
    sysmsg '########################' 90
    sysmsg '.' instructions_msg_color
    sysmsg 'INSTRUCTIONS:' instructions_msg_color
    sysmsg '.' instructions_msg_color
    sysmsg "â–· If boating, start from inside the boat with enough space to turn it" instructions_msg_color
    sysmsg "â–· If using packies, start close to them and far from other players packies" instructions_msg_color
    sysmsg "â–· Create Cooldowns for each spell. Ex: 'Magic Arrow', 'Harm', ..." instructions_msg_color
    sysmsg '########################' 90
    sysmsg '.' instructions_msg_color

    wait 3000
    setvar! printed_instructions_once 1
endif


if not timerexists 'script_settings_timer'
    createtimer 'script_settings_timer'
endif
settimer 'script_settings_timer' 0


############################################################################
# GENERAL SETTINGS
############################################################################

if stack_trace == 1
    sysmsg '[STACK] Setting General Configuration...' script_msg_color
endif

# VERBOSITY SETTINGS
setvar! debug 0
setvar! stack_trace 0
setvar! verbose 0
setvar! use_script_overhead_messages 1

# GENERAL SETTINGS
setvar! auto_configure_script_based_on_skills 1
setvar! auto_rail 0
setvar! auto_heal 1
setvar! auto_cure_poison 1
setvar! auto_delectable 0
setvar! hide_valuables_in_char_loot_pouch 1
setvar! auto_move_regs_to_satchel 1
setvar! recall_home_to_restock 1
setvar! auto_escape_pks 1
setvar! auto_escape_thiefs 1
setvar! auto_meditate 1
setvar! auto_escape_ground_burning_flames 0
setvar! juggle_mode 0

# SKILL BUFF SETTINGS
setvar! auto_spirit_speak 0
setvar! auto_skin_corpses 0

# TARGETING SETTINGS
setvar! auto_get_new_targets 0
setvar! auto_attack_targets 1
setvar! hold_targets 0
setvar! keep_getting_closest_target 0
setvar! get_players_on_auto_target 0
setvar! lure_mobs_closer_before_killing 0
setvar! lure_mobs_distance_to_lure 2
setvar! offensive_mode 1


# FOLLOWER SETTINGS
setvar! auto_herd_mobs 0
setvar! patrol_first_relative_direction 0
setvar! patrol_second_relative_direction -10


setvar! is_summoner 0
setvar! is_tamer 0

# SUMMON SETTINGS
if skill 'magery' >= 90 and skill 'taming' == 0
    setvar! is_summoner 1
    sysmsg 'MAGE DETECTED. OPTIMIZING...' script_msg_color
    sysmsg '[STACK] Setting Summons Options...' script_msg_color
    
    if not listexists 'summons'
        createlist 'summons'
    endif
    
    clearlist 'summons'
    pushlist 'summons' 'an earth elemental'
    pushlist 'summons' 'a fire elemental'
    pushlist 'summons' 'summ. creature'
    
    setvar! auto_summon 1
    setvar! use_undead_summons 1
    setvar! auto_all_guard 1
    setvar! auto_patrol_when_no_active_lasttarget 0
    setvar! auto_vampiric_embrace 1

    # if summ creature is one of players summons, change limit to 5 so even with 4 followers, we still make the char cast to summon the fifth creature
    # if not, then we just want 2 elementals so limit should be 4, since they take up 2 slots each and the fifth wouldnt be possible
    if inlist 'summons' 'summ. creature'
        setvar! followers_max_limit 5
    else
        setvar! followers_max_limit 4
    endif
endif

# TAMER SETINGS
if skill 'taming' >= 100
    setvar! is_tamer 1
    sysmsg 'TAMMER DETECTED. OPTIMIZING...' script_msg_color
    setvar! auto_heal_pets 1
    setvar! auto_ress_pets 1
endif

if skill 'veterinary' >= 50
    sysmsg 'VETERINARY DETECTED. OPTIMIZING...' script_msg_color
    setvar! is_veterinarian 1
    setvar! auto_vet_pets 1
    setvar! vet_pets_delay 5000
endif

if skill 'herding' >= 80
    sysmsg 'HERDER DETECTED. OPTIMIZING...' script_msg_color
    setvar! is_herder 1
    setvar! auto_herd_mobs 1
endif

if skill 'detectinghidden' >= 80
    sysmsg 'DETECTER DETECTED. OPTIMIZING...' script_msg_color
    setvar! is_detecter 1
endif

setvar! use_mushroom_delay 60000
setvar! all_guard_delay 5000
setvar! all_patrol_delay 6000
setvar! cast_summons_delay 3300




# SPELLS TO AUTO CAST
setvar! use_reactive_armor 1
setvar! use_magic_reflection 1
setvar! use_protection 1
setvar! use_arch_protection 0
setvar! use_strength 1
setvar! use_incognito 0
setvar! use_mana_drain 1
setvar! use_curse 1
setvar! use_mass_curse 0
setvar! use_ma 1
setvar! use_harm 1
setvar! use_fireball 0
setvar! use_lightning 1
setvar! use_mind_blast 0
setvar! use_eb 0
setvar! use_flamestrike 1
setvar! use_pain_spike 0
setvar! use_chain_lightning 1
setvar! use_meteor_swarm 0
setvar! use_earthquake 0
if skill 'poisoning' >= 100
    setvar! use_poison 1
endif


# SPELL GRIMOIRE INTERVALS
setvar! mana_drain_delay 60000
setvar! curse_delay 60000
setvar! mass_curse_delay 300000
setvar! poison_delay 60000
setvar! eb_delay 10000
setvar! ma_delay 60000
setvar! harm_delay 60000
setvar! fireball_delay 60000
setvar! lightning_delay 60000
setvar! chain_lightning_delay 20000
setvar! meteor_swarm_delay 20000
setvar! earthquake_delay 60000

# PACKIES SETTINGS
setvar! auto_unload_items_in_pack_animal 0
setvar! auto_unload_reagents_in_pack_animal 1
setvar! move_gold 1
setvar! move_resources 1
setvar! move_gems 1
setvar! move_food 1
setvar! move_reagents 1
setvar! min_reagents_to_leave_on_char 160
setvar! amount_of_regs_to_move 40


# BOATING SETTINGS
setvar! boating_mode 0
setvar! auto_defuse_bombs 1
setvar! auto_repair_ship 1
setvar! auto_reload_cannons 1
setvar! auto_fire_cannons 1
setvar! auto_heal_crew 1
setvar! auto_open_enemy_boat_holds 1
setvar! auto_dock_when_close_to_dockmaster 1


# BOATING DELAYS
setvar! search_ships_delay 15000
setvar! reload_cannons_delay 10000
setvar! fire_cannons_delay 12000
setvar! repair_ship_cooldown 10000
# we create individual delays for each part so we can increase the delay when ship is full health
setvar! repair_ship_hull_delay repair_ship_cooldown
setvar! repair_ship_sails_delay repair_ship_cooldown
setvar! repair_ship_guns_delay repair_ship_cooldown
setvar! heal_ship_crew_delay 20000
setvar! ship_lesser_ability_delay 113000


# AUTO RAIL DIRECTIONS
clearlist rail_directions
createlist rail_directions
pushlist rail_directions 2
pushlist rail_directions 6
pushlist rail_directions 4
pushlist rail_directions 4
pushlist rail_directions 10
pushlist rail_directions 10

# AUTO RAIL X POSITIONS
clearlist rail_x_positions
createlist rail_x_positions
pushlist rail_x_positions 5644
pushlist rail_x_positions 5641
pushlist rail_x_positions 5641
pushlist rail_x_positions 5641
pushlist rail_x_positions 5641
pushlist rail_x_positions 5641


# AUTO RAIL Y POSITIONS
clearlist rail_y_positions
createlist rail_y_positions
pushlist rail_y_positions 1010
pushlist rail_y_positions 1010
pushlist rail_y_positions 1019
pushlist rail_y_positions 1029
pushlist rail_y_positions 1021
pushlist rail_y_positions 1010

if debug == 1
    sysmsg '[DEBUG] FINISHED PLAYER SETTINGS IN {{script_settings_timer}} ms' debug_msg_color
endif


############################################################################
# SCRIPT SPECIFIC SETTINGS (USUALLY THERES NO NEED TO DONT CHANGE THESE)
############################################################################

if not timerexists 'script_related_settings_timer'
    createtimer 'script_related_settings_timer'
endif
settimer 'script_related_settings_timer' 0

setvar! action_delay 550
setvar! spell_recovery_delay 120
setvar! find_last_target_max_range 18
setvar! find_enemy_boats_max_range 15
setvar! find_summon_range 8

#####################################
# LIMITS BEFORE ACTIONS
setvar! max_diffhits_before_healing 10
setvar! max_diffhits_before_buffing 5
setvar! max_diffhits_before_meditating 5
setvar! max_diffhits_before_heal_pot 40
setvar! max_diffhits_before_greater_heal 20
setvar! min_mana_to_attack 52
setvar! mana_limit_to_medit 40
setvar! mana_limit_to_eat_mushroom 70
setvar! mushroom_limit_before_creating_more 2
setvar! mushroom_stock_size 15


#####################################
# VARIABLES FOR MESSAGE COLORS
#####################################
setvar! debug_msg_color 41
setvar! script_msg_color 2213
setvar! default_sysmsg_color 1360
setvar! default_overhead_color 1360

setvar! spell_msg_color 49
setvar! buff_msg_color 92
setvar! warning_msg_color 1196
setvar! alert_msg_color 1172
setvar! success_msg_color 1272
setvar! action_msg_color 90
setvar! rail_msg_color 116
setvar! on_cooldown_msg_color 53
setvar! reset_timer_msg_color 1258
setvar! boating_msg_color 84


#####################################
# CONSTANTS FOR IN-GAME TYPES
setvar! LANTERN_ON_TYPE 2594
setvar! LANTERN_OFF_TYPE 2597
setvar! TORCH_ON_TYPE 2578
setvar! TORCH_OFF_TYPE 3947
setvar! YULETIDE_CANDLE_ON_TYPE 22432
setvar! YULETIDE_CANDLE_OFF_TYPE 22433
# dungeon torches only have a 'on' graphic, they cant be turned off
setvar! DUNGEON_TORCH_TYPE 30580
setvar! SHIP_BOMB 5188
setvar! HULL_STATUS_BAR_COLOR 150

#####################################
# CONSTANTS FOR IN-GAME GUMP IDS
setvar! necromancy_gump_id 622436516
setvar! dockmaster_gump_id 3287496917

setvar! boarding_gump_id 2881168634
setvar! search_ships_gump_id 2890020940


setvar! 1st_circle_spell_mana_cost 8
setvar! 2nd_circle_spell_mana_cost 9
setvar! 3rd_circle_spell_mana_cost 10
setvar! 4th_circle_spell_mana_cost 12

if is_summoner == 1
    #####################################
    # SET MAX SUMMONS LIMIT
    # if summ creature is one of players summons, change limit to 5 so even with 4 followers, we still make the char cast to summon the fifth creature
    # if not, then we just want 2 elementals so limit should be 4, since they take up 2 slots each and the fifth wouldnt be possible
    if inlist 'summons' 'summ. creature'
        setvar! followers_max_limit 5
    else
        setvar! followers_max_limit 4
    endif
    
    #####################################
    # SUMMONS SPELL LISTS
    #####################################
    
    if not listexists 'summonspells'
        createlist 'summonspells'
    endif
    clearlist 'summonspells'
    
    if inlist 'summons' 'an air elemental'
        @pushlist 'summonspells' 'air elemental'
    endif
    if inlist 'summons' 'an earth elemental'
        @pushlist 'summonspells' 'earth elemental'
    endif
    if inlist 'summons' 'a water elemental'
        @pushlist 'summonspells' 'water elemental'
    endif
    if inlist 'summons' 'a fire elemental'
        @pushlist 'summonspells' 'fire elemental'
    endif
    if inlist 'summons' 'a daemon'
        @pushlist 'summonspells' 'summon daemon'
    endif
    if inlist 'summons' 'an energy vortex'
        @pushlist 'summonspells' 'energy vortex'
    endif
    if inlist 'summons' 'a blade spirit'
        @pushlist 'summonspells' 'blade spirits'
    endif
    if inlist 'summons' 'summ. creature'
        @pushlist 'summonspells' 'summ. creature'
    endif
endif


################################################
# UNLOAD ITEMS IN PACKIE SETUP


if auto_unload_items_in_pack_animal == 1
    if not listexists 'open_pack_animal_backpack'
        createlist 'open_pack_animal_backpack'
    endif
    clearlist 'open_pack_animal_backpack'


    # CREATE ITEMS TO MOVE TO PACKIE LISTS
    if not listexists 'items_to_move_to_llama'
        @createlist 'items_to_move_to_llama'

        if move_gold == 1
            @pushlist 'items_to_move_to_llama' 'gold coin'
        endif

        if move_resources == 1
            @pushlist 'items_to_move_to_llama' 'cut up leather'
            @pushlist 'items_to_move_to_llama' 'log%s'
            @pushlist 'items_to_move_to_llama' 'board%s'
            @pushlist 'items_to_move_to_llama' 'ingot%s'
        endif

        # gems
        if move_gems == 1
            @pushlist 'items_to_move_to_llama' 'rub%ies/y%'
            @pushlist 'items_to_move_to_llama' 'tourmaline%s%'
            @pushlist 'items_to_move_to_llama' 'emerald%s%'
            @pushlist 'items_to_move_to_llama' 'diamond%s%'
            @pushlist 'items_to_move_to_llama' 'piece%s% of amber'
            @pushlist 'items_to_move_to_llama' 'amethyst%s%'
            @pushlist 'items_to_move_to_llama' 'star sapphire%s%'
            @pushlist 'items_to_move_to_llama' 'citrine%s%'
            @pushlist 'items_to_move_to_llama' 'sapphire%s%'
        endif
        #
        # foods
        if move_food == 1
            @pushlist 'items_to_move_to_llama' 'sliced ham'
            @pushlist 'items_to_move_to_llama' 'raw chicken leg%s%'
            @pushlist 'items_to_move_to_llama' 'raw leg%s% of lamb'
            @pushlist 'items_to_move_to_llama' 'slab%s% of bacon'
            @pushlist 'items_to_move_to_llama' 'sausage%s%'
            @pushlist 'items_to_move_to_llama' 'ham%s%'
            @pushlist 'items_to_move_to_llama' 'cut%s% of raw ribs'
        endif
        #
        # foods
    endif

    if move_reagents == 1 and not listexists 'reagents'
        @createlist 'reagents'
        @pushlist 'reagents' 'Blood Moss'
        @pushlist 'reagents' 'Black Pearl%s%'
        @pushlist 'reagents' 'Garlic'
        @pushlist 'reagents' 'Mandrake Root%s%'
        @pushlist 'reagents' 'Ginseng'
        @pushlist 'reagents' 'Nightshade'
        @pushlist 'reagents' 'Sulfurous Ash'
        @pushlist 'reagents' "Spider's Silk"
    endif


endif


####################################
# BOATING LISTS

createlist 'my_boat_cannons'
clearlist 'my_boat_cannons'

# cannons north
if findtypelist 'my_boat_cannons' 'Light Cannon (North)' ground any any 10
endif
# cannons south
if findtypelist 'my_boat_cannons' 'Light Cannon (South)' ground any any 10
endif
# cannons west
if findtypelist 'my_boat_cannons' 'Light Cannon (West)' ground any any 10
endif
# cannons east
if findtypelist 'my_boat_cannons' 'Light Cannon (East)' ground any any 10
endif






# NPC Ship Hues
createlist npcshiphues
clearlist npcshiphues
# druid
pushlist npcshiphues 2845
# Vile
pushlist npcshiphues 2841
# Ossurary
pushlist npcshiphues 2840
# pirate
pushlist npcshiphues 2269
# merchant
pushlist npcshiphues 2766
# ghost
pushlist npcshiphues 2955
# orc reaver
pushlist npcshiphues 2141
# raider
pushlist npcshiphues 2927
# tradesman
pushlist npcshiphues 2347
# Lizardman
pushlist npcshiphues 2363
# explorer
pushlist npcshiphues 2845
# fisherman
pushlist npcshiphues 2076
# daemon
pushlist npcshiphues 2740
# submerged
pushlist npcshiphues 2826


#create list of tillermen
#if not listexists tillermen_list
createlist tillermen_list
clearlist tillermen_list
@pushlist tillermen_list 15952
@pushlist tillermen_list 15955
@pushlist tillermen_list 15950
@pushlist tillermen_list 15947

if not listexists 'dockmasters_serials'
    createlist 'dockmasters_serials'
    clearlist 'dockmasters_serials'
    # shelter docks Uriah the Dockmaster
    pushlist 'dockmasters_serials' 0x11A32F
    # Horseshoe Bay Beaumont the Dockmaster
    pushlist 'dockmasters_serials' 0x80600
endif


################################################
# UNLOAD ITEMS IN PACKIE SETUP
#
# lists to control which corpses have been drained and skinned
# update: with necro you dont need to be draining corpses, summons loose hp until they die instead of lasting a duration in time

# used to control which mobs i already used herding on
@createlist 'herdened_mobs'

if skill 'necromancy' == 0
    if skill 'spirit' > 0 and not listexists 'drained_corpses'
        sysmsg '$$$ Creating list to control drained corpses...' script_msg_color
        createlist 'drained_corpses'
    endif
endif

if skill 'forensic' > 0 and auto_skin_corpses == 1 and not listexists 'skinned_corpses'
    sysmsg '$$$ Creating list to control skinned corpses...' script_msg_color
    createlist 'skinned_corpses'
endif





setvar! mage_bot_first_run_done 1

sysmsg '>> FINISHED SCRIPT RELATED VARIABLES AND LISTS IN  {{script_settings_timer}} ms' script_msg_color
setvar! script_settings_execution_time setup_timers_timer



#################################
# CREATE ALL TIMERS
#################################

if not timerexists 'setup_timers_timer'
    createtimer 'setup_timers_timer'
endif
settimer 'setup_timers_timer' 0

if not varexist timers_setup_done

    createlist 'mage_bot_timers'
    # pushlist 'mage_bot_timers' 'loop_on_warning_msg'
    pushlist 'mage_bot_timers' 'script_running_warning_msg_timer'
    pushlist 'mage_bot_timers' 'script_debug_stats_msg_timer'
    pushlist 'mage_bot_timers' 'script_stats_msg_timer'
    pushlist 'mage_bot_timers' 'spirit_speak_cooldown_timer'
    pushlist 'mage_bot_timers' 'use_mushroom_timer'
    # SPELL CAST TIMERS
    pushlist 'mage_bot_timers' 'mana_drain_timer'
    pushlist 'mage_bot_timers' 'curse_timer'
    pushlist 'mage_bot_timers' 'poison_timer'
    pushlist 'mage_bot_timers' 'mass_curse_timer'
    pushlist 'mage_bot_timers' 'ma_timer'
    pushlist 'mage_bot_timers' 'harm_timer'
    pushlist 'mage_bot_timers' 'fireball_timer'
    pushlist 'mage_bot_timers' 'lightning_timer'
    pushlist 'mage_bot_timers' 'eb_timer'
    pushlist 'mage_bot_timers' 'chain_lightning_timer'
    pushlist 'mage_bot_timers' 'meteor_swarm_timer'
    pushlist 'mage_bot_timers' 'earthquake_timer'
    pushlist 'mage_bot_timers' 'medit_msg_timer'
    pushlist 'mage_bot_timers' 'auto_get_new_targets_timer'
    pushlist 'mage_bot_timers' 'get_new_target_msg'
    pushlist 'mage_bot_timers' 'all_guard_timer'
    pushlist 'mage_bot_timers' 'all_patrol_timer'
    pushlist 'mage_bot_timers' 'holding_target_warning_msg'
    pushlist 'mage_bot_timers' 'waiting_summon_timer'
    pushlist 'mage_bot_timers' 'waiting_spell_timer'
    pushlist 'mage_bot_timers' 'waiting_target_timer'
    pushlist 'mage_bot_timers' 'lure_mob_closer_timer'
    pushlist 'mage_bot_timers' 'low_mana_for_summoning_warning_msg_timer'
    pushlist 'mage_bot_timers' 'fun_timer'
    # BOATING TIMERS
    pushlist 'mage_bot_timers' 'heal_ship_crew_timer'
    pushlist 'mage_bot_timers' 'search_ships_timer'
    pushlist 'mage_bot_timers' 'repair_ship_hull_timer'
    pushlist 'mage_bot_timers' 'repair_ship_sails_timer'
    pushlist 'mage_bot_timers' 'repair_ship_guns_timer'
    pushlist 'mage_bot_timers' 'reload_cannons_timer'
    pushlist 'mage_bot_timers' 'fire_cannons_timer'
    pushlist 'mage_bot_timers' 'ship_lesser_ability_timer'

    if skill 'necromancy' > 0
        pushlist 'mage_bot_timers' 'vengeful_spirit_timer'
        pushlist 'mage_bot_timers' 'vampiric_embrace_cooldown_timer'
    endif

    pushlist 'mage_bot_timers' 'heal_pets_timer'
    pushlist 'mage_bot_timers' 'ress_pets_timer'


    # start each timer with a high value since most actions we want to execute on first runs
    foreach timer in 'mage_bot_timers'
        if not timerexists timer
            createtimer timer
            settimer timer 99999
        endif
    endfor

    # ZERO THE TIMERS OF ACTIONS WE DONT WANNA EXECUTE RIGHTAWAY
    settimer 'holding_target_warning_msg' 0
    settimer 'waiting_summon_timer' 0
    settimer 'waiting_spell_timer' 0
    settimer 'waiting_target_timer' 0
    settimer 'script_stats_msg_timer' 0
    # settimer 'mana_drain_timer' mana_drain_delay
    # settimer 'curse_timer' curse_delay
    # settimer 'ma_timer' ma_delay
    # settimer 'harm_timer' harm_delay
    # settimer 'fireball_timer' fireball_delay
    # settimer 'lightning_timer' lightning_delay
    # settimer 'chain_lightning_timer' lightning_delay
    # settimer 'meteor_swarm_timer' lightning_delay
    # settimer 'earthquake_timer' lightning_delay
    # settimer 'eb_timer' eb_delay
    # settimer 'medit_msg_timer' 1000
    # settimer 'auto_get_new_targets_timer' 1000
    # settimer 'get_new_target_msg' 120000
    # settimer 'all_guard_timer' all_guard_delay
    # settimer 'all_patrol_timer' all_patrol_delay
    # settimer 'lure_mob_closer_timer' 5000
    # settimer 'script_running_warning_msg_timer' 2000
    # settimer 'use_mushroom_timer' use_mushroom_delay
    settimer 'spirit_speak_cooldown_timer' 1000


    setvar! timers_setup_done 1
    setvar! setup_timers_execution_time setup_timers_timer
    sysmsg '>> FINISHED TIMERS IN {{setup_timers_timer}} ms' script_msg_color
endif

if debug == 1
    settimer 'script_stats_msg_timer' 0
endif

#######################################################
# CHAR BASED CUSTOMIZATIONS
#######################################################

if name == 'Neron'
    sysmsg '[OPTS] APPLYING CONFIG FOR Neron' script_msg_color
    setvar! debug 1
    setvar! use_incognito 0
    setvar! juggle_mode 0
    setvar! auto_patrol_when_no_active_lasttarget 1
    setvar! auto_rail 0
    setvar! lure_mobs_closer_before_killing 1
    setvar! boating_mode 1
endif

if name == 'gugutz'
    sysmsg '[OPTS] APPLYING CONFIG FOR gugutz' script_msg_color
    setvar! debug 1
    setvar! use_incognito 0
    setvar! juggle_mode 0
    setvar! auto_patrol_when_no_active_lasttarget 1
    setvar! auto_rail 0
    setvar! lure_mobs_closer_before_killing 1
    setvar! use_ma 1
    setvar! auto_skin_corpses 1
    setvar! use_harm 1
    setvar! use_fireball 1
    setvar! use_lightning 1
    setvar! use_mind_blast 1
    setvar! use_eb 0
    setvar! use_flamestrike 0
    setvar! use_pain_spike 0
    setvar! use_chain_lightning 0
    setvar! use_meteor_swarm 0
    setvar! use_earthquake 0
endif

# BUGUEI SETTINGS
if name == 'Yorixiriamori-'
    sysmsg '[OPTS] APPLYING CONFIG FOR Yorixiriamori-' script_msg_color
    setvar! boating_mode 0
    setvar! use_mind_blast 0
    setvar! use_fireball 1
    setvar! use_incognito 1
    setvar! auto_get_new_targets 0
    setvar! kill_close_to_loot 0
endif



#######################################################
## FINAL CHECKS AND WARNINGS BEFORE STARTING
#######################################################

# if were on a boat, activate boat mode if its not already on
if not varexist tillerman or varexist tillerman and not find tillerman ground any any 12
    if findtype 'tillerman' ground as found
        sysmsg '[BOAT] TILLERMAN SET!' boating_msg_color
        overhead "tillerman set!" boating_msg_color
        setvar tillerman found
        setvar! boating_mode 1

        dclick tillerman
        wait action_delay
    endif
endif

if skill 'taming' > 0
    if auto_summon == 1
        sysmsg 'CHAR IS TAMER. DISABLING AUTO SUMMON' 39
        setvar! auto_summon 0
    endif

    # for tamers we dont want the char to think its under max summons right?
    setvar! followers_max_limit 1
endif


if auto_configure_script_based_on_skills == 1
    if skill 'herding' == 0 and auto_herd_mobs == 1
        sysmsg '[OPTIONS] DISABLING auto_herd_mobs' script_msg_color
        setvar! auto_herd_mobs 0
    elseif skill 'herding' > 0 and auto_herd_mobs == 0
        sysmsg '[OPTIONS] ENABLING auto_herd_mobs' script_msg_color
        setvar! auto_herd_mobs 1
    endif

    if skill 'necromancy' == 0 use_undead_summons == 1
        sysmsg '[OPTIONS] DISABLING use_undead_summons' script_msg_color
        setvar! use_undead_summons 0
    elseif skill 'necromancy' > 0 and use_undead_summons == 0
        sysmsg '[OPTIONS] ENABLING auto_herd_mobs' script_msg_color
        setvar! use_undead_summons 1
    endif
endif

# WARN IF SET TO HIDE VALUABLES BUT NO CHAR_LOOT_POUCH SET
if hide_valuables_in_CHAR_LOOT_POUCH == 1
    if not varexist CHAR_LOOT_POUCH
        sysmsg 'LOOT POUCH IS NOT SET. PLEASE SELECT A POUCH TO HIDE VALUABLE LOOT:' warning_msg_color
        setvar CHAR_LOOT_POUCH
    elseif varexist CHAR_LOOT_POUCH and not find CHAR_LOOT_POUCH backpack
        sysmsg 'CANT FIND PREVIOUSLY SET LOOT POUCH. PLEASE SELECT A NEW ONE:' warning_msg_color
        setvar CHAR_LOOT_POUCH
    endif
endif



#######################################################
# TAMER PRE START ROUTINE
#######################################################

if skill 'taming' >= 100
    sysmsg "SCANNING FOR PLAYER PETS"
    @createlist 'player_pets'
    createlist 'player_tank_pets'
    createlist 'player_ranged_pets'

    # foreach pet in 'tank_pets'
        # using 5 here cause thats the max ammount of pets of the same graphic a player can have
        #
    while findtype 293|60|61|385|60|61|776|293|213|169|718|51|315|61|60|718|729|12|59|51|12|59|388 ground any 5 find_pet_range as pet
        if noto pet = friend
            overhead 'found tank pet!' 55 pet
            if not inlist 'player_pets' pet
                @pushlist 'player_pets' pet
            endif
            if not inlist 'player_tank_pets' pet
                @pushlist 'player_tank_pets' pet
            endif
            # ignore for now so razor cant find it anymore and we can leave the while loop
        endif
        @ignore pet
    endwhile
    @clearignore

    # using 5 here cause thats the max ammount of pets of the same graphic a player can have
    while findtype 832|287|2466 ground any 5 find_pet_range as pet
        if noto pet = friend and not inlist 'player_pets' pet
            overhead 'found ranged pet!' 55 pet
            @pushlist 'player_ranged_pets' pet
            @pushlist 'player_pets' pet
            # ignore for now so razor cant find it anymore and we can leave the while loop
        endif
        @ignore pet
    endwhile
    @clearignore
endif


#######################################################
# BOATING PRE START ROUTINE
#######################################################

# TRY TO DETECT IF WE ARE STARTING INSIDE A BOAT AND IF SO, SAVE MY BOAT HULL STATUS BAR AND ENABLE boating_mode
if varexist CHAR_BOAT_STATUS_BAR
    if debug == 1
        sysmsg 'CHAR BOAT STATUS BAR VAR EXISTS: {{CHAR_BOAT_STATUS_BAR}}!' boating_msg_color
    endif

    if not find CHAR_BOAT_STATUS_BAR ground any any 12
        if verbose == 1
            sysmsg 'CANT FIND SAVED BOAT. TRYING TO SPIN THE BOAT TO FIND IT!' boating_msg_color
        endif

        say 'turn right'
        wait action_delay
        if not find CHAR_BOAT_STATUS_BAR ground any any 12
            unsetvar CHAR_BOAT_STATUS_BAR
        endif
    else
        if verbose == 1
            sysmsg 'CHAR SAVED BOAT FOUND: {{CHAR_BOAT_STATUS_BAR}}!' boating_msg_color
        endif
    endif
endif

if not varexist CHAR_BOAT_STATUS_BAR
    if debug == 1
        sysmsg '[DEBUG] CHAR BOAT VAR DONT EXIST! SEARCHING STATUS BARS ' boating_msg_color
    endif

    createlist 'status_bars'
    clearlist 'status_bars'

    if findtype 'status bar' ground HULL_STATUS_BAR_COLOR any as found
        setvar CHAR_BOAT_STATUS_BAR found
        sysmsg 'FOUND HULL STATUS BAR {{found}}' boating_msg_color
    else
#         sysmsg 'CANT FINDTYPE STATUS BAR. SELECT YOUR BOAT HULL STATUS BAR' 90
#         setvar CHAR_BOAT_STATUS_BAR
#         wft action_delay
#         while targetexists 'neutral'
#             wait 10
#             sysmsg 'waiting to select boat status bar' 54
#         endwhile
#
#         if not varexist CHAR_BOAT_STATUS_BAR and boating_mode == 1
        if boating_mode == 1
            if verbose == 1
                sysmsg 'CANT FIND BOAT. DISABLING BOAT MODE' alert_msg_color
            endif

            setvar! boating_mode 0
        endif
        # else
        #     sysmsg 'BOAT STATUS BAR SET!'
        #     setvar! boating_mode 1
        # endif
    endif
endif


# MY BOAT HATCH
if boating_mode == 1
    if varexist CHAR_BOAT_HATCH
        sysmsg 'CHAR BOAT HATCH VAR EXISTS: {{CHAR_BOAT_HATCH}}!' boating_msg_color
        if find CHAR_BOAT_HATCH ground any any 12
            sysmsg 'CHAR SAVED HATCH FOUND!' boating_msg_color
        else
            sysmsg 'CHAR SAVED HATCH CANT BE FOUND. TRYING TO SPIN THE BOAT!' boating_msg_color
            say 'turn right'
            wait action_delay
            if not find CHAR_BOAT_HATCH ground any any 12
                unsetvar CHAR_BOAT_HATCH
            endif
        endif
    endif

    if not varexist CHAR_BOAT_HATCH
        sysmsg 'CHAR BOAT HATCH VAR DONT EXIST!' boating_msg_color
        if debug == 1
            sysmsg 'SEARCHING HATCH' boating_msg_color
        endif
        createlist 'boat_hatches'
        clearlist 'boat_hatches'

        if findtype 'hatch' ground any any as found
            sysmsg 'FOUND CHAR BOAT HATCH {{found}}' boating_msg_color
            setvar CHAR_BOAT_HATCH found
        else
            sysmsg 'CANT FINDTYPE HATCH. SELECT YOUR BOAT HATCH' 90
            setvar CHAR_BOAT_HATCH
            wft action_delay

            while targetexists 'neutral'
                wait 10
                sysmsg 'waiting to select boat status bar' 54
            endwhile

            if not varexist CHAR_BOAT_HATCH and boating_mode == 1
                sysmsg 'CANT FIND BOAT HATCH!!!!!'
            else
                sysmsg 'BOAT HATCH SET: {CHAR_BOAT_HATCH}!'
            endif
        endif
    endif
endif

# MY BOAT CREW!

if boating_mode == 1
    if not listexists 'ship_crew'
        createlist 'ship_crew'
    endif

    # check if need to remake ship crew list
    foreach member in 'ship_crew'
        if not find member ground any any 15
            sysmsg 'CANT FIND CREW MEMBER {{member}}' boating_msg_color
            clearlist 'ship_crew'
        endif
    endfor

    if list 'ship_crew' == 0
        sysmsg 'SEARCHING FOR CREW MEMBERS' boating_msg_color

        for 7
            hotkey 'Next Friendly Monster Target'
            # wait action_delay
            setvar! temp_serial lasttarget
            getlabel temp_serial label

            if noto temp_serial != hostile
                if 'elemental' in label or 'lich' in label or 'mummy' in label or 'vampire' in label
                elseif not inlist 'ship_crew' temp_serial
                    overhead 'found crew member!' boating_msg_color
                    sysmsg 'FOUND CREW MEMBER: {{label}}!' boating_msg_color

                    pushlist 'ship_crew' temp_serial
                endif
            endif
        endfor
    endif
endif

# boating mode related options
if boating_mode == 1
    sysmsg 'OPTIMIZING SCRIPT FOR BOATING' warning_msg_color
    setvar! use_curse 0
    setvar! use_mass_curse 1
    setvar! use_protection 0
    setvar! use_arch_protection 1
    setvar! kill_close_to_loot 0

    clearlist 'summons'
    pushlist 'summons' 'an earth elemental'
    pushlist 'summons' 'a fire elemental'
    pushlist 'summons' 'summ. creature'
endif


# open necro hotbar on start
if skill 'necromancy' > 0 and not gumpexists necromancy_gump_id
    sysmsg 'Opening Necro Hotbar...' 100
    say '[necromancyhotbar'
endif


# SET CURRENT RAIL INDEX TO 0 IF FIRST RUN
if auto_rail == 1 and not varexist first_run_done
    setvar! current_rail_index 0
endif


# PACKIES PRE START SETUP
if auto_unload_items_in_pack_animal == 1
    if varexist pack_animal
        if not find pack_animal ground 0 any 5
            setvar! recreate_packies_list true
        endif
    else
        setvar! recreate_packies_list true
    endif
    
    
    # ONLY START THIS ROUTINE IF CHAR HAS FOLLOWERS AND WE FIND EITHER A PACK LLAMA OR HORSE NEARBY
    if followers > 0 and findtype 292 ground 0 any 5 as llama or findtype 291 ground 0 any 5 as horse
        if varexist recreate_packies_list
            if debug == 1
                sysmsg '[DEBUG] RECREATING PACKIES LIST' debug_msg_color
            endif
    
            unsetvar! recreate_packies_list
            unsetvar! pack_animal
    
            # FIND AND SAVE PLAYER LLAMA
            if findtype 292 ground 0 any 5 as llama
                overhead 'scanning' 55 llama
                if noto llama == noto 'self'
                    setvar! pack_animal llama
                    overhead 'found player llama' 55 pack_animal
                endif
            elseif findtype 291 ground 0 any 5 as horse
                overhead 'scanning' 55 horse
                if noto horse == noto 'self'
                    setvar! pack_animal horse
                endif
            endif
    
            if varexist pack_animal
                sysmsg "FOUND PLAYER PACK LLAMA" 55
                overhead "found and saving llama!" 55 'self'
                overhead 'found player llama' 55 pack_animal
    
                overhead '*renaming*' 55 pack_animal
                rename pack_animal 'i'
                menu pack_animal 4
                sysmsg '>>> Comanding pack animal to follow char...' 56
                say 'i follow me'
            else
                sysmsg '>>> COULD NOT FIND ANY PACK ANIMALS CLOSE.' 56
                sysmsg '****** IMPORTANT: ******' 90
                sysmsg '>>> YOU SHOULD BE WITHIN 5 TILES OF YOUR LLAMA SO THE SCRIPT CAN FIND AND SAVE IT!' 56
            endif
        endif
    endif
endif


# IF OFFENSIVE MODE IS ON, TRY TO GET A TARGET SO WE CAN SKIP THE BUFFS AND ATTACK ASAP
if offensive_mode == 1 and auto_get_new_targets == 1 and keep_getting_closest_target == 1
        # sysmsg '[OFFENSIVE MODE] GETTING CLOSEST TARGET' action_msg_color

    hotkey 'Target Closest Non-Friendly Monster'
endif


# all guard right now so summons protect char if we start script in the middle of a fight
say 'all guard me'


#############################
# SET THE HOME BOOK
#############################

# search runetomes first
while findtype 'runetome' backpack as found
    getlabel found rtome_label
    if 'home' in rtome_label or 'Home' in rtome_label or 'HOME' in rtome_label
        sysmsg 'FOUND HOME RUNETOME {{rtome}}' 54
        setvar! home_book rtome
        setvar! home_book_gump_id 167090027
        setvar! home_rune_btn_number runetome_rune_position
    endif

    @ignore found
endwhile
@clearignore

# if we couldnt find a home runetome, search for a home runebook
if not varexist home_book
    while findtype 'runebook' backpack as found
        getlabel found rbook_label
        if 'home' in rbook_label or 'Home' in rbook_label or 'HOME' in rbook_label
            sysmsg 'FOUND HOME RUNEBOOK {{rtome}}' 54
            setvar! home_book rtome
            setvar! home_book_gump_id 167090027
            setvar! home_rune_btn_number runetome_rune_position
        endif

        @ignore found
    endwhile
    @clearignore
endif

if recall_home_to_restock == 1 and not varexist home_book
    sysmsg "YOU NEED A RUNEBOOK OR RUNETOME NAMED 'HOME' WITH YOUR HOME RUNE SET TO DEFAULT TO RUN THIS SCRIPT" 54
    stop
endif


#############################
# RUNEBOOK / RUNETOME RECALL SETTINGS
#############################

setvar! recall_home_now 0
setvar! runetome_gump_id 167090027
setvar! runebook_gump_id 1551740969

setvar! recall_travel_time 3000

setvar! 1st_circle_spell_mana_cost 8
setvar! 2nd_circle_spell_mana_cost 9
setvar! 3rd_circle_spell_mana_cost 10
setvar! 4th_circle_spell_mana_cost 12

# runetomes recall via scroll buttons have a interval of 6, so first button is 2, second is 8, and so on...
if not listexists 'runetome_page_numbers'
    createlist 'runetome_page_numbers'

    # runetome page 1
    # we dont push the first rune since its the home rune
    pushlist 'runetome_page_numbers' 200
    pushlist 'runetome_page_numbers' 201
    pushlist 'runetome_page_numbers' 202
    pushlist 'runetome_page_numbers' 203
    pushlist 'runetome_page_numbers' 204
    pushlist 'runetome_page_numbers' 205
    pushlist 'runetome_page_numbers' 206
    pushlist 'runetome_page_numbers' 207
    pushlist 'runetome_page_numbers' 208
    pushlist 'runetome_page_numbers' 209
    pushlist 'runetome_page_numbers' 210
    pushlist 'runetome_page_numbers' 211
    pushlist 'runetome_page_numbers' 212
    pushlist 'runetome_page_numbers' 213
    
    # runetome page 2
    pushlist 'runetome_page_numbers' 214
    pushlist 'runetome_page_numbers' 215
    pushlist 'runetome_page_numbers' 216
    pushlist 'runetome_page_numbers' 217
    pushlist 'runetome_page_numbers' 218
    pushlist 'runetome_page_numbers' 219
    pushlist 'runetome_page_numbers' 220
    pushlist 'runetome_page_numbers' 221
    pushlist 'runetome_page_numbers' 222
    pushlist 'runetome_page_numbers' 223
    pushlist 'runetome_page_numbers' 224
endif




#######################################################
## BEGIN MAIN ROUTINE
#######################################################

sysmsg '### STARTING MAIN LOOP AT {{execution_timer}} ms' success_msg_color

while not dead 'self'

    if cycle_runetome_farming == 1
        foreach runebook in 'lumber_runebooks'
            sysmsg '>>> STARTING RUNEBOOK {{index}}: {{runebook}}'
        
            foreach page_number in 'runetome_page_numbers'
                if recall_home_now != 1
                    # travel to the rune
        
                    while mana <= 11
                        sysmsg 'MEDITATING TO RECALL' warning_msg_color
                        if not findbuff 'actively meditating'
                            skill meditation
                            wait action_delay
                        endif
                        wait action_delay
                    endwhile
        
                    sysmsg 'OPENING RUNEBOOK {{runebook}}'
                    dclick runebook
        
                    settimer 'waiting_runebook_gump_timer' 0
                    if not gumpexists runetome_gump_id and timer 'waiting_runebook_gump_timer' < 2000
                        if insysmsg 'You must wait'
                            while insysmsg 'You must wait'
                                clearsysmsg
                                dclick steal_container
                                wait action_delay
                            endwhile
                        endif
        
                        sysmsg 'waiting for runebook gump'
                        while not gumpexists runetome_gump_id and timer 'waiting_runebook_gump_timer' < 2000
                            waitforgump runetome_gump_id action_delay
                        endwhile
                    endif
        
                    if gumpexists runetome_gump_id
                        waitforgump runetome_gump_id action_delay
                        gumpresponse page_number runetome_gump_id
                        waitforgump runetome_gump_id action_delay
                        sysmsg 'TRAVELLING RUNEBOOK {{runebook}} PAGE NUMBER {{page_number}} RUNE: {{rune_number}}'
                        gumpresponse rune_number runetome_gump_id
                        wait recall_travel_time
                    else
                        sysmsg 'COULDNT OPEN RUNEBOOK TO TRAVEL!' 37
                    endif
                endif

                sysmsg 'SETTING NEXT RUNE'
                setvar! go_to_next_rune 0
                sysmsg 'GOING TO NEXT RUNE' 54
                # poplist 'runebook_rune_btns' 'front'
                # pushlist 'runebook_rune_btns' rune_number 'back'
                # say 'all follow me'


                ########################################
                # SET NEXT RUNE TO TRAVEL
                ########################################
                if rune_number == 10
                    setvar! rune_number 20
                elseif rune_number == 20
                    setvar! rune_number 10
                    poplist 'runetome_page_numbers' 'front'
                    pushlist 'runetome_page_numbers' page_number 'back'
                endif


                ########################################
                # SET NEXT RUNETOME PAGE
                ########################################

                poplist 'runetome_page_numbers' 'front'
                pushlist 'runetome_page_numbers' page_number 'back'

                ########################################
                # SET NEXT RUNETOME IF LAST PAGE OF CURRENT ONE
                ########################################

                if page_number == 224
                    sysmsg 'GOING TO NEXT RUNETOME'
                    poplist 'lumber_runetomes' 'front'
                    pushlist 'lumber_runetomes' page_number 'back'
                    say 'all follow me'
                    break
                endif


                # break
            endfor
        endfor
    endif


    setvar! iteration_number index

    if timer 'script_running_warning_msg_timer' >= 8000
        if verbose == 1
            sysmsg 'â˜… MAGE BOT by gugutz â™¥' script_msg_color
        endif

        settimer 'script_running_warning_msg_timer' 0
    endif

    # PRINT DEBUGGING STATS
    if first_run_done == 1 and timer 'script_debug_stats_msg_timer' >= 60000
        sysmsg 'SETTINGS SETUP: {{script_settings_execution_time}}' debug_msg_color
        sysmsg 'TIMERS SETUP: {{setup_timers_execution_time}}' debug_msg_color
        settimer 'script_debug_stats_msg_timer' 0
    endif

    # PRINT SCRIPT STATS
    if first_run_done == 1 and timer 'script_stats_msg_timer' >= 60000
        if verbose == 1
            sysmsg '#########################' 90
            sysmsg '# SCRIPT STATS:' warning_msg_color
            sysmsg 'âˆž Uptime: {{execution_timer}} ms' script_msg_color
            sysmsg 'âˆž Iterations: {{iteration_number}} ms' script_msg_color

            if use_mana_drain == 1
                sysmsg 'â–· Mana Drain Timer: {{mana_drain_timer}} ms' script_msg_color
            endif
            if use_curse == 1
                sysmsg 'â–· Curse Timer: {{curse_timer}} ms' 36
            endif
            if use_lightning == 1
                sysmsg 'â–· Lightning Timer: {{lightning_timer}} ms' 36
            endif
            if use_ma == 1
                sysmsg 'â–· Magic Arrow Timer: {{ma_timer}} ms' 36
            endif
            if use_harm == 1
                sysmsg 'â–· Harm Timer: {{harm_timer}} ms' 36
            endif
            if use_fireball == 1
                sysmsg 'â–· Fireball Timer: {{fireball_timer}} ms' 36
            endif
            if use_eb == 1
                sysmsg 'â–· Energy Bolt Timer: {{eb_timer}} ms' 36
            endif
            if use_eb == 1
                sysmsg 'â–· Energy Bolt Timer: {{eb_timer}} ms' 36
            endif
            if use_chain_lightning == 1
                sysmsg 'â–· Chain Lightning Timer: {{chain_lightning_timer}} ms' 36
            endif
            if use_meteor_swarm == 1
                sysmsg 'â–· Meteor Swarm Timer: {{meteor_swarm_timer}} ms' 36
            endif
            if use_earthquake == 1
                sysmsg 'â–· Earthquake Timer: {{earthquake_timer}} ms' 36
            endif


            if offensive_mode == 1
                sysmsg 'â–· Offensive Mode ON' success_msg_color
            endif

            if boating_mode == 1
                sysmsg 'â–· Boating Mode ON' boating_msg_color
                if varexist CHAR_BOAT_STATUS_BAR
                    sysmsg 'â–· Char Boat Status Bar: {{CHAR_BOAT_STATUS_BAR}}' boating_msg_color
                else
                    sysmsg 'â–· Char Boat Status Bar NOT FOUND' alert_msg_color
                endif

                if varexist CHAR_BOAT_HATCH
                    sysmsg 'â–· Char Boat Hatch: {{CHAR_BOAT_HATCH}}' boating_msg_color
                else
                    sysmsg 'â–· Char Boat Hatch NOT FOUND' alert_msg_color
                endif
            endif

            sysmsg '#########################' 90
        endif

        settimer 'script_stats_msg_timer' 0
    endif


    ########################################
    # TOGGLE OPTIONS IN GAME BY TURNING CHAR LIGHTSOURCE ON/OFF


    if findtype 2594|2598|2578|30580 self
        # sysmsg 'FOUND LIGHTSOURCE ON' debug_msg_color
        if auto_get_new_targets == 0
            sysmsg '[LANTERN] TURNING AUTO GET NEW TARGETS ON' script_msg_color
            setvar! auto_get_new_targets 1
        endif

    # LIGHT SOURCES OFF
    # dungeon torches have to be undressed (they have to be in the backpack since they cant be turned off)
    elseif findtype 2597|3947 self and not findtype 2597|3947 backpack or findtype 'dungeon torch' backpack
        # sysmsg 'FOUND LIGHTSOURCE OFF' debug_msg_color
        if auto_get_new_targets == 1
            sysmsg '[LANTERN] TURNING AUTO GET NEW TARGETS OFF' script_msg_color
            setvar! auto_get_new_targets 0
        endif
    endif


    # satchel equiped
    if findtype 'reagent satchel' self and not findtype 'reagent satchel' backpack
        # sysmsg '>>>>>> FOUND SATCHEL ON SELF' warning_msg_color
        if debug == 0
            sysmsg '[SATCHEL] TURNING debug ON' script_msg_color
            setvar! debug 1
        endif
        if verbose == 0
            sysmsg '[SATCHEL] TURNING verbose ON' default_sysmsg_color
            setvar! verbose 1
        endif
    # satchel not equiped (in backpack)
    elseif findtype 'reagent satchel' self and findtype 'reagent satchel' backpack
        # sysmsg '>>>>>> FOUND SATCHEL ON BACKPACK' debug_msg_color
        if debug == 1
            sysmsg '[SATCHEL] TURNING debug OFF' script_msg_color
            setvar! debug 0
        endif
        if verbose == 1
            sysmsg '[SATCHEL] TURNING verbose OFF' script_msg_color
            setvar! verbose 0
        endif
    endif

    ########################################
    # IF THERE ARE TARGETS OPENED, SPEND THEM
    # ACCORDING TO THEIR TYPE

    if targetexists 'beneficial'
        if auto_get_new_targets == 1 or hold_targets == 0
            overhead 'spending beneficial target' warning_msg_color
           hotkey 'Target Self'
        else
            overhead 'holding beneficial target' warning_msg_color
            while targetexists 'beneficial'
                if timer 'holding_target_warning_msg' > 2000
                    settimer 'holding_target_warning_msg' 0
                    sysmsg '>>> HOLDING BENEFICIAL TARGET' warning_msg_color
                    # hotkey 'Target Self'
                endif
            endwhile
        endif
    endif

    if targetexists 'neutral'
        # if auto target is on, we dont want any stuck open neutral target stopping the actions on the script so we spend the target
        if auto_get_new_targets == 1 or hold_targets == 0
            overhead 'canceling neutral target' warning_msg_color
            sysmsg '>>> CANCELING NEUTRAL TARGET' warning_msg_color
            hotkey 'Cancel Current Target'
        else
            overhead 'holding neutral target' warning_msg_color
            while targetexists 'neutral'
                if timer 'holding_target_warning_msg' > 2000
                    settimer 'holding_target_warning_msg' 0
                    sysmsg '>>> HOLDING NEUTRAL TARGET' warning_msg_color
                endif
            endwhile
        endif
    endif

    if targetexists 'harmful'
        if not dead 'last'
            if noto 'last' == hostile or noto 'last' == murderer or noto 'last' == criminal
                overhead 'spending harmful target' warning_msg_color
                sysmsg '>>> SPENDING HARMFUL TARGET' 99
                hotkey 'Last Target'
            endif
        else
            if auto_get_new_targets == 1
                overhead 'spending harmful target (dead last)' warning_msg_color
               hotkey 'Target Self'
            else
                overhead 'holding harmful target'
                while targetexists 'harmful'
                    if timer 'holding_target_warning_msg' > 2000
                        settimer 'holding_target_warning_msg' 0
                        sysmsg '>>> HOLDING HARMFUL TARGET' warning_msg_color
                        # targetrelloc 0 1
                    endif

                    # copied this part from bottom of script to get new targets if option is set
                    if auto_get_new_targets == 1 and timer 'auto_get_new_targets_timer' > 1000
                        if use_script_overhead_messages
                            overhead '*searching monsters to use target*' action_msg_color
                        endif
                        if verbose == 1
                            sysmsg '> SEARCHING MONSTERS TO USE HARMFUL TARGET...' action_msg_color
                        endif

                        hotkey 'Target Closest Non-Friendly Monster'

                        if get_players_on_auto_target == 1
                            overhead '*searching players*' action_msg_color
                            sysmsg '> SEARCHING PLAYERS...' action_msg_color
                            hotkey 'Next Grey Player Target'
                            # wait action_delay
                        endif
                        settimer 'auto_get_new_targets_timer' 0
                    elseif auto_get_new_targets == 0 and timer 'get_new_target_msg' > 4000
                        overhead 'waiting for new target' alert_msg_color
                        settimer 'get_new_target_msg' 0
                    endif

                    if not dead 'last' and noto 'last' == hostile or noto 'last' == criminal
                        hotkey 'Last Target'
                    endif
                endwhile
            endif
        endif
    endif


    ########################################
    # MOST IMPORTANT ROUTINE - KEEP SUMMONS UP!


    # CHOOSE CHARACTER SUMMONS

    # this is just a print to inform char is under summon_limit and is getting ready to summon up
    if auto_summon == 1 and followers < followers_max_limit
        if debug == 1
            sysmsg '[DEBUG] PREPARING TO RESUMMON' debug_msg_color
        endif

        if verbose == 1
            sysmsg 'UNDER SUMMON LIMIT. PREPARING TO SUMMON...' alert_msg_color
        endif




        foreach summon in 'summons'

            if debug == 1
                sysmsg 'CHECKING {{summon}}: {{index}}' default_sysmsg_color
            endif

            if list 'summons' == 1 and followers == 4
                if verbose == 1
                    sysmsg 'SUMMONS LIST ONLY HAS 1 SUMMON TYPE AND CHAR ALREADY HAVE 4 HAVE FOLLOWERS {{summon}}' warning_msg_color
                endif

                if debug == 1
                    sysmsg 'BREAKING 1 ON CHECKING SUMMON {{summon}}' warning_msg_color
                endif
                break
            elseif list 'summons' > 1 and followers == 5
                if verbose == 1
                    sysmsg 'SUMMONS LIST ONLY HAS 1 SUMMON TYPE AND CHAR ALREADY HAVE 5 HAVE FOLLOWERS {{summon}}' warning_msg_color
                endif

                if debug == 1
                    sysmsg 'BREAKING 2 ON CHECKING SUMMON {{summon}}' warning_msg_color
                endif
                break
            endif

            unsetvar! found_summon
            unsetvar! cast_summon_spell

            # determine summon name by whether char has necromancy or not
            if use_undead_summons == 1
                # on each iteration, clear and populate this list to set the undead alternative summon based on current summon
                if not listexists 'undead_summons'
                    createlist 'undead_summons'
                endif
                clearlist 'undead_summons'

                if 'earth' in summon
                    pushlist 'undead_summons' 'an ancient mummy'
                elseif 'fire' in summon
                    pushlist 'undead_summons' 'a lich'
                elseif 'air' in summon
                    pushlist 'undead_summons' 'a skeletal fiend'
                elseif 'daemon' in summon
                    pushlist 'undead_summons' 'a vampire thrall'
                elseif 'water' in summon
                    pushlist 'undead_summons' 'a rag witch'
                endif
            endif

            # if char is necro, make sure vengeful spirit is activated before summoning
            if list 'undead_summons' > 0
                if timer 'vengeful_spirit_timer' >= 30000
                    if verbose == 1
                        sysmsg '>>> VENGEFUL SPIRIT...' spell_msg_color
                    endif
                    say '[vengefulspirit'

                    wait action_delay

                    if verbose == 1
                        sysmsg '>>> WITHER...' spell_msg_color
                    endif

                    say '[wither'
                    settimer 'vengeful_spirit_timer' 0
                else
                    if verbose == 1
                        sysmsg 'Vengeful Spirit Cooldown..' on_cooldown_msg_color
                    endif
                endif
            endif

            #########################
            # try to find a similir creature summon to see if we need to cast this one or skip to next one


            if findtype summon ground any 1 find_summon_range as summonserial
                if noto summonserial = friend
                    if verbose == 1
                        overhead '*found {{summon}}*' 91 summonserial
                    endif

                    setvar! found_summon true
                endif
            # if the 'undead_summons' list has elements, we need to check for those undead summons as well
            elseif list 'undead_summons' > 0
                foreach necro_summon in 'undead_summons'
                    if findtype necro_summon ground any 1 find_summon_range as summonserial
                        if noto summonserial = friend
                            overhead '*found {{summon}}*' 91 summonserial
                            setvar! found_summon true

                            # TESTING HERE (this break was disabled before)
                            # break
                        endif
                    endif
                endfor
            endif

            # even if we found this summon type, we still might need to cast it (if only 1 summon in list for instance)
            if varexist found_summon
                # clearlist 'found_summon'

                # if theres only one summon in the 'summons' list, even if we found the summon above,
                # we still need to cast it again
                if list 'summons' == 1 and followers < 4
                    setvar! cast_summon_spell true
                # if one of our summons is summ creature and we only have 3 followers, we can still cast another more usefull
                # summon before actually casting summ.creature
                elseif list 'summons' == 2 and followers <= 3 and inlist 'summons' 'summ. creature'
                    setvar! cast_summon_spell true
                elseif list 'summons' >= 3 and followers <= 1
                    setvar! cast_summon_spell true
                # else if theres more than one summon in 'summons' list and we didnt find this specific summon
                # we need to cast ig
                endif
            else
                if debug == 1
                    sysmsg '[DEBUG] setting to cast summon spell (summon not found)' debug_msg_color
                endif
                setvar! cast_summon_spell true
            endif

            #########################
            # prepare to cast the summon spell for this summon
            if varexist cast_summon_spell


                foreach summonspell in 'summonspells'

                    if summonspell in summon

                        unsetvar! summon_spell_required_mana

                        # first make a mana check for this specific summon spell
                        if 'creature' in summonspell or 'blade' in summonspell
                            setvar! 'summon_spell_required_mana' 14
                        else
                            setvar! 'summon_spell_required_mana' 50
                        endif

                        if varexist summon_spell_required_mana
                            if mana < summon_spell_required_mana

                                if timer 'low_mana_for_summoning_warning_msg_timer' >= 2000
                                    if verbose == 1
                                        sysmsg "!!! LOW MANA FOR SUMMONING {{summon}}. (NEEDS {{summon_spell_required_mana}})..." alert_msg_color
                                        overhead "low mana for summoning" alert_msg_color
                                    endif

                                    settimer 'low_mana_for_summoning_warning_msg_timer' 0
                                endif
                            else
                                if verbose == 1
                                    sysmsg ">>> SUMMONING {{summon}}..." action_msg_color
                                endif
                                cast summonspell

                                if 'blade' in summonspell or 'vortex' in summonspell
                                    if verbose == 1
                                        sysmsg 'WAITING FOR {{summonspell}} TARGET..' alert_msg_color
                                        overhead 'Waiting for {{summonspell}} target..' alert_msg_color
                                    endif

                                    @settimer 'waiting_summon_timer' 0
                                    while not targetexists 'neutral' and timer 'waiting_summon_timer' < cast_summons_delay
                                        wft 10
                                        if insysmsg 'disturbed'
                                            @settimer 'waiting_summon_timer' 0
                                            if verbose == 1
                                                sysmsg 'BREAKING WHILE WAITING FOR SUMMONING {{summon}}' alert_msg_color
                                            endif

                                            wait spell_recovery_delay
                                            break
                                        endif
                                    endwhile

                                    if targetexists 'neutral'
                                        if verbose == 1
                                            sysmsg 'CASTING BLADE OR VORTEX IN GROUND' 55
                                        endif

                                        targetrelloc 0 1
                                        break
                                    endif
                                else
                                    @settimer 'waiting_summon_timer' 0
                                    while timer 'waiting_summon_timer' < cast_summons_delay
                                        wait 10
                                        if insysmsg 'disturbed'
                                            @settimer 'waiting_summon_timer' 0
                                            if verbose == 1
                                                sysmsg 'BREAKING WHILE WAITING FOR SUMMONING {{summon}}' alert_msg_color
                                            endif

                                            wait spell_recovery_delay
                                            break
                                        endif
                                    endwhile

                                    say 'all guard me'
                                endif

                                break

                            endif
                        endif


                    endif

                endfor
            endif


        endfor
    endif

    # if debug == 1
        # sysmsg '[DEBUG] AFTER AUTO-SUMMON ROUTINE' debug_msg_color
    # endif

    # keep draining corpses within 10 tile range
    if followers >= followers_max_limit and diffhits < max_diffhits_before_buffing
        if offensive_mode == 1 and dead lasttarget or offensive_mode == 0
            if auto_spirit_speak == 1 and skill 'spirit' > 0 and use_undead_summons == 0
                if timer 'spirit_speak_cooldown_timer' > 1000
                    settimer 'spirit_speak_cooldown_timer' 0
                    if findtype 'corpse' ground any any 10 as body
                        if not inlist 'drained_corpses' body
                            if verbose == 1
                                sysmsg '>>> DRANING NEARBY CORPSES' action_msg_color
                                overhead '*spirit speak*' action_msg_color
                            endif

                            skill 'spirit'
                            # avoiding using global ignore here, switching to list control to avoid imprevisiblities
                            @pushlist 'drained_corpses' body
                            wait action_delay
                            # @ignore body
                        endif
                    endif
                endif
            endif
        else
            if verbose == 1
                # sysmsg '[OFFENSIVE MODE] SKIPPING SPIRIT SPEAK...' warning_msg_color
            endif
        endif
    endif

    # keep draining corpses within 10 tile range
    if followers >= followers_max_limit and diffhits < max_diffhits_before_buffing
        if offensive_mode == 1 and dead lasttarget or offensive_mode == 0
            if auto_vampiric_embrace == 1 and skill 'necromancy' > 0
                # if timer 'vampiric_embrace_cooldown_timer' >= 30000
                if not cooldown 'Necro Ability'
                    if findtype 'corpse' ground any any 10 as body
                        if verbose == 1
                            sysmsg '>>> VAMPIRIC EMBRACE' spell_msg_color
                        endif

                        say '[vampiricembrace'
                        wft action_delay
                        if targetexists 'neutral'
                            if verbose == 1
                                sysmsg '>>> CONSUMING NEARBY CORPSE...' action_msg_color
                                overhead '*consuming corpse*' default_overhead_color
                            endif
                            # target body
                            # TESTING trade target body to target self to avoid locking char trying to consume an out of sight body like one in another room
                            hotkey 'Target Self'
                            wait action_delay
                            settimer 'vampiric_embrace_cooldown_timer' 0

                            if debug == 1
                                sysmsg 'RESETING LAST AFTER CONSUMING CORPSE' reset_timer_msg_color
                            endif

                            hotkey 'Set Last Target (Harmful)'
                            wft action_delay
                            target last_target_serial
                        endif

                    endif
                else
                    # if verbose == 1
                    #     sysmsg '... VAMPIRIC EMBRACE COOLDOWN' on_cooldown_msg_color
                    # endif
                endif
            endif
        else
            if verbose == 1
                # sysmsg '[OFFENSIVE MODE] SKIPPING VAMPIRIC EMBRACE...' warning_msg_color
            endif
        endif
    endif


    ########################################
    # TAMER MOST IMPORTANT ROUTINE - KEEP RESSING PETS
    ########################################

    if varexist auto_ress_pets
        if timer 'ress_pets_timer' >= ress_pets_delay
            settimer 'ress_pets_timer' 0
            foreach pet in 'player_pets'
                if find pet ground any 1 15
                    if dead pet and diffhits <= 10
                        sysmsg "ACHOU DEAD PET PORRA!"
                        # use context menu to give the 'follow' command to this pet
                        menu pet 4
                        if is_veterinarian == 1
                            if findtype 'veterinary supplies' backpack as supplies
                                overhead '>>> TRYING TO RESS PET WITH VET SUPPLIES' 55 pet
                                useobject supplies
                                waitforsysmsg 'begin using veterinary supplies' action_delay

                                if insysmsg 'You do not have any living followers close'
                                    clearsysmsg
                                    sysmsg 'PETS FAR! CALLING THEM CLOSER...' 54
                                    say 'all follow me'
                                endif

                            elseif findtype 'clean bandage%s%' backpack as bands
                                overhead '>>> TRYING TO RESS PET WITH BANDAGES' 55 pet
                                useobject bands
                                wft 600
                                if targetexists 'beneficial'
                                    overhead '*ressing with bands*' 55 pet
                                    target pet
                                endif
                            else
                                sysmsg "NO BANDAGES TO RESS PET!" 55
                            endif
                        endif

                        if skill 'magery' > 90 or skill 'veterinary' > 90 and not findtype 'veterinary supplies' backpack and not findtype 'clean bandage%s%' backpack
                            if mana > 50
                                overhead '>>> TRYING TO RESS PET WITH MAGERY' 55 pet
                                cast 'resurrection'
                                @settimer 'waiting_target_timer' 0
                                while not targetexists 'beneficial' and timer 'waiting_target_timer' < 8000
                                    wft 100
                                    if insysmsg 'disturbed'
                                        sysmsg 'BREAKING WHILE WAITING FOR RESS TARGET'
                                        break
                                    endif
                                endwhile
                                wait 150
                                if targetexists 'beneficial'
                                    overhead 'ressing with magery' 55 pet
                                    target pet
                                endif
                            else
                                overhead '*no mana to ress*' 55 petserial
                                overhead '*no mana to ress pet*' 55 'self'
                                while mana < 50 and not findbuff 'actively meditating'
                                    useskill 'meditation'
                                    wait 500
                                endwhile
                                while findbuff 'actively meditating' and mana < 50
                                    if timer 'medit_msg_timer' >= 2000
                                        sysmsg '>>> MEDITATING TO RESS PET...'
                                        overhead 'meditating to ress pet'
                                        settimer 'medit_msg_timer' 0
                                    endif
                                endwhile
                            endif
                        endif
                    endif
                endif
            endfor
        endif
    endif

    ########################################
    # KEEP HEALING PETS
    ########################################

    if is_veterinarian == 1
        if auto_heal_pets == 1 and not targetexists 'any'
            if not cooldown Bandage
                if findtype 'veterinary supplies' as vet_supplies
                    settimer 'heal_pets_timer' 0
                    useobject vet_supplies
                    if verbose == 1
                        sysmsg ">>> USING VET SUPPLIES ON PET" 55
                        overhead '*vetting*' 75 pet
                        overhead '*vetting player pet*' 75 'self'
                    endif
                # elseif findtype 'clean bandage%s%' as bands
                #     useobject bands
                #     wft 1000
                #     if targetexists 'beneficial'
                #         overhead '*bandaging...*' 55 pet
                #         sysmsg ">>> BANDAGING PET" 55
                #         target pet
                #     endif
                endif
            endif
        endif
    endif


    ########################################
    # KEEP CHAR BUFFED UP
    ########################################


    # reflect buff
    if followers >= followers_max_limit and diffhits < max_diffhits_before_buffing
        if offensive_mode == 1 and dead lasttarget or offensive_mode == 0
            if use_magic_reflection == 1 and not findbuff 'magic reflection' and mana >= 4th_circle_spell_mana_cost
                if verbose == 1
                    sysmsg '>>> MAGIC REFLECT' spell_msg_color
                endif
                cast 'magic reflection'

                @settimer 'waiting_spell_timer' 0
                while not findbuff 'magic reflection' and timer 'waiting_spell_timer' < 3000
                    wait 10
                    if insysmsg 'disturbed' or insysmsg 'spell will not adhere' or insysmsg 'cannot cast a spell'
                        if verbose == 1
                            sysmsg 'BREAKING WHILE WAITING FOR MAGIC REFLECTION' warning_msg_color
                        endif
                        wait spell_recovery_delay
                        break
                    endif
                endwhile

                wait spell_recovery_delay

                if findbuff 'magic reflection'
                    overhead '+MAGIC REFLECT' buff_msg_color
                endif
            endif
        else
            if verbose == 1
                # sysmsg '[OFFENSIVE MODE] SKIPPING MAGIC REFLECTION...' warning_msg_color
            endif
        endif
    endif

    # reactive armor buff
    if followers >= followers_max_limit and diffhits < max_diffhits_before_buffing
        if offensive_mode == 1 and dead lasttarget or offensive_mode == 0
            if use_reactive_armor == 1 and not findbuff 'reactive armor' and mana >= 3rd_circle_spell_mana_cost
                if verbose == 1
                    sysmsg '>>> REACTIVE ARMOR' spell_msg_color
                endif

                cast 'reactive armor'
                @settimer 'waiting_spell_timer' 0
                while not findbuff 'reactive armor' and timer 'waiting_spell_timer' < 2000
                    wait 10
                    if insysmsg 'disturbed' or insysmsg 'spell will not adhere' or insysmsg 'cannot cast a spell'
                        if verbose == 1
                            sysmsg 'BREAKING WHILE WAITING FOR REACTIVE ARMOR' warning_msg_color
                        endif

                        wait spell_recovery_delay
                        break
                    endif
                endwhile

                wait spell_recovery_delay

                if findbuff 'reactive armor'
                    overhead '+reactive' buff_msg_color
                endif
            endif
        else
            if verbose == 1
                # sysmsg '[OFFENSIVE MODE] SKIPPING REACTIVE ARMOR...' warning_msg_color
            endif
        endif
    endif

    # PROTECTION ARMOR BUFF
    if followers >= followers_max_limit and diffhits < max_diffhits_before_buffing
        if offensive_mode == 1 and dead lasttarget or offensive_mode == 0
            if use_protection == 1 and not findbuff 'protection' and mana >= 2nd_circle_spell_mana_cost
                if verbose == 1
                    sysmsg '>>> PROTECTION' spell_msg_color
                endif

                cast 'protection'

                @settimer 'waiting_spell_timer' 0
                while not findbuff 'protection' and timer 'waiting_spell_timer' < 1500
                    wait 10
                    if insysmsg 'disturbed' or insysmsg 'spell will not adhere' or insysmsg 'cannot cast a spell'
                        if verbose == 1
                            sysmsg 'BREAKING WHILE WAITING FOR PROTECTION' warning_msg_color
                        endif

                        wait spell_recovery_delay
                        break
                    endif
                endwhile

                wait spell_recovery_delay

                if findbuff 'protection'
                    overhead '+PROTECTION' buff_msg_color
                endif
            # OR ARCH PROTECTION
            elseif use_arch_protection == 1 and not findbuff 'protection' and mana >= 4th_circle_spell_mana_cost

                @settimer 'waiting_target_timer' 0
                while not targetexists 'neutral' and timer 'waiting_spell_timer' < 4000
                    wft 100
                    if insysmsg 'disturbed' or insysmsg 'spell will not adhere' or insysmsg 'cannot cast a spell'
                        if verbose == 1
                            sysmsg 'BREAKING WHILE WAITING FOR ARCH PROTECTION TARGET' warning_msg_color
                        endif

                        wait spell_recovery_delay
                        break
                    endif
                endwhile

                if targetexists 'neutral'
                    hotkey 'Target Self'
                    wait 100
                endif

                wait 150
                if findbuff 'protection'
                    if verbose == 1
                        overhead '+arch protection' buff_msg_color
                    endif
                endif
            endif
        else
            if verbose == 1
                # sysmsg '[OFFENSIVE MODE] SKIPPING PROTECTION...' warning_msg_color
            endif
        endif
    endif

    # keep str above 100
    if followers >= followers_max_limit and diffhits < max_diffhits_before_healing
        if offensive_mode == 1 and dead lasttarget or offensive_mode == 0
            if mana >= 2nd_circle_spell_mana_cost
                if use_strength == 1 and not findbuff 'Strength' or str < 110
                    if verbose == 1
                        sysmsg '>>> STRENGTH' spell_msg_color
                    endif
    
                    cast 'Strength'
    
                    @settimer 'waiting_target_timer' 0
                    while not findbuff 'strength' and not targetexists 'beneficial' and not insysmsg 'disturbed' and not insysmsg 'cannot cast a spell' and timer 'waiting_target_timer' < 1500
                        wft 10
                        if insysmsg 'disturbed' or insysmsg 'spell will not adhere' or insysmsg 'cannot cast a spell'
                            if verbose == 1
                                sysmsg 'BREAKING WHILE WAITING FOR STRENGTH TARGET' warning_msg_color
                            endif
    
                            wait spell_recovery_delay
                            break
                        endif
                    endwhile
    
                    if targetexists 'beneficial'
                        hotkey 'Target Self'
                        wait spell_recovery_delay
                    endif
    
                    if findbuff 'strength'
                        overhead '+strength' buff_msg_color
                    endif
                endif
            endif
        else
            if verbose == 1
                # sysmsg '[OFFENSIVE MODE] SKIPPING STRENGTH...' warning_msg_color
            endif
        endif
    endif


    # DELECTABLE
    if auto_delectable == 1 and not findbuff 'food satisfaction'
        if findtype 'tray' as delectable
            overhead '*eating deletable*'
            dclick delectable
            wait action_delay
        else
            overhead '*no delectable*'
        endif
    endif


    # AUTO CURE POISON
    if auto_cure_poison == 1 and poisoned
        # if diffhits is too high, better guarantee and use a gheal pot
        if findtype 'orange potion' backpack as pot
            if verbose == 1
                sysmsg '>>> CURE POTION! ' action_msg_color
            endif

            useobject pot
            wait action_delay
        else
            if mana >= 4th_circle_spell_mana_cost
                if verbose == 1
                    sysmsg '>>> ARCH CURING!' spell_msg_color
                endif
    
                cast 'arch cure'
    
                @settimer 'waiting_spell_timer' 0
                while not targetexists 'beneficial' and not insysmsg 'disturbed' and not insysmsg 'cannot cast a spell' and timer 'waiting_target_timer' < 4000
                    wft 10
                    if insysmsg 'disturbed' or insysmsg 'spell will not adhere'
                        if verbose == 1
                            sysmsg 'BREAKING WHILE WAITING FOR ARCH CURE TARGET' warning_msg_color
                        endif
    
                        wait spell_recovery_delay
                        break
                    endif
                endwhile
    
                if targetexists 'neutral'
                    hotkey 'Target Self'
                    wait spell_recovery_delay
                endif
            else
                sysmsg 'NO MANA TO ARCH CURE!' alert_msg_color
            endif
        endif
    endif


    # KEEP CHAR HITS UP
    if auto_heal == 1 and diffhits > 0
        # if diffhits is too high, better guarantee and use a gheal pot
        if diffhits >= max_diffhits_before_heal_pot
            if findtype 'yellow potion' backpack as pot
                if verbose == 1
                    sysmsg '>>> LOW HP! USING HEAL POTION.. ' action_msg_color
                endif

                if use_script_overhead_messages == 1
                    overhead '*using heal potion*' action_msg_color
                endif

                useobject pot
                wait action_delay
            endif
        endif

        if diffhits >= max_diffhits_before_greater_heal
            if mana >= 4th_circle_spell_mana_cost
                if verbose == 1
                    sysmsg '>>> GREATER HEALING...' 76
                endif
    
                hotkey 'Clear Target Queue'
                cast 'greater heal'
    
                @settimer 'waiting_target_timer' 0
                while not targetexists 'beneficial' and not insysmsg 'disturbed' and not insysmsg 'cannot cast a spell' and timer 'waiting_target_timer' < 4000
                    wft 10
                    if insysmsg 'disturbed' or insysmsg 'spell will not adhere' or insysmsg 'cannot cast a spell'
                        if verbose == 1
                            sysmsg 'BREAKING WHILE WAITING FOR GREATER HEAL TARGET' warning_msg_color
                        endif
                        wait spell_recovery_delay
                        break
                    endif
                endwhile
    
                if targetexists 'beneficial' and hits < maxhits
                    hotkey 'Target Self'
                    wait spell_recovery_delay
    
                    if debug == 1
                        sysmsg 'RESETING LAST AFTER GHEAL' debug_msg_color
                    endif
                    hotkey 'Set Last Target (Harmful)'
                    wft action_delay
                    target last_target_serial
                endif
            else
                sysmsg 'NO MANA FOR GHEAL!' alert_msg_color
            endif
        elseif diffhits >= max_diffhits_before_healing
            sysmsg '>>> MINI HEALING...' 78
            hotkey 'Clear Target Queue'
            cast 'heal'

            @settimer 'waiting_target_timer' 0
            while not targetexists 'beneficial' and not insysmsg 'disturbed' and not insysmsg 'cannot cast a spell' and timer 'waiting_target_timer' < 1500
                wft 10
                if insysmsg 'disturbed' or insysmsg 'spell will not adhere' or insysmsg 'cannot cast a spell'
                    if verbose == 1
                        sysmsg 'BREAKING WHILE WAITING FOR HEAL TARGET' warning_msg_color
                    endif

                    wait spell_recovery_delay
                    break
                endif
            endwhile

            if targetexists 'beneficial' and hits < maxhits
                hotkey 'Target Self'
                wait spell_recovery_delay

                if debug == 1
                    sysmsg 'RESETING LAST AFTER MINI HEAL' debug_msg_color
                endif

                hotkey 'Set Last Target (Harmful)'
                wft action_delay
                target last_target_serial
            endif
        endif
    endif

    # keep mushrooms stock in backpack
    # if not dead lasttarget
    setvar! create_mushrooms_now 0
    if dead lasttarget or not dead lasttarget and counttype 'mushroom' < mushroom_limit_before_creating_more
        setvar! create_mushrooms_now 1
    endif

    if create_mushrooms_now == 1
        if verbose == 1
            sysmsg '>>> CREATING MUSHROOMS' action_msg_color
        endif

        if use_script_overhead_messages == 1
            overhead '*creating mushrooms*' action_msg_color
        endif

        while counttype 'mushroom' < mushroom_stock_size
            # if we loose hits while creating mushrooms, a new target might have been got and we need to break to heal
            if diffhits > max_diffhits_before_healing
                if verbose == 1
                    sysmsg 'BREAKING WHILE CREATING MUSHROOMS TO HEAL!' warning_msg_color
                endif

                break
            endif

            # if now we have a live target and already have the min mushroom limit, break to attack
            if not dead lasttarget and counttype 'mushroom' < mushroom_limit_before_creating_more
                if verbose == 1
                    sysmsg 'BREAKING WHILE CREATING MUSHROOMS TO ATTACK LAST TARGET!' warning_msg_color
                endif

                break
            endif

            cast 'create food'
            wait action_delay
        endwhile
    endif

    # eat mushroom on its timer
    if mana < mana_limit_to_eat_mushroom and timer 'use_mushroom_timer' >= use_mushroom_delay
        if findtype 'mushroom' backpack as mush
            useobject mush
            wait action_delay

            if insysmsg 'you consume'
                if verbose == 1
                    sysmsg '>>> [TIMER] RESETING MUSHROOM (NEXT IN {{use_mushroom_delay}})' reset_timer_msg_color
                endif
                settimer 'use_mushroom_timer' 0
            endif
        else
            sysmsg "!!! NO MUSHROOM!" warning_msg_color
        endif
    endif

    # meditate when needed
    if diffhits < max_diffhits_before_meditating
        if auto_meditate == 1 and mana < mana_limit_to_medit and not findbuff 'actively meditating'
            # TESTING: removing toggle peace so pets wont stop attacking and come close to char
            # hotkey 'Toggle Peace Only'
            skill 'meditation'
            waitforsysmsg 'You start meditating' 200

            if findbuff 'actively meditating'
                if use_script_overhead_messages == 1
                    overhead 'meditating' action_msg_color
                endif
                while findbuff 'actively meditating' and diffhits < max_diffhits_before_meditating and mana < min_mana_to_attack
                    if mana < mana_limit_to_eat_mushroom and timer 'use_mushroom_timer' >= use_mushroom_delay
                        if findtype 'mushroom' backpack as mush
                            useobject mush
                            if insysmsg 'you consume'
                                sysmsg '>>> [TIMER] RESETING MUSHROOM (NEXT IN {{use_mushroom_delay}})' reset_timer_msg_color
                                settimer 'use_mushroom_timer' 0
                            endif
                        else
                            sysmsg ">>> NO MUSHROOM!" alert_msg_color
                        endif
                    endif
                    if timer 'medit_msg_timer' >= 2000
                        sysmsg '>>> MEDITATING...'
                        if use_script_overhead_messages == 1
                            overhead 'meditating...'
                        endif
                        settimer 'medit_msg_timer' 0
                    endif
                endwhile
            endif
        endif
    endif


    # SKIN CORPSES/FORENSIC
    if followers >= followers_max_limit and diffhits < max_diffhits_before_healing
        if offensive_mode == 1 and dead lasttarget or offensive_mode == 0
            if auto_skin_corpses == 1 and skill 'forensic' > 0 and not findbuff 'Actively Meditating'
                # trying this: only skin if there isnt a active target to attack
                if dead 'last' or not find 'last' ground any any 20
                    if findtype corpse ground any any 2 as body
                        if not inlist 'skinned_corpses' body
                            if not findtype 'elven spellblade' backpack
                                if verbose == 1
                                    sysmsg 'NO SKINNING KNIFE!!!' alert_msg_color
                                endif
                            endif

                            if findtype 'elven spellblade' backpack as knife
                                useobject knife
                                wft action_delay
                                if targetexists 'neutral'
                                    hotkey 'Target Self'

                                    if use_script_overhead_messages == 1
                                        overhead '*skinning corpses*' action_msg_color
                                    endif

                                    if verbose == 1
                                        sysmsg '>>> SKINNING CORPSES NEARBY' action_msg_color
                                    endif

                                    @pushlist 'skinned_corpses' body
                                    wait action_delay
                                endif



                                if insysmsg 'dont see anything'
                                    if use_script_overhead_messages == 1
                                        overhead '*NOTHING TO CARVE*' 41
                                    endif

                                    @ignore body
                                elseif insysmsg 'carve materials'
                                    if use_script_overhead_messages == 1
                                        overhead '*carved materials!*' success_msg_color
                                    endif

                                    # switched ignore to list control cause spirit speak will ignore corpses and then razor wont skin it anymore since it would be globally ignored
                                    # @ignore body
                                    @pushlist 'skinned_corpses' body
                                elseif insysmsg 'must wait'
                                    if verbose == 1
                                        sysmsg '>>> SKILL COOLDOWN (FORENSIC)' on_cooldown_msg_color
                                    endif

                                    if use_script_overhead_messages == 1
                                        overhead ':: FORENSIC COOLDOWN ::' on_cooldown_msg_color
                                    endif
                                    wait action_delay
                                endif
                            endif
                        endif
                    endif
                endif
            endif
        else
            if verbose == 1
                # sysmsg '[OFFENSIVE MODE] SKIPPING SKINNING...' warning_msg_color
            endif
        endif
    endif


    # INCOGNITO
    if followers >= followers_max_limit and diffhits < max_diffhits_before_buffing
        if offensive_mode == 1 and dead lasttarget or offensive_mode == 0
            if use_incognito == 1 and not findbuff 'incognito'
                if verbose == 1
                    sysmsg '>>> INCOGNITO' spell_msg_color
                endif

                cast 'incognito'

                @settimer 'waiting_spell_timer' 0
                while not findbuff 'incognito' and timer 'waiting_spell_timer' < 3000
                    wait 10
                    if insysmsg 'disturbed' or insysmsg 'spell will not adhere' or insysmsg 'cannot cast a spell'
                        if verbose == 1
                            sysmsg 'BREAKING WHILE WAITING FOR INCOGNITO' warning_msg_color
                        endif

                        wait spell_recovery_delay
                        break
                    endif
                endwhile

                wait spell_recovery_delay

                if findbuff 'incognito'
                    if use_script_overhead_messages == 1
                        overhead '+INCOGNITO' buff_msg_color
                    endif
                endif
            endif
        else
            if verbose == 1
                # sysmsg '[OFFENSIVE MODE] SKIPPING MAGIC REFLECTION...' warning_msg_color
            endif
        endif
    endif

    if debug == 1
        # sysmsg '[DEBUG] AFTER AUTO-BUFFS' debug_msg_color
    endif


    # monitor sysmsgs to know when we can reset time spell timers
    if insysmsg 'You may now cast a wizardry harm'
        if verbose == 1
            sysmsg '+++ [TIMER] RESETING HARM TIMER...' reset_timer_msg_color
        endif

        settimer 'harm_timer' 0
    endif
    if insysmsg 'You may now cast a wizardry magic arrow'
        if verbose == 1
            sysmsg '+++ [TIMER] RESETING MAGIC ARROW (NEXT IN {{ma_delay}})' reset_timer_msg_color
        endif

        settimer 'magic arrow_timer' 0
    endif
    if insysmsg 'You may now cast a wizardry fireball'
        if verbose == 1
            sysmsg '+++ [TIMER] RESETING FIREBALL TIMER...' reset_timer_msg_color
        endif

        settimer 'fireball_timer' 0
    endif
    if insysmsg 'You may now cast a wizardry lightning'
        if verbose == 1
            sysmsg '+++ RESETING LIGHTNING TIMER. NEXT IN {{lightning_delay}}...' reset_timer_msg_color
        endif

        settimer 'lightning_timer' 0
    endif


    if is_detecter == 1
        useskill 'detectinghidden'
        wait action_delay

        if insysmsg 'you reveal what was hidden.'
            sysmsg '!FOUND HIDDEN PLAYER!' alert_msg_color
            sysmsg '> FOUND HIDDEN PLAYER! PROBABLY THIEF!' alert_msg_color
        endif
    endif

    # try to detect GMs on screen and say 'hi'
    # if auto_detect_gms == 1
    #     sysmsg 'â–· SEARCHING FOR GMs ON SCREEN'
    #     hotkey 'Clear Target Queue'
    #     hotkey 'Next Grey Player Target'
    #     if insysmsg 'New target'
    #         sysmsg '> FOUND THIEF! ESCAPING!' alert_msg_color
    #         setvar! recall_home_now 1
    #     endif
    # endif

    # this piece has to run after using detecting hiden to find the player revealed
    if auto_escape_thiefs == 1
        if verbose == 1
            sysmsg 'â–· SEARCHING FOR GREY PLAYERS ON SCREEN'
        endif
        # hotkey 'Clear Target Queue'
        clearsysmsg
        hotkey 'Next Grey Player Target'
        if insysmsg 'New target'
            sysmsg '> FOUND THIEF! ESCAPING!' alert_msg_color
            setvar! recall_home_now 1
        endif
    endif

    if auto_escape_pks == 1
        if verbose == 1
            sysmsg 'â–· SEARCHING FOR PKS ON SCREEN'
        endif
        # hotkey 'Clear Target Queue'
        clearsysmsg
        hotkey 'Next Murderer Player Target'
        if insysmsg 'New target'
            sysmsg '!!!!!!! FOUND PK! RUN!!!!!!!' alert_msg_color
            sysmsg '!!!!!!! FOUND PK! RUN!!!!!!!' alert_msg_color
            sysmsg '!!!!!!! FOUND PK! RUN!!!!!!!' alert_msg_color
            sysmsg '!!!!!!! FOUND PK! RUN!!!!!!!' alert_msg_color

            overhead '!!!!!!! FOUND PK! RUN!!!!!!!' alert_msg_color
            overhead '!!!!!!! FOUND PK! RUN!!!!!!!' alert_msg_color
            overhead '!!!!!!! FOUND PK! RUN!!!!!!!' alert_msg_color
            overhead '!!!!!!! FOUND PK! RUN!!!!!!!' alert_msg_color

            cast 'recall'

            clearsysmsg
            @settimer 'waiting_target_timer' 0
            while not targetexists 'neutral' and not insysmsg 'disturbed' and not insysmsg 'cannot cast a spell' and timer 'waiting_target_timer' < 4000
                wft 10
                if insysmsg 'disturbed' or insysmsg 'spell will not adhere' or insysmsg 'cannot cast a spell'
                    if verbose == 1
                        overhead 'â–½â–½ BREAKING RECALL ON ESCAPE PKS â–½â–½' warning_msg_color
                        sysmsg 'BREAKING WHILE WAITING FOR RECALL TO ESCAPE PKS {{crew_member}}' warning_msg_color
                    endif

                    wait spell_recovery_delay
                    break
                endif

                if diffhits >= max_diffhits_before_heal_pot
                    if findtype 'yellow potion' backpack as pot
                        if verbose == 1
                            sysmsg '>>> LOW HP! USING HEAL POTION.. ' action_msg_color
                        endif
        
                        if use_script_overhead_messages == 1
                            overhead '*using heal potion*' action_msg_color
                        endif
        
                        useobject pot
                        wait action_delay
                    endif
                endif

            endwhile

            if targetexists 'beneficial'
                target home_book
                wait spell_recovery_delay
            endif

        endif

        if cooldown 'UNDER ATTACK' or insysmsg 'Attacking you'
            if verbose == 1
                sysmsg '>>> BEING ATTACKED! TRYING TO ESCAPE...' alert_msg_color
                sysmsg '>>> BEING ATTACKED! TRYING TO ESCAPE...' alert_msg_color
                sysmsg '>>> BEING ATTACKED! TRYING TO ESCAPE...' alert_msg_color
                sysmsg '>>> BEING ATTACKED! TRYING TO ESCAPE...' alert_msg_color
            endif
            # say 'time to go...'
            # cast 'recall'
            # wft 3500
            # target escape_runetome
            # wait 2000
            # sysmsg '>>> STOPPING MACRO'
            # stop
        endif
        if not dead lasttarget
            if noto lasttarget  == murderer
            # if findtype 400 ground any any 20 as player

                # say 'time to go...'
                # cast 'recall'
                # wft 3500
                # target escape_runetome
                # wait 2000
                # sysmsg '>>> STOPPING MACRO'
                # stop
            endif
        endif

    endif

    if cooldown 'OUT OF REGS' > 0
        sysmsg 'OUT OF REGS! GONNA TRAVEL HOME TO RESSUPLY' 54
        setvar! recall_home_now 1
    endif

    # if debug == 1
        # sysmsg '[DEBUG] AFTER ESCAPE PK' debug_msg_color
    # endif


    ########################################
    # GO HOME AND UNLOAD ROUTINE
    ########################################
    if recall_home_now == 1

        if skill 'magery' == 0 or counttype "Black Pearl%s%" == 0 or counttype "Blood Moss" == 0 or counttype "Mandrake Root%s%" == 0
            if counttype "Recall"
                overhead 'no regs. trying scroll...' 54
                setvar! use_recall_scroll 1
            else
                overhead 'no regs. trying charges...' 54
                setvar! use_charges 1
            endif
        endif


        if use_charges == 1
            sysmsg 'TRAVELLING VIA CHARGES'
            dclick home_book
            waitforgump recall_book_gump_id 600
            gumpresponse recall_rune_btn_number recall_book_gump_id
            setvar! use_charges 0
        else
            # dclick recall_book
            # waitforgump recall_book_gump_id action_delay
            # gumpresponse recall_rune_btn_number recall_book_gump_id
            sysmsg 'TRAVELLING VIA SPELL WITH RUNEBOOK {{home_runebook}}'
            hotkey 'Recall'
            waitfortarget 3500
            target home_book
        endif

        unsetvar! recall_book

        wait recall_travel_time

        sysmsg 'ASSUMING CHAR IS HOME. START UNLOADING'

        if use_hotel_room == 1
            say 'room'
            waitforgump 2393832411 action_delay
            if ingump 'Your Room' 2393832411 action_delay
                if use_own_room == 1
                    overhead 'entering own room'
                    gumpresponse 4 2393832411
                else
                    overhead 'entering friend room'
                    gumpresponse 5 2393832411
                    waitforgump 2393832411 action_delay
                    gumpresponse 100 2393832411
                endif
            else
                overhead 'entering friend room'
                gumpresponse 5 2393832411
                waitforgump 2393832411 action_delay
                gumpresponse 100 2393832411
            endif

            wait 1500
        endif

        # unload on resource stockpile
        if findtype 'resource container' ground any any 2 as stockpile
            setvar! resource_stockpile stockpile
            menu resource_stockpile 0
            wft 600
            if targetexists 'neutral'
                sysmsg '> Restocking Resource Stockpile...' sysmsgs_color
                target 'self'
            endif

            if gumpexists 1859005118
                gumpclose 1859005118
            endif
        endif

        # unload in shelf
        if findtype 'storage shelf' ground any any 2 as shelf
            sysmsg 'RESSUPLYING...' 55
            menu shelf 1
            waitforgump 3232825965 600
        else
            overhead 'NO SHELFS FOUND TO RESSUPLY!'
        endif

        sysmsg 'SETTING TO TRAVEL TO NEXT RUNE' 54
        setvar! go_to_next_rune 1

        setvar! recall_home_now 0
        stop

    endif


    #####################################
    # MOVE ITEMS TO PACKIE MAIN ROUTINE
    #####################################

    if followers >= followers_max_limit and diffhits < max_diffhits_before_healing
        if auto_unload_items_in_pack_animal == 1 or auto_unload_reagents_in_pack_animal == 1
            if diffweight <= 15 or weight >= maxweight


                if varexist pack_animal and find pack_animal 'ground' 0 any 7
                    unsetvar! found_item_to_unload
                    # make one more search with range reduced to 2 to see if we need to call the llama close
                    while not find pack_animal 'ground' 0 1 2
                        wait 10

                        if timer 'call_packie_closer_timer' >= 1000
                            settimer 'call_packie_closer_timer' 0
                            overhead "calling packie closer!" 40 'self'
                            overhead "too far to unload!" 40 pack_animal

                            # say 'all follow me'
                            menu pack_animal 5
                        endif
                    endwhile


                    dclick pack_animal
                    wait action_delay

                    if verbose == 1
                        sysmsg 'SEARCHING ITEMS TO UNLOAD...' 56
                    endif

                    foreach item_graphic in 'items_to_move_to_llama'
                        if findtype item_graphic backpack as item
                            # set the variable so we know we found something in the end of the script
                            # if this var is not set, we warn the player there was nothing to move
                            if not varexist found_item_to_unload
                                setvar! found_item_to_unload true
                            endif

                            sysmsg ">  Unloading Items In Pack Animal..." 56 'self'
                            sysmsg item_graphic 56

                            # overhead "*unloading char*" 56 'self'
                            # overhead "*unloading items*" 56 pack_animal
                            while findtype item_graphic backpack as item
                                getlabel item item_label
                                overhead "unloading {{item_label}}" 56 pack_animal
                                lift item 60000
                                wait action_delay
                                drop pack_animal -1 -1 0
                                wait action_delay
                            endwhile
                        endif
                    endfor

                    if move_reagents == 1
                        sysmsg 'SEARCHING REAGENTS TO UNLOAD...' 56
                        foreach reagent_graphic in 'reagents'

                            # set an initial amount of regs to leave on char
                            setvar! min_amount_to_leave_on_char 100
                            if counttype reagent_graphic backpack > min_amount_to_leave_on_char
                                # set the variable so we know we found something in the end of the script
                                # if this var is not set, we warn the player there was nothing to move
                                sysmsg ">  Unloading {{reagent_graphic}} In Pack Animal..." 56 'self'
                                # overhead "*unloading reagents*" 56 'self'
                                while counttype reagent_graphic > min_amount_to_leave_on_char

                                    # set the variable so we know we found something in the end of the script
                                    # if this var is not set, we warn the player there was nothing to move
                                    setvar! found_item_to_unload true

                                    # decide how many regs to move based on current amount
                                    unsetvar! amount_of_regs_to_move
                                    if counttype reagent_graphic backpack >= 600
                                        setvar! amount_of_regs_to_move 500
                                    elseif counttype reagent_graphic backpack >= 500
                                        setvar! amount_of_regs_to_move 400
                                    elseif counttype reagent_graphic backpack >= 400
                                        setvar! amount_of_regs_to_move 300
                                    elseif counttype reagent_graphic backpack >= 300
                                        setvar! amount_of_regs_to_move 200
                                    elseif counttype reagent_graphic backpack >= 200
                                        setvar! amount_of_regs_to_move 100
                                    elseif counttype reagent_graphic backpack >= 200
                                        setvar! amount_of_regs_to_move 100
                                    elseif counttype reagent_graphic backpack > min_amount_to_leave_on_char
                                        setvar! amount_of_regs_to_move 40
                                    endif

                                    # get packie closer if it gets too far to unload (more than 2 tiles away)
                                    if not find pack_animal ground any any 2
                                        while not find pack_animal ground any any 2
                                            if timer 'call_packie_closer_timer' >= 1000
                                                settimer 'call_packie_closer_timer' 0
                                                overhead "calling packie closer!" 40 'self'
                                                overhead "too far to unload!" 40 pack_animal

                                                # say 'all follow me'
                                                menu pack_animal 5
                                            endif
                                            wait 10
                                        endwhile
                                        # break
                                    endif

                                    overhead 'unloading {{amount_of_regs_to_move}} {{reagent_graphic}}' 53 pack_animal

                                    lifttype reagent_graphic amount_of_regs_to_move backpack
                                    wait action_delay
                                    drop pack_animal -1 -1 0
                                    wait action_delay

                                endwhile
                            endif
                        endfor
                    endif

                    if not varexist found_item_to_unload
                        overhead '*no items to unload*' 41
                        sysmsg '> No Items To Unload To Packie' 41
                    endif

                else
                    if verbose == 1
                        sysmsg "!!!!!! CHAR HEAVY AND NO PACKIES NEARBY" alert_msg_color
                    endif

                    if use_script_overhead_messages == 1
                        overhead "CHAR HEAVY AND NO PACKIES"
                    endif

                    if str < 120 and findtype 'white potion' backpack
                        sysmsg 'HEAVY! DRINKING STR POT TO INCREASE MAX WEIGHT.' alert_msg_color
                        hotkey 'Drink Strength'
                        wait action_delay
                    endif
                endif
            endif
        endif
    endif


    #####################################
    # KEEP REGS STACKED INSIDE CHAR SATCHEL
    #####################################

    if followers >= followers_max_limit and diffhits < max_diffhits_before_healing
        if offensive_mode == 1 and dead lasttarget or offensive_mode == 0
            if auto_move_regs_to_satchel == 1

                # CHAR WIZARDS SATCHEL
                if not varexist char_reg_bag or not find char_reg_bag backpack and not find char_reg_bag self
                    if findtype 'reagent satchel' as satchel
                        sysmsg 'FOUND AND SAVED CHAR REG SATCHEL' script_msg_color
                        setvar! char_reg_bag satchel
                    endif
                endif

                while findtype "Blood Moss|Black Pearl%s%|Garlic|Mandrake Root%s%|Ginseng|Nightshade|Sulfurous Ash|Spider's Silk" backpack as reg
                # while findtype "Blood Moss|Black Pearl%s%" backpack as reg
                    getlabel reg reg_label
                    while find reg backpack and not find reg char_reg_bag

                        sysmsg '>>> MOVING {{reg_label}} TO SATCHEL.' action_msg_color
                        menu char_reg_bag 0
                        wait action_delay
                    endwhile

                    @ignore reg
                endwhile
                @clearignore
            endif
        endif
    endif


    #####################################
    # KEEP MOBS GUARDING PLAYER
    #####################################

    # TESTING also checking if dead so it doenst all guard before the 2 all follows for luring current lasttarget
    # if auto_all_guard == 1 and timer 'all_guard_timer' >= all_guard_delay
    if auto_all_guard == 1 and timer 'all_guard_timer' >= all_guard_delay
        if lure_mobs_closer_before_killing == 1 and not dead lasttarget
            if debug == 1
                sysmsg 'SKIPPING ALL GUARD IN FAVOR OF LURING' warning_msg_color
            endif
        elseif auto_patrol_when_no_active_lasttarget == 1 and dead lasttarget
            if debug == 1
                sysmsg 'SKIPPING ALL GUARD IN FAVOR OF PATROL' warning_msg_color
            endif
        else
            say 'all guard me'
            settimer 'all_guard_timer' 0
        endif
    endif


    #############################
    # HIDE ITENS IN CHOOSEN POUCH
    #############################

    if hide_valuables_in_CHAR_LOOT_POUCH == 1 and varexist CHAR_LOOT_POUCH
        # if offensive_mode == 1 and dead lasttarget or offensive_mode == 0
            @clearignore
            unsetvar! found_something_to_hide_in_pouch

            # hide char sheps crook is char has one (thiefs love to steal sheps crook)
            if hide_sheps_crook == 1
                if findtype 3713 backpack as crook

                    getlabel crook crook_label
                    if find crook CHAR_LOOT_POUCH
                        sysmsg " > {{crook_label}}!" 52
                    endif

                    # make sure were not just finding the crook inside the loot_pouch already
                    if not find crook CHAR_LOOT_POUCH
                        # lets assume here crook is with aspect activated so the recycler doenst pull it it
                        if hue crook != 0
                            overhead '*hiding crook in loot pouch!' 63
                            sysmsg '> Hiding {{crook_label}}' 63
                            lift crook 1
                            wait action_delay
                            drop CHAR_LOOT_POUCH -1 -1 0
                            wait action_delay
                            setvar! found_something_to_hide_in_pouch true
                        endif
                    endif
                endif
            endif

            # CHAR INSTRUMENT
            # check if there is a saved instrument already, and if its still in char's backpack
            if skill 'musicianship' > 0
                if varexist char_instrument
                    if not find char_instrument backpack
                        overhead '! cant find saved instrument !' 39
                        unsetvar! char_instrument
                    endif
                endif


                # FIND AND SAVE CHAR INSTRUMENT IF NEEDED
                if not varexist char_instrument
                    foreach instrument_type in 'instruments'
                        if findtype instrument_type backpack as instrument
                            getlabel instrument instrument_label

                            unsetvar! found_char_instrument
                            foreach magical_instrument_type in 'magical_instruments_types'
                                if magical_instrument_type in instrument_label
                                    setvar! found_something_to_hide_in_pouch true
                                    setvar! found_char_instrument true
                                    setvar! char_instrument instrument
                                    break
                                endif
                            endfor
                        endif

                        if varexist found_char_instrument
                            break
                        endif
                    endfor
                endif

                if varexist char_instrument
                    getlabel char_instrument instrument_label

                    if find char_instrument CHAR_LOOT_POUCH
                        @ignore char_instrument
                    endif

                    while find char_instrument backpack and not find char_instrument CHAR_LOOT_POUCH

                        # razor will always find the item in backpack, even if its already on loot pouch
                        # so we make sure we dont try to move it again if its already in the pouch
                        # overhead 'hiding {{instrument_label}} in trap pouch' 51 'self'
                        overhead '*hiding instrument*' 91 'self'
                        sysmsg '> Hiding {{instrument_label}}' 91

                        setvar! found_something_to_hide_in_pouch true

                        lift char_instrument 9999
                        wait action_delay
                        drop CHAR_LOOT_POUCH -1 -1 0
                        wait action_delay

                    endwhile
                endif
            endif


            # HIDE RARES IN CHAR_LOOT_POUCH
            while findtype "29833|42517|29040|52615|17083|map|48261|'bold and arrow keg'|'void orb'|'research materials'|'scroll of calling'|22336|'Book of Truth'|5359|'folded cloth'|sandals|'aspect core'|3836|17686|parchment|carpet|bottle|3838|3839|3843|3842|3843|29025|29036|'blank scroll%s%'|29030" container as found
                if find found backpack and not find found CHAR_LOOT_POUCH
                    getlabel found found_label

                    sysmsg 'Hiding {{found_label}}' 54 'self'
                    overhead 'hiding {{found_label}}' 91 'self'
            
                    if varexist CHAR_LOOT_POUCH
                        lift found 999
                        wait 50
                        while queued
                        endwhile
            
                        drop CHAR_LOOT_POUCH
                        wait 50
                        while queued
                        endwhile
                    else
                        hotkey 'Grab Item'
                        wft action_delay
                        target found
                        wait 50
                        while queued
                        endwhile
                    endif
                endif
            
            endwhile
            @clearignore

    endif


    #############################
    # AVOID STAYING ABOVE DANGEROUS
    # TILES LIKE BOSS AND DAEMONFLAMES
    #############################

    if auto_escape_ground_burning_flames == 1
        # mausoleum forgotten soul flames
        while findtype 28016 ground 2264 any 0 and not findtype 28016 ground 2264 1
            sysmsg '>>> BURNING FLAME UNDER CHAR!!!!!! MOVING CHAR'

            random 8
            if insysmsg 'Random: 1'
                walk 'south'
                walk 'south'
            elseif insysmsg  'Random: 2'
                walk 'down'
                walk 'down'
            elseif insysmsg  'Random: 3'
                walk 'east'
                walk 'east'
            elseif insysmsg  'Random: 4'
                walk 'right'
                walk 'right'
            elseif insysmsg  'Random: 5'
                walk 'north'
                walk 'north'
            elseif insysmsg  'Random: 6'
                walk 'up'
                walk 'up'
            elseif insysmsg  'Random: 7'
                walk 'west'
                walk 'west'
            elseif insysmsg  'Random: 8'
                walk 'left'
                walk 'left'
            endif
        endwhile
    endif


    #############################
    # INCOGNITO
    #############################
    if followers >= followers_max_limit and diffhits < max_diffhits_before_buffing
        if offensive_mode == 1 and dead lasttarget or offensive_mode == 0
            if dead lasttarget and diffhits == 0 and diffmana == 0 and diffstam == 0
                if juggle_mode == 1
                    if timer 'fun_timer' > 120000
                        clearsysmsg
                        random 3
                        if insysmsg 'Random: 1'
                            if findtype 'juggling torches' backpack
                                dclicktype 'juggling torches' backpack
                                wait action_delay
                            endif
                        elseif insysmsg  'Random: 2'
                            if findtype 'juggling bottles' backpack
                                dclicktype 'juggling bottles'
                                wait action_delay
                            endif
                        elseif insysmsg  'Random: 3'
                            if findtype 45285 backpack 2466
                                dclicktype 45285
                                wait action_delay
                            endif
                        endif

                        settimer 'fun_timer' 0
                    endif
                endif
            endif
        endif
    endif



    #########################################
    # BOATING STUFF
    #########################################

    if stack_trace == 1
        sysmsg 'BEFORE BOATING ROUTINE' debug_msg_color
    endif

    # save my boats hatch so i can tell it apart from enemy ships to detect enemy ships on screen
    if boating_mode == 1

        # if we are boating, first thing before any other we need to check if theres an enemy ship on screen
        # FIND NEARBY ENEMY BOATS AND SAVE ITS HATCH TO VARIABLE
        setvar! enemy_boat_present 0
        if varexist enemy_boat_status_bar
            if enemy_boat_status_bar != CHAR_BOAT_STATUS_BAR and find enemy_boat_status_bar ground any any find_enemy_boats_max_range
                sysmsg 'ENEMY BOAT SAVED FOUND AND PRESENT IN SCREEN: {{enemy_boat_status_bar}}!' boating_msg_color
                setvar! enemy_boat_present 1
            else
                sysmsg 'ENEMY BOAT SAVED CANT BE FOUND IN SCREEN. UNSETING!' boating_msg_color
                unsetvar enemy_boat_status_bar
            endif
        endif

        # if saved boat hatch is not found, we need to search for another
        if enemy_boat_present == 0
            if verbose == 1
                sysmsg 'SEARCHING FOR NEW ENEMY BOATS' boating_msg_color
                overhead '*searching enemy boats*' boating_msg_color
            endif

            createlist 'status_bars'
            clearlist 'status_bars'

            if findtypelist 'status_bars' 'status bar' ground HULL_STATUS_BAR_COLOR any 12
            endif

            if list status_bars > 0
                foreach bar in 'status_bars'

                    if findtype 'status bar' ground HULL_STATUS_BAR_COLOR any find_enemy_boats_max_range as found
                        if debug == 1
                            sysmsg 'FOUND STATUS BAR : {{found}} COMPARING TO {{CHAR_BOAT_STATUS_BAR}} ' boating_msg_color
                        endif

                        if found != CHAR_BOAT_STATUS_BAR
                            sysmsg 'FOUND SAIL {{found}} AND SAVING AS ENEMY BOAT SAIL' success_msg_color
                            setvar! enemy_boat_status_bar found
                            setvar! enemy_boat_present 1
                            break
                        endif
                    endif
                endfor
            endif

        endif


        # search ships on spyglass if no enemy boats present in screen
        if enemy_boat_present == 0 and not gumpexists search_ships_gump_id
            if timer 'search_ships_timer' >= search_ships_delay
                sysmsg 'SEARCHING SHIPS WITH SPYGLASS' boating_msg_color
                if findtype 'spyglass' backpack as tool
                    dclick tool
                    waitfortarget action_delay
                    if targetexists 'neutral'
                        overhead '*opening searching ships*' boating_msg_color
                        sysmsg 'OPENING SEARCH SHIPS GUMP' boating_msg_color
                        hotkey 'Target Self'
                        waitforgump 2890020940 action_delay
                        # if gumpexists 2890020940
                            # sysmsg 'Searching Ships...' 89
                            # overhead 'searching ships...' 89
                            # gumpresponse 4
                            # waitforgump 2890020940 600
                        # endif
                    endif
                endif
            endif
        endif

        # auto dock boat when find a known dockmaster nearby
        if auto_dock_when_close_to_dockmaster == 1
            foreach dockmaster in 'dockmasters_serials'
                if find dockmaster ground any any 8
                    sysmsg '>> FOUND DOCKMASTER!' success_msg_color
                    menu dockmaster 1
                    waitforgump dockmaster_gump_id action_delay

                    if gumpexists dockmaster_gump_id
                        sysmsg '>>> DOCKING SHIP!' warning_msg_color
                        gumpresponse 7
                        waitforgump dockmaster_gump_id action_delay
                        waitforgump 4216593270
                        waitforgump dockmaster_gump_id action_delay
                    endif
                endif
            endfor
        endif

          #try to find tillerman
        # if not varexist tillerman or varexist tillerman and not find tillerman ground any any 15
        #     foreach tillerman in tillermen_list
        #         if findtype tillerMenVar ground as found
        #             sysmsg 'TILLERMAN SET!' success_msg_color
        #             overhead "Tillerman Set"
        #             setvar tillerman found
        #             dclick tillerman
        #             wait 500
        #         endif
        #     endfor
        # endif


        if boating_mode == 1 and auto_repair_ship == 1
            if timer 'repair_ship_hull_timer' > repair_ship_hull_delay
                sysmsg 'REPAIRING SHIP HULL' action_msg_color
                say '[RepairHull'
                wait action_delay

                if insysmsg 'hull does not need'
                    if verbose == 1
                        sysmsg 'HULL DONT NEED REPAIRING! SETTING HIGHER DELAY' warning_msg_color
                    endif
                    setvar! repair_ship_hull_delay 30000
                    settimer 'repair_ship_hull_timer' 0
                else
                    if verbose == 1
                        sysmsg 'REPAIRED HULLS! NEXT IN {{repair_boat_hull_delay}}ms' reset_timer_msg_color
                    endif
                    # reset repair delay to regular repair cooldown to keep repairing this part until its full
                    setvar! repair_ship_hull_delay repair_ship_cooldown
                    settimer 'repair_ship_hull_timer' 0
                endif
            endif

            if timer 'repair_ship_sails_timer' > repair_ship_sails_delay
                if verbose == 1
                    sysmsg 'REPAIRING SHIP SAILS' action_msg_color
                endif

                say '[RepairSails'
                wait action_delay

                if insysmsg 'sails do not need'
                    if verbose == 1
                        sysmsg 'SAILS DONT NEED REPAIRING! SETTING HIGHER DELAY' warning_msg_color
                    endif

                    setvar! repair_ship_sails_delay 30000
                    settimer 'repair_ship_sails_timer' 0
                else
                    sysmsg 'REPAIRED SAILS! NEXT IN {{repair_ship_sails_delay}}ms' reset_timer_msg_color

                    # reset repair delay to regular repair cooldown to keep repairing this part until its full
                    setvar! repair_ship_sails_delay repair_ship_cooldown
                    settimer 'repair_ship_sails_timer' 0
                endif
            endif

            if timer 'repair_ship_guns_timer' > repair_ship_guns_delay
                sysmsg 'REPAIRING SHIP GUNS' action_msg_color
                say '[RepairGuns'
                wait action_delay

                if insysmsg "guns do not need"
                    if verbose == 1
                        sysmsg 'GUNS DONT NEED REPAIRING! SETTING HIGHER DELAY' warning_msg_color
                    endif

                    setvar! repair_ship_guns_delay 30000
                    settimer 'repair_ship_guns_timer' 0
                else
                    sysmsg 'REPAIRED GUNS! NEXT IN {{repair_ship_guns_delay}}ms' reset_timer_msg_color

                    # reset repair delay to regular repair cooldown to keep repairing this part until its full
                    setvar! repair_ship_sails_delay repair_ship_cooldown
                    settimer 'repair_ship_guns_timer' 0
                endif
            endif
        endif


        # heal crew
        if followers >= followers_max_limit and diffhits < max_diffhits_before_healing
            if boating_mode == 1 and auto_heal_crew == 1 and timer 'heal_ship_crew_timer' >= heal_ship_crew_delay
                if list 'ship_crew' > 0
                    foreach crew_member in 'ship_crew'
                        if find crew_member ground any any 15
                            cast 'greater heal'
                            getlabel crew_member crew_member_label
                            sysmsg 'HEALING CREW MEMBER {{crew_member_label}}'
            
                            clearsysmsg
                            @settimer 'waiting_target_timer' 0
                            while not targetexists 'beneficial' and not insysmsg 'disturbed' and not insysmsg 'cannot cast a spell' and timer 'waiting_target_timer' < 4000
                                wft 10
                                if insysmsg 'disturbed' or insysmsg 'spell will not adhere' or insysmsg 'cannot cast a spell'
                                    if verbose == 1
                                        overhead 'â–½â–½ BREAKING HEAL â–½â–½' warning_msg_color
                                        sysmsg 'BREAKING WHILE WAITING FOR GREATER HEAL TARGET TO HEAL CREWMEMBER {{crew_member}}' warning_msg_color
                                    endif

                                    wait spell_recovery_delay
                                    break
                                endif
                            endwhile
                
                            if targetexists 'beneficial'
                                target crew_member
                                wait spell_recovery_delay
                            endif
                        else
                            sysmsg 'CREWMEMBER {{crew_member}} NOT FOUND TO HEAL!' alert_msg_color
                        endif
                    endfor

                    settimer 'heal_ship_crew_timer' 0

                    if varexist last_target_serial
                        if debug == 1
                            sysmsg 'RESETING LAST AFTER GHEAL' debug_msg_color
                        endif
                        hotkey 'Set Last Target (Harmful)'
                        wft action_delay
                        target last_target_serial
                    endif

                endif
            endif
        endif

    # closes if boating_mode == 1
    endif


    #########################################
    # SEARCH NEW ENEMIES
    #########################################

    if auto_get_new_targets == 1 and timer 'auto_get_new_targets_timer' > 1000
        if verbose == 1
            sysmsg '> SEARCHING MONSTERS TARGETS...' action_msg_color
        endif

        if use_script_overhead_messages == 1
            overhead '*searching monsters*' action_msg_color
        endif

        hotkey 'Target Closest Non-Friendly Monster'
        if get_players_on_auto_target == 1
            if verbose == 1
                sysmsg '> SEARCHING PLAYER TARGETS...' action_msg_color
            endif

            if use_script_overhead_messages == 1
                overhead '*searching players*' action_msg_color
            endif

            hotkey 'Next Grey Humanoid Target'
            # TESTING removing wait
            # wait action_delay
        endif

        settimer 'auto_get_new_targets_timer' 0
    elseif auto_get_new_targets == 0 && timer 'get_new_target_msg' > 4000
        overhead 'waiting for new target' overhead_color
        settimer 'get_new_target_msg' 0
    endif



    #########################################
    # MAIN ATTACK ROUTINE
    #########################################

    # make sure char has high hp and mana for FS before attacking

    if followers >= followers_max_limit and diffhits < max_diffhits_before_healing
        # if auto_attack_targets == 1 and diffhits < max_diffhits_before_healing and mana >= min_mana_to_attack
        if auto_attack_targets == 1
            # if targetr queue is active, we need to clear it here or else the script cant detect the first target opened (for mana drain) cause its queued
            # make sure char is always max summon before attacking
            # if not dead 'last' and followers >= followers_max_limit and find 'last' ground any any find_last_target_max_range as last_target_serial_found
            while not dead lasttarget or enemy_boat_present == 1


                #----------------------------------------
                # BOAT ATTACK ROUTINE

                if boating_mode == 1 and enemy_boat_present == 1
                    if not find enemy_boat_status_bar ground any any 2
                       sysmsg 'CANT FIND SAVED ENEMY BOAT INSIDE ATTACK ROUTINE' alert_msg_color
                    endif

                    # reload cannons
                    if auto_reload_cannons == 1 and timer 'reload_cannons_timer' >= reload_cannons_delay
                        foreach cannon in 'my_boat_cannons'
                            getlabel cannon cannon_label

                            if '4/10' in cannon_label or '3/10' in cannon_label or '2/10' in cannon_label or '1/10' in cannon_label
                                sysmsg 'RELOADING CANNONS'
                                say '[reloadcannons'
                                wait action_delay

                                if not insysmsg 'No cannons require reloading at the moment'
                                    sysmsg 'REALODING CANNONS AND RESETING RELOAD TIMER' reset_timer_msg_color
                                    settimer 'reload_cannons_timer' 0
                                endif
                            endif

                        endfor
                    endif

                    if auto_use_ship_abilities == 1 and timer 'ship_lesser_ability_timer' >= ship_lesser_ability_delay
                        if varexist enemy_boat_status_bar and find enemy_boat_status_bar ground any any find_enemy_boats_max_range

                            sysmsg 'LESSER ABILITY!' warning_msg_color
                            say '[lesserability'
                            wft action_delay


                            if targetexists 'any'
                                sysmsg 'SHOOTING LESSER ABILITY AT ENEMY SHIP {{enemy_boat_status_bar}}' action_msg_color
                                target enemy_boat_status_bar
                                wait action_delay
                                if not insysmsg 'You may not fire onto your own ship' and not insysmsg 'Your cannons cannot reach that location'
                                    sysmsg 'LESSER ABILITY FIRED! RESETING LESSER ABILITY TIMER' reset_timer_msg_color
                                    settimer 'ship_lesser_ability_timer' 0
                                endif
                            endif
                        endif
                    endif

                    # fire cannons
                    if auto_fire_cannons == 1 and timer 'fire_cannons_timer' >= fire_cannons_delay
                        if varexist enemy_boat_status_bar and find enemy_boat_status_bar ground any any find_enemy_boats_max_range

                            sysmsg 'FIRING CANNONS!' warning_msg_color
                            say '[firecannons'
                            wft action_delay


                            if targetexists 'any'
                                sysmsg 'FIREING CANNON AT ENEMY SHIP {{enemy_boat_status_bar}}' action_msg_color
                                target enemy_boat_status_bar
                                wait action_delay
                                if not insysmsg 'You may not fire onto your own ship' and not insysmsg 'Your cannons cannot reach that location'
                                    sysmsg 'CANNONS FIRED! RESETING FIRE CANNONS TIMER' reset_timer_msg_color
                                    settimer 'fire_cannons_timer' 0
                                endif
                            endif
                        endif
                    endif

                    #Check if we are on NPC ship AGAIN
                    #
                    if boating_mode == 1 and auto_board_enemy_ships == 1
                        if not gumpexists boarding_gump_id
                            if findtype 'rope' backpack 0 as rop
                                useobject rop
                                waitforgump boarding_gump_id action_delay
                            else
                                overhead 'no boarding rope!'
                                stop
                            endif
                        endif

                        if gumpexists boarding_gump_id
                            gumpresponse 5 boarding_gump_id
                            wft action_delay

                            if targetexists 'neutral'
                                sysmsg 'TRYING TO BOARDO ENEMY SHIP {{enemy_boat_status_bar}}' action_msg_color
                                overhead 'board which ship?' 64
                                target enemy_boat_status_bar
                            endif

                            wait action_delay

                            if insysmsg "You board the ship"
                                setvar! is_boarded 1
                                # settimer 'boarded_timer' 0
                                wait action_delay
                                overhead "BOARDED ENEMY SHIP!!!!!!!!!" boating_msg_color
                            endif

                        endif
                    endif


                    #check for bombs nearby and defuses them
                    if boating_mode == 1 and auto_defuse_bombs = 1
                        if findtype '5188' ground -1 -1 2
                            sysmsg 'DEFUSING BOMB!' action_msg_color
                            dclicktype SHIP_BOMB
                            say "[embark"
                            wait 600
                            say "[embarkfollowers"
                            wait 600
                            setvar! is_boarded 1
                        endif

                        if findtype '5188' ground
                            sysmsg 'DEFUSING BOMB!' action_msg_color
                            dclicktype SHIP_BOMB
                            say "[embark"
                            wait 600
                            say "[embarkfollowers"
                            wait 600

                            setvar! is_boarded 1
                        endif
                    endif


                    # heal crew
                    if followers >= followers_max_limit and diffhits < max_diffhits_before_healing
                        if boating_mode == 1 and auto_heal_crew == 1 and timer 'heal_ship_crew_timer' >= heal_ship_crew_delay
                            if list 'ship_crew' > 0
                                sysmsg 'HEALING CREW' boating_msg_color
                                foreach crew_member in 'ship_crew'
                                    cast 'greater heal'
                        
                                    @settimer 'waiting_target_timer' 0
                                    while not targetexists 'beneficial' and not insysmsg 'disturbed' and not insysmsg 'cannot cast a spell' and timer 'waiting_target_timer' < 4000
                                        wft 10
                                        if insysmsg 'disturbed' or insysmsg 'spell will not adhere' or insysmsg 'cannot cast a spell'
                                            if verbose == 1
                                                overhead 'â–½â–½ BREAKING HEAL â–½â–½' warning_msg_color
                                                sysmsg 'BREAKING WHILE WAITING FOR GREATER HEAL TARGET TO HEAL CREWMEMBER {{crew_member}}' warning_msg_color
                                            endif
                                            wait spell_recovery_delay
                                            break
                                        endif
                                    endwhile
                        

                                endfor

                                settimer 'heal_ship_crew_timer' 0
            
                                if varexist last_target_serial
                                    if debug == 1
                                        sysmsg 'RESETING LAST AFTER GHEAL' debug_msg_color
                                    endif
                                    hotkey 'Set Last Target (Harmful)'
                                    wft action_delay
                                    target last_target_serial
                                endif
                            endif
                        endif
                    endif

                # CLOSES if boating_mode == 1 and enemy_boat_present == 1
                endif




sysmsg 'chegou enemy mob attack routine'
                #----------------------------------------
                # ENEMY/MONSTER ATTACK ROUTINE
                if not dead last target
                    if followers < followers_max_limit
                        if verbose == 1
                            sysmsg 'BREAKING ATTACK LOOP TO SUMMON' alert_msg_color
                        endif
                        break
                    endif

                    if diffhits > max_diffhits_before_healing
                        if verbose == 1
                            sysmsg 'BREAKING ATTACK LOOP TO HEAL' alert_msg_color
                        endif
                        break
                    endif



                    if mana < min_mana_to_attack
                        if verbose == 1
                            sysmsg 'BREAKING ATTACK LOOP TO MEDITATE' alert_msg_color
                        endif
                        break

                    endif

                    if findtype '0x54A4' ground any any 4 as eldrich_proc
                        getlabel eldrich_proc proc_label
                        overhead '*using eldrich mana well*' success_msg_color
                        sysmsg 'Using ElDRICH MANA WELL: {{proc_label}}' success_msg_color
                        cooldown 'Proc' 5000
                    endif


                    hotkey 'Clear Target Queue'

                    if debug == 1
                        sysmsg '>>> FOUND ALIVE LAST && MAX SUMMONS' debug_msg_color
                    endif

                    # save current target to compare with last saved last_target_serial to see if we have a new mob or just a old mob that went off screen of hid itself
                    if find 'last' ground any any find_last_target_max_range as serial
                        setvar! current_target_serial serial
                    else
                        if verbose == 1
                            sysmsg '!!!!!! BREAKING ATTACK LOOP BECAUSE CANT FIND LASTTARGET' alert_msg_color
                        endif

                        hotkey '> Interrupt'
                        break
                    endif

                    if noto 'last' == hostile or noto 'last' == murderer or noto 'last' == criminal
                        if debug == 1
                            if noto 'last' == hostile
                                sysmsg 'NOTO LAST HOSTILE!!!' debug_msg_color
                            endif

                            sysmsg '>>> FOUND HOSTILE LASTTARGET' debug_msg_color
                        endif

                        # # save last target serial on custom var to re-set after healing friendly targets

                        if last_target_serial != current_target_serial
                            if verbose == 1
                                sysmsg '+++ RESETING LAST TARGET SERIAL VAR (NEW MOB)' alert_msg_color
                            endif

                            unsetvar last_target_serial
                            setvar! last_target_serial current_target_serial

                            if verbose == 1
                                sysmsg '+++ RESETING ALL TIMERS!' reset_timer_msg_color
                            endif

                            settimer 'mana_drain_timer' mana_drain_delay
                            settimer 'curse_timer' mana_drain_delay
                            settimer 'medit_msg_timer' 6000
                            settimer 'auto_get_new_targets_timer' 1000
                            settimer 'all_guard_timer' all_guard_delay
                            settimer 'all_patrol_timer' all_patrol_delay
                        elseif last_target_serial == current_target_serial
                            if verbose == 1
                                sysmsg '+++ MOB {{current_target_serial}} IS SAME AS LAST TARGET FOUND {{last_target_serial}}' alert_msg_color
                            endif
                        endif

                        # use crook on last target
                        if auto_herd_mobs == 1
                            if not dead 'last' and find 'last' ground any any find_last_target_max_range and noto 'last' == hostile or noto 'last' == murderer or noto 'last' == criminal
                                if varexist last_target_serial
                                    if not inlist 'herdened_mobs' last_target_serial
                                        if findtype 3713 as crook
                                            while not targetexists 'harmful'
                                                useobject crook
                                                wft action_delay
                                            endwhile

                                            if targetexists 'harmful'
                                                sysmsg 'FOCUSING AGGRESSION' 54
                                                hotkey 'Last Target'
                                                wait action_delay

                                                if insysmsg 'You focus your follower'
                                                    if use_script_overhead_messages == 1
                                                        overhead 'focused pets agression' actions_msg_color 'last'
                                                    endif

                                                    pushlist 'herdened_mobs' last_target_serial
                                                endif
                                            endif

                                            say 'all kill'
                                            wft action_delay
                                            if targetexists 'harmful'
                                                hotkey "Last Target"
                                                wait action_delay
                                            endif

                                        else
                                            overhead "no sheperd's crook!"
                                        endif
                                    endif
                                endif
                            endif
                        endif

sysmsg 'chegou kill close to loot'

                        # kill close to loot mob easier
                        if lure_mobs_closer_before_killing == 1 and timer 'lure_mob_closer_timer' > 4000
                            if not find 'last' ground any any lure_mobs_distance_to_lure
                                if verbose == 1
                                    sysmsg '>>> LURING MOB CLOSE TO CHAR' default_sysmsg_color
                                endif
                                # say 'all kill'
                                # wft 600
                                # target 'last'
                                # this wait is just to avoid speech throttle from the server
                                wait 250

                                say 'all follow me'

                                settimer 'waiting_mob_to_approach_timer' 0
                                while timer 'waiting_mob_to_approach_timer' < 1500
                                    wait 10
                                    if find 'last' ground any any lure_mobs_distance_to_lure
                                        sysmsg 'MOB IS NOW AT {{lure_mobs_distance_to_lure}} TILES' success_msg_color
                                        break
                                    endif
                                endwhile


                                hotkey 'Toggle Peace Only'
                                settimer 'lure_mob_closer_timer' 0
                                say 'all guard me'
                            else
                                if verbose == 1
                                    sysmsg '>>> MOB IS CLOSE, NO NEED TO LURE' warning_msg_color
                                endif
                            endif
                        endif

                        # safe clause to not attack self or friendsa
                        if noto 'last' = friend or noto 'last' = friendly or noto 'last' = innocent
                            sysmsg 'CANCELING FRIENDLY TARGET'
                            target 'clear'
                            hotkey 'Cancel Current Target'
                        endif

                        # if set to keep getting the closest target, we only wanna do that in case theres already a live target set
                        # the reason is that if there isnt, the script is already searching for the closest target to set before the main attack routine
                        if auto_get_new_targets == 1 and keep_getting_closest_target == 1 and not dead lasttarget
                            if verbose == 1
                                sysmsg 'RE-GETTING CLOSEST TARGET' action_msg_color
                            endif
                    
                            hotkey 'Target Closest Non-Friendly Monster'
                        endif
                    
                        # TRY TO DETECT AND CANCEL ENEMIES OUT OF LOS
                        if not dead 'last' and not find 'last' ground any any find_last_target_max_range
                            sysmsg 'LASTTARGET NOT FOUND. CANCELLING CURRENT TARGET' alert_msg_color
                            unsetvar lasttarget
                            unsetvar 'last'
                            clearsysmsg
                            clearall
                            if debug == 1
                                sysmsg 'BREAKING INSIDE MAIN ATTACK ROUTINE CAUSE ENEMY OUT OF LOS' alert_msg_color
                            endif
                            break
                        endif
                    
                        setvar! last_target_serial lasttarget

                        # before each spell and every attack, we first check 2 things:
                        # if the followers number is 4 or more, indicating we have all summons up
                        # and if diffhits is under 10, indicating character is not under threat of dying and doenst need heal
                        # only if all checks pass we start attacking the target
                        if followers >= followers_max_limit and noto 'last' != friend and noto 'last' != friendly
                            if noto 'last' == hostile or noto 'last' == murderer or noto 'last' == criminal
                                attack 'last'

                                if auto_all_guard == 1 and timer 'all_guard_timer' >= 5000
                                    say 'all guard me'
                                    settimer 'all_guard_timer' 0
                                endif


                                # GRIMOIRE SPELLS

                                # mana drain
                                if followers >= followers_max_limit and diffhits < max_diffhits_before_healing
                                    if use_mana_drain == 1
                                        if not dead 'last' and find 'last' ground any any find_last_target_max_range

                                            if last_target_serial == last_mana_drained_serial and timer 'mana_drain_timer' <= mana_drain_delay
                                                if verbose == 1
                                                    sysmsg '!!! THIS MOB WAS MANA DRAINED {{mana_drain_timer}}ms AGO' warning_msg_color
                                                endif
                                            elseif last_target_serial != last_mana_drained_serial and timer 'mana_drain_timer' >= mana_drain_delay
                                                # overhead '> mana drain <' spell_overhead_color
                                                if verbose == 1
                                                    sysmsg 'â—Ž MANA DRAIN (NEW MOB)' spell_msg_color
                                                endif
                                                cast 'mana drain'

                                                @settimer 'waiting_target_timer' 0
                                                @clearsysmsg
                                                while not targetexists 'harmful' and not insysmsg 'disturbed' and not insysmsg 'cannot cast a spell' and timer 'waiting_target_timer' < 3500
                                                    wait 10

                                                    if insysmsg 'disturbed' or insysmsg 'cannot cast a spell'
                                                        if verbose == 1
                                                            sysmsg 'BREAKING WHILE WAITING FOR MANA DRAIN TARGET' warning_msg_color
                                                        endif

                                                        wait spell_recovery_delay
                                                        break
                                                    endif
                                                endwhile

                                                if targetexists 'harmful'
                                                    @clearsysmsg
                                                    hotkey 'Last Target'
                                                    wait spell_recovery_delay

                                                    if not insysmsg 'Target cannot be seen'
                                                        if debug == 1
                                                            sysmsg '+++ RESETING MANA DRAIN TIMER' reset_timer_msg_color
                                                        endif

                                                        settimer 'mana_drain_timer' 0
                                                        cooldown 'MANA DRAIN/VAMPIRE' mana_drain_delay
                                                        setvar! last_mana_drained_serial lasttarget
                                                    endif
                                                endif
                                            endif
                                        endif
                                    endif
                                endif

                                # poison
                                if followers >= followers_max_limit and diffhits < max_diffhits_before_healing
                                    if use_poison == 1 and timer 'poison_timer' >= poison_delay
                                        if is_noxer == 1
                                            if verbose == 1
                                                sysmsg 'â—Ž POISON (ALL MOBS)' spell_msg_color
                                            endif
                                            createlist 'poison_targets'
                                            clearlist 'poison_targets'
                                            
                                            while not dead self
                                                hotkey "Next Non-Friendly Monster Target"
                                                if insysmsg 'New target'
                                                    setvar! targserial lasttarget
                                                    if not inlist 'poison_targets' targserial
                                                        sysmsg 'PUSHING {{targserial}} TO LIST'
                                                        pushlist 'poison_targets' targserial
                                                    else
                                                        sysmsg 'TARGET {{targserial}} ALREADY ON LIST. ASSUMING NO NEW TARGETS' 54
                                                        break
                                                    endif
                                                endif
                                            endwhile

                                            hotkey 'Clear Target Queue'
                                            hotkey 'Toggle Peace Only'
                                            
                                            foreach targ in 'poison_targets'
                                                if not dead targ
                                                    overhead '*poisoning*' 76 targ
                                                    cast 'poison'
                                                    wft 3000
                                                    target targ
                                                    wait spell_recovery_delay
                                                else
                                                    sysmsg 'MOB {{mob}} ALREADY DEAD!' 54
                                                endif
                                            endfor

                                            settimer 'poison_timer' 0
                                            cooldown 'POISON' poison_delay
                                            setvar! last_cursed_serial lasttarget
                                        else
                                            sysmsg 'â—Ž POISON' spell_msg_color
                                            cast 'poison'
                                            wft 3000
                                            hotkey 'Last Target'
                                        endif
                                    endif
                                endif

                                # curse
                                if followers >= followers_max_limit and diffhits < max_diffhits_before_healing
                                    if use_curse == 1 and timer 'curse_timer' >= curse_delay
                                        if not dead 'last' and find 'last' ground any any find_last_target_max_range

                                            if last_target_serial == last_cursed_serial and timer 'curse_timer' <= curse_delay
                                                if verbose == 1
                                                    sysmsg '!!! THIS MOB WAS CURSED {{curse_timer}}ms AGO' warning_msg_color
                                                endif
                                            elseif last_target_serial != last_cursed_serial and timer 'curse_timer' >= curse_delay
                                                if verbose == 1
                                                    sysmsg 'â—Ž CURSE' spell_msg_color
                                                endif
                                                cast 'curse'

                                                @settimer 'waiting_target_timer' 0
                                                clearsysmsg
                                                while not targetexists 'harmful' and not insysmsg 'disturbed' and not insysmsg 'cannot cast a spell' and timer 'waiting_target_timer' < 3500
                                                    wait 10

                                                    if insysmsg 'disturbed' or insysmsg 'cannot cast a spell'
                                                        if verbose == 1
                                                            sysmsg 'BREAKING WHILE WAITING FOR CURSE TARGET' warning_msg_color
                                                        endif

                                                        wait spell_recovery_delay
                                                        break
                                                    endif
                                                endwhile

                                                if targetexists 'harmful'
                                                    clearsysmsg
                                                    hotkey 'Last Target'
                                                    wait spell_recovery_delay

                                                    if not insysmsg 'Target cannot be seen'
                                                        if verbose == 1
                                                            sysmsg '+++ RESETING CURSE TIMER' reset_timer_msg_color
                                                        endif

                                                        settimer 'curse_timer' 0
                                                        cooldown CURSE curse_delay
                                                        setvar! last_cursed_serial lasttarget
                                                    endif
                                                endif
                                            endif
                                        endif
                                    endif
                                endif

                                # mass curse
                                if followers >= followers_max_limit and diffhits < max_diffhits_before_healing
                                    if use_mass_curse == 1 and timer 'mass_curse_timer' >= curse_delay
                                        if not dead 'last' and find 'last' ground any any find_last_target_max_range

                                            if last_target_serial == last_cursed_serial and timer 'mass_curse_timer' <= curse_delay
                                                if verbose == 1
                                                    sysmsg '!!! THIS MOB WAS MASS CURSED {{curse_timer}}ms AGO' warning_msg_color
                                                endif
                                            elseif last_target_serial != last_cursed_serial and timer 'mass_curse_timer' >= curse_delay
                                                if verbose == 1
                                                    sysmsg 'â—Ž MASS CURSE' spell_msg_color
                                                endif
                                                cast 'mass curse'

                                                @settimer 'waiting_target_timer' 0
                                                clearsysmsg
                                                while not targetexists 'harmful' and not insysmsg 'disturbed' and not insysmsg 'cannot cast a spell' and timer 'waiting_target_timer' < 3500
                                                    wait 10

                                                    if insysmsg 'disturbed' or insysmsg 'cannot cast a spell'
                                                        if verbose == 1
                                                            sysmsg 'BREAKING WHILE WAITING FOR CURSE TARGET' warning_msg_color
                                                        endif

                                                        wait spell_recovery_delay
                                                        break
                                                    endif
                                                endwhile

                                                if targetexists 'harmful'
                                                    clearsysmsg
                                                    hotkey 'Last Target'
                                                    wait spell_recovery_delay

                                                    if not insysmsg 'Target cannot be seen'
                                                        if verbose == 1
                                                            sysmsg '+++ RESETING MASS CURSE TIMER' reset_timer_msg_color
                                                        endif

                                                        settimer 'mass_curse_timer' 0
                                                        cooldown CURSE mass_curse_delay
                                                        setvar! last_cursed_serial lasttarget
                                                    endif
                                                endif
                                            endif
                                        endif
                                    endif
                                endif

                                # energy bolt
                                if followers >= followers_max_limit and diffhits < max_diffhits_before_healing and not dead 'last' and find 'last' ground any any find_last_target_max_range
                                    if use_eb == 1 and timer 'eb_timer' > eb_delay
                                        if verbose == 1
                                            sysmsg '>>> ENERGY BOLT' spell_msg_color
                                        endif
                                        cast 'energy bolt' 40

                                        @settimer 'waiting_target_timer' 0
                                        while not targetexists 'harmful' and not insysmsg 'disturbed' and not insysmsg 'cannot cast a spell' and timer 'waiting_target_timer' < 4000
                                            wft 10
                                            if insysmsg 'disturbed' or insysmsg 'cannot cast a spell'
                                                if verbose == 1
                                                    sysmsg 'BREAKING WHILE WAITING FOR EB TARGET' warning_msg_color
                                                endif

                                                wait spell_recovery_delay
                                                break
                                            endif
                                        endwhile

                                        if targetexists 'harmful'
                                            clearsysmsg
                                            hotkey 'Last Target'
                                            wait spell_recovery_delay

                                            if not insysmsg 'Target cannot be seen' or insysmsg 'Wizardy Energy Bolt activated'
                                                if verbose == 1
                                                    sysmsg '+++ RESETING ENERGY BOLT TIMER' reset_timer_msg_color
                                                endif

                                                settimer 'eb_timer' 0
                                                cooldown 'ENERGY BOLT' eb_delay
                                            endif
                                        endif
                                    endif
                                endif

                                # magic arrow
                                if followers >= followers_max_limit and diffhits < max_diffhits_before_healing and not dead 'last' and find 'last' ground any any find_last_target_max_range
                                    if use_ma == 1 and timer 'ma_timer' > ma_delay
                                        if verbose == 1
                                            sysmsg 'â—Ž MAGIC ARROW' spell_msg_color
                                        endif
                                        cast 'magic arrow'

                                        @settimer 'waiting_target_timer' 0
                                        while not targetexists 'harmful' and not insysmsg 'disturbed' and not insysmsg 'cannot cast a spell' and timer 'waiting_target_timer' < 1500
                                            wft 10
                                            if insysmsg 'disturbed' or insysmsg 'cannot cast a spell'
                                                if verbose == 1
                                                    sysmsg 'BREAKING WHILE WAITING FOR MA TARGET' warning_msg_color
                                                endif
                                                wait spell_recovery_delay
                                                break
                                            endif
                                        endwhile

                                        if targetexists 'harmful'
                                            hotkey 'Last Target'
                                            wait spell_recovery_delay

                                            if not insysmsg 'Target cannot be seen' or insysmsg 'Wizardy magic arrow activated'
                                                wait spell_recovery_delay
                                                settimer 'ma_timer' 0
                                                cooldown 'MAGIC ARROW' ma_delay
                                            endif
                                        endif
                                    endif
                                endif

                                # harm
                                if followers >= followers_max_limit and diffhits < max_diffhits_before_healing and not dead 'last' and find 'last' ground any any find_last_target_max_range
                                    if use_harm == 1 and timer 'harm_timer' > harm_delay
                                        if verbose == 1
                                            sysmsg 'â—Ž HARM' spell_msg_color
                                        endif
                                        cast 'harm'

                                        @settimer 'waiting_target_timer' 0
                                        while not targetexists 'harmful' and not insysmsg 'disturbed' and not insysmsg 'cannot cast a spell' and timer 'waiting_target_timer' < 1500
                                            wft 10
                                            if insysmsg 'disturbed' or insysmsg 'cannot cast a spell'
                                                if verbose == 1
                                                    sysmsg 'BREAKING WHILE WAITING FOR HARM TARGET' warning_msg_color
                                                endif
                                                wait spell_recovery_delay
                                                break
                                            endif
                                        endwhile

                                        if targetexists 'harmful'
                                            hotkey 'Last Target'
                                            wait spell_recovery_delay

                                            if not insysmsg 'Target cannot be seen' or insysmsg 'Wizardy harm activated'
                                                settimer 'harm_timer' 0
                                                cooldown HARM harm_delay
                                            endif
                                        endif
                                    endif
                                endif

                                ########################################
                                # KEEP HEALING PETS
                                ########################################
                            
                                if is_veterinarian == 1 and auto_heal_pets == 1 and not targetexists 'any'
                                    if not cooldown Bandage
                                        if findtype 'veterinary supplies' as vet_supplies
                                            settimer 'heal_pets_timer' 0
                                            useobject vet_supplies
                                            if verbose == 1
                                                sysmsg ">>> USING VET SUPPLIES ON PET" 76
                                                overhead '*vetting*' 76 pet
                                                overhead '*vetting player pet*' 77 'self'
                                            endif
                                        # elseif findtype 'clean bandage%s%' as bands
                                        #     useobject bands
                                        #     wft 1000
                                        #     if targetexists 'beneficial'
                                        #         overhead '*bandaging...*' 55 pet
                                        #         sysmsg ">>> BANDAGING PET" 55
                                        #         target pet
                                        #     endif
                                        endif
                                    endif
                                endif

                                # fireball
                                if followers >= followers_max_limit and diffhits < max_diffhits_before_healing and not dead 'last' and find 'last' ground any any find_last_target_max_range
                                    if use_fireball == 1 and timer 'fireball_timer' > fireball_delay
                                        if verbose == 1
                                            sysmsg 'â—Ž FIREBALL' spell_msg_color
                                        endif

                                        cast 'fireball'

                                        @settimer 'waiting_target_timer' 0
                                        while not targetexists 'harmful' and not insysmsg 'disturbed' and not insysmsg 'cannot cast a spell' and timer 'waiting_target_timer' < 1500
                                            wft 10
                                            if insysmsg 'disturbed' or insysmsg 'cannot cast a spell'
                                                if verbose == 1
                                                    sysmsg 'BREAKING WHILE WAITING FOR FIREBALl TARGET' warning_msg_color
                                                endif

                                                wait spell_recovery_delay
                                                break
                                            endif
                                        endwhile

                                        if targetexists 'harmful'
                                            hotkey 'Last Target'
                                            wait spell_recovery_delay

                                            if not insysmsg 'Target cannot be seen' or insysmsg 'Wizardy fireball activated'
                                                settimer 'fireball_timer' 0
                                                cooldown FIREBALL fireball_delay
                                            endif
                                        endif
                                    endif
                                endif

                                # kill close to loot mob easier (duplicate from above snippet)
                                if lure_mobs_closer_before_killing == 1 and timer 'lure_mob_closer_timer' > 4000
                                    if not find 'last' ground any any lure_mobs_distance_to_lure
                                        if verbose == 1
                                            sysmsg '>>> LURING MOB CLOSE TO CHAR' default_sysmsg_color
                                        endif
                                        # say 'all kill'
                                        # wft 600
                                        # target 'last'
                                        # this wait is just to avoid speech throttle from the server
                                        wait 250

                                        say 'all follow me'

                                        settimer 'waiting_mob_to_approach_timer' 0
                                        while timer 'waiting_mob_to_approach_timer' < 1500
                                            wait 10
                                            if find 'last' ground any any lure_mobs_distance_to_lure
                                                sysmsg 'MOB IS NOW AT {{lure_mobs_distance_to_lure}} TILES' success_msg_color
                                                break
                                            endif
                                        endwhile


                                        hotkey 'Toggle Peace Only'
                                        settimer 'lure_mob_closer_timer' 0
                                        say 'all guard me'
                                    else
                                        if verbose == 1
                                            sysmsg '>>> MOB IS CLOSE, NO NEED TO LURE' warning_msg_color
                                        endif
                                    endif
                                endif


                                # lightning
                                if followers >= followers_max_limit and diffhits < max_diffhits_before_healing and not dead 'last' and find 'last' ground any any find_last_target_max_range
                                    if use_lightning == 1
                                        if timer 'lightning_timer' > lightning_delay
                                            if verbose == 1
                                                sysmsg 'â—Ž LIGHTNING' spell_msg_color
                                            endif
                                            cast 'lightning'

                                            @settimer 'waiting_target_timer' 0
                                            while not targetexists 'harmful' and not insysmsg 'disturbed' and not insysmsg 'cannot cast a spell' and timer 'waiting_target_timer' < 2500
                                                wft 10
                                                if insysmsg 'disturbed' or insysmsg 'cannot cast a spell'
                                                    if verbose == 1
                                                        sysmsg 'BREAKING WHILE WAITING FOR LIGHTNING TARGET' warning_msg_color
                                                    endif

                                                    wait spell_recovery_delay
                                                    break
                                                endif
                                            endwhile

                                            if targetexists 'harmful'
                                                hotkey 'Last Target'
                                                wait spell_recovery_delay

                                                if not insysmsg 'Target cannot be seen' or insysmsg 'Wizardy lightning activated'
                                                    settimer 'lightning_timer' 0
                                                    cooldown LIGHTNING lightning_delay
                                                endif
                                            endif
                                        else
                                            if verbose == 1
                                                sysmsg 'LIGHTNING NOT READY! TIMER: {{lightning_timer}}' warning_msg_color
                                            endif
                                        endif
                                    endif
                                endif


                                # USE MIND BLAST
                                if followers >= followers_max_limit and diffhits < max_diffhits_before_healing and not dead 'last' and find 'last' ground any any find_last_target_max_range
                                    if use_mind_blast == 1
                                        if verbose == 1
                                            sysmsg 'â—Ž MIND BLAST' spell_msg_color
                                        endif
                                        cast 'mind blast'

                                        @settimer 'waiting_target_timer' 0
                                        while not targetexists 'harmful' and not insysmsg 'disturbed' and not insysmsg 'cannot cast a spell' and timer 'waiting_target_timer' < 4500
                                            wft 10
                                            if insysmsg 'disturbed' or insysmsg 'cannot cast a spell'
                                                if verbose == 1
                                                    sysmsg 'BREAKING WHILE WAITING FOR MIND BLAST TARGET' warning_msg_color
                                                endif

                                                wait spell_recovery_delay
                                                break
                                            endif
                                        endwhile

                                        if targetexists 'harmful'
                                            hotkey 'Last Target'
                                            wait spell_recovery_delay
                                        endif
                                    endif
                                endif

                                ########################################
                                # KEEP HEALING PETS
                                ########################################
                            
                                if is_veterinarian == 1 and auto_heal_pets == 1 and not targetexists 'any'
                                    if not cooldown Bandage
                                        if findtype 'veterinary supplies' as vet_supplies
                                            settimer 'heal_pets_timer' 0
                                            useobject vet_supplies
                                            sysmsg ">>> USING VET SUPPLIES ON PET" 76
                                            overhead '*vetting*' 76 pet
                                            overhead '*vetting player pet*' 77 'self'
                                        # elseif findtype 'clean bandage%s%' as bands
                                        #     useobject bands
                                        #     wft 1000
                                        #     if targetexists 'beneficial'
                                        #         overhead '*bandaging...*' 55 pet
                                        #         sysmsg ">>> BANDAGING PET" 55
                                        #         target pet
                                        #     endif
                                        endif
                                    endif
                                endif

                                # USE FLAMESTRIKE
                                if followers >= followers_max_limit and diffhits < max_diffhits_before_healing and not dead 'last' and find 'last' ground any any find_last_target_max_range
                                    if use_flamestrike == 1
                                        if verbose == 1
                                            sysmsg 'â—Ž FLAMESTRIKE' spell_msg_color
                                        endif
                                        cast 'flamestrike'

                                        @settimer 'waiting_target_timer' 0
                                        while not targetexists 'harmful' and not insysmsg 'disturbed' and not insysmsg 'cannot cast a spell' and timer 'waiting_target_timer' < 4500
                                            wft 10
                                            if insysmsg 'disturbed' or insysmsg 'cannot cast a spell'
                                                if verbose == 1
                                                    sysmsg 'BREAKING WHILE WAITING FOR FLAMESTRIKE TARGET' warning_msg_color
                                                endif

                                                wait spell_recovery_delay
                                                break
                                            endif
                                        endwhile

                                        if targetexists 'harmful'
                                            hotkey 'Last Target'
                                            wait spell_recovery_delay
                                        endif
                                    endif
                                endif


                                # CHAIN LIGHTNING
                                if followers >= followers_max_limit and diffhits < max_diffhits_before_healing and not dead 'last' and find 'last' ground any any find_last_target_max_range
                                    if use_chain_lightning == 1
                                        if timer 'chain_lightning_timer' > chain_lightning_delay
                                            if verbose == 1
                                                sysmsg 'â—Ž CHAIN LIGHTNING' spell_msg_color
                                            endif
                                            cast 'chain lightning'

                                            @settimer 'waiting_target_timer' 0
                                            while not targetexists 'harmful' and not insysmsg 'disturbed' and not insysmsg 'cannot cast a spell' and timer 'waiting_target_timer' < 2500
                                                wft 10
                                                if insysmsg 'disturbed' or insysmsg 'cannot cast a spell'
                                                    if verbose == 1
                                                        sysmsg 'BREAKING WHILE WAITING FOR CHAIN LIGHTNING TARGET' warning_msg_color
                                                    endif

                                                    wait spell_recovery_delay
                                                    break
                                                endif
                                            endwhile

                                            if targetexists 'harmful'
                                                hotkey 'Last Target'
                                                wait spell_recovery_delay

                                                if not insysmsg 'Target cannot be seen'
                                                    if verbose == 1
                                                        sysmsg '+++ RESETING CHAIN LIGHTNING TIMER' reset_timer_msg_color
                                                    endif

                                                    settimer 'chain_lightning_timer' 0
                                                    cooldown 'CHAIN LIGHTNING' chain_lightning_delay
                                                endif
                                            endif

                                        else
                                            if verbose == 1
                                                sysmsg 'CHAIN LIGHTNING NOT READY! TIMER: {{lightning_timer}}' warning_msg_color
                                            endif
                                        endif
                                    endif
                                endif


                                # METEOR SWARM
                                if followers >= followers_max_limit and diffhits < max_diffhits_before_healing and not dead 'last' and find 'last' ground any any find_last_target_max_range
                                    if use_meteor_swarm == 1 and timer 'meteor_swarm_timer' > meteor_swarm_delay
                                        if verbose == 1
                                            sysmsg 'â—Ž METEOR SWARM ' spell_msg_color
                                        endif
                                        cast 'meteor swarm'

                                        @settimer 'waiting_target_timer' 0
                                        while not targetexists 'harmful' and not insysmsg 'disturbed' and not insysmsg 'cannot cast a spell' and timer 'waiting_target_timer' < 2500
                                            wft 10
                                            if insysmsg 'disturbed' or insysmsg 'cannot cast a spell'
                                                if verbose == 1
                                                    sysmsg 'BREAKING WHILE WAITING FOR METEOR SWARM TARGET' warning_msg_color
                                                endif

                                                wait spell_recovery_delay
                                                break
                                            endif
                                        endwhile

                                        if targetexists 'harmful'
                                            hotkey 'Last Target'
                                            wait spell_recovery_delay

                                            if not insysmsg 'Target cannot be seen'
                                                if verbose == 1
                                                    sysmsg '+++ RESETING METEOR SWARM TIMER' reset_timer_msg_color
                                                endif

                                                settimer 'meteor_swarm_timer' 0
                                                cooldown 'Meteor Swarm' meteor_swarm_delay
                                            endif
                                        endif
                                        endif
                                    endif
                                endif

                                # ###############################
                                # # EARTHQUAKE
                                # ###############################

                                if followers >= followers_max_limit and diffhits < max_diffhits_before_healing and not dead 'last' and find 'last' ground any any find_last_target_max_range
                                    if use_meteor_swarm == 1 and timer 'earthquake_timer' > earthquake_delay
                                        if verbose == 1
                                            sysmsg '>>> EARTHQUAKE' spell_msg_color
                                        endif
                                        cast 'earthquake'

                                        @settimer 'waiting_target_timer' 0
                                        while not insysmsg 'disturbed' and not insysmsg 'cannot cast a spell' and timer 'waiting_target_timer' < 2500
                                            wft 10
                                            if insysmsg 'disturbed' or insysmsg 'cannot cast a spell'
                                                if verbose == 1
                                                    sysmsg 'BREAKING WHILE WAITING FOR EARTHQUAKE' warning_msg_color
                                                endif

                                                wait spell_recovery_delay
                                                break
                                            endif
                                        endwhile

                                        if targetexists 'harmful'
                                            hotkey 'Last Target'
                                            wait spell_recovery_delay
                                            settimer 'earthquake_timer' 0
                                        endif
                                    endif
                                endif




                                # ###############################
                                # # PAIN SPIKE
                                # ###############################

                                if use_pain_spike == 1
                                    if not timerexists 'painspike_timer'
                                        createtimer 'painspike_timer'
                                        settimer 'painspike_timer' 30001
                                    endif



                                    if skill 'necromancy' > 20 and findtype 'corpse' ground any any 30
                                        if timer 'painspike_timer' >= 30000
                                            if verbose == 1
                                                sysmsg '>>> Using pain spike...'
                                            endif

                                            say '[painspike'
                                            wft action_delay
                                            if targetexists 'neutral'
                                                if verbose == 1
                                                    sysmsg '>>> PAIN SPIKE!' 89
                                                endif

                                                hotkey 'Last Target'
                                                wait action_delay
                                                if insysmsg 'Unholy symbols remaining'
                                                    if verbose == 1
                                                        sysmsg '>>> EXPLODED CORPSE!' 30
                                                    endif

                                                    if use_script_overhead_messages == 1
                                                        overhead '*exploded corpse*' 30
                                                    endif

                                                    settimer 'painspike_timer' 0
                                                endif
                                            endif
                                            wait action_delay
                                        else
                                            if verbose == 1
                                                sysmsg 'Pain spike cooldown...' 56
                                            endif
                                        endif
                                    endif
                                endif

                            endif

                        else
                            if debug == 1
                                sysmsg 'NAO ENTROU NOTO AQUI 2'
                                overhead 'LAST BUGADO' 90 'last'
                                hotkey 'Cancel Current Target'
                                break
                            endif
                        endif
                    else
                        if debug == 1
                            sysmsg 'NAO ENTROU NOTO AQUI 1'
                            overhead 'LAST BUGADO' 90 'last'
                            hotkey 'Cancel Current Target'
                            break
                        endif
                    endif
                # CLOSES if not dead last target inside main while loop of main attack routine
                endif
            # CLOSES while not dead lasttarget or enemy_boat_present == 1
            endwhile
        endif
    # CLOSES if followers >= followers_max_limit and diffhits < max_diffhits_before_healing
    endif


    #########################################
    # QUESTS AND EVENT SPECIFIC CODE
    #########################################

    if insysmsg 'You have received a Dungeon Torch!'
        sysmsg '!!!!!! DUNGEON TORCH!!!!!!!!!!!!!!!!!!!' 90
        overhead '!!!!!! DUNGEON TORCH!!!!!!!!!!!!!!!!!!!' 90
    endif

    if findtype 'an elusive rabbit' ground any any 30 as rabbit
        overhead '!! RABBIT !!' 90
        overhead '!! RABBIT !!' 90 rabbit
    endif





    #########################################
    # AUTO RAIL ROUTINE
    #########################################

    if auto_rail == 1
        if debug == 1
           sysmsg '[DEBUG] ENTERED RAIL' debug_msg_color
        endif

        setvar! do_rail_now 0

        hotkey 'Target Closest Non-Friendly Monster'
        hotkey 'Set Last Target'
        wft action_delay
        hotkey 'Last Target'
        wait spell_recovery_delay

        if dead last_target_serial
            if verbose == 1
                sysmsg 'LAST TARGET DEAD. DOING RAIL' debug_msg_color
            endif

            setvar! do_rail_now 1
        elseif insysmsg 'Target cannot be seen'
            if verbose == 1
              sysmsg 'LAST TARGET CANNOT BE SEEN. DOING RAIL' debug_msg_color
            endif

            setvar! do_rail_now 1
        elseif insysmsg 'The requested target is out of range'
            if verbose == 1
                sysmsg 'TARGET IS OUT OF RANGE. DOING RAIL' alert_msg_color
            endif

            setvar! do_rail_now 1
        endif


        if do_rail_now == 1
            sysmsg 'DOING RAIL INDEX {{current_rail_index}}' rail_msg_color

            if current_rail_index >= list 'rail_directions'
                sysmsg 'GOT TO END OF RAIL LIST. RESETING RAIL INDEX' rail_msg_color
                setvar! current_rail_index 0
            endif

            unsetvar rail_direction
            unsetvar rail_x
            unsetvar rail_y

            if atlist 'rail_directions' current_rail_index as direction
                if direction == 10
                    # sysmsg 'SETTING DIRECTION TO 0'
                    setvar! rail_direction 0
                else
                    setvar! rail_direction direction
                    # sysmsg 'SETTING DIRECTION TO {{rail_direction}}'
                endif
            endif
            if atlist 'rail_x_positions' current_rail_index as x
                setvar! rail_x x
                # sysmsg 'SETTING X POSITION TO {{rail_x}}'
            endif
            if atlist 'rail_y_positions' current_rail_index as y
                setvar! rail_y y
                # sysmsg 'SETTING Y POSITION TO {{rail_y}}'
            endif
            # endfor

            # WALK THE RAIL!
            if varexist rail_direction and varexist rail_x and varexist rail_y
                while not position rail_x rail_y
                    sysmsg 'RAIL {{current_rail_index}}: DIRECTION: {{rail_direction}} | X: {{rail_x}} | Y: {{rail_y}}' rail_msg_color
                    walk rail_direction

                    if dead lasttarget
                        hotkey 'Target Closest Non-Friendly Monster'
                    endif

                    if not dead lasttarget
                        sysmsg '[RAIL] CHECKING LASTTARGET DISTANCE' rail_msg_color
                        hotkey 'Set Last Target'
                        wft action_delay
                        hotkey 'Last Target'
                    endif

                    wait 400

                    if not dead lastarget and not insysmsg 'not be seen' and not insysmsg 'out of range'
                        if debug == 1
                            sysmsg 'BREAKING ON RAIL' alert_msg_color
                        endif
                        break
                    endif
                endwhile
            else
                sysmsg 'COUNDNT SET RAIL VARIABLES' alert_msg_color
            endif

            if varexist rail_direction and varexist rail_x and varexist rail_y
                if position rail_x rail_y
                    sysmsg 'RAIL {{current_rail_index}} COMPLETE...' success_msg_color

                        # lift trap_pouch
                    if current_rail_index == 0
                        setvar! current_rail_index 1
                    elseif current_rail_index == 1
                        setvar! current_rail_index 2
                    elseif current_rail_index == 2
                        setvar! current_rail_index 3
                    elseif current_rail_index == 3
                        setvar! current_rail_index 4
                    elseif current_rail_index == 4
                        setvar! current_rail_index 5
                    elseif current_rail_index == 5
                        setvar! current_rail_index 6
                    elseif current_rail_index == 6
                        setvar! current_rail_index 7
                    elseif current_rail_index == 7
                        setvar! current_rail_index 8
                    elseif current_rail_index == 8
                        setvar! current_rail_index 9
                    elseif current_rail_index == 9
                        setvar! current_rail_index 10
                    elseif current_rail_index == 10
                        setvar! current_rail_index 11
                    elseif current_rail_index == 11
                        setvar! current_rail_index 11
                    elseif current_rail_index == 12
                        setvar! current_rail_index 13
                    endif

                    sysmsg 'SETTING NEXT RAIL INDEX TO {{current_rail_index}}' success_msg_color
                endif
            endif

        endif
    endif


    if auto_patrol_when_no_active_lasttarget == 1 and timer 'all_patrol_timer' > all_patrol_delay
        say 'all patrol'
        wft action_delay
        targetrelloc patrol_first_relative_direction patrol_second_relative_direction

        if verbose == 1
            sysmsg '[TIMER] RESETING PATROL (NEXT IN {{all_patrol_delay}})' reset_timer_msg_color
            sysmsg '[TIMER] RESETING GUARD (NEXT IN {{all_guard_delay}})' reset_timer_msg_color
        endif

        settimer 'all_patrol_timer' 0
        # also reset guard to wait a bit longer to call pets back in
        settimer 'all_guard_timer' 0
    endif

    # putting the clear here to reset all possible msgs i caught during the previous iteration
    clearsysmsg

    setvar! first_run_done 1
endwhile
