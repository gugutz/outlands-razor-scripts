setvar! script_version 1000

# LIGHT SOURCES OFF AT STARTUP - RE-READ CHAR CONFIG
# dungeon torches have to be undressed (they have to be in the backpack since they cant be turned off)
# if findtype 2597|3947 self as found
#     sysmsg 'LANTERN OFF AT STARTUP. RESETTING SCRIPT CONFIG...' success_msg_color
#     unsetvar! mage_bot_config_loaded
#     dclick found
# elseif findtype 'dungeon torch' backpack as found
#     sysmsg 'LANTERN OFF AT STARTUP. RESETTING SCRIPT CONFIG...' success_msg_color
#     unsetvar! mage_bot_config_loaded
#     dclick found
# endif

if not varexist mage_bot_greetings_done
    sysmsg '#########################' 90
    # overhead 'ðŸ¤– MAGE BOT ðŸ¤–' 55
    # overhead 'by gugutz' 55
    # overhead 'version 3.0' 56
    sysmsg 'â˜…â˜… MAGE BOT Â®' 55
    sysmsg 'â†’ by gugutz â„¢' 55
    sysmsg 'version: {{script_version}}' 56
    sysmsg '########################' 90


    #####################################
    # VARIABLES FOR MESSAGE COLORS
    #####################################
    setvar! debug_msg_color 76
    setvar! script_msg_color 1151
    setvar! default_sysmsg_color 56
    setvar! default_overhead_color 56


    setvar! spell_msg_color 49
    setvar! necro_spell_msg_color 1195
    setvar! buff_msg_color 92
    # setvar! warning_msg_color 1196
    setvar! warning_msg_color 1161
    # setvar! alert_msg_color 1172
    setvar! alert_msg_color 33
    setvar! success_msg_color 1272
    setvar! action_msg_color 1151
    setvar! rail_msg_color 116
    setvar! skill_cooldown_msg_color 51
    setvar! spell_cooldown_msg_color 53
    setvar! reset_timer_msg_color 1258
    setvar! boating_msg_color 84

    setvar! mage_bot_greetings_done 1
endif

# sysmsg '.' instructions_msg_color

if not timerexists 'execution_timer'
    createtimer 'execution_timer'
endif

settimer 'execution_timer' 0



############################################################################
# INSTRUCTIONS
############################################################################

# if printed_instructions_once != 1
#     setvar! instructions_msg_color 1161
#     sysmsg '########################' 90
#     sysmsg '.' instructions_msg_color
#     sysmsg 'INSTRUCTIONS:' instructions_msg_color
#     sysmsg '.' instructions_msg_color
#     sysmsg "â–· If boating, start from inside the boat with enough space to turn it" instructions_msg_color
#     sysmsg "â–· If using packies, start close to them and far from other players packies" instructions_msg_color
#     sysmsg "â–· Create Cooldowns for each spell. Ex: 'Magic Arrow', 'Harm', ..." instructions_msg_color
#     sysmsg '########################' 90
#     sysmsg '.' instructions_msg_color

#     # wait 3000
#     setvar! printed_instructions_once 1
# endif




############################################################################
# GENERAL SETTINGS
############################################################################


if not varexist mage_bot_config_loaded
    # create lists used in config first
    if not listexists 'summons'
        createlist 'summons'
    endif

    sysmsg '[OPS] READING AND APPLYING CONFIG...' script_msg_color
    script 'loops\mage-bot\config'
endif

# SET MAX SUMMONS LIMIT
# if summ creature is one of players summons, change limit to 5 so even with 4 followers, we still make the char cast to summon the fifth creature
# if not, then we just want 2 elementals so limit should be 4, since they take up 2 slots each and the fifth wouldnt be possible
if list 'summons' > 0
    if inlist 'summons' 'summ. creature'
        setvar! followers_max_limit 5
    else
        setvar! followers_max_limit 4
    endif
endif

############################################################################
# SET FLAGS FOR CHAR TEMPLATE/SKILLS
############################################################################

if not varexist mage_bot_templates_detected
    setvar! is_summoner 0
    setvar! is_tamer 0
    setvar! is_herder 0
    setvar! is_veterinarian 0
    setvar! is_detecter 0
    setvar! is_noxxer 0


    # taming
    if skill 'taming' >= 100
        setvar! is_tamer 1
        sysmsg 'TAMER DETECTED. OPTIMIZING...' script_msg_color
        setvar! auto_heal_pets 1
        setvar! auto_ress_pets 1
        # keep close so the pets are close to heal
        setvar! keep_pets_close_to_vet 1
    endif

    # veterinary
    if skill 'veterinary' >= 50
        sysmsg 'VETERINARY DETECTED. OPTIMIZING...' script_msg_color
        setvar! is_veterinarian 1
    endif

    # herder
    if skill 'herding' >= 80
        sysmsg 'HERDER DETECTED. OPTIMIZING...' script_msg_color
        setvar! is_herder 1
        setvar! auto_herd_mobs 1
    endif

    # detecter
    if skill 'detectinghidden' >= 80
        sysmsg 'DETECTER DETECTED. OPTIMIZING...' script_msg_color
        setvar! is_detecter 1
    endif

    # summoner
    if skill 'magery' >= 90 and skill 'taming' == 0
        sysmsg 'SUMMONER DETECTED. OPTIMIZING...' script_msg_color
        setvar! is_summoner 1
    endif

    if skill 'necromancy' >= 50
        sysmsg 'NECROMANCER DETECTED. OPTIMIZING...' script_msg_color
        setvar! is_necromancer 1
    endif

    if skill 'poisoning' >= 80
        sysmsg 'NOXXER DETECTED. OPTIMIZING...' script_msg_color
        setvar! is_noxxer 1
    endif

    setvar! mage_bot_templates_detected 1
endif





############################################################################
# AUTO SETUP SCRIPT SETTINGS BASED ON TEMPLATE
############################################################################



if not varexist skill_based_configuration_done
    if auto_configure_script_based_on_skills == 1
        # SUMMONER AUTO SETUP
        if is_summoner == 1
            if list summons == 0
                sysmsg '[OPTS] Setting Summons' script_msg_color
                clearlist 'summons'
                pushlist 'summons' 'an earth elemental'
                pushlist 'summons' 'an earth elemental'
                pushlist 'summons' 'summ. creature'
            endif

            # if auto_summon == 0
            #     sysmsg '[OPTS] Enabling Auto Summon' script_msg_color
            #     setvar! auto_summon 1
            # endif



            # if summ creature is one of players summons, change limit to 5 so even with 4 followers, we still make the char cast to summon the fifth creature
            # if not, then we just want 2 elementals so limit should be 4, since they take up 2 slots each and the fifth wouldnt be possible
            if inlist 'summons' 'summ. creature'
                setvar! followers_max_limit 5
            else
                setvar! followers_max_limit 4
            endif

            # if is_necromancer == 0 and use_undead_summons == 1
            #     sysmsg '[OPTS] Disabling Use Undead Summons' script_msg_color
            #     setvar! use_undead_summons 0
            # endif
        endif

        # NOXXER AUTO SETUP
        if is_noxxer == 1
            if use_poison == 0
                sysmsg '[OPTS] NOXXER -> Use Poison' script_msg_color
                setvar! use_poison 1
            endif

            if is_necromancer == 1 and use_poison_strike == 0
                sysmsg '[OPTS] NOXXER -> Use Poison Strike' script_msg_color
                setvar! use_poison_strike 1
            endif
        endif


        # TAMER AUTO SETUP
        if is_tamer == 1
            if auto_summon == 1
                sysmsg '[OPTS] TAMER -> Disabling Auto Summon' script_msg_color
                setvar! auto_summon 0
            endif

            # for tamers we dont want the char to think its under max summons right?
            setvar! followers_max_limit 1
        endif

        # VETERINARIAN AUTO SETUP
        if is_veterinarian == 1
            sysmsg '[OPTS] ENABLING auto_vet_pets' script_msg_color
            setvar! auto_vet_pets 1
            setvar! vet_pets_delay 5000
        endif


        # HERDER AUTO SETUP
        if is_herder == 0 and auto_herd_mobs == 1
            sysmsg '[OPTS] DISABLING auto_herd_mobs' script_msg_color
            setvar! auto_herd_mobs 0
        elseif is_herder == 1 and auto_herd_mobs == 0
            sysmsg '[OPTS] ENABLING auto_herd_mobs' script_msg_color
            setvar! auto_herd_mobs 1
        endif

        # NECRO AUTO SETUP
        # if is_necromancer == 0 and use_undead_summons == 1
        #     sysmsg '[OPTS] DISABLING use_undead_summons' script_msg_color
        #     setvar! use_undead_summons 0
        # elseif is_necromancer == 1
        #     if use_undead_summons == 0
        #         sysmsg '[OPTS] Use Undead Summons' script_msg_color
        #         setvar! use_undead_summons 1
        #     endif

        #     if auto_vampiric_embrace == 0
        #         sysmsg '[OPTS] Use Vampiric Embrace' script_msg_color
        #         setvar! auto_vampiric_embrace 1
        #     endif
        # endif
    endif

    setvar! skill_based_configuration_done 1
endif


# WARN IF SET TO HIDE VALUABLES BUT NO CHAR_LOOT_POUCH SET
if hide_valuables_in_char_loot_pouch == 1
    if not varexist CHAR_LOOT_POUCH
        sysmsg 'LOOT POUCH IS NOT SET. PLEASE SELECT A POUCH TO HIDE VALUABLE LOOT:' warning_msg_color
        setvar CHAR_LOOT_POUCH
    elseif varexist CHAR_LOOT_POUCH and not find CHAR_LOOT_POUCH backpack
        sysmsg 'CANT FIND PREVIOUSLY SET LOOT POUCH. PLEASE SELECT A NEW ONE:' warning_msg_color
        setvar CHAR_LOOT_POUCH
    endif
endif




############################################################################
# SCRIPT SPECIFIC SETTINGS (USUALLY THERES NO NEED TO DONT CHANGE THESE)
############################################################################

if not varexist mage_bot_script_variables_done
    if not timerexists 'script_related_settings_timer'
        createtimer 'script_related_settings_timer'
    endif
    settimer 'script_related_settings_timer' 0
    setvar! last_target_serial 0

    setvar! action_delay 550
    setvar! spell_recovery_delay 130
    setvar! recall_travel_time 3200
    # set to go to next rune when script starts in case cycle_runetome_farming is active
    setvar! go_to_next_rune 1

    setvar! find_last_target_max_range 30
    setvar! attack_range 12
    setvar! offensive_spell_range 12
    setvar! find_enemy_boats_max_range 15
    # this was 8, worked for a while, testing with 15 because
    # when playing without luring, the summons sometimes get really far
    setvar! find_summon_range 15

    #####################################
    # LIMITS BEFORE ACTIONS
    setvar! max_diffhits_before_healing 10
    setvar! max_diffhits_before_greater_heal 20
    # setvar! max_diffhits_before_buffing 5
    setvar! max_diffhits_before_meditating 5
    setvar! max_diffhits_before_heal_pot 40
    setvar! min_diffweight_before_going_home_to_unload 15
    setvar! min_mana_to_attack 45
    setvar! mana_limit_to_medit 40
    setvar! mana_limit_to_eat_mushroom 70
    setvar! mushroom_limit_before_creating_more 2
    setvar! mushroom_stock_size 15


    #####################################
    # CONSTANTS FOR IN-GAME GUMP IDS
    setvar! necromancy_gump_id 622436516

    # boating gumps
    # setvar! dockmaster_gump_id 3287496917
    # setvar! boarding_gump_id 2881168634
    # setvar! search_ships_gump_id 2890020940


    setvar! 1st_circle_spell_mana_cost 8
    setvar! 2nd_circle_spell_mana_cost 9
    setvar! 3rd_circle_spell_mana_cost 10
    setvar! 4th_circle_spell_mana_cost 12


    if is_summoner == 1

        #####################################
        # SUMMONS SPELL LISTS
        #####################################

        if not listexists 'summonspells'
            createlist 'summonspells'
        endif
        clearlist 'summonspells'

        if inlist 'summons' 'an air elemental'
            @pushlist 'summonspells' 'air elemental'
        endif
        if inlist 'summons' 'an earth elemental'
            @pushlist 'summonspells' 'earth elemental'
        endif
        if inlist 'summons' 'a water elemental'
            @pushlist 'summonspells' 'water elemental'
        endif
        if inlist 'summons' 'a fire elemental'
            @pushlist 'summonspells' 'fire elemental'
        endif
        if inlist 'summons' 'a daemon'
            @pushlist 'summonspells' 'summon daemon'
        endif
        if inlist 'summons' 'an energy vortex'
            @pushlist 'summonspells' 'energy vortex'
        endif
        if inlist 'summons' 'a blade spirit'
            @pushlist 'summonspells' 'blade spirits'
        endif
        if inlist 'summons' 'summ. creature'
            @pushlist 'summonspells' 'summ. creature'
        endif
    endif

    if debug == 1
        sysmsg '>> FINISHED SCRIPT RELATED VARIABLES AND LISTS IN  {{script_related_settings_timer}} ms' script_msg_color
    endif
    setvar! mage_bot_script_variables_done 1
endif


setvar! script_settings_execution_time script_settings_timer



#################################
# CREATE ALL TIMERS
#################################

if not varexist timers_setup_done
    if not timerexists 'timers_setup_time'
        createtimer 'timers_setup_time'
    endif

    settimer 'timers_setup_time' 0

    script 'loops\mage-bot\timers'
endif

if debug == 1
    settimer 'script_stats_msg_timer' 0
endif




#######################################################
# TAMER PRE START ROUTINE
#######################################################

if not varexist mage_bot_tamer_setup_done
    if skill 'taming' >= 100
        sysmsg "SCANNING FOR PLAYER PETS at {{execution_timer}}" success_msg_color
        if not listexists player_pets
            @createlist player_pets
            createlist player_tank_pets
            createlist player_ranged_pets
        endif

        if list player_pets == 0
            while findtype 293|60|61|385|776|213|169|718|315|729|12|59|388 ground any 5 find_pet_range as pet
                if noto pet = friend
                    overhead 'found tank pet!' 55 pet
                    if not inlist player_pets pet
                        @pushlist player_pets pet
                    endif
                    if not inlist player_tank_pets pet
                        @pushlist player_tank_pets pet
                    endif
                    # ignore for now so razor cant find it anymore and we can leave the while loop
                endif
                @ignore pet
            endwhile
            @clearignore

            # using 5 here cause thats the max ammount of pets of the same graphic a player can have
            while findtype 51|832|287|2466 ground any 5 find_pet_range as pet
                if noto pet = friend and not inlist 'player_pets' pet
                    overhead 'found ranged pet!' 55 pet
                    @pushlist player_ranged_pets pet
                    @pushlist player_pets pet
                    # ignore for now so razor cant find it anymore and we can leave the while loop
                endif
                @ignore pet
            endwhile
            @clearignore
        endif
    endif
    setvar! mage_bot_tamer_setup_done 1
endif



#############################
# TRAVEL CONFIG
#############################

if not varexist mage_bot_travel_setup_done
    # SET THE HOME BOOK
    if not varexist home_book
        while findtype 'runetome' backpack as found
            getlabel found rtome_label
            if 'home' in rtome_label or 'Home' in rtome_label or 'HOME' in rtome_label
                sysmsg 'HOME RUNETOME: {{found}}' success_msg_color
                setvar! home_book found
                setvar! home_book_gump_id 167090027
                setvar! home_rune_btn_number runetome_rune_position
                break
            endif

            @ignore found
        endwhile
        @clearignore

        # if we couldnt find a home runetome, search for a home runebook
        if not varexist home_book
            while findtype 'runebook' backpack as found
                getlabel found rbook_label
                if 'home' in rbook_label or 'Home' in rbook_label or 'HOME' in rbook_label
                    sysmsg 'FOUND HOME RUNEBOOK {{rbook_label}}' success_msg_color
                    setvar! home_book found
                    setvar! home_book_gump_id 167090027
                    setvar! home_rune_btn_number runetome_rune_position
                    break
                endif

                @ignore found
            endwhile
            @clearignore
        endif

        if not varexist home_book
            sysmsg "YOU NEED A RUNEBOOK OR RUNETOME NAMED 'HOME' WITH YOUR HOME RUNE SET TO DEFAULT TO RUN THIS SCRIPT" 54
            stop
        endif
    endif


    # RUNEBOOK / RUNETOME RECALL SETTINGS
    setvar! recall_home_now 0
    setvar! runetome_gump_id 167090027
    setvar! runebook_gump_id 1551740969
    setvar! recall_travel_time 3000
    setvar! 1st_circle_spell_mana_cost 8
    setvar! 2nd_circle_spell_mana_cost 9
    setvar! 3rd_circle_spell_mana_cost 10
    setvar! 4th_circle_spell_mana_cost 12

    # runetomes recall via scroll buttons have a interval of 6, so first button is 2, second is 8, and so on...
    if not listexists runetome_page_numbers
        createlist runetome_page_numbers

        # runetome page 1
        # we dont push the first rune since its the home rune
        pushlist runetome_page_numbers 200
        pushlist runetome_page_numbers 201
        pushlist runetome_page_numbers 202
        pushlist runetome_page_numbers 203
        pushlist runetome_page_numbers 204
        pushlist runetome_page_numbers 205
        pushlist runetome_page_numbers 206
        pushlist runetome_page_numbers 207
        pushlist runetome_page_numbers 208
        pushlist runetome_page_numbers 209
        pushlist runetome_page_numbers 210
        pushlist runetome_page_numbers 211
        pushlist runetome_page_numbers 212
        pushlist runetome_page_numbers 213

        # runetome page 2
        pushlist runetome_page_numbers 214
        pushlist runetome_page_numbers 215
        pushlist runetome_page_numbers 216
        pushlist runetome_page_numbers 217
        pushlist runetome_page_numbers 218
        pushlist runetome_page_numbers 219
        pushlist runetome_page_numbers 220
        pushlist runetome_page_numbers 221
        pushlist runetome_page_numbers 222
        pushlist runetome_page_numbers 223
        pushlist runetome_page_numbers 224
    endif

    # create a duplicate list so we can restore the main list when needed (like when reaching max rune set to use on runetome)
    if not listexists runetome_page_numbers_unchanged
        createlist runetome_page_numbers_unchanged

        foreach x in runetome_page_numbers
            pushlist runetome_page_numbers_unchanged x
        endfor
    endif


    #------------------------------
    # SET THE FARM RUNEBOOKS
    clearlist farm_runetomes
    createlist farm_runetomes

    while findtype 'runetome' backpack as found
        getlabel found rbook_label
        if 'farm' in rbook_label or 'Farm' in rbook_label or 'FARM' in rbook_label
            pushlist farm_runetomes found

            setvar! recall_book_gump_id 167090027
            setvar! recall_by_charge_btn_number runetome_rune_position
        endif

        @ignore found
    endwhile

    @clearignore

    foreach x in farm_runetomes
        sysmsg 'FARM RUNEBOOK {{index}}: {{x}}'
    endfor

    if cycle_runetome_farming == 1 and list farm_runetomes == 0
        sysmsg 'SCRIPT IS SET TO CYCLE RUNETOMES BUT NO LUMBER RUNETOMES WERE FOUND.' 41
        sysmsg 'PLEASE HAVE AT LEAST 1 RUNETOME NAMED LUMBER INSIDE YOUR BACKPACK AND RE-RUN THE SCRIPT' 41
        stop
    endif


    setvar! mage_bot_travel_setup_done 1
endif




#######################################################
## BEGIN MAIN ROUTINE
#######################################################

if debug == 1
    sysmsg '>>> STARTING MAIN LOOP AT {{execution_timer}} ms' success_msg_color
endif


#########################################
# SHELF RESTOCK / RESSUPLY IF THERES ONE NEARBY AT START
#########################################

if findtype 'storage shelf' ground any any 2 as shelf
    if not timerexists ressuplied_from_shelf
        createtimer ressuplied_from_shelf
        settimer ressuplied_from_shelf 10000
    endif

    if timer ressuplied_from_shelf >= 10000

        #################################
        # DUMP ITENS IN RECYCLER

        if findtype 'ornate elven chest' ground any any 2 as recycler
            sysmsg 'Recycling unidentified items...' warning_msg_color

            menu recycler 1
            wait action_delay
            if insysmsg 'recyclable items found'
                sysmsg 'Recycled all items!' 71
            endif

        endif

        #################################
        # DUMP ITENS IN STOCKPILE

        if findtype 'resource container' ground any any 2 as stockpile
            setvar! resource_stockpile stockpile
            menu resource_stockpile 0
            wft 600
            if targetexists 'neutral'
                sysmsg '> Restocking Resource Stockpile...' warning_msg_color
                target 'self'
            endif

            if gumpexists 1859005118
                gumpclose 1859005118
            endif
        endif

        #################################
        # SHELF RESTOCK & RESSUPLY

        sysmsg 'RESTOCKING...' 55
        menu shelf 0
        wft action_delay
        if targetexists 'neutral'
            target self
        endif

        if gumpexists 3232825965
            gumpclose 3232825965
        endif

        sysmsg 'RESSUPLYING...' 55
        menu shelf 1
        settimer ressuplied_from_shelf 0
        # waitforgump 3232825965 action_delay
    endif
endif


#####################################
# KEEP MOBS GUARDING PLAYER
#####################################

# all guard right now so summons protect char if we start script in the middle of a fight
# say 'all guard me'

if dead lasttarget and not find lasttarget ground any any find_last_target_max_range and recall_home_now != 1
    if auto_patrol_when_no_active_lasttarget == 1 and timer 'all_patrol_timer' > all_patrol_delay
        if debug == 1
            sysmsg 'SKIPPING ALL GUARD IN FAVOR OF PATROL' warning_msg_color
        endif

        say 'all patrol'
        wft action_delay
        target self
        # targetrelloc patrol_first_relative_direction patrol_second_relative_direction

        if verbose == 1
            sysmsg '[TIMER] RESETING PATROL (NEXT IN {{all_patrol_delay}})' reset_timer_msg_color
            sysmsg '[TIMER] RESETING GUARD (NEXT IN {{all_guard_delay}})' reset_timer_msg_color
        endif

        settimer 'all_patrol_timer' 0

        # also reset guard to wait a bit longer to call pets back in
        settimer 'all_guard_timer' 0
    endif
endif


# TESTING also checking if dead so it doenst all guard before the 2 all follows for luring current lasttarget
# if auto_all_guard == 1 and timer 'all_guard_timer' >= all_guard_delay
if auto_all_guard == 1 and timer 'all_guard_timer' >= all_guard_delay and recall_home_now != 1
    if lure_mobs_closer_before_killing == 1 and not dead lasttarget and find lasttarget ground any any find_last_target_max_range
        if verbose == 1
            sysmsg 'SKIPPING ALL GUARD IN FAVOR OF LURING' warning_msg_color
        endif
    # elseif auto_patrol_when_no_active_lasttarget == 1 and dead lasttarget and not find lasttarget ground any any find_last_target_max_range
    else
        if debug == 1
            sysmsg 'ALL GUARDING at {{execution_timer}}' success_msg_color
        endif
        say 'all guard me'
        settimer 'all_guard_timer' 0
    endif
endif


# if auto_patrol_when_no_active_lasttarget == 1 and timer 'all_patrol_timer' > all_patrol_delay
# endif

# putting the clear here to reset all possible msgs i caught during the previous iteration
# clearsysmsg


########################################
# HANDLE HP
########################################

if auto_heal == 1 and diffhits > max_diffhits_before_healing
    # say all guard because the damage could have come from another mob
    # than the current one we were attacking
    say 'all guard'

    # if diffhits is too high, better guarantee and use a gheal pot
    if diffhits >= max_diffhits_before_heal_pot
        if findtype 'yellow potion' backpack as pot
            if verbose == 1
                sysmsg '>>> LOW HP! USING HEAL POTION.. ' action_msg_color
            endif

            if use_script_overhead_messages == 1
                overhead '*using heal potion*' action_msg_color
            endif

            useobject pot
            wait action_delay
        endif
    endif

    # GREATER HEAL
    if diffhits >= max_diffhits_before_greater_heal
        if mana >= 4th_circle_spell_mana_cost
            if verbose == 1
                sysmsg '>>> GREATER HEALING...' 76
            endif

            if targetexists 'any'
                hotkey 'Cancel Current Target'
            endif

            hotkey 'Clear Target Queue'
            cast 'greater heal'

            @settimer 'waiting_target_timer' 0
            while not targetexists 'beneficial' and not insysmsg 'disturbed' and not insysmsg 'cannot cast a spell' and timer 'waiting_target_timer' < 4000
                wft 10
                if insysmsg 'disturbed' or insysmsg 'spell will not adhere' or insysmsg 'cannot cast a spell'
                    if verbose == 1
                        sysmsg 'BREAKING WHILE WAITING FOR GREATER HEAL TARGET' warning_msg_color
                    endif

                    wait spell_recovery_delay
                    break
                endif
            endwhile

            if targetexists 'beneficial' and hits < maxhits
                hotkey 'Target Self'
                wait spell_recovery_delay

                # if debug == 1
                #     sysmsg 'RESETING LAST AFTER GHEAL' debug_msg_color
                # endif

                # hotkey 'Clear Target Queue'
                # hotkey 'Set Last Target'
                # wft action_delay
                # target last_target_serial
            endif
        else
            sysmsg 'NO MANA FOR GHEAL!' alert_msg_color
        endif
    endif

    # MINI HEAL
    if diffhits >= max_diffhits_before_healing
        sysmsg '>>> MINI HEALING...' 78
        hotkey 'Clear Target Queue'
        cast 'heal'

        @settimer 'waiting_target_timer' 0
        while not targetexists 'beneficial' and not insysmsg 'disturbed' and not insysmsg 'cannot cast a spell' and timer 'waiting_target_timer' < 1500
            wft 10
            if insysmsg 'disturbed' or insysmsg 'spell will not adhere' or insysmsg 'cannot cast a spell'
                if verbose == 1
                    sysmsg 'BREAKING WHILE WAITING FOR HEAL TARGET' warning_msg_color
                endif

                wait spell_recovery_delay
                break
            endif
        endwhile

        if targetexists 'beneficial' and hits < maxhits
            hotkey 'Target Self'
            wait spell_recovery_delay

            # if debug == 1
            #     sysmsg 'RESETING LAST AFTER MINI HEAL' debug_msg_color
            # endif

            # hotkey 'Clear Target Queue'
            # hotkey 'Set Last Target'
            # wft action_delay
            # target last_target_serial
        endif
    endif
endif

########################################
# HANDLE POISON
########################################


if auto_cure_poison == 1 and poisoned
    # if diffhits is too high, better guarantee and use a gheal pot
    if findtype 'orange potion' backpack as pot
        if verbose == 1
            sysmsg '>>> CURE POTION! ' action_msg_color
        endif

        useobject pot
        wait action_delay
    else
        if mana >= 4th_circle_spell_mana_cost
            if verbose == 1
                sysmsg '>>> ARCH CURING!' spell_msg_color
            endif

            cast 'arch cure'

            @settimer 'waiting_spell_timer' 0
            while not targetexists 'beneficial' and not insysmsg 'disturbed' and not insysmsg 'cannot cast a spell' and timer 'waiting_target_timer' < 4000
                wft 10
                if insysmsg 'disturbed' or insysmsg 'spell will not adhere'
                    if verbose == 1
                        sysmsg 'BREAKING WHILE WAITING FOR ARCH CURE TARGET' warning_msg_color
                    endif

                    wait spell_recovery_delay
                    break
                endif
            endwhile

            if targetexists 'neutral'
                hotkey 'Target Self'
                wait spell_recovery_delay
            endif
        else
            sysmsg 'NO MANA TO ARCH CURE!' alert_msg_color
        endif
    endif
endif







########################################
# IF THERE ARE TARGETS OPENED, SPEND THEM
# ACCORDING TO THEIR TYPE
########################################

if targetexists 'beneficial'
    if auto_get_new_targets == 1 or hold_targets == 0
        overhead 'spending beneficial target' warning_msg_color
        hotkey 'Target Self'
    else
        overhead 'holding beneficial target' warning_msg_color
        while targetexists 'beneficial'
            if timer 'holding_target_warning_msg' > 2000
                settimer 'holding_target_warning_msg' 0
                sysmsg '>>> HOLDING BENEFICIAL TARGET' warning_msg_color
                # hotkey 'Target Self'
            endif
        endwhile
    endif
endif

if targetexists 'neutral'
    # if auto target is on, we dont want any stuck open neutral target stopping the actions on the script so we spend the target
    if auto_get_new_targets == 1 or hold_targets == 0
        overhead 'canceling neutral target' warning_msg_color
        sysmsg '>>> CANCELING NEUTRAL TARGET' warning_msg_color
        hotkey 'Cancel Current Target'
    else
        overhead 'holding neutral target' warning_msg_color
        while targetexists 'neutral'
            if timer 'holding_target_warning_msg' > 2000
                settimer 'holding_target_warning_msg' 0
                sysmsg '>>> HOLDING NEUTRAL TARGET' warning_msg_color
            endif
        endwhile
    endif
endif

if targetexists 'harmful'
    if not dead lasttarget
        if lasttarget == self
            hotkey 'Cancel Current Target'
            sysmsg 'CANCELLING TARGET (LAST == SELF)' warning_msg_color
        elseif noto lasttarget == hostile or noto lasttarget == murderer or noto lasttarget == criminal
            overhead 'spending harmful target' warning_msg_color lasttarget
            sysmsg '>>> SPENDING HARMFUL TARGET ON {{lasttarget}}' warning_msg_color
            hotkey 'Last Target'
        endif
    else
        if auto_get_new_targets == 1
            overhead 'spending harmful target (dead last)' warning_msg_color
            sysmsg 'SPENDING HARMFUL TARGET ON {{}}'
            hotkey 'Target Self'
        else
            overhead 'holding harmful target'
            while targetexists 'harmful'
                if timer 'holding_target_warning_msg' > 2000
                    settimer 'holding_target_warning_msg' 0
                    sysmsg '>>> HOLDING HARMFUL TARGET' warning_msg_color
                    # targetrelloc 0 1
                endif

                # copied this part from bottom of script to get new targets if option is set
                if auto_get_new_targets == 1 and timer 'auto_get_new_targets_timer' > 1000
                    if use_script_overhead_messages
                        overhead '*searching monsters to use target*' action_msg_color
                    endif
                    if verbose == 1
                        sysmsg '> SEARCHING MONSTERS TO USE HARMFUL TARGET...' action_msg_color
                    endif

                    hotkey 'Target Closest Non-Friendly Monster'

                    if get_players_on_auto_target == 1
                        overhead '*searching players*' action_msg_color
                        sysmsg '> SEARCHING PLAYERS...' action_msg_color
                        hotkey 'Next Grey Player Target'
                        # wait action_delay
                    endif
                    settimer 'auto_get_new_targets_timer' 0
                elseif auto_get_new_targets == 0 and timer 'get_new_target_msg' > 4000
                    overhead 'waiting for new target' alert_msg_color
                    settimer 'get_new_target_msg' 0
                endif

                if not dead 'last' and noto 'last' == hostile or noto 'last' == criminal
                    hotkey 'Last Target'
                endif
            endwhile
        endif
    endif
endif


# Setting current necro symbols - checks again it the attack loop
setvar! necroSymbols 12
if gumpexists 622436516 and skill "Necromancy" >= 50 and recall_home_now != 1
    if ingump "12/" 622436516
        setvar! necroSymbols 12
    elseif ingump "13/" 622436516
        setvar! necroSymbols 13
    elseif ingump "14/" 622436516
        setvar! necroSymbols 14
    elseif ingump "15/" 622436516
        setvar! necroSymbols 15
    elseif ingump "16/" 622436516
        setvar! necroSymbols 16
    elseif ingump "17/" 622436516
        setvar! necroSymbols 17
    elseif ingump "18/" 622436516
        setvar! necroSymbols 18
    elseif ingump "19/" 622436516
        setvar! necroSymbols 19
    elseif ingump "20/" 622436516
        setvar! necroSymbols 20
    elseif ingump "21/" 622436516
        setvar! necroSymbols 21
    elseif ingump "11/" 622436516
        setvar! necroSymbols 11
    elseif ingump "10/" 622436516
        setvar! necroSymbols 10
    elseif ingump "9/" 622436516
        setvar! necroSymbols 9
    elseif ingump "8/" 622436516
        setvar! necroSymbols 8
    elseif ingump "7/" 622436516
        setvar! necroSymbols 7
    elseif ingump "6/" 622436516
        setvar! necroSymbols 6
    elseif ingump "5/" 622436516
        setvar! necroSymbols 5
    elseif ingump "4/" 622436516
        setvar! necroSymbols 4
    elseif ingump "3/" 622436516
        setvar! necroSymbols 3
    elseif ingump "2/" 622436516
        setvar! necroSymbols 2
    elseif ingump "1/" 622436516
        setvar! necroSymbols 1
    elseif ingump "0/" 622436516
        setvar! necroSymbols 0
    endif
endif



######################################
# MEDITATE
######################################

if diffhits > max_diffhits_before_meditating or poisoned
    if debug == 1
        sysmsg 'replay before meditate' debug_msg_color
    endif
    replay
endif

if auto_meditate == 1 and meditate_now == 1 and not findbuff 'actively meditating'
    # TESTING: removing toggle peace so pets wont stop attacking and come close to char
    # hotkey 'Toggle Peace Only'
    useskill 'meditation'
    waitforsysmsg 'You start meditating' 600

    if findbuff 'actively meditating'
        if use_script_overhead_messages == 1
            overhead 'meditating' action_msg_color
        endif

        while findbuff 'actively meditating' and mana < min_mana_to_attack

            if diffhits > max_diffhits_before_meditating or poisoned or followers < followers_max_limit
                if debug == 1
                    sysmsg 'replay meditating' debug_msg_color
                endif
                replay
            endif

            if insysmsg 'Now tracking'
                sysmsg 'TRACKED PK WHILE MEDITATING. BREAKING TO ESCAPE' alert_msg_color
                sysmsg 'TRACKED PK WHILE MEDITATING. BREAKING TO ESCAPE' alert_msg_color
                sysmsg 'TRACKED PK WHILE MEDITATING. BREAKING TO ESCAPE' alert_msg_color
                sysmsg 'TRACKED PK WHILE MEDITATING. BREAKING TO ESCAPE' alert_msg_color
                replay
            endif


            if mana < mana_limit_to_eat_mushroom and timer 'use_mushroom_timer' >= use_mushroom_delay
                if findtype 'mushroom' backpack as mush
                    useobject mush
                    if insysmsg 'you consume'
                        sysmsg '>>> [TIMER] RESETING MUSHROOM (NEXT IN {{use_mushroom_delay}})' reset_timer_msg_color
                        settimer 'use_mushroom_timer' 0
                    endif
                else
                    sysmsg ">>> NO MUSHROOM!" alert_msg_color
                endif
            endif

            if timer 'medit_msg_timer' >= 2000
                sysmsg '>>> MEDITATING...'
                if use_script_overhead_messages == 1
                    overhead 'meditating...'
                endif
                settimer 'medit_msg_timer' 0
            endif

        endwhile
    endif

    setvar! meditate_now 0
endif


########################################
# HANDLE SUMMONS
########################################

if debug == 1
    if recall_home_now == 1
        sysmsg 'recall_home_now == 1 before summons' debug_msg_color
    endif
endif

if is_summoner == 1 and auto_summon == 1 and followers < followers_max_limit and recall_home_now != 1
    # if debug == 1
    #     sysmsg '[DEBUG] PREPARING TO RESUMMON' debug_msg_color
    # endif

    if verbose == 1
        sysmsg '>>> PREPARING TO SUMMON...' warning_msg_color
    endif

    if list 'summons' == 0
        sysmsg 'SUMMONS LIST IS EMPTY! SOMETHING IS WRONG.' 39
        overhead 'SUMMONS LIST IS EMPTY! SOMETHING IS WRONG.' 39
    endif

    if targetexists 'any'
        hotkey 'Cancel Current Target'
    endif

    foreach summon in 'summons'
        if diffhits > max_diffhits_before_healing
            if debug == 1
                sysmsg 'replay summons' debug_msg_color
            endif

            replay
        endif

        if debug == 1
            sysmsg 'CHECKING {{summon}}: {{index}}' default_sysmsg_color
        endif

        # if this current summons is NOT summ creature, but summ creature  is in the summons list, and char has 4 slots filled already
        # skip current iteration to go to summ creature and cast it as the last summon
        if 'creature' in summon
        else
            if 'summ. creature' in summons and followers == 4
                if verbose == 1
                    sysmsg 'ALREADY HAVE 4 HAVE FOLLOWERS FOR {{summon}}. CONTINUE TO CAST SUMM CREATURE' warning_msg_color
                endif

                continue
            endif
        endif

        if followers == followers_max_limit
            if verbose == 1
                sysmsg 'BREAKING ON {{summon}} (ALREADY HAVE 5 HAVE FOLLOWERS)' warning_msg_color
            endif

            if debug == 1
                sysmsg 'BREAKING 2 ON CHECKING SUMMON {{summon}}' warning_msg_color
            endif
            break
        endif

        unsetvar! found_summon
        unsetvar! cast_summon_spell

        # # determine summon name by whether char has necromancy or not
        # if use_undead_summons == 1
        #     # on each iteration, clear and populate this list to set the undead alternative summon based on current summon
        #     if not listexists 'undead_summons'
        #         createlist 'undead_summons'
        #     endif
        #     clearlist 'undead_summons'



        # endif

        # if char is necro, make sure vengeful spirit is activated before summoning
        if is_necromancer == 1

            # VENGEFUL SPIRIT
            if use_undead_summons == 1
                if timer vengeful_spirit_timer >= 30000
                    if verbose == 1
                        sysmsg '>>> VENGEFUL SPIRIT...' spell_msg_color
                    endif

                    clearsysmsg
                    say '[vengefulspirit'
                    wait action_delay

                    if insysmsg 'symbols'
                        settimer vengeful_spirit_timer 0
                        cooldown "VENGEFUL SPIRIT" 30000
                    endif
                else
                    if verbose == 1
                        sysmsg 'Vengeful Spirit Cooldown..' spell_cooldown_msg_color
                    endif
                endif
            endif

            # WITHER
            if timer wither_timer >= 30000
                if verbose == 1
                    sysmsg '>>> WITHER...' spell_msg_color
                endif

                clearsysmsg
                say '[wither'
                wait action_delay

                if insysmsg 'symbols'
                    settimer wither_timer 0
                    cooldown "WITHER" 30000
                endif
            else
                if verbose == 1
                    sysmsg 'Wither Cooldown..' spell_cooldown_msg_color
                endif
            endif
        endif

        #########################
        # try to find a similir creature summon to see if we need to cast this one or skip to next one


        setvar! summon_search_amount index

        if not listexists summons_found
            createlist summons_found
        endif
        clearlist summons_found

        # 158 - an ancient mummy
        # 14 - an earth elemental
        if 'earth' in summon
            if findtypelist summons_found 158|14 ground any any find_summon_range
                sysmsg 'FOUND EARTH/ CORPSES' 73
            endif
            # pushlist 'undead_summons' 'an ancient mummy'
        # 24 - a lich
        # 15 - a fire elemental
        elseif 'fire' in summon
            if findtypelist summons_found 24|15 ground any any find_summon_range
                sysmsg 'FOUND EARTH/ CORPSES' 73
            endif
            # pushlist 'undead_summons' 'a lich'
        # 13 - air elemental
        # 306 - a skeletal fiend
        elseif 'air' in summon
            if findtypelist summons_found 13|306 ground any any find_summon_range
                sysmsg 'FOUND EARTH/ CORPSES' 73
            endif
            # pushlist 'undead_summons' 'a skeletal fiend'
        # 9 - a deamon
        # 722 - a vampire thrall
        elseif 'daemon' in summon
            if findtypelist summons_found 9|722 ground any any find_summon_range
                sysmsg 'FOUND EARTH/ CORPSES' 73
            endif
            # pushlist 'undead_summons' 'a vampire thrall'
        # 16 - water elemental
        # 740 - a rage witch
        elseif 'water' in summon
            if findtypelist summons_found 16|740 ground any any find_summon_range
                sysmsg 'FOUND EARTH/ CORPSES' 73
            endif
            # pushlist 'undead_summons' 'a rag witch'
        # endif

        elseif summon = "Energy Vortex" and findtype 13|391 ground -1 -1 2 as myPet
        # 574 - a blade spirit
        # 309 - a skeletal husk
        elseif summon = "Blade Spirits" and findtype 574|309 ground -1 -1 2 as myPet
        endif


        # if list summons_found == 1
        #     setvar! summons_found_amount 1
        # if list summons_found == 2
        #     setvar! summons_found_amount 2
        # endif


        foreach summonserial in summons_found
            if noto summonserial = friend
                if verbose == 1
                    overhead '*found {{summon}}*' 91 summonserial
                    sysmsg 'FOUND SUMMON {{summon}}*' 91
                endif

                setvar! found_summon 1
            endif
        endfor

        # if findtype summon ground any summon_search_amount find_summon_range as summonserial
        #     if noto summonserial = friend
        #         if verbose == 1
        #             overhead '*found {{summon}}*' 91 summonserial
        #             sysmsg 'FOUND SUMMON {{summon}}*' 91
        #         endif

        #         setvar! found_summon 1
        #     endif
        # # if the 'undead_summons' list has elements, we need to check for those undead summons as well
        # elseif list 'undead_summons' > 0
        #     foreach necro_summon in 'undead_summons'

        #         if diffhits > max_diffhits_before_healing
        #             replay
        #         endif

        #         if findtype necro_summon ground any 1 find_summon_range as summonserial
        #             if noto summonserial = friend
        #                 overhead '*found {{summon}}*' 91 summonserial
        #                 sysmsg 'FOUND SUMMON {{summon}}*' 91
        #                 setvar! found_summon 1

        #                 # TESTING HERE (this break was disabled before)
        #                 # break
        #             endif
        #         endif
        #     endfor
        # endif

        # even if we found this summon type, we still might need to cast it (if only 1 summon in list for instance)
        if found_summon == 1
            setvar! found_summon 0

            # if followers < 5, and theres repeated summons in the summons list, and only found 1 of this summon type, cast it again
            if followers < 5 and list summons_found == 1 and repeated_summon_in_list == 1
                sysmsg 'FOUND SUMMON BUT CASTING AGAIN' 90
                setvar! cast_summon_spell 1
            # if one of our summons is summ creature and we only found 1 summon of this type,
            # cast another more usefull summon before actually casting summ.creature
            elseif followers <= 3 and inlist 'summons' 'summ. creature' and list summons_found == 1
                sysmsg 'FOUND SUMM CREATURE CASTING {{summon}}'
                setvar! cast_summon_spell 1
            # elseif list 'summons' >= 3 and followers <= 1
            #     setvar! cast_summon_spell 1
            endif
        else
            if verbose == 1
                sysmsg 'SETTING TO CAST {{summon}}' warning_msg_color
            endif
            setvar! cast_summon_spell 1
        endif

        #########################
        # prepare to cast the summon spell for this summon
        if cast_summon_spell == 1

            if diffhits > max_diffhits_before_healing or followers == followers_max_limit
                sysmsg 'replay cast summons' debug_msg_color
                replay
            endif


            setvar! summon_spell_required_mana 50
            if 'creature' in summon or 'blade' in summon
                setvar! summon_spell_required_mana 14
            endif

            if mana < summon_spell_required_mana
                if verbose == 1
                    sysmsg "!!! {{summon_spell_required_mana}} REQUIRED FOR {{summon}}!" alert_msg_color
                    overhead "!! low mana for summoning !!" alert_msg_color
                endif

                setvar! meditate_now 1
                replay
            endif

            if verbose == 1
                sysmsg ">>> SUMMONING {{summon}}..." action_msg_color
            endif

            if 'earth' in summon
                cast 'Earth Elemental'
            elseif 'fire' in summon
                cast 'Fire Elemental'
            elseif 'air' in summon
                cast 'Air Elemental'
            elseif 'daemon' in summon
                cast 'Summon Daemon'
            elseif 'water' in summon
                cast 'Water Elemental'
            elseif 'vortex' in summon
                cast 'Energy Vortex'
            elseif 'creature' in summon
                cast 'Summ. Creature'
                setvar! summon_spell_required_mana 14
            elseif 'blade' in summon
                cast 'Blade Spirits'
                setvar! summon_spell_required_mana 14
            endif


            if 'blade' in summon or 'vortex' in summon
                if verbose == 1
                    sysmsg 'WAITING FOR {{summonspell}} TARGET..' warning_msg_color
                    overhead 'Waiting for {{summonspell}} target..' alert_msg_color
                endif

                @settimer 'waiting_summon_timer' 0
                while not targetexists 'neutral' and timer 'waiting_summon_timer' < cast_summons_delay

                    if diffhits > max_diffhits_before_healing
                        sysmsg 'replay waiting cast blade or vortex' debug_msg_color
                        replay
                    endif

                    wft 10
                    if insysmsg 'disturbed'
                        @settimer 'waiting_summon_timer' 0
                        if verbose == 1
                            sysmsg 'BREAKING WHILE WAITING FOR SUMMONING {{summon}}' alert_msg_color
                        endif

                        wait spell_recovery_delay
                        break
                    endif
                endwhile

                if targetexists 'neutral'
                    if verbose == 1
                        sysmsg 'CASTING BLADE OR VORTEX IN GROUND' 55
                    endif

                    targetrelloc 0 1
                    break
                endif
            else
                @settimer 'waiting_summon_timer' 0
                while timer 'waiting_summon_timer' < cast_summons_delay

                    if diffhits > max_diffhits_before_healing
                        sysmsg 'replay waiting cast summons' debug_msg_color
                        replay
                    endif

                    wait 10
                    if insysmsg 'disturbed'
                        @settimer 'waiting_summon_timer' 0
                        if verbose == 1
                            sysmsg 'BREAKING WHILE WAITING FOR SUMMONING {{summon}}' alert_msg_color
                        endif

                        wait spell_recovery_delay
                        break
                    endif
                endwhile

                say 'all guard me'
            endif

        endif

        # poplist summons 'front'
        # pushlist summons summon 'back'
    endfor
endif

if debug == 1
    sysmsg 'after handle summons' debug_msg_color
endif

########################################
# KEEP HEALING PETS
########################################

if is_veterinarian == 1 and recall_home_now != 1
    if auto_heal_pets == 1 and not targetexists 'any'
        if not cooldown Bandage
            if findtype 'veterinary supplies' as vet_supplies
                settimer 'heal_pets_timer' 0
                useobject vet_supplies
                if verbose == 1
                    sysmsg ">>> USING VET SUPPLIES ON PET" 55
                    overhead '*vetting*' 75 pet
                    overhead '*vetting player pet*' 75 'self'
                endif
            # elseif findtype 'clean bandage%s%' as bands
            #     useobject bands
            #     wft 1000
            #     if targetexists 'beneficial'
            #         overhead '*bandaging...*' 55 pet
            #         sysmsg ">>> BANDAGING PET" 55
            #         target pet
            #     endif
            endif
        endif
    endif
endif


########################################
# TAMER - KEEP RESSING PETS
########################################

if auto_ress_pets == 1 and recall_home_now != 1
    if timer 'ress_pets_timer' >= ress_pets_delay
        sysmsg 'CHECKING RESS PETS at {{execution_timer}}' success_msg_color

        settimer 'ress_pets_timer' 0
        foreach pet in 'player_pets'
            if find pet ground any 1 15
                if dead pet and diffhits <= 10
                    sysmsg "ACHOU DEAD PET PORRA!"
                    # use context menu to give the 'follow' command to this pet
                    menu pet 4
                    if is_veterinarian == 1
                        if findtype 'veterinary supplies' backpack as supplies
                            overhead '>> RESS PET <<' 55 pet
                            useobject supplies
                            waitforsysmsg 'begin using veterinary supplies' action_delay

                            if insysmsg 'You do not have any living followers close'
                                clearsysmsg
                                sysmsg 'PETS FAR! CALLING THEM CLOSER...' 54
                                say 'all follow me'
                            endif

                        elseif findtype 'clean bandage%s%' backpack as bands
                            overhead '>>> RESS PET (BANDAGES)' 55 pet
                            useobject bands
                            wft 600
                            if targetexists 'beneficial'
                                overhead '*ressing with bands*' 55 pet
                                target pet
                            endif
                        else
                            sysmsg "NO BANDAGES TO RESS PET!" 55
                        endif
                    endif

                    if skill 'magery' > 90 or skill 'veterinary' > 90 and not findtype 'veterinary supplies' backpack and not findtype 'clean bandage%s%' backpack
                        if mana > 50
                            overhead '>>> TRYING TO RESS PET WITH MAGERY' 55 pet
                            cast 'resurrection'
                            @settimer 'waiting_target_timer' 0
                            while not targetexists 'beneficial' and timer 'waiting_target_timer' < 8000
                                wft 100
                                if insysmsg 'disturbed'
                                    sysmsg 'BREAKING WHILE WAITING FOR RESS TARGET'
                                    break
                                endif
                            endwhile

                            wait spell_recovery_delay

                            if targetexists 'beneficial'
                                overhead 'ressing with magery' 55 pet
                                target pet
                            endif
                        else
                            overhead '*no mana to ress*' 55 petserial
                            overhead '*no mana to ress pet*' 55 'self'

                            while mana < 50 and not findbuff 'actively meditating'
                                sysmsg 'MEDITATING TO RESS PET' warning_msg_color
                                setvar! meditate_now 1
                                replay
                            endwhile
                        endif
                    endif
                endif
            endif
        endfor
    endif
endif



########################################
# OPEN NECRO HOTBAR ON START
########################################

if is_necromancer == 1 and not gumpexists necromancy_gump_id and recall_home_now != 1
    sysmsg 'Opening Necro Hotbar...' 100
    say '[necromancyhotbar'
endif



########################################
# HANDLE PKs
########################################

if auto_escape_pks_on_screen == 1 and recall_home_now != 1
    if verbose == 1
        sysmsg 'â–· SEARCHING FOR PKS ON SCREEN'
    endif
    # hotkey 'Clear Target Queue'
    clearsysmsg
    hotkey 'Next Murderer Player Target'
    if insysmsg 'New target'
        sysmsg '!!!!!!! FOUND PK! RUN!!!!!!!' alert_msg_color
        sysmsg '!!!!!!! FOUND PK! RUN!!!!!!!' alert_msg_color

        overhead '!!!!!!! FOUND PK! RUN!!!!!!!' alert_msg_color
        overhead '!!!!!!! FOUND PK! RUN!!!!!!!' alert_msg_color

        setvar! recall_home_now 1
        replay


    endif
endif



########################################
# HANDLE ATTACKS
########################################

if cooldown 'UNDER ATTACK' or insysmsg 'Attacking you'
    if verbose == 1
        sysmsg '>>> BEING ATTACKED! TRYING TO ESCAPE...' alert_msg_color
        sysmsg '>>> BEING ATTACKED! TRYING TO ESCAPE...' alert_msg_color
        sysmsg '>>> BEING ATTACKED! TRYING TO ESCAPE...' alert_msg_color
        sysmsg '>>> BEING ATTACKED! TRYING TO ESCAPE...' alert_msg_color
        setvar! recall_home_now 1
    endif
    # say 'time to go...'
    # cast 'recall'
    # wft 3500
    # target escape_runetome
    # wait 2000
    # sysmsg '>>> STOPPING MACRO'
    # stop
endif

if not dead lasttarget
    if noto lasttarget  == murderer
    # if findtype 400 ground any any 20 as player

        # say 'time to go...'
        # cast 'recall'
        # wft 3500
        # target escape_runetome
        # wait 2000
        # sysmsg '>>> STOPPING MACRO'
        # stop
    endif
endif



######################################
# MUSHROOMS
######################################

# keep mushrooms stock in backpack
# if not dead lasttarget

if diffhits > max_diffhits_before_healing or poisoned or followers < followers_max_limit
    if debug == 1
        sysmsg 'replay mushrooms' debug_msg_color
    endif
    replay
endif

setvar! create_mushrooms_now 0
if dead lasttarget or not dead lasttarget and counttype 'mushroom' < mushroom_limit_before_creating_more
    sysmsg '> CREATING MUSHROOMS at {{execution_timer}}' action_msg_color
    overhead '*creating mushrooms*' action_msg_color

    while counttype 'mushroom' < mushroom_stock_size
        if targetexists 'any'
            sysmsg 'replay on creating mushrooms' debug_msg_color
            replay
        endif

        if diffhits > max_diffhits_before_healing or poisoned or followers < followers_max_limit
            if debug == 1
                sysmsg 'replay creating mushrooms' debug_msg_color
            endif
            replay
        endif

        if verbose == 1
            sysmsg '>>> CREATING MUSHROOMS' action_msg_color
        endif

        # if we loose hits while creating mushrooms, a new target might have been got and we need to break to heal
        if diffhits > max_diffhits_before_healing
            if debug == 1
                sysmsg 'replay creating mushrooms' debug_msg_color
            endif

            replay
        endif

        # if now we have a live target and already have the min mushroom limit, break to attack
        if not dead lasttarget and counttype 'mushroom' >= mushroom_limit_before_creating_more
            if verbose == 1
                sysmsg 'BREAKING WHILE CREATING MUSHROOMS TO ATTACK LAST TARGET!' warning_msg_color
            endif

            break
        endif

        cast 'create food'
        wait action_delay
    endwhile
endif

# eat mushroom on its timer
if mana < mana_limit_to_eat_mushroom and timer 'use_mushroom_timer' >= use_mushroom_delay
    if findtype 'mushroom' backpack as mush
        useobject mush
        wait action_delay

        if insysmsg 'you consume'
            if verbose == 1
                sysmsg '>>> [TIMER] RESETING MUSHROOM (NEXT IN {{use_mushroom_delay}})' reset_timer_msg_color
            endif

            settimer 'use_mushroom_timer' 0
            cooldown 'MUSHROOM' use_mushroom_delay
        endif
    else
        sysmsg "!!! NO MUSHROOM!" warning_msg_color
    endif
endif



######################################
# WAIT TO LOOT BEFORE GOING TO NEXT RUNE
######################################


# this variable is set in a check down bellow the script after finishing
# the attack routine and killing the last mob on screen
if dead current_target_serial and wait_to_loot_now == 1
    if debug == 1
        sysmsg 'ENTER WAIT TO LOOT at {{execution_timer}}'
    endif

    if not timerexists waiting_to_loot_before_travelling_timer
        createtimer waiting_to_loot_before_travelling_timer
    endif
    settimer waiting_to_loot_before_travelling_timer 0

    if not timerexists waiting_to_loot_warning_msg_timer
        createtimer waiting_to_loot_warning_msg_timer
    endif
    settimer waiting_to_loot_warning_msg_timer 0


    while timer waiting_to_loot_before_travelling_timer < time_to_wait_for_looting
        if timer waiting_to_loot_warning_msg_timer > 1000
            sysmsg '{{waiting_to_loot_before_travelling_timer}}ms BEFORE CONTINUING...' warning_msg_color
        endif

    endwhile

    unsetvar! started_attack_routine
    setvar! wait_to_loot_now 0
endif


########################################
# HANDLE OVERWEIGHT BEFORE (IF TRAVELLING)
########################################

if weight >= maxweight or diffweight < min_diffweight_before_going_home_to_unload
    if findtype 'White Potion' backpack
        sysmsg 'CHAR HEAVY! DRINKING STR POT.' alert_msg_color
        potion 'strength'
        wait action_delay
    else
        sysmsg 'CHAR HEAVY! CASTING STRENGTH.' alert_msg_color
        cast 'Strength'
        wft 1500
        target self
    endif

    if cycle_runetome_farming == 1
        sysmsg 'GOING HOME TO UNLOAD WEIGHT.' warning_msg_color setvar! recall_home_now 1
        setvar! recall_home_now 1
    endif
endif


######################################
# HANDLE LOW RESOURCES
######################################

if cycle_runetome_farming == 1 and recall_home_now != 1
    if cooldown 'OUT OF REGS' > 0
        sysmsg 'OUT OF REGS! GONNA TRAVEL HOME TO RESSUPLY' 54
        setvar! recall_home_now 1
    endif

    # noxxer supplies
    if is_noxxer == 1 and counttype 'Green Potion' == 0
        sysmsg 'LOW ON POISON POTIONS. GOING HOME TO RESSUPLY' alert_msg_color
        setvar! recall_home_now 1
    endif

    # tamer supplies
    if is_tamer == 1 and counttype 'veterinary supplies' == 0
        sysmsg 'LOW ON VET SUPPLIES. GOING HOME TO RESSUPLY' alert_msg_color
        setvar! recall_home_now 1
    endif

    # pot supplies
    if counttype 'Yellow Potion' == 0 or counttype 'Orange Potion' == 0
        sysmsg 'LOW ON POTIONS. GOING HOME TO RESSUPLY' alert_msg_color
        setvar! recall_home_now 1
    endif

    # reg supplies
    if counttype 3962 < 1 or counttype 3963 < 1 or counttype 3974 < 1 or counttype 3972 < 1 or counttype 3973 < 1 counttype 3976 < 1 or counttype 3981 < 1 or counttype 3980 < 1
        sysmsg 'LOW ON REAGENTS. GOING HOME TO RESSUPLY' alert_msg_color
        setvar! recall_home_now 1
    endif
endif


########################################
# GO HOME AND UNLOAD ROUTINE
########################################

setvar! recall_book_gump_id 167090027
setvar! recall_by_charge_btn_number runetome_rune_position

if diffhits > max_diffhits_before_healing or poisoned or followers < followers_max_limit
    if debug == 1
        sysmsg 'replay before go home and unload' debug_msg_color
    endif

    replay
endif

if recall_home_now == 1
    sysmsg 'ENTER GO HOME ROUTINE at {{execution_timer}}' 90
    unsetvar! recall_home_now

    if findtype 55814|23034|11761|29355 ground any any 10
        sysmsg 'ASSUMING CHAR IS ALREADY HOME AND SKIPPING RECALL...'
    else

        if skill 'magery' == 0 or counttype "Black Pearl%s%" == 0 or counttype "Blood Moss" == 0 or counttype "Mandrake Root%s%" == 0
            if counttype "Recall" > 0
                overhead 'no regs. trying scroll...' 54
                setvar! use_recall_scroll 1
            else
                overhead 'no regs. trying charges...' 54
                setvar! use_charges 1
            endif
        endif


        if use_charges == 1
            sysmsg 'TRAVELLING VIA CHARGES'
            dclick home_book
            waitforgump recall_book_gump_id 600
            setvar! recall_rune_btn_number 100
            gumpresponse recall_rune_btn_number recall_book_gump_id
            setvar! use_charges 0
        else
            # dclick recall_book
            # waitforgump recall_book_gump_id action_delay
            # gumpresponse recall_rune_btn_number recall_book_gump_id
            sysmsg 'TRAVELLING VIA SPELL WITH RUNEBOOK {{home_book}}'
            hotkey 'Recall'

            clearsysmsg
            @settimer 'waiting_target_timer' 0
            while not targetexists 'neutral' and not insysmsg 'disturbed' and not insysmsg 'cannot cast a spell' and timer 'waiting_target_timer' < 4000
                wft 10
                if insysmsg 'disturbed' or insysmsg 'spell will not adhere' or insysmsg 'cannot cast a spell'
                    if verbose == 1
                        overhead 'â–½â–½ BREAKING RECALL ON ESCAPE PKS â–½â–½' warning_msg_color
                        sysmsg 'BREAKING WHILE WAITING FOR RECALL TO ESCAPE PKS {{crew_member}}' warning_msg_color
                    endif

                    wait spell_recovery_delay
                    break
                endif

                if diffhits >= max_diffhits_before_heal_pot
                    if findtype 'Yellow Potion' backpack as pot
                        if verbose == 1
                            sysmsg '>>> LOW HP! USING HEAL POTION.. ' action_msg_color
                        endif

                        if use_script_overhead_messages == 1
                            overhead '*using heal potion*' action_msg_color
                        endif

                        useobject pot
                        wait action_delay
                    endif
                endif

            endwhile

            if targetexists 'neutral'
                target home_book
                wait spell_recovery_delay
            endif
        endif

        # unsetvar! recall_book
        wait recall_travel_time

        sysmsg 'ASSUMING TRAVEL IS OVER AND CHAR IS HOME.'
    endif


    if use_hotel_room == 1
        say 'room'
        waitforgump 2393832411 action_delay
        if ingump 'Your Room' 2393832411 action_delay
            if use_own_room == 1
                overhead 'entering own room'
                gumpresponse 4 2393832411
            else
                overhead 'entering friend room'
                gumpresponse 5 2393832411
                waitforgump 2393832411 action_delay
                gumpresponse 100 2393832411
            endif
        else
            overhead 'entering friend room'
            gumpresponse 5 2393832411
            waitforgump 2393832411 action_delay
            gumpresponse 100 2393832411
        endif

        wait 1500
    endif

    sysmsg '>>> START UNLOADING' success_msg_color


    #################################
    # UNLOAD GOLD
    #################################

    sysmsg '> Searching for gold or doubloon...' warning_msg_color
    if findtype 'bank deposit safe' ground any any 2 as found
        while findtype 3821 backpack as currency
            getlabel currency currency_label
            sysmsg 'Depositing {{currency_label}}!' 49

            lift currency 60000
            wait 30
            while queued
                wait 10
            endwhile
            wait action_delay

            # IMPORTANT! gold here has to be droped at -1 -1 0, or else is ends up 'inside' the vault, and not in the bank
            drop found -1 -1 0
            wait 30
            while queued
                wait 10
            endwhile

            if insysmsg 'You deposit'
                pushlist 'items_unloaded' currency_label
                overhead '*deposited {{currency_label}}*' 70
                sysmsg 'Deposited {{currency_label}} in vault!' 49
            endif
        endwhile
    endif


    #################################
    # TREASURE MAPS
    #################################

    if findtype 'book' ground 2990 1 2 as treasure_map_tome
        sysmsg '> Searching for Treasure Maps...' warning_msg_color

        if print_unloaded_items == 1
            while findtype 'map' backpack 0 any as found
                getlabel found item_label

                if not inlist 'items_unloaded' item_label
                    sysmsg 'Adding {{item_label}}'
                    pushlist 'items_unloaded' item_label
                endif

                @ignore found
            endwhile
            @clearignore
        endif

        while findtype 'map' backpack 0 any as tmap
            getlabel tmap tmap_label

            if "in progress" in tmap_label
                @ignore tmap
            endif

            if "completed by" in tmap_label
                lift tmap 1
                wait action_delay
                overhead "dropping completed map"
                if findtype 'barrel' ground 0 1 2 as trashcan
                    if verbose_mode  == 1
                        sysmsg "Dropping Completed Map On Trash Barrel" warning_msg_color
                    endif
                    drop trashcan -1 -1 0
                else
                    if verbose_mode  == 1
                        sysmsg "Dropping Completed Map On The Ground" warning_msg_color
                    endif
                    droprelloc 0 0
                endif
            else
                sysmsg '> Unloading treasure maps...' warning_msg_color
                menu treasure_map_tome 0
            endif
        endwhile
    endif


    #################################
    # MINING MAPS
    #################################

    if findtype 'book' ground 2796 1 2 as mining_map_tome
        sysmsg '> Searching for Mining Maps...' warning_msg_color

        if print_unloaded_items == 1
            while findtype 'map' backpack 2796 any as found
                getlabel found item_label

                if not inlist 'items_unloaded' item_label
                    sysmsg 'Adding {{item_label}}'
                    pushlist 'items_unloaded' item_label
                endif

                @ignore found
            endwhile
            @clearignore
        endif

        if findtype 'map' backpack 2796 any as mining_map
            if verbose_mode  == 1
                sysmsg '> Unloading mining maps...' warning_msg_color
            endif
            menu mining_map_tome 0
        endif
    endif


    #################################
    # LUMBER MAPS
    #################################

    if findtype 'book' ground 2799 1 2 as lumber_map_tome
        sysmsg '> Searching for Lumber Maps...' warning_msg_color

        if print_unloaded_items == 1
            while findtype 'map' backpack 2799 any as found
                getlabel found item_label

                if not inlist 'items_unloaded' item_label
                    sysmsg 'Adding {{item_label}}'
                    pushlist 'items_unloaded' item_label
                endif

                @ignore found
            endwhile
            @clearignore
        endif


        if findtype 'map' backpack 2799 any as lumber_map
            if verbose_mode  == 1
                sysmsg '> Unloading lumber maps...' warning_msg_color
            endif

            menu lumber_map_tome 0
        endif
    endif


    #################################
    # SKINNING MAPS
    #################################

    if findtype 'book' ground 2651 1 2 as skinning_map_tome
        sysmsg '> Searching for Skinning Maps...' warning_msg_color

        if print_unloaded_items == 1
            while findtype 'map' backpack 2651 any as found
                getlabel found item_label

                if not inlist 'items_unloaded' item_label
                    sysmsg 'Adding {{item_label}}'
                    pushlist 'items_unloaded' item_label
                endif

                @ignore found
            endwhile
            @clearignore
        endif

        if findtype 'map' backpack 2651 any as skinning_map
            if verbose_mode  == 1
                sysmsg '> Unloading skinning maps...' warning_msg_color
            endif

            menu skinning_map_tome 0
        endif
    endif


    #################################
    # FISHING MAPS
    #################################

    if findtype 'book' ground 2722 1 2 as fishing_map_tome
        sysmsg '> Searching for Fishing Maps...' warning_msg_color

        if print_unloaded_items == 1
            while findtype 'map' backpack 2904 any as found
                getlabel found item_label
                if not inlist 'items_unloaded' item_label
                    sysmsg 'Adding {{item_label}}'
                    pushlist 'items_unloaded' item_label
                endif
                @ignore found
            endwhile
            @clearignore
        endif

        if findtype 'map' backpack 2904 any as fishing_map
            if verbose_mode  == 1
                sysmsg '> Unloading fishing maps...' warning_msg_color
            endif

            menu fishing_map_tome 0
        endif
    endif



    #################################
    # SKILL SCROLLS
    #################################

    if findtype 'book' ground 2963 1 2 as skill_scroll_tome
        sysmsg '> Searching for Skill Scrolls...' warning_msg_color

        if print_unloaded_items == 1
            while findtype 'scroll of calling' backpack any any as found
                getlabel found item_label

                if not inlist 'items_unloaded' item_label
                    sysmsg 'Adding {{item_label}}'
                    pushlist 'items_unloaded' item_label
                endif

                @ignore found
            endwhile
            @clearignore
        endif

        if findtype 'scroll of calling' backpack any any as skill_scroll
            if verbose_mode  == 1
                sysmsg '> Unloading skill scrolls...' warning_msg_color
            endif

            menu skill_scroll_tome 0
        endif
    endif


    #################################
    # ASPECT ITEMS
    #################################

    if unload_aspect_items_in_stockpile == 0
        sysmsg '> Searching for Aspect Items...' warning_msg_color

        if findtype 'book' ground 2618 1 2 as aspect_item_tome

            if print_unloaded_items == 1
                # createlist 'aspect_items_types'
                # pushlist 'aspect_items_types' 'aspect core'
                # pushlist 'aspect_items_types' 3836
                # pushlist 'aspect_items_types' 17686
                # pushlist 'aspect_items_types' phylactery

                # foreach item_type in 'aspect_items_types'
                # while findtype item_type backpack as item
                while findtype "aspect core|3836|17686|phylactery" backpack as found
                    getlabel found item_label

                    if not inlist 'items_unloaded' item_label
                        pushlist 'items_unloaded' item_label
                    endif

                    @ignore found
                endwhile
                @clearignore
                # endfor
            endif

            if findtype 'aspect core' backpack or findtype 3836 backpack or findtype 17686 backpack or findtype phylactery backpack or findtype 45285 backpack or findtype 48261 backpack or findtype 39856 backpack
                if verbose_mode  == 1
                    sysmsg '> Unloading aspect items...' warning_msg_color
                endif

                menu aspect_item_tome 0
            endif
        endif
    endif


    #################################
    # RARE CLOTHES
    #################################

    if findtype 'book' ground 1495 1 2 as rare_cloth_tome
        sysmsg '> Searching for Rare Cloths...' warning_msg_color

        if print_unloaded_items == 1
            while findtype 'folded cloth' backpack any any as found
                getlabel found item_label

                if not inlist 'items_unloaded' item_label
                    sysmsg 'Adding {{item_label}}'
                    pushlist 'items_unloaded' item_label
                endif

                @ignore found
            endwhile
            @clearignore
        endif

        if findtype 'folded cloth' backpack any any as piece_of_cloth
            if verbose_mode  == 1
                sysmsg '> Unloading Rare Cloths' warning_msg_color
            endif

            menu rare_cloth_tome 0
        endif
    endif


    #################################
    # DYES CLOTHES
    #################################



    if findtype 'book' ground 1494 1 2 as dyes_tome
        sysmsg '> Searching for Dyes...' warning_msg_color

        if print_unloaded_items == 1
            # if not listexists 'dyes'
            #     createlist 'dyes'
            #     # runebook dye
            #     pushlist 'dyes' 3838
            #     # backpack dye
            #     pushlist 'dyes' 3839
            #     # headwear dye
            #     pushlist 'dyes' 3842
            #     # facial hair dye
            #     pushlist 'dyes' 3843
            #     # hair, shield and quiver dye
            #     pushlist 'dyes' 3843
            #     # fortuniture dye
            #     pushlist 'dyes' 29025
            #     # carpet dye
            #     pushlist 'dyes' 29036
            # endif

            # foreach dye in 'dyes'
            while findtype '3838|3839|3842|3843|29025|29036' backpack any any as found
            # while findtype dye backpack any any as item
                getlabel found item_label

                if not inlist 'items_unloaded' item_label
                    sysmsg 'Adding DYE {{item_label}}'
                    pushlist 'items_unloaded' item_label
                endif

                @ignore found
            endwhile
            @clearignore

            # endfor
        endif

        if findtype '3838|3839|3842|3843|29025|29036|15296' backpack any any as dye_bottle
            if verbose_mode  == 1
                sysmsg '> Unloading Dyes' warning_msg_color
            endif

            menu dyes_tome 0
        endif
    endif


    #################################
    # INCRIPTION RUNES
    #################################


    if findtype 'book' ground 2085 1 2 as runes_tome
        sysmsg '> Searching for Arcane Runes...' warning_msg_color

        if print_unloaded_items == 1
            while findtype rune backpack any any as found
                getlabel found item_label

                if not inlist 'items_unloaded' item_label
                    sysmsg 'Adding {{item_label}}'
                    pushlist 'items_unloaded' item_label
                endif

                @ignore found
            endwhile
            @clearignore
        endif

        if findtype rune backpack any any as magic_rune
            if verbose_mode  == 1
                sysmsg '> Unloading Magic Runes' warning_msg_color
            endif

            menu runes_tome 0
        endif
    endif

    #################################
    # MAGERY SCROLLS
    #################################


    if unload_magery_scroll_in_tome == 1
        if findtype 'book' ground 2227 1 2 as magery_scroll_tome
            sysmsg '> Searching for Magery Scrolls...' warning_msg_color

            if print_unloaded_items == 1
                if not listexists 'magery_scrolls'
                    createlist 'magery_scrolls'
                    pushlist 'magery_scrolls' 'Curse Scroll'
                    pushlist 'magery_scrolls' 'Recall'
                    pushlist 'magery_scrolls' 'ManaDrain Scroll'
                    pushlist 'magery_scrolls' 'Paralyze Scroll'
                    pushlist 'magery_scrolls' 'Archcure Scroll'
                    pushlist 'magery_scrolls' 'Fire Field Scrol'
                    pushlist 'magery_scrolls' 'Magic Trap Scroll'
                    pushlist 'magery_scrolls' 'Magic Arrow Scroll'
                    pushlist 'magery_scrolls' 'Arch Protection Sc'
                    pushlist 'magery_scrolls' 'Greater Heal Scrol'
                    pushlist 'magery_scrolls' 'Fire Field Scroll'
                    pushlist 'magery_scrolls' 'Lightning Scroll'
                    pushlist 'magery_scrolls' 'Energy Bolt Scroll'
                endif

                while findtype "Recall|Invisibility|Bless" backpack any any as found
                    getlabel found item_label

                    if not inlist 'items_unloaded' item_label
                        sysmsg 'Adding {{item_label}}'
                        pushlist 'items_unloaded' item_label
                    endif

                    @ignore found
                endwhile

                @clearignore
            endif

            if findtype "Recall|Invisibility" backpack any any as found
                if verbose_mode  == 1
                    sysmsg '> Unloading Magery Scrolls' warning_msg_color
                endif

                menu magery_scroll_tome 0
            endif
        endif
    endif

    #################################
    # DUMP ITENS IN RECYCLER
    #################################

    if findtype 'ornate elven chest' ground any any 2 as recycler
        sysmsg 'Recycling unidentified items...' warning_msg_color

        menu recycler 1
        wait action_delay
        if insysmsg 'recyclable items found'
            sysmsg 'Recycled all items!' 71
        endif

    endif

    #################################
    # DUMP ITENS IN STOCKPILE
    #################################

    if findtype 'resource container' ground any any 2 as stockpile
        setvar! resource_stockpile stockpile
        menu resource_stockpile 0
        wft 600
        if targetexists 'neutral'
            sysmsg '> Restocking Resource Stockpile...' warning_msg_color
            target 'self'
        endif

        if gumpexists 1859005118
            gumpclose 1859005118
        endif
    endif

    #################################
    # SHELF RESTOCK/RESSUPLY
    #################################

    if findtype 'storage shelf' ground any any 2 as shelf
        sysmsg 'RESTOCKING...' 55
        menu shelf 0
        wft action_delay
        if targetexists 'neutral'
            target self
        endif

        if gumpexists 3232825965
            gumpclose 3232825965
        endif


        menu shelf 1
        waitforgump 3232825965 action_delay

    else
        overhead 'NO SHELFS FOUND TO RESSUPLY!'
    endif


    sysmsg 'SETTING TO TRAVEL TO NEXT RUNE' success_msg_color
    setvar! go_to_next_rune 1
    setvar! recall_home_now 0
    cooldown 'OUT OF REGS' 0

endif


########################################
# TRAVEL ROUTINE - CYCLE RUNETOMES
########################################

# if set to travel, first see if there istn any mobs alive
# char was travelling before cleaning the mobs on the site
if cycle_runetome_farming == 1 and go_to_next_rune == 0 and recall_home_now != 1
    if dead lasttarget and not find lasttarget ground any any attack_range
        hotkey 'Target Closest Non-Friendly Monster'

        if insysmsg 'New target'
            sysmsg 'FOUND TARGET BEFORE TRAVELLING' warning_msg_color
        else
            setvar! go_to_next_rune 1
        endif
    elseif not dead lasttarget and find lasttarget ground any any attack_range
        if noto lasttarget == friend or noto lasttarget == friendly
            sysmsg 'CURR TARGET IS FRIENDLY. SKIPPING TO NEXT RUNE' warning_msg_color
        endif
    endif

endif


# should only travel if all enemies in the screen are dead!
if cycle_runetome_farming == 1 and go_to_next_rune == 1 and recall_home_now != 1

    # if first rune, need to hard set the number here
    if not varexist rune_number
        setvar! rune_number 10
    endif

    if debug == 1
        sysmsg 'CYCLE RUNETOME at {{execution_timer}}' success_msg_color
    endif

    say 'all follow me'

    foreach runebook in 'farm_runetomes'
        if verbose == 1
            sysmsg '>>> STARTING RUNEBOOK {{index}}: {{runebook}}'
        endif

        if index == 1
            setvar! runebook_number 1
        elseif index == 2
            setvar! runebook_number 2
        elseif index == 3
            setvar! runebook_number 3
        elseif index == 4
            setvar! runebook_number 4
        endif

        foreach page_number in runetome_page_numbers

            # set the rune position in runebook to print it so player knows which rune he is
            if page_number == 200
                setvar! current_rune_position 1
            elseif page_number == 201
                setvar! current_rune_position 2
            elseif page_number == 202
                setvar! current_rune_position 3
            elseif page_number == 203
                setvar! current_rune_position 4
            elseif page_number == 204
                setvar! current_rune_position 5
            elseif page_number == 205
                setvar! current_rune_position 6
            elseif page_number == 206
                setvar! current_rune_position 7
            elseif page_number == 207
                setvar! current_rune_position 8
            elseif page_number == 208
                setvar! current_rune_position 9
            elseif page_number == 209
                setvar! current_rune_position 10
            elseif page_number == 210
                setvar! current_rune_position 11
            elseif page_number == 211
                setvar! current_rune_position 12
            elseif page_number == 212
                setvar! current_rune_position 13

            # runebook page 2
            elseif page_number == 213
                setvar! current_rune_position 14
            elseif page_number == 214
                setvar! current_rune_position 15
            elseif page_number == 215
                setvar! current_rune_position 16
            elseif page_number == 216
                setvar! current_rune_position 17
            elseif page_number == 217
                setvar! current_rune_position 18
            elseif page_number == 218
                setvar! current_rune_position 19
            elseif page_number == 219
                setvar! current_rune_position 20
            elseif page_number == 220
                setvar! current_rune_position 21
            elseif page_number == 221
                setvar! current_rune_position 22
            elseif page_number == 222
                setvar! current_rune_position 23
            elseif page_number == 223
                setvar! current_rune_position 24
            elseif page_number == 224
                setvar! current_rune_position 25
            elseif page_number == 225
                setvar! current_rune_position 26
            endif

            # travel to the rune
            if recall_home_now != 1
                while mana <= 11
                    if verbose == 1
                        sysmsg 'MEDITATING TO RECALL' warning_msg_color
                    endif
                    setvar! meditate_now 1
                    replay
                endwhile

                if verbose == 1
                    sysmsg 'OPENING RUNEBOOK {{runebook}}'
                endif

                dclick runebook

                settimer 'waiting_runebook_gump_timer' 0
                if not gumpexists runetome_gump_id and timer 'waiting_runebook_gump_timer' < 2000
                    if insysmsg 'You must wait'
                        while insysmsg 'You must wait'
                            clearsysmsg
                            dclick steal_container
                            wait action_delay
                        endwhile
                    endif

                    sysmsg 'waiting for runebook gump'
                    while not gumpexists runetome_gump_id and timer 'waiting_runebook_gump_timer' < 2000
                        waitforgump runetome_gump_id action_delay
                    endwhile
                endif

                sysmsg '>> RUNEBOOK {{runebook}} | PAGE: {{page_number}} | RUNE: {{rune_number}}'
                if gumpexists runetome_gump_id
                    waitforgump runetome_gump_id action_delay
                    # switch to correct page
                    gumpresponse page_number runetome_gump_id
                    waitforgump runetome_gump_id action_delay
                    gumpresponse rune_number runetome_gump_id
                    wait recall_travel_time

                    if insysmsg 'Magical travel from inside a dungeon'
                        sysmsg 'CHAR INSIDE DUNGEON! DISABLING RUNETOME CYCLING!' warning_msg_color
                        overhead 'dungeon! disabling travel.' warning_msg_color

                        setvar! cycle_runetome_farming 0
                        replay
                    endif
                else
                    sysmsg 'COULDNT OPEN RUNEBOOK TO TRAVEL!' 37
                endif
            endif

            sysmsg 'SETTING NEXT RUNE'
            setvar! go_to_next_rune 0
            sysmsg 'GOING TO NEXT RUNE' 54
            # poplist 'runebook_rune_btns' 'front'
            # pushlist 'runebook_rune_btns' rune_number 'back'

            # SET NEXT RUNE TO TRAVEL
            if rune_number == 10
                setvar! rune_number 20
            elseif rune_number == 20
                setvar! rune_number 10
            endif


            # SET NEXT RUNETOME PAGE
            poplist runetome_page_numbers 'front'
            pushlist runetome_page_numbers page_number 'back'

            ########################################
            # CHANGE RUNEBOOK AND RESET PAGE
            # NUMBERS IF LAST RUNE REACHED
            ########################################

            # if we reached the max rune set to use, reset the runetome page numbers so we can start cycling it azgain from the first rune
            if page_number == 224 or current_rune_position == max_runes_to_use_per_runebook

                if atlist farm_runetomes 1 as found
                    sysmsg 'REACHED LAST RUNE {{max_runes_to_use_per_runebook}}. STARTING NEXT RUNEBOOK {{found}}...' 54
                else
                    sysmsg 'REACHED LAST RUNE {{max_runes_to_use_per_runebook}}. STARTING RUNEBOOK AGAIN' 54
                endif

                # move current runebook to back of the list
                poplist farm_runetomes 'front'
                pushlist farm_runetomes runebook 'back'
                say 'all follow me'

                # reset the page numbers to original format including all rune positions to start from the first rune
                clearlist runetome_page_numbers
                foreach x in runetome_page_numbers_unchanged
                    pushlist runetome_page_numbers x
                endfor

                # reset rune btn on runetome to first btn of each page
                setvar! rune_number 10
            endif


            # this break has to happen, or the script will loop through
            # all the runes in the book without ever trying to get targets
            if debug == 1
                sysmsg 'BREAKING 1st TRAVEL FOR' debug_msg_color
            endif
            break
        endfor

        if debug == 1
            sysmsg 'BREAKING 2nd TRAVEL FOR' debug_msg_color
        endif

        break
    endfor

#endif cycle_runetome_farming == 1
endif





########################################
# TOGGLE AUTO GET TARGETS WITH LANTERN
########################################


if findtype 2594|2598|2578|30580 self
    # sysmsg 'FOUND LIGHTSOURCE ON' debug_msg_color
    if auto_get_new_targets == 0
        sysmsg '[LANTERN] TURNING AUTO GET NEW TARGETS ON' script_msg_color
        setvar! auto_get_new_targets 1
    endif

# LIGHT SOURCES OFF
# dungeon torches have to be undressed (they have to be in the backpack since they cant be turned off)
elseif findtype 2597|3947 self or findtype 'dungeon torch' backpack
    # sysmsg 'FOUND LIGHTSOURCE OFF' debug_msg_color
    if auto_get_new_targets == 1
        sysmsg '[LANTERN] TURNING AUTO GET NEW TARGETS OFF' script_msg_color
        setvar! auto_get_new_targets 0
    endif
endif


# satchel equiped
if findtype 'reagent satchel' self and not findtype 'reagent satchel' backpack
    # sysmsg '>>>>>> FOUND SATCHEL ON SELF' warning_msg_color
    if debug == 0
        sysmsg '[SATCHEL] TURNING debug ON' script_msg_color
        setvar! debug 1
    endif
    if verbose == 0
        sysmsg '[SATCHEL] TURNING verbose ON' default_sysmsg_color
        setvar! verbose 1
    endif
# satchel not equiped (in backpack)
elseif findtype 'reagent satchel' self and findtype 'reagent satchel' backpack
    # sysmsg '>>>>>> FOUND SATCHEL ON BACKPACK' debug_msg_color
    if debug == 1
        sysmsg '[SATCHEL] TURNING debug OFF' script_msg_color
        setvar! debug 0
    endif
    if verbose == 1
        sysmsg '[SATCHEL] TURNING verbose OFF' script_msg_color
        setvar! verbose 0
    endif
endif




# if debug == 1
    # sysmsg '[DEBUG] AFTER AUTO-SUMMON ROUTINE' debug_msg_color
# endif



############################################
# SPIRIT SPEAK DEAD CORPSES
############################################

if diffhits > max_diffhits_before_healing or poisoned or followers < followers_max_limit
    if debug == 1
        sysmsg 'replay spirit speak' debug_msg_color
    endif
    replay
endif

if offensive_mode == 1 and dead lasttarget or offensive_mode == 0 and recall_home_now != 1
    if auto_spirit_speak == 1 and skill 'spirit' > 0 and use_undead_summons == 0
        if timer 'spirit_speak_cooldown_timer' > 1000
            settimer 'spirit_speak_cooldown_timer' 0
            if findtype 'corpse' ground any any 10 as body
                if not listexists 'drained_corpses'
                    createlist 'drained_corpses'
                endif

                if not inlist 'drained_corpses' body
                    if verbose == 1
                        sysmsg '>>> DRANING NEARBY CORPSES' action_msg_color
                        overhead '*spirit speak*' action_msg_color
                    endif

                    skill 'spirit'
                    # avoiding using global ignore here, switching to list control to avoid imprevisiblities
                    @pushlist 'drained_corpses' body
                    wait action_delay
                    # @ignore body
                endif
            endif
        endif
    endif
else
    if verbose == 1
        # sysmsg '[OFFENSIVE MODE] SKIPPING SPIRIT SPEAK...' warning_msg_color
    endif
endif



############################################
# VAMPIRIC EMBRACE DEAD CORPSES
############################################

# keep draining corpses within 10 tile range

if diffhits > max_diffhits_before_healing or poisoned or followers < followers_max_limit
    if debug == 1
        sysmsg 'replay vampiric embrace' debug_msg_color
    endif
    replay
endif

if offensive_mode == 1 and dead lasttarget or offensive_mode == 0 and recall_home_now != 1
    if auto_vampiric_embrace == 1 and skill 'necromancy' > 0
        # if timer 'vampiric_embrace_cooldown_timer' >= 30000
        if not cooldown 'Vampiric Embrace'
            if findtype 'corpse' ground any any 10 as body
                if not listexists consumed_corpses
                    createlist consumed_corpses
                endif

                if not inlist consumed_corpses body
                    pushlist consumed_corpses body

                    if verbose == 1
                        sysmsg '>>> VAMPIRIC EMBRACE' spell_msg_color
                    endif

                    say '[vampiricembrace'
                    wft action_delay
                    if targetexists 'neutral'
                        if verbose == 1
                            sysmsg '>>> CONSUMING NEARBY CORPSE...' action_msg_color
                            overhead '*consuming corpse*' default_overhead_color
                        endif
                        # target body
                        # TESTING trade target body to target self to avoid locking char trying to consume an out of sight body like one in another room
                        hotkey 'Target Self'
                        wait action_delay
                        settimer 'vampiric_embrace_cooldown_timer' 0
                        settimer 'Vampiric Embrace' 0

                        if debug == 1
                            sysmsg 'RESETING LAST AFTER CONSUMING CORPSE' reset_timer_msg_color
                        endif

                        hotkey 'Clear Target Queue'
                        hotkey 'Set Last Target'
                        wft action_delay
                        target last_target_serial
                    endif
                endif

            endif
        else
            # if verbose == 1
            #     sysmsg '... VAMPIRIC EMBRACE COOLDOWN' spell_cooldown_msg_color
            # endif
        endif
    endif
else
    if verbose == 1
        # sysmsg '[OFFENSIVE MODE] SKIPPING VAMPIRIC EMBRACE...' warning_msg_color
    endif
endif






######################################
# RESET SPELL TIMERS
# monitor sysmsgs to know when we can reset time spell timers
######################################

if debug == 1
    sysmsg 'SYSMSG JOURNAL CHECKS at {{execution_timer}}'
endif

if diffhits > max_diffhits_before_healing or poisoned or followers < followers_max_limit
    if debug == 1
        sysmsg 'replay sysmsg journal checks' debug_msg_color
    endif
    replay
endif

if insysmsg 'You may now cast a wizardry harm'
    if verbose == 1
        sysmsg '+++ [TIMER] RESETING HARM TIMER...' reset_timer_msg_color
    endif

    settimer 'harm_timer' 0
endif

if insysmsg 'You may now cast a wizardry magic arrow'
    if verbose == 1
        sysmsg '+++ [TIMER] RESETING MAGIC ARROW (NEXT IN {{ma_delay}})' reset_timer_msg_color
    endif

    settimer 'magic arrow_timer' 0
endif

if insysmsg 'You may now cast a wizardry fireball'
    if verbose == 1
        sysmsg '+++ [TIMER] RESETING FIREBALL TIMER...' reset_timer_msg_color
    endif

    settimer 'fireball_timer' 0
endif

if insysmsg 'You may now cast a wizardry lightning'
    if verbose == 1
        sysmsg '+++ RESETING LIGHTNING TIMER. NEXT IN {{lightning_delay}}...' reset_timer_msg_color
    endif

    settimer 'lightning_timer' 0
endif

if debug == 1
    sysmsg 'SAIU SYSMSG JOURNAL CHECKS {{execution_timer}}'
endif


if is_detecter == 1
    useskill 'detectinghidden'
    wft action_delay
    target self

    if insysmsg 'you reveal what was hidden.'
        sysmsg '!FOUND HIDDEN PLAYER!' alert_msg_color
        sysmsg '> FOUND HIDDEN PLAYER! PROBABLY THIEF!' alert_msg_color
    endif
endif





#############################
# AVOID STAYING ABOVE DANGEROUS
# TILES LIKE BOSS AND DAEMONFLAMES
#############################

if diffhits > max_diffhits_before_healing or poisoned or followers < followers_max_limit
    if debug == 1
        sysmsg 'replay dangerous tiles' debug_msg_color
    endif
    replay
endif

if auto_escape_ground_burning_flames == 1
    # 28016 / Hue 2264 - mausoleum forgotten soul flames
    # 42014 / Hue 2929 - smoking pyre mage flames
    # 28016 / Hue 2236 - a custodian's flames
    if findtype 28016|42014 ground any any 1 as found
        while find found ground any any 1 and not find found ground any any 2
            sysmsg '>>> BURNING FLAME!!!!!! MOVE!!!' alert_msg_color
            sysmsg '>>> BURNING FLAME!!!!!! MOVE!!!' warning_msg_color
            sysmsg '>>> BURNING FLAME!!!!!! MOVE!!!' alert_msg_color
            overhead '!!! MOVE !!!' self alert_msg_color
            overhead '!!! MOVE !!!' self warning_msg_color
            overhead '!!! MOVE !!!' self alert_msg_color

            cast 'Heal'
            wft 1500
            target self
        endwhile
    endif
endif






#########################################
# SEARCH NEW ENEMIES
#########################################

if diffhits > max_diffhits_before_healing or poisoned or followers < followers_max_limit
    if debug == 1
        sysmsg 'replay search new enemies' debug_msg_color
    endif
    replay
endif


if mana < min_mana_to_attack
    if debug == 1
        sysmsg 'MEDITATE TO SEARCH FOR NEW ENEMIES' debug_msg_color
    endif

    setvar! meditate_now 1
    replay
endif

# IF OFFENSIVE MODE IS ON, TRY TO GET A TARGET EVEN IF lasttarget IS ALIVE
if offensive_mode == 1 and auto_get_new_targets == 1 and keep_getting_closest_target == 1
    if debug == 1
        sysmsg '[OFFENSIVE MODE] GETTING CLOSEST TARGET at {{execution_timer}}' debug_msg_color
    endif

    if verbose == 1
        sysmsg '[OFFENSIVE MODE] GETTING CLOSEST TARGET at {{execution_timer}}' debug_msg_color
    endif

    hotkey 'Target Closest Non-Friendly Monster'
endif

if dead lasttarget or not find lasttarget ground any any 10 and recall_home_now != 1
    if auto_get_new_targets == 1 and timer auto_get_new_targets_timer >= 1000
        if debug == 1
            sysmsg '> SEARCHING MONSTERS TARGETS at {{execution_timer}}...' debug_msg_color
        endif

        if verbose == 1
            overhead '*searching monsters*' action_msg_color
        endif

        hotkey 'Target Closest Non-Friendly Monster'
        if get_players_on_auto_target == 1
            if verbose == 1
                sysmsg '> SEARCHING PLAYER TARGETS...' action_msg_color
                overhead '*searching players*' action_msg_color
            endif

            hotkey 'Next Grey Humanoid Target'
            # TESTING removing wait
            # wait action_delay
        endif

        if insysmsg 'No one matching that was found on your screen'
            if cycle_runetome_farming == 1
                sysmsg 'NO TARGETS FOUND. GOING TO NEXT RUNE...'
                setvar! go_to_next_rune 1
            endif
        endif

        settimer auto_get_new_targets_timer 0
    elseif auto_get_new_targets == 0 and timer 'get_new_target_msg' > 4000
        overhead 'waiting for new target' overhead_color
        settimer 'get_new_target_msg' 0
    endif
endif



#########################################
# MAIN ATTACK ROUTINE
#########################################


# make sure char has high hp and mana for FS before attacking
if diffhits > max_diffhits_before_healing or poisoned or followers < followers_max_limit
    if debug == 1
        sysmsg 'replay main attack routine' debug_msg_color
    endif
    replay
endif

if auto_attack_targets == 1 and mana >= min_mana_to_attack and recall_home_now != 1
    if debug == 1
        sysmsg 'ENTROU MAIN ATTACK IF em {{execution_timer}}' debug_msg_color
    endif
    # setvar! last_serial lasttarget
    clearall

    # if target is farther than 10 tiles, warn player
    if not find lasttarget ground any any attack_range and find lasttarget ground any any 20 as targ
        sysmsg 'MOB TOO FAR TO ATTACK' warning_msg_color
        overhead 'TOO FAR TO ATTACK!' warning_msg_color targ

        if not timerexists waiting_to_lure_timer
            createtimer waiting_to_lure_timer
            settimer waiting_to_lure_timer 0
        endif
        if timer waiting_to_lure_timer > 3000
            if verbose == 1
                sysmsg 'TOO LONG TO LURE MOB. ASSUMING ITS OUT OF SIGHT' warning_msg_color
            endif

            if cycle_runetome_farming == 1
                setvar! go_to_next_rune 1
                removetimer waiting_to_lure_timer
                replay
            endif
        endif

        if lure_out_of_range_mobs == 1
            sysmsg 'LURING MOB TO BE IN RANGE OF ATTACK' warning_msg_color
            overhead '>>>> LURING <<<<' 90 targ

            say 'all kill'
            wft action_delay
            target targ
            attack targ
            wait 1000
            say 'all follow'
        endif
    endif

    # SAVE CURRENT TARGET TO COMPARE WITH LAST SAVED LAST_TARGET_SERIAL TO SEE IF WE HAVE A NEW MOB OR JUST A OLD MOB THAT WENT OFF SCREEN OF HID ITSELF
    if find lasttarget ground any any find_last_target_max_range as serial
        overhead '>> CURR TARG <<' warning_msg_color serial
        sysmsg 'SAVING {{lasttarget}} AS CURR TARG' 90 serial
        setvar! current_target_serial serial
        getlabel current_target_serial current_target_label
    endif

    while find current_target_serial ground any any attack_range
        # this variable is used later on to check if we finished killing some mob, to start a timer to wait for looting the corpses before travelling to another rune
        setvar! started_attack_routine 1
        if verbose == 1
            sysmsg 'ATTACKING: {{current_target_label}}' warning_msg_color
        endif

        ########################################
        # check for pks on screen
        if auto_escape_pks_on_screen == 1 and recall_home_now != 1
            if verbose == 1
                sysmsg 'â–· searching for pks on screen'
            endif
            # hotkey 'clear target queue'
            clearsysmsg
            hotkey 'Next Murderer Player Target'
            if insysmsg 'New target'
                sysmsg '!!!!!!! FOUND PK! RUN!!!!!!!' alert_msg_color
                setvar! recall_home_now 1
                replay
            endif
        endif


        # if set to lure, avoid luring mobs that do AOS when close to char, cause that slows down killing by a lot
        if 'Daemon' in current_target_label or 'daemon' in current_target_label or 'archer' in current_target_label
            if lure_mobs_closer_before_killing == 1
                sysmsg 'TURNING LURING OFF FOR {{current_target_label}}'
                overhead 'NON LURABLE MOB' warning_msg_color current_target_serial
                setvar! turn_luring_back_on 1
                setvar! lure_mobs_closer_before_killing 0
            endif
        else
            if lure_mobs_closer_before_killing == 0 and turn_luring_back_on == 1
                sysmsg 'TURNING LURING BACK ON FOR {{current_target_label}}'
                unsetvar! turn_luring_back_on
                setvar! lure_mobs_closer_before_killing 1
            endif
        endif

        # since we found a mob, if set to cycle runetomes, set to wait to loot before going to next rune after finishing this mob
        if cycle_runetome_farming == 1 and wait_to_loot_before_travelling_to_next_rune == 1 and started_attack_routine == 1
            setvar! wait_to_loot_now 1
        endif

        if debug == 1
            sysmsg '# MAIN ATTACK LOOP at {{execution_timer}}' debug_msg_color
        endif


        #----------------------------------------
        # ENEMY/MONSTER ATTACK ROUTINE

        # if target queue is active, we need to clear it here or else the script cant detect the first target opened (for mana drain) cause its queued
        hotkey 'Clear Target Queue'

        if diffhits > max_diffhits_before_healing or poisoned or followers < followers_max_limit
            if debug == 1
                sysmsg 'replay attack routine while loop' debug_msg_color
            endif

            replay
        endif

        if mana < min_mana_to_attack
            if debug == 1
                sysmsg 'MEDITATING TO ATTACK...' debug_msg_color
            endif
            setvar! meditate_now 1

            replay
        endif


        # try to find target in ground, to see if its dead or gone hidden
        if not find current_target_serial ground any any find_last_target_max_range
            sysmsg '!!!!!! BREAKING ATTACK LOOP BECAUSE CANT FIND LASTTARGET' alert_msg_color
            hotkey '> Interrupt'
            break
            # continue
        endif

        # safe clause to not attack self or friendsa
        if not dead current_target_serial and noto current_target_serial = friend or noto current_target_serial = friendly or noto current_target_serial = innocent
            sysmsg 'CANCELING FRIENDLY TARGET AND BREAKING ATTACK LOOP' warning_msg_color
            target 'clear'
            hotkey 'Cancel Current Target'
            hotkey '> Interrupt'
            break
        endif

        # warn and heal when char is over mob flames
        if auto_escape_ground_burning_flames == 1
            # 28016 / Hue 2264 - mausoleum forgotten soul flames
            # 42014 / Hue 2929 - smoking pyre mage flames
            # 28016 / Hue 2236 - a custodian's flames
            while findtype 28016|42014 ground any any 1 and not findtype 28016|42014 ground any any 2
                sysmsg '>>> BURNING FLAME UNDER CHAR!!!!!! MOVING CHAR'
                sysmsg '>>> BURNING FLAME UNDER CHAR!!!!!! MOVING CHAR'
                sysmsg '>>> BURNING FLAME UNDER CHAR!!!!!! MOVING CHAR'
                sysmsg '>>> BURNING FLAME UNDER CHAR!!!!!! MOVING CHAR'
                sysmsg '>>> BURNING FLAME UNDER CHAR!!!!!! MOVING CHAR'
                overhead '>>> BURNING FLAME UNDER CHAR!!!!!! MOVING CHAR'
                overhead '>>> BURNING FLAME UNDER CHAR!!!!!! MOVING CHAR'
                overhead '>>> BURNING FLAME UNDER CHAR!!!!!! MOVING CHAR'

                cast 'Heal'
                wft 1500
                target self
            endwhile
        endif

        # TOGGLE LANTERN TO MAKE CHAR SKIP CURRENT RUNE
        if findtype 2594|2598|2578|30580 self
        elseif not findtype 2597|3947 backpack and findtype 2597|3947 self as lights
            if verbose == 1
                sysmsg '[LANTERN OFF] SKIPING TO NEXT RUNE' script_msg_color
            endif

            wait action_delay
            dclick lights
            wait action_delay
            setvar! go_to_next_rune 1
            replay
        endif

        if not dead current_target_serial and noto current_target_serial == hostile or noto current_target_serial == murderer or noto current_target_serial == criminal

            ########################################
            # check for pks on screen
            if auto_escape_pks_on_screen == 1 and recall_home_now != 1
                if verbose == 1
                    sysmsg 'â–· searching for pks on screen'
                endif
                # hotkey 'clear target queue'
                clearsysmsg
                hotkey 'Next Murderer Player Target'
                if insysmsg 'New target'
                    sysmsg '!!!!!!! FOUND PK! RUN!!!!!!!' alert_msg_color
                    setvar! recall_home_now 1
                    replay
                endif
            endif

            #------------------------------------------
            # THESE 3 CHECKS BELLOW MUST BE HERE ON TOP
            # OF THE ATTACK ROUTINE CAUSE IF THE TARGET CHANGES,
            # WE WANNA PUT IT THROUGH THE ENTIRE ROUTINE
            # FROM START: HERD, MANA DRAIN, etc...

            if diffhits > max_diffhits_before_healing or poisoned or followers < followers_max_limit
                if debug == 1
                    sysmsg 'replay before LOS check' debug_msg_color
                endif

                replay
            endif

            # if set to keep getting the closest target, we only wanna do that in case theres already a live target set
            # the reason is that if there isnt, the script is already searching for the closest target to set before the main attack routine
            if auto_get_new_targets == 1 and keep_getting_closest_target == 1 and not dead current_target_serial
                sysmsg 'RE-GETTING CLOSEST TARGET' action_msg_color
                hotkey 'Target Closest Non-Friendly Monster'
            endif

            # HANDLE GONE OR HIDDEN LAST TARGET
            if not dead current_target_serial and not find current_target_serial ground any any find_last_target_max_range
                sysmsg 'TARGET NOT FOUND! RESETING TARGET...' warning_msg_color
                setvar! reset_current_target 1
                # break
            endif

            if not listexists out_of_sight_mobs
                createlist out_of_sight_mobs
            endif

            # HANDLE LAST TARGET OUT OF SIGHT / NOT IN LOS
            if current_target_out_of_sight == 1
                sysmsg 'TARGET OUT OF SIGHT. RESETING TARGET...' alert_msg_color
                setvar! reset_current_target 1
                pushlist out_of_sight_mobs current_target_serial
                setvar! last_out_of_sight_enemy current_target_serial
                setvar! current_target_out_of_sight 0
            endif

            if reset_current_target == 1
                if verbose == 1
                    sysmsg '>>>> RESET CURRENT TARGET!' warning_msg_color
                endif
                unsetvar! current_target_serial
                unsetvar! reset_current_target

                # NOTE: trying next instead of closest here to get another mob that is not out of sight
                # hotkey 'Target Closest Non-Friendly Monster'
                hotkey 'Next Non-Friendly Monster Target'

                if insysmsg 'New target set'
                    setvar! targserial lasttarget
                    if inlist out_of_sight_mobs targserial
                        sysmsg 'MOB SAVED AS OUT OF SIGHT. MOVE TO ATTACK IT!' warning_msg_color
                        overhead 'saved as out of sight!' warning_msg_color targserial
                        setvar! no_new_mobs 1
                    else
                        sysmsg 'NEW MOB! RESETING CURRENT TARGET!' warning_msg_color
                        overhead '>> NEW MOB <<' warning_msg_color targserial
                        setvar! current_target_serial targserial
                    endif
                else
                    setvar! no_new_mobs 1
                endif

                if no_new_mobs == 1
                    if debug == 1
                        sysmsg 'NO NEW MOBS at {{execution_timer}}' debug_msg_color
                    endif
                    unsetvar! no_new_mobs

                    if cycle_runetome_farming == 1
                        if debug == 1
                            sysmsg 'replay due to no new targets inside attack routine' debug_msg_color
                        endif

                        setvar! go_to_next_rune 1

                        replay
                    endif
                endif
            endif

            #------------------------------------------
            # save last target serial on custom var to re-set after healing friendly targets
            # if last_target_serial == 0 or current_target_serial != last_target_serial
            if current_target_serial != last_target_serial
                overhead '>>> NEW MOB <<<' warning_msg_color current_target_serial
                overhead '>>> OLD MOB <<<' warning_msg_color last_target_serial
                sysmsg '>>> NEW MOB: {{current_target_serial}} | LAST MOB: {{last_target_serial}} *' warning_msg_color lasttarget

                # unsetvar last_target_serial
                setvar! last_target_serial current_target_serial

                sysmsg '+++ RESETING ALL TIMERS!' reset_timer_msg_color

                settimer mana_drain_timer mana_drain_delay
                settimer curse_timer mana_drain_delay
                settimer poison_timer poison_delay
                settimer medit_msg_timer 6000
                settimer auto_get_new_targets_timer 1000
                settimer all_guard_timer all_guard_delay
                settimer all_patrol_timer all_patrol_delay

            elseif current_target_serial == last_target_serial
                sysmsg '+++ MOB {{current_target_serial}} == LAST FOUND {{last_target_serial}}' warning_msg_color
                overhead '>>> SAME MOB <<<' warning_msg_color lasttarget
            endif

            #------------------------------------------
            # HERDING
            if diffhits > max_diffhits_before_healing or poisoned or followers < followers_max_limit
                if debug == 1
                    sysmsg 'replay herding' debug_msg_color
                endif

                replay
            endif

            if auto_herd_mobs == 1
                # if not dead 'last' and find 'last' ground any any find_last_target_max_range and noto 'last' == hostile or noto 'last' == murderer or noto 'last' == criminal
                if varexist current_target_serial
                    if not listexists herdened_mobs
                        createlist herdened_mobs
                    endif

                    if not inlist herdened_mobs current_target_serial
                        if findtype 3713 as crook
                            if debug == 1
                                sysmsg 'HERDING at {{execution_timer}}' debug_msg_color
                            endif

                            say '[FocusAggression'
                            wft action_delay

                            if targetexists 'harmful'
                                if verbose == 1
                                    sysmsg 'FOCUSING AGGRESSION' 54
                                endif
                                hotkey 'Last Target'
                                wait action_delay

                                if insysmsg 'You focus your follower'
                                    overhead 'focused pets agression' actions_msg_color current_target_serial

                                    pushlist herdened_mobs current_target_serial
                                endif
                            endif

                            say 'all kill'
                            wft action_delay
                            target current_target_serial
                        else
                            overhead "no sheperd's crook!"
                        endif
                    endif
                endif
                # endif
            endif


            ########################################
            # check for pks on screen
            if auto_escape_pks_on_screen == 1 and recall_home_now != 1
                if verbose == 1
                    sysmsg 'â–· searching for pks on screen'
                endif
                # hotkey 'clear target queue'
                clearsysmsg
                hotkey 'Next Murderer Player Target'
                if insysmsg 'New target'
                    sysmsg '!!!!!!! FOUND PK! RUN!!!!!!!' alert_msg_color
                    setvar! recall_home_now 1
                    replay
                endif
            endif



            #------------------------------------------
            # LURE MOB CLOSER BEFORE KILLING
            if diffhits > max_diffhits_before_healing or poisoned or followers < followers_max_limit
                if debug == 1
                    sysmsg 'replay lure mobs before killing' debug_msg_color
                endif

                replay
            endif

            if keep_pets_close_to_vet == 1 or lure_mobs_closer_before_killing == 1 and timer lure_mob_closer_timer > 4000
                if not find current_target_serial ground any any lure_mobs_distance_to_lure and find current_target_serial ground any any find_last_target_max_range
                    if verbose == 1
                        sysmsg '>>> LURING MOB CLOSER at {{execution_timer}}' debug_msg_color
                        overhead '*luring*' warning_msg_color current_target_serial
                    endif

                    attack current_target_serial
                    say 'all follow me'


                    if not timerexists waiting_mob_to_approach_timer
                        createtimer waiting_mob_to_approach_timer
                    endif

                    while timer waiting_mob_to_approach_timer < 1500
                        if diffhits > max_diffhits_before_healing or poisoned or followers < followers_max_limit
                            if debug == 1
                                sysmsg 'replay waiting mob to approach' debug_msg_color
                            endif

                            replay
                        endif

                        wait 10
                        if find current_target_serial ground any any lure_mobs_distance_to_lure
                            sysmsg 'MOB IS NOW AT {{lure_mobs_distance_to_lure}} TILES' success_msg_color
                            break
                        endif
                    endwhile


                    hotkey 'Toggle Peace Only'
                    settimer lure_mob_closer_timer 0
                    say 'all guard me'
                else
                    if verbose == 1
                        sysmsg '>>> MOB IS CLOSE, NO NEED TO LURE' warning_msg_color
                    endif
                endif
            endif



            # setvar! last_target_serial lasttarget

            #------------------------------------------
            # before each spell and every attack, we first check 2 things:
            # if the followers number is 4 or more, indicating we have all summons up
            # and if diffhits is under 10, indicating character is not under threat of dying and doenst need heal
            # only if all checks pass we start attacking the target
            if not dead current_target_serial and noto current_target_serial != friend and noto current_target_serial == hostile or noto current_target_serial == murderer or noto current_target_serial == criminal
            # if noto current_target_serial != friend

                if diffhits > max_diffhits_before_healing or poisoned or followers < followers_max_limit
                    if debug == 1
                        sysmsg 'replay before spells' debug_msg_color
                    endif

                    replay
                endif

                attack current_target_serial

                if auto_all_guard == 1 and timer 'all_guard_timer' >= 5000
                    say 'all guard me'
                    settimer 'all_guard_timer' 0
                endif


                # GRIMOIRE SPELLS

                # mana drain
                if use_mana_drain == 1
                    if diffhits > max_diffhits_before_healing or poisoned or followers < followers_max_limit
                        if debug == 1
                            sysmsg 'replay before mana drain' debug_msg_color
                        endif

                        replay
                    endif

                    if not dead current_target_serial and find current_target_serial ground any any find_last_target_max_range

                        if current_target_serial == last_mana_drained_serial and timer 'mana_drain_timer' <= mana_drain_delay
                            if verbose == 1
                                overhead '>> DRAINED {{mana_drain_timer}}ms AGO <<' warning_msg_color current_target_serial
                                sysmsg '!!! THIS MOB WAS MANA DRAINED {{mana_drain_timer}}ms AGO' warning_msg_color
                            endif

                        elseif current_target_serial != last_mana_drained_serial and timer 'mana_drain_timer' >= mana_drain_delay
                            # overhead '> mana drain <' spell_overhead_color
                            sysmsg 'â—Ž MANA DRAIN NEW MOB: {{current_target_serial}} | LAST DRAINED: {{last_mana_drained_serial}}' spell_msg_color
                            overhead '>> LAST DRAINED TARGET <<' warning_msg_color last_mana_drained_serial
                            overhead '>> NEW MANA DRAIN TARGET <<' warning_msg_color current_target_serial

                            hotkey 'Clear Target Queue'
                            cast 'mana drain'

                            settimer 'waiting_target_timer' 0
                            clearsysmsg
                            while not targetexists 'any' and not insysmsg 'disturbed' and not insysmsg 'cannot cast a spell' and timer 'waiting_target_timer' < 3500
                                wait 10

                                if insysmsg 'disturbed' or insysmsg 'cannot cast a spell'
                                    if verbose == 1
                                        sysmsg 'BREAKING WHILE WAITING FOR MANA DRAIN TARGET' warning_msg_color
                                    endif

                                    wait spell_recovery_delay
                                    break
                                endif
                            endwhile

                            if targetexists 'harmful'
                                #hotkey 'Last Target'

                                clearsysmsg

                                target current_target_serial
                                wait spell_recovery_delay

                                sysmsg 'ENTROU IF TARGET EXISTS MANA DRAIN' warning_msg_color

                                if insysmsg 'Target cannot be seen' or insysmsg 'out of sight' or insysmsg 'Thats too far away'
                                    if debug == 1
                                        sysmsg 'CANT BE SEEN ON MANA DRAIN. BREAKING ATK LOOP' warning_msg_color
                                    endif

                                    setvar! reset_current_target 1
                                    setvar! current_target_out_of_sight 1
                                    pushlist out_of_sight_mobs current_target_serial
                                    # break
                                    continue
                                else
                                    if debug == 1
                                        sysmsg '+++ RESETING MANA DRAIN TIMER' reset_timer_msg_color
                                    endif

                                    settimer 'mana_drain_timer' 0
                                    cooldown 'MANA DRAIN/VAMPIRE' mana_drain_delay
                                    setvar! last_mana_drained_serial current_target_serial
                                endif
                            else
                                sysmsg 'MANA DRAIN TARGET NOT OPENED' alert_msg_color
                            endif
                        endif
                    endif
                endif


                ########################################
                # check for pks on screen
                if auto_escape_pks_on_screen == 1 and recall_home_now != 1
                    if verbose == 1
                        sysmsg 'â–· searching for pks on screen'
                    endif
                    # hotkey 'clear target queue'
                    clearsysmsg
                    hotkey 'Next Murderer Player Target'
                    if insysmsg 'New target'
                        sysmsg '!!!!!!! FOUND PK! RUN!!!!!!!' alert_msg_color
                        setvar! recall_home_now 1
                        replay
                    endif
                endif



                #-------------------------
                # MIND ROT AND CORPSE SKIN
                if is_necromancer == 1
                    if use_mind_rot == 1
                        if timer mind_rot_timer > 30000
                            sysmsg 'â—Ž MIND ROT' necro_spell_msg_color
                            say '[mindrot'
                            wait action_delay
                            if insysmsg 'symbols'
                                settimer mind_rot_timer 0
                                cooldown 'MIND ROT'
                            endif
                        endif
                    else
                        sysmsg 'MIND ROT COOLDOWN...' spell_cooldown_msg_color
                    endif

                endif

                #-------------------------
                # POISON (NOXXER)

                if diffhits > max_diffhits_before_healing or poisoned or followers < followers_max_limit
                    if debug == 1
                        sysmsg 'replay before poison (multiple targets)' debug_msg_color
                    endif

                    replay
                endif

                if not listexists poisoned_mobs
                    createlist poisoned_mobs
                endif

                if use_poison == 1 and timer poison_timer >= poison_delay
                    sysmsg 'CLEARING POISONED MOBS LIST' warning_msg_color
                    clearlist poisoned_mobs
                endif

                if use_poison == 1 and is_noxxer == 1 and multiple_poison_targets == 1
                    sysmsg 'â—Ž POISON (MULTIPLE TARGETS)' spell_msg_color
                    # save current target to re-set last target after iterating through all mobs
                    setvar! previous_target current_target_serial

                    # if poison timer is up, reset the control list


                    # if not listexists poison_targets
                    #     createlist poison_targets
                    # endif
                    # clearlist poison_targets


                    if not listexists scanned_poison_targets
                        createlist scanned_poison_targets
                    endif
                    clearlist scanned_poison_targets

                    settimer scanning_poison_targets 0
                    unsetvar! missed_poison_target
                    # while not dead self and timer scanning_poison_targets < 1000
                    while not dead self


                        ########################################
                        # check for pks on screen
                        if auto_escape_pks_on_screen == 1 and recall_home_now != 1
                            if verbose == 1
                                sysmsg 'â–· searching for pks on screen'
                            endif
                            # hotkey 'clear target queue'
                            clearsysmsg
                            hotkey 'Next Murderer Player Target'
                            if insysmsg 'New target'
                                sysmsg '!!!!!!! FOUND PK! RUN!!!!!!!' alert_msg_color
                                setvar! recall_home_now 1
                                replay
                            endif
                        endif


                        if diffhits > max_diffhits_before_healing or poisoned or followers < followers_max_limit
                            if debug == 1
                                sysmsg 'replay inside poison (multiple targets)' debug_msg_color
                            endif

                            replay
                        endif

                        clearsysmsg
                        hotkey "Next Non-Friendly Monster Target"

                        # if no targets, break
                        if insysmsg 'No one matching that was found on your screen'
                            sysmsg 'NO NEW TARGETS TO SCAN FOR POISON' warning_msg_color
                            break
                        endif

                        # if targets found, poison all of them
                        if insysmsg 'New target'
                            setvar! targserial lasttarget
                            getlabel targserial targlabel

                            if inlist scanned_poison_targets targserial
                                if verbose == 1
                                    sysmsg 'NO NEW POISON TARGETS. BREAKING SCAN LOOP' warning_msg_color
                                    sysmsg '{{targlabel}} ALREADY POISONED. RE-POISONING...' warning_msg_color
                                endif
                                break
                            endif

                            # if not in range to poison, lure (if set to lure)
                            if not find targserial ground any any offensive_spell_range
                                sysmsg '{{targlabel}} TOO FAR TO POISON!' alert_msg_color
                                overhead '!! TOO FAR TO POISON!! ' alert_msg_color targserial

                                if lure_mobs_closer_to_poison == 1
                                    sysmsg '>>> LURING MOB CLOSE TO POISON' default_sysmsg_color
                                    overhead '> LURING TO POISON <' warning_msg_color targserial

                                    attack targserial

                                    settimer waiting_mob_to_approach_timer 0
                                    while timer waiting_mob_to_approach_timer < 1500
                                        wait 10
                                        if find targserial ground any any attack_range
                                            sysmsg 'MOB IS NOW AT {{lure_mobs_distance_to_lure}} TILES' success_msg_color
                                            overhead '*in range to poison*' success_msg_color targserial

                                        endif
                                    endwhile

                                    # if even after waiting mob is still not closer, its probably out of sight and didnt respond to the attack
                                    if not find targserial ground any any offensive_spell_range
                                        if verbose == 1
                                            sysmsg '{{targlabel}} STILL NOT IN RANGE (OUT OF SIGHT?)' warning_msg_color
                                        endif

                                        overhead '?? OUT OF SIGHT ??' debug_msg_color targserial
                                        pushlist scanned_poison_targets targserial
                                        pushlist out_of_sight_mobs targserial

                                        setvar! reset_current_target 1
                                        continue
                                    endif


                                    hotkey 'Toggle Peace Only'
                                    settimer lure_mob_closer_timer 0
                                    say 'all guard me'
                                endif

                            endif

                            if reset_current_target == 1
                                sysmsg 'RESETING TARGET AFTER POISON SCAn' warning_msg_color
                            endif

                            if 'Deadly' in targlabel or 'Lethal' in targlabel
                                overhead '*already poisoned*' success_msg_color targlabel
                            else
                                pushlist scanned_poison_targets targserial

                                if verbose == 1
                                    sysmsg 'POISON TARGET: {{targlabel}}'
                                    if inlist poisoned_mobs targserial
                                        sysmsg '{{targlabel}} ALREADY POISONED. RE-POISONING...' warning_msg_color
                                        overhead '* RE-POISONING *' warning_msg_color targserial
                                    else
                                        overhead '* POISONING *' warning_msg_color targserial
                                    endif
                                endif


                                # pushlist poison_targets targserial
                                # settimer poison_timer poison_delay

                                clearsysmsg
                                cast 'poison'

                                settimer waiting_target_timer 0
                                # settimer scanning_poison_targets 0
                                while not targetexists 'harmful' and not insysmsg 'disturbed' and not insysmsg 'cannot cast a spell' and timer 'waiting_target_timer' < 3500

                                    if diffhits > max_diffhits_before_healing or poisoned or followers < followers_max_limit
                                        if debug == 1
                                            sysmsg 'replay waiting poison target (multiple targets)' debug_msg_color
                                        endif

                                        replay
                                    endif

                                    wait 10

                                    if insysmsg 'disturbed' or insysmsg 'cannot cast a spell'
                                        if verbose == 1
                                            sysmsg 'BREAKING WHILE WAITING FOR POISON TARGET' warning_msg_color
                                        endif

                                        wait spell_recovery_delay
                                        break
                                    endif
                                endwhile

                                if targetexists 'harmful'
                                    clearsysmsg
                                    target targserial
                                    wait spell_recovery_delay

                                    if insysmsg 'Target cannot be seen' or insysmsg 'out of sight' or insysmsg 'Thats too far away'
                                        if verbose == 1
                                            sysmsg 'CANT BE SEEN ON POISON. CONTiNUING TO NEXT TARGET' warning_msg_color
                                            overhead '!! MISSED POISON !!' warning_msg_color targserial
                                        endif
                                        setvar! reset_current_target 1
                                        setvar! missed_poison_target 1
                                        pushlist out_of_sight_mobs current_target_serial

                                        # if we missed a target, reset the poison_timer so we can enter the poison routine again
                                        settimer poison_timer 0
                                        cooldown 'POISON' poison_delay

                                        # NOTE: testing without this break cause it need to continue poisoning the other mobs found
                                        # break
                                    else
                                        if debug == 1
                                            sysmsg '+++ RESETING POISON TIMER' reset_timer_msg_color
                                        endif

                                        pushlist poisoned_mobs targserial
                                        @ignore targserial
                                        # overhead 'POISONED!' success_msg_color targserial

                                        setvar! last_poisoned_serial targserial
                                        settimer scanning_poison_targets 0
                                    endif
                                endif
                            endif
                        endif
                    endwhile

                    clearignore

                    if not varexist missed_poison_target
                        settimer poison_timer 0
                        cooldown 'POISON' poison_delay
                    endif

                    if verbose == 1
                        sysmsg 'RESETING LAST (SCANNED POISON TARGETS)' warning_msg_color
                        overhead 'RESETING LAST TO THIS MOB' warning_msg_color previous_target
                    endif

                    hotkey 'Clear Target Queue'
                    hotkey 'Set Last Target'
                    wft 600
                    target current_target_serial
                endif


                #-------------------------
                # POISON (SINGLE TARGET)

                if diffhits > max_diffhits_before_healing or poisoned or followers < followers_max_limit
                    if debug == 1
                        sysmsg 'replay poison (single target)' debug_msg_color
                    endif

                    replay
                endif

                if use_poison == 1 and multiple_poison_targets == 0 and timer poison_timer >= poison_delay

                    ########################################
                    # check for pks on screen
                    if auto_escape_pks_on_screen == 1 and recall_home_now != 1
                        if verbose == 1
                            sysmsg 'â–· searching for pks on screen'
                        endif
                        # hotkey 'clear target queue'
                        clearsysmsg
                        hotkey 'Next Murderer Player Target'
                        if insysmsg 'New target'
                            sysmsg '!!!!!!! FOUND PK! RUN!!!!!!!' alert_msg_color
                            setvar! recall_home_now 1
                            replay
                        endif
                    endif

                    if verbose == 11
                        sysmsg 'â—Ž POISON (SINGLE TARGET)' spell_msg_color
                        overhead '*POISONING*' 76 current_target_serial
                    endif

                    if 'Deadly' in targlabel or 'Lethal' in targlabel
                        overhead '* already poisoned *' success_msg_color current_target_serial
                    else
                        overhead '* poisoning *' success_msg_color targ
                        cast 'poison'

                        @settimer 'waiting_target_timer' 0
                        clearsysmsg
                        while not targetexists 'harmful' and not insysmsg 'disturbed' and not insysmsg 'cannot cast a spell' and timer 'waiting_target_timer' < 3500

                            if diffhits > max_diffhits_before_healing or poisoned or followers < followers_max_limit
                                if debug == 1
                                    sysmsg 'replay waiting poison target (single target)' debug_msg_color
                                endif

                                replay
                            endif

                            wait 10

                            if insysmsg 'disturbed' or insysmsg 'cannot cast a spell'
                                if verbose == 1
                                    sysmsg 'BREAKING WHILE WAITING FOR POISON TARGET' warning_msg_color
                                endif

                                wait spell_recovery_delay
                                break
                            endif
                        endwhile

                        wft spell_recovery_delay

                        if targetexists 'harmful'
                            clearsysmsg
                            target current_target_serial
                            wait spell_recovery_delay

                            if insysmsg 'Target cannot be seen' or insysmsg 'out of sight' or insysmsg 'Thats too far away'
                                if verbose == 1
                                    sysmsg 'CANT BE SEEN ON POISON. BREAKING ATK LOOP' warning_msg_color
                                endif
                                setvar! reset_current_target 1
                                setvar! current_target_out_of_sight 1
                                pushlist out_of_sight_mobs current_target_serial
                                # break
                                continue
                            else
                                if debug == 1
                                    sysmsg '+++ RESETING POISON TIMER' reset_timer_msg_color
                                endif

                                settimer poison_timer 0
                                pushlist poisoned_mobs current_target_serial
                                cooldown 'POISON' poison_delay

                                setvar! last_poisoned_serial current_target_serial
                            endif
                        else
                            if verbose == 1
                                sysmsg 'COULDNT OPEN POISON TARGET!' alert_msg_color
                            endif
                        endif
                    endif
                endif


                endif


                # CURSE

                if diffhits > max_diffhits_before_healing or poisoned or followers < followers_max_limit
                    if debug == 1
                        sysmsg 'replay before curse' debug_msg_color
                    endif

                    replay
                endif



                if use_curse == 1 and timer curse_timer >= curse_delay

                    ########################################
                    # check for pks on screen
                    if auto_escape_pks_on_screen == 1 and recall_home_now != 1
                        if verbose == 1
                            sysmsg 'â–· searching for pks on screen'
                        endif
                        # hotkey 'clear target queue'
                        clearsysmsg
                        hotkey 'Next Murderer Player Target'
                        if insysmsg 'New target'
                            sysmsg '!!!!!!! FOUND PK! RUN!!!!!!!' alert_msg_color
                            setvar! recall_home_now 1
                            replay
                        endif
                    endif

                    if not dead 'last' and find 'last' ground any any find_last_target_max_range
                        if current_target_serial == last_cursed_serial and timer curse_timer <= curse_delay
                            if verbose == 1
                                sysmsg '!!! THIS MOB WAS CURSED {{curse_timer}}ms AGO' warning_msg_color
                            endif
                        elseif current_target_serial != last_cursed_serial and timer curse_timer >= curse_delay
                            if verbose == 1
                                sysmsg 'â—Ž CURSE' spell_msg_color
                            endif
                            cast 'curse'

                            @settimer 'waiting_target_timer' 0
                            clearsysmsg
                            while not targetexists 'harmful' and not insysmsg 'disturbed' and not insysmsg 'cannot cast a spell' and timer 'waiting_target_timer' < 3500

                                if diffhits > max_diffhits_before_healing or poisoned or followers < followers_max_limit
                                    if debug == 1
                                        sysmsg 'replay waiting curse target' debug_msg_color
                                    endif

                                    replay
                                endif

                                wait 10

                                if insysmsg 'disturbed' or insysmsg 'cannot cast a spell'
                                    if verbose == 1
                                        sysmsg 'BREAKING WHILE WAITING FOR CURSE TARGET' warning_msg_color
                                    endif

                                    wait spell_recovery_delay
                                    break
                                endif
                            endwhile

                            wft spell_recovery_delay

                            if targetexists 'harmful'
                                clearsysmsg
                                target current_target_serial
                                wait spell_recovery_delay

                                if insysmsg 'Target cannot be seen' or insysmsg 'out of sight' or insysmsg 'Thats too far away'
                                    if verbose == 1
                                        sysmsg 'CANT BE SEEN ON CURSE. BREAKING ATK LOOP' warning_msg_color
                                    endif
                                    setvar! reset_current_target 1
                                    setvar! current_target_out_of_sight 1
                                    pushlist out_of_sight_mobs current_target_serial
                                    # break
                                    continue
                                else
                                    if verbose == 1
                                        sysmsg '+++ RESETING CURSE TIMER' reset_timer_msg_color
                                    endif

                                    settimer curse_timer 0
                                    cooldown CURSE curse_delay
                                    setvar! last_cursed_serial lasttarget
                                endif
                            endif
                        endif
                    endif
                endif


                # MASS CURSE

                if diffhits > max_diffhits_before_healing or poisoned or followers < followers_max_limit
                    replay
                endif


                if use_mass_curse == 1 and timer 'mass_curse_timer' >= curse_delay

                    ########################################
                    # check for pks on screen
                    if auto_escape_pks_on_screen == 1 and recall_home_now != 1
                        if verbose == 1
                            sysmsg 'â–· searching for pks on screen'
                        endif
                        # hotkey 'clear target queue'
                        clearsysmsg
                        hotkey 'Next Murderer Player Target'
                        if insysmsg 'New target'
                            sysmsg '!!!!!!! FOUND PK! RUN!!!!!!!' alert_msg_color
                            setvar! recall_home_now 1
                            replay
                        endif
                    endif

                    if not dead 'last' and find 'last' ground any any find_last_target_max_range

                        if current_target_serial == last_cursed_serial and timer 'mass_curse_timer' <= curse_delay
                            if verbose == 1
                                sysmsg '!!! THIS MOB WAS MASS CURSED {{curse_timer}}ms AGO' warning_msg_color
                            endif
                        elseif current_target_serial != last_cursed_serial and timer 'mass_curse_timer' >= curse_delay
                            if verbose == 1
                                sysmsg 'â—Ž MASS CURSE' spell_msg_color
                            endif
                            cast 'mass curse'

                            @settimer 'waiting_target_timer' 0
                            clearsysmsg
                            while not targetexists 'harmful' and not insysmsg 'disturbed' and not insysmsg 'cannot cast a spell' and timer 'waiting_target_timer' < 3500
                                wait 10

                                if insysmsg 'disturbed' or insysmsg 'cannot cast a spell'
                                    if verbose == 1
                                        sysmsg 'BREAKING WHILE WAITING FOR CURSE TARGET' warning_msg_color
                                    endif

                                    wait spell_recovery_delay
                                    break
                                endif
                            endwhile

                            if targetexists 'harmful'
                                clearsysmsg
                                target current_target_serial
                                wait spell_recovery_delay

                                if insysmsg 'Target cannot be seen' or insysmsg 'out of sight' or insysmsg 'Thats too far away'
                                    if verbose == 1
                                        sysmsg 'CANT BE SEEN ON MASS CURSE. BREAKING ATK LOOP' warning_msg_color
                                    endif

                                    setvar! current_target_out_of_sight 1
                                    setvar! reset_current_target 1
                                    pushlist out_of_sight_mobs current_target_serial
                                    # break
                                    continue
                                else
                                    if verbose == 1
                                        sysmsg '+++ RESETING MASS CURSE TIMER' reset_timer_msg_color
                                    endif

                                    settimer 'mass_curse_timer' 0
                                    cooldown CURSE mass_curse_delay
                                    setvar! last_cursed_serial lasttarget
                                endif
                            endif
                        endif
                    endif
                endif


                # CORPSE SKIN

                if is_necromancer == 1
                    if use_corpse_skin == 1
                        if timer corpse_skin_timer > 30000

                            ########################################
                            # check for pks on screen
                            if auto_escape_pks_on_screen == 1 and recall_home_now != 1
                                if verbose == 1
                                    sysmsg 'â–· searching for pks on screen'
                                endif
                                # hotkey 'clear target queue'
                                clearsysmsg
                                hotkey 'Next Murderer Player Target'
                                if insysmsg 'New target'
                                    sysmsg '!!!!!!! FOUND PK! RUN!!!!!!!' alert_msg_color
                                    setvar! recall_home_now 1
                                    replay
                                endif
                            endif

                            if verbose == 1
                                sysmsg 'â—Ž CORPSE SKIN' necro_spell_msg_color
                            endif

                            say '[corpseskin'
                            wait action_delay
                            if insysmsg 'symbols'
                                settimer corpse_skin_timer 0
                                cooldown 'CORPSE SKIN'
                            endif
                        endif
                    else
                        sysmsg 'CORPSE SKIN COOLDOWN...' spell_cooldown_msg_color
                    endif
                endif


                # ENERGY BOLT

                if diffhits > max_diffhits_before_healing or poisoned or followers < followers_max_limit
                    replay
                endif

                if not dead 'last' and find 'last' ground any any find_last_target_max_range
                    if use_eb == 1 and timer 'eb_timer' > eb_delay

                        ########################################
                        # check for pks on screen
                        if auto_escape_pks_on_screen == 1 and recall_home_now != 1
                            if verbose == 1
                                sysmsg 'â–· searching for pks on screen'
                            endif
                            # hotkey 'clear target queue'
                            clearsysmsg
                            hotkey 'Next Murderer Player Target'
                            if insysmsg 'New target'
                                sysmsg '!!!!!!! FOUND PK! RUN!!!!!!!' alert_msg_color
                                setvar! recall_home_now 1
                                replay
                            endif
                        endif


                        if verbose == 1
                            sysmsg '>>> ENERGY BOLT' spell_msg_color
                        endif
                        cast 'energy bolt' 40

                        @settimer 'waiting_target_timer' 0
                        while not targetexists 'harmful' and not insysmsg 'disturbed' and not insysmsg 'cannot cast a spell' and timer 'waiting_target_timer' < 4000
                            wft 10
                            if insysmsg 'disturbed' or insysmsg 'cannot cast a spell'
                                if verbose == 1
                                    sysmsg 'BREAKING WHILE WAITING FOR EB TARGET' warning_msg_color
                                endif

                                wait spell_recovery_delay
                                break
                            endif
                        endwhile

                        if targetexists 'harmful'
                            clearsysmsg
                            target current_target_serial
                            wait spell_recovery_delay

                            if insysmsg 'Target cannot be seen' or insysmsg 'out of sight' or insysmsg 'Thats too far away'
                                if debug == 1
                                    sysmsg 'CANT BE SEEN ON EB. BREAKING ATK LOOP'
                                endif
                                setvar! reset_current_target 1
                                setvar! current_target_out_of_sight 1
                                pushlist out_of_sight_mobs current_target_serial
                                # break
                                continue
                            else
                                if verbose == 1
                                    sysmsg '+++ RESETING ENERGY BOLT TIMER' reset_timer_msg_color
                                endif

                                settimer 'eb_timer' 0
                                cooldown 'ENERGY BOLT' eb_delay
                            endif
                        endif
                    endif
                endif


                # MAGIC ARROW

                if diffhits > max_diffhits_before_healing or poisoned or followers < followers_max_limit
                    replay
                endif

                if followers >= followers_max_limit and diffhits < max_diffhits_before_healing and not dead 'last' and find 'last' ground any any find_last_target_max_range
                    if use_ma == 1 and timer 'ma_timer' > ma_delay

                        ########################################
                        # check for pks on screen
                        if auto_escape_pks_on_screen == 1 and recall_home_now != 1
                            if verbose == 1
                                sysmsg 'â–· searching for pks on screen'
                            endif
                            # hotkey 'clear target queue'
                            clearsysmsg
                            hotkey 'Next Murderer Player Target'
                            if insysmsg 'New target'
                                sysmsg '!!!!!!! FOUND PK! RUN!!!!!!!' alert_msg_color
                                setvar! recall_home_now 1
                                replay
                            endif
                        endif


                        if verbose == 1
                            sysmsg 'â—Ž MAGIC ARROW' spell_msg_color
                        endif
                        cast 'magic arrow'

                        @settimer 'waiting_target_timer' 0
                        while not targetexists 'harmful' and not insysmsg 'disturbed' and not insysmsg 'cannot cast a spell' and timer 'waiting_target_timer' < 1500
                            wft 10
                            if insysmsg 'disturbed' or insysmsg 'cannot cast a spell'
                                if verbose == 1
                                    sysmsg 'BREAKING WHILE WAITING FOR MA TARGET' warning_msg_color
                                endif
                                wait spell_recovery_delay
                                break
                            endif
                        endwhile

                        if targetexists 'harmful'
                            clearsysmsg
                            target current_target_serial
                            wait spell_recovery_delay

                            if insysmsg 'Target cannot be seen' or insysmsg 'out of sight' or insysmsg 'Thats too far away'
                                if debug == 1
                                    sysmsg 'CANT BE SEEN ON MA. BREAKING ATK LOOP' debug_msg_color
                                endif

                                setvar! reset_current_target 1
                                setvar! current_target_out_of_sight 1
                                pushlist out_of_sight_mobs current_target_serial
                                # break
                                continue
                            else
                                settimer 'ma_timer' 0
                                cooldown 'MAGIC ARROW' ma_delay
                            endif
                        endif
                    endif
                endif


                # HARM

                if diffhits > max_diffhits_before_healing or poisoned or followers < followers_max_limit
                    replay
                endif

                if not dead 'last' and find 'last' ground any any find_last_target_max_range
                    if use_harm == 1 and timer 'harm_timer' > harm_delay

                        ########################################
                        # check for pks on screen
                        if auto_escape_pks_on_screen == 1 and recall_home_now != 1
                            if verbose == 1
                                sysmsg 'â–· searching for pks on screen'
                            endif
                            # hotkey 'clear target queue'
                            clearsysmsg
                            hotkey 'Next Murderer Player Target'
                            if insysmsg 'New target'
                                sysmsg '!!!!!!! FOUND PK! RUN!!!!!!!' alert_msg_color
                                setvar! recall_home_now 1
                                replay
                            endif
                        endif


                        if verbose == 1
                            sysmsg 'â—Ž HARM' spell_msg_color
                        endif
                        cast 'harm'

                        @settimer 'waiting_target_timer' 0
                        while not targetexists 'harmful' and not insysmsg 'disturbed' and not insysmsg 'cannot cast a spell' and timer 'waiting_target_timer' < 1500
                            wft 10
                            if insysmsg 'disturbed' or insysmsg 'cannot cast a spell'
                                if verbose == 1
                                    sysmsg 'BREAKING WHILE WAITING FOR HARM TARGET' warning_msg_color
                                endif
                                wait spell_recovery_delay
                                break
                            endif
                        endwhile

                        if targetexists 'harmful'
                            clearsysmsg
                            target current_target_serial
                            wait spell_recovery_delay

                            if insysmsg 'Target cannot be seen' or insysmsg 'out of sight' or insysmsg 'Thats too far away'
                                if debug == 1
                                    sysmsg 'CANT BE SEEN ON HARM. BREAKING ATK LOOP' debug_msg_color
                                endif
                                setvar! reset_current_target 1
                                setvar! current_target_out_of_sight 1
                                pushlist out_of_sight_mobs current_target_serial
                                # break
                                continue
                            else
                                settimer 'harm_timer' 0
                                cooldown HARM harm_delay
                            endif
                        endif
                    endif
                endif

                ########################################
                # KEEP HEALING PETS
                ########################################

                if diffhits > max_diffhits_before_healing or poisoned or followers < followers_max_limit
                    replay
                endif

                if is_veterinarian == 1 and auto_heal_pets == 1 and not targetexists 'any'

                    # NOTE: verificar se da pra trocar por if not bandaging aqui
                    if not cooldown Bandage

                        ########################################
                        # check for pks on screen
                        if auto_escape_pks_on_screen == 1 and recall_home_now != 1
                            if verbose == 1
                                sysmsg 'â–· searching for pks on screen'
                            endif
                            # hotkey 'clear target queue'
                            clearsysmsg
                            hotkey 'Next Murderer Player Target'
                            if insysmsg 'New target'
                                sysmsg '!!!!!!! FOUND PK! RUN!!!!!!!' alert_msg_color
                                setvar! recall_home_now 1
                                replay
                            endif
                        endif


                        if findtype 'veterinary supplies' as vet_supplies
                            settimer 'heal_pets_timer' 0
                            useobject vet_supplies
                            if verbose == 1
                                sysmsg ">>> USING VET SUPPLIES ON PET" 76
                                overhead '*vetting*' 76 pet
                                overhead '*vetting player pet*' 77 'self'
                            endif
                        # elseif findtype 'clean bandage%s%' as bands
                        #     useobject bands
                        #     wft 1000
                        #     if targetexists 'beneficial'
                        #         overhead '*bandaging...*' 55 pet
                        #         sysmsg ">>> BANDAGING PET" 55
                        #         target pet
                        #     endif
                        endif
                    endif
                endif


                # FIREBALL

                if diffhits > max_diffhits_before_healing or poisoned or followers < followers_max_limit
                    replay
                endif

                if followers >= followers_max_limit and diffhits < max_diffhits_before_healing and not dead 'last' and find 'last' ground any any find_last_target_max_range
                    if use_fireball == 1 and timer 'fireball_timer' > fireball_delay

                        ########################################
                        # check for pks on screen
                        if auto_escape_pks_on_screen == 1 and recall_home_now != 1
                            if verbose == 1
                                sysmsg 'â–· searching for pks on screen'
                            endif
                            # hotkey 'clear target queue'
                            clearsysmsg
                            hotkey 'Next Murderer Player Target'
                            if insysmsg 'New target'
                                sysmsg '!!!!!!! FOUND PK! RUN!!!!!!!' alert_msg_color
                                setvar! recall_home_now 1
                                replay
                            endif
                        endif


                        if verbose == 1
                            sysmsg 'â—Ž FIREBALL' spell_msg_color
                        endif

                        cast 'fireball'

                        @settimer 'waiting_target_timer' 0
                        while not targetexists 'harmful' and not insysmsg 'disturbed' and not insysmsg 'cannot cast a spell' and timer 'waiting_target_timer' < 1500
                            wft 10
                            if insysmsg 'disturbed' or insysmsg 'cannot cast a spell'
                                if verbose == 1
                                    sysmsg 'BREAKING WHILE WAITING FOR FIREBALl TARGET' warning_msg_color
                                endif

                                wait spell_recovery_delay
                                break
                            endif
                        endwhile

                        if targetexists 'harmful'
                            clearsysmsg
                            target current_target_serial
                            wait spell_recovery_delay

                            if insysmsg 'Target cannot be seen' or insysmsg 'out of sight' or insysmsg 'Thats too far away'
                                if debug == 1
                                    sysmsg 'CANT BE SEEN ON FIREBALL. BREAKING ATK LOOP' debug_msg_color
                                endif
                                setvar! reset_current_target 1
                                setvar! current_target_out_of_sight 1
                                pushlist out_of_sight_mobs current_target_serial
                                # break
                                continue
                            else
                                settimer 'fireball_timer' 0
                                cooldown FIREBALL fireball_delay
                            endif
                        endif
                    endif
                endif


                # # LURE MOBS CLOSER (duplicate snippet from above)
                # if diffhits > max_diffhits_before_healing or poisoned or followers < followers_max_limit
                #     replay
                # endif

                # if lure_mobs_closer_before_killing == 1 and timer lure_mob_closer_timer > 4000
                #     if not find 'last' ground any any lure_mobs_distance_to_lure
                #         if verbose == 1
                #             sysmsg '>>> LURING MOB CLOSE TO CHAR' default_sysmsg_color
                #         endif
                #         # say 'all kill'
                #         # wft 600
                #         # target 'last'
                #         # this wait is just to avoid speech throttle from the server
                #         wait 250

                #         say 'all follow me'


                #         settimer waiting_mob_to_approach_timer 0
                #         while timer waiting_mob_to_approach_timer < 1500
                #             wait 10
                #             if find 'last' ground any any lure_mobs_distance_to_lure
                #                 sysmsg 'MOB IS NOW AT {{lure_mobs_distance_to_lure}} TILES' success_msg_color
                #                 break
                #             endif
                #         endwhile


                #         hotkey 'Toggle Peace Only'
                #         settimer lure_mob_closer_timer 0
                #         say 'all guard me'
                #     else
                #         if verbose == 1
                #             sysmsg '>>> MOB IS CLOSE, NO NEED TO LURE' warning_msg_color
                #         endif
                #     endif
                # endif

                # LIGHTNING

                if diffhits > max_diffhits_before_healing or poisoned or followers < followers_max_limit
                    replay
                endif

                if not find 'last' ground any any find_last_target_max_range
                    sysmsg 'LAST GONE. REGETTING AND CONTINUE...'
                    hotkey 'Target Closest Non-Friendly Monster'
                    continue
                endif

                if use_lightning == 1
                    if timer 'lightning_timer' > lightning_delay

                        ########################################
                        # check for pks on screen
                        if auto_escape_pks_on_screen == 1 and recall_home_now != 1
                            if verbose == 1
                                sysmsg 'â–· searching for pks on screen'
                            endif
                            # hotkey 'clear target queue'
                            clearsysmsg
                            hotkey 'Next Murderer Player Target'
                            if insysmsg 'New target'
                                sysmsg '!!!!!!! FOUND PK! RUN!!!!!!!' alert_msg_color
                                setvar! recall_home_now 1
                                replay
                            endif
                        endif


                        if verbose == 1
                            sysmsg 'â—Ž LIGHTNING' spell_msg_color
                        endif
                        cast 'lightning'

                        @settimer 'waiting_target_timer' 0
                        while not targetexists 'harmful' and not insysmsg 'disturbed' and not insysmsg 'cannot cast a spell' and timer 'waiting_target_timer' < 2500
                            wft 10
                            if insysmsg 'disturbed' or insysmsg 'cannot cast a spell'
                                if verbose == 1
                                    sysmsg 'BREAKING WHILE WAITING FOR LIGHTNING TARGET' warning_msg_color
                                endif

                                wait spell_recovery_delay
                                break
                            endif
                        endwhile

                        if targetexists 'harmful'
                            clearsysmsg
                            target current_target_serial
                            wait spell_recovery_delay

                            if insysmsg 'Target cannot be seen' or insysmsg 'out of sight' or insysmsg 'Thats too far away'
                                if debug == 1
                                    sysmsg 'CANT BE SEEN ON LIGHTNING. BREAKING ATK LOOP' debug_msg_color
                                endif
                                setvar! reset_current_target 1
                                setvar! current_target_out_of_sight 1
                                pushlist out_of_sight_mobs current_target_serial
                                # break
                                continue
                            else
                                settimer 'lightning_timer' 0
                                cooldown LIGHTNING lightning_delay
                            endif
                        endif
                    else
                        if verbose == 1
                            sysmsg 'LIGHTNING NOT READY! TIMER: {{lightning_timer}}' warning_msg_color
                        endif
                    endif
                endif


                # MIND BLAST

                if diffhits > max_diffhits_before_healing or poisoned or followers < followers_max_limit
                    replay
                endif

                if not find 'last' ground any any find_last_target_max_range
                    sysmsg 'LAST GONE. REGETTING AND CONTINUE...'
                    hotkey 'Target Closest Non-Friendly Monster'
                    # continue
                    break
                endif


                if use_mind_blast == 1

                    ########################################
                    # check for pks on screen
                    if auto_escape_pks_on_screen == 1 and recall_home_now != 1
                        if verbose == 1
                            sysmsg 'â–· searching for pks on screen'
                        endif
                        # hotkey 'clear target queue'
                        clearsysmsg
                        hotkey 'Next Murderer Player Target'
                        if insysmsg 'New target'
                            sysmsg '!!!!!!! FOUND PK! RUN!!!!!!!' alert_msg_color
                            setvar! recall_home_now 1
                            replay
                        endif
                    endif


                    if verbose == 1
                        sysmsg 'â—Ž MIND BLAST' spell_msg_color
                    endif
                    cast 'mind blast'

                    @settimer 'waiting_target_timer' 0
                    while not targetexists 'harmful' and not insysmsg 'disturbed' and not insysmsg 'cannot cast a spell' and timer 'waiting_target_timer' < 4500
                        wft 10
                        if insysmsg 'disturbed' or insysmsg 'cannot cast a spell'
                            if verbose == 1
                                sysmsg 'BREAKING WHILE WAITING FOR MIND BLAST TARGET' warning_msg_color
                            endif

                            wait spell_recovery_delay
                            break
                        endif
                    endwhile

                    if targetexists 'harmful'
                        clearsysmsg
                        target current_target_serial
                        wait spell_recovery_delay

                        if insysmsg 'Target cannot be seen' or insysmsg 'out of sight' or insysmsg 'Thats too far away'
                            if debug == 1
                                sysmsg 'CANT BE SEEN ON MB. BREAKING ATK LOOP' debug_msg_color
                            endif
                            setvar! reset_current_target 1
                            setvar! current_target_out_of_sight 1
                            pushlist out_of_sight_mobs current_target_serial
                            continue
                            # break
                        endif
                    endif
                endif

                ########################################
                # KEEP HEALING PETS
                ########################################

                if diffhits > max_diffhits_before_healing or poisoned or followers < followers_max_limit
                    replay
                endif

                if is_veterinarian == 1 and auto_heal_pets == 1 and not targetexists 'any'
                    if not cooldown Bandage

                        ########################################
                        # check for pks on screen
                        if auto_escape_pks_on_screen == 1 and recall_home_now != 1
                            if verbose == 1
                                sysmsg 'â–· searching for pks on screen'
                            endif
                            # hotkey 'clear target queue'
                            clearsysmsg
                            hotkey 'Next Murderer Player Target'
                            if insysmsg 'New target'
                                sysmsg '!!!!!!! FOUND PK! RUN!!!!!!!' alert_msg_color
                                setvar! recall_home_now 1
                                replay
                            endif
                        endif


                        if findtype 'veterinary supplies' as vet_supplies
                            settimer 'heal_pets_timer' 0
                            useobject vet_supplies
                            sysmsg ">>> USING VET SUPPLIES ON PET" 76
                            overhead '*vetting*' 76 pet
                            overhead '*vetting player pet*' 77 'self'
                        # elseif findtype 'clean bandage%s%' as bands
                        #     useobject bands
                        #     wft 1000
                        #     if targetexists 'beneficial'
                        #         overhead '*bandaging...*' 55 pet
                        #         sysmsg ">>> BANDAGING PET" 55
                        #         target pet
                        #     endif
                        endif
                    endif
                endif




                # FLAMESTRIKE

                if debug == 1
                    sysmsg 'BEFORE FLAMESTRIKE at {{execution_timer}}' success_msg_color
                endif

                if diffhits > max_diffhits_before_healing or poisoned or followers < followers_max_limit
                    if debug == 1
                        sysmsg 'replaying before flamestrike' debug_msg_color
                    endif
                    replay
                endif

                if dead 'last' and not find 'last' ground any any find_last_target_max_range
                    sysmsg 'LAST GONE. REGETTING AND CONTINUE...'
                    setvar! reset_current_target 1
                    continue
                endif

                if use_flamestrike == 1

                    ########################################
                    # check for pks on screen
                    if auto_escape_pks_on_screen == 1 and recall_home_now != 1
                        if verbose == 1
                            sysmsg 'â–· searching for pks on screen'
                        endif
                        # hotkey 'clear target queue'
                        clearsysmsg
                        hotkey 'Next Murderer Player Target'
                        if insysmsg 'New target'
                            sysmsg '!!!!!!! FOUND PK! RUN!!!!!!!' alert_msg_color
                            setvar! recall_home_now 1
                            replay
                        endif
                    endif


                    if verbose == 1
                        sysmsg 'â—Ž FLAMESTRIKE' spell_msg_color
                    endif

                    clearsysmsg
                    cast 'flamestrike'

                    @settimer 'waiting_target_timer' 0
                    while not targetexists 'harmful' and not insysmsg 'disturbed' and not insysmsg 'cannot cast a spell' and timer 'waiting_target_timer' < 4500

                        if diffhits > max_diffhits_before_healing or poisoned or followers < followers_max_limit
                            replay
                        endif

                        wft 10
                        if insysmsg 'disturbed' or insysmsg 'cannot cast a spell'
                            if verbose == 1
                                sysmsg 'BREAKING WHILE WAITING FOR FLAMESTRIKE TARGET' warning_msg_color
                            endif

                            wait spell_recovery_delay
                            break
                        endif
                    endwhile

                    if targetexists 'harmful'
                        clearsysmsg
                        target current_target_serial
                        wait spell_recovery_delay

                        if insysmsg 'Target cannot be seen' or insysmsg 'out of sight' or insysmsg 'Thats too far away'
                            if debug == 1
                                sysmsg 'CANT BE SEEN ON FS. BREAKING ATK LOOP' debug_msg_color
                            endif
                            setvar! reset_current_target 1
                            setvar! current_target_out_of_sight 1
                            pushlist out_of_sight_mobs current_target_serial
                            # break
                            continue
                        endif
                    endif
                endif


                # CHAIN LIGHTNING

                if diffhits > max_diffhits_before_healing or poisoned or followers < followers_max_limit
                    replay
                endif

                if not dead 'last' and find 'last' ground any any find_last_target_max_range
                    if use_chain_lightning == 1
                        if timer 'chain_lightning_timer' > chain_lightning_delay

                            ########################################
                            # check for pks on screen
                            if auto_escape_pks_on_screen == 1 and recall_home_now != 1
                                if verbose == 1
                                    sysmsg 'â–· searching for pks on screen'
                                endif
                                # hotkey 'clear target queue'
                                clearsysmsg
                                hotkey 'Next Murderer Player Target'
                                if insysmsg 'New target'
                                    sysmsg '!!!!!!! FOUND PK! RUN!!!!!!!' alert_msg_color
                                    setvar! recall_home_now 1
                                    replay
                                endif
                            endif


                            if verbose == 1
                                sysmsg 'â—Ž CHAIN LIGHTNING' spell_msg_color
                            endif
                            cast 'chain lightning'

                            @settimer 'waiting_target_timer' 0
                            while not targetexists 'harmful' and not insysmsg 'disturbed' and not insysmsg 'cannot cast a spell' and timer 'waiting_target_timer' < 2500

                                if diffhits > max_diffhits_before_healing or poisoned or followers < followers_max_limit
                                    replay
                                endif

                                wft 10
                                if insysmsg 'disturbed' or insysmsg 'cannot cast a spell'
                                    if verbose == 1
                                        sysmsg 'BREAKING WHILE WAITING FOR CHAIN LIGHTNING TARGET' warning_msg_color
                                    endif

                                    wait spell_recovery_delay
                                    break
                                endif
                            endwhile

                            if targetexists 'harmful'
                                clearsysmsg
                                target current_target_serial
                                wait spell_recovery_delay

                                if insysmsg 'Target cannot be seen' or insysmsg 'out of sight' or insysmsg 'Thats too far away'
                                    if debug == 1
                                        sysmsg 'CANT BE SEEN ON CHAIN LIGHTNING. BREAKING ATK LOOP'
                                    endif
                                    setvar! reset_current_target 1
                                    setvar! current_target_out_of_sight 1
                                    pushlist out_of_sight_mobs current_target_serial
                                    continue
                                else
                                    if verbose == 1
                                        sysmsg '+++ RESETING CHAIN LIGHTNING TIMER' reset_timer_msg_color
                                    endif

                                    settimer 'chain_lightning_timer' 0
                                    cooldown 'CHAIN LIGHTNING' chain_lightning_delay
                                endif
                            endif

                        else
                            if verbose == 1
                                sysmsg 'CHAIN LIGHTNING NOT READY! TIMER: {{lightning_timer}}' warning_msg_color
                            endif
                        endif
                    endif
                endif


                # METEOR SWARM

                if diffhits > max_diffhits_before_healing or poisoned or followers < followers_max_limit
                    replay
                endif

                if not dead 'last' and find 'last' ground any any find_last_target_max_range
                    if use_meteor_swarm == 1 and timer 'meteor_swarm_timer' > meteor_swarm_delay

                        ########################################
                        # check for pks on screen
                        if auto_escape_pks_on_screen == 1 and recall_home_now != 1
                            if verbose == 1
                                sysmsg 'â–· searching for pks on screen'
                            endif
                            # hotkey 'clear target queue'
                            clearsysmsg
                            hotkey 'Next Murderer Player Target'
                            if insysmsg 'New target'
                                sysmsg '!!!!!!! FOUND PK! RUN!!!!!!!' alert_msg_color
                                setvar! recall_home_now 1
                                replay
                            endif
                        endif


                        if verbose == 1
                            sysmsg 'â—Ž METEOR SWARM ' spell_msg_color
                        endif
                        cast 'meteor swarm'

                        @settimer 'waiting_target_timer' 0
                        while not targetexists 'harmful' and not insysmsg 'disturbed' and not insysmsg 'cannot cast a spell' and timer 'waiting_target_timer' < 2500

                            if diffhits > max_diffhits_before_healing or poisoned or followers < followers_max_limit
                                replay
                            endif

                            wft 10
                            if insysmsg 'disturbed' or insysmsg 'cannot cast a spell'
                                if verbose == 1
                                    sysmsg 'BREAKING WHILE WAITING FOR METEOR SWARM TARGET' warning_msg_color
                                endif

                                wait spell_recovery_delay
                                break
                            endif
                        endwhile

                        if targetexists 'harmful'
                            target current_target_serial
                            wait spell_recovery_delay

                            if insysmsg 'Target cannot be seen' or insysmsg 'out of sight' or insysmsg 'Thats too far away'
                                if debug == 1
                                    sysmsg 'CANT BE SEEN ON METEOR SWARM. BREAKING ATK LOOP' debug_msg_color
                                endif

                                setvar! reset_current_target 1
                                setvar! current_target_out_of_sight 1
                                continue
                            else
                                if verbose == 1
                                    sysmsg '+++ RESETING METEOR SWARM TIMER' reset_timer_msg_color
                                endif

                                settimer 'meteor_swarm_timer' 0
                                cooldown 'METEOR SWARM' meteor_swarm_delay
                            endif
                        endif
                    endif
                endif


                # ###############################
                # # EARTHQUAKE
                # ###############################


                if diffhits > max_diffhits_before_healing or poisoned or followers < followers_max_limit
                    replay
                endif

                if use_earthquake == 1 and timer earthquake_timer > earthquake_delay

                    ########################################
                    # check for pks on screen
                    if auto_escape_pks_on_screen == 1 and recall_home_now != 1
                        if verbose == 1
                            sysmsg 'â–· searching for pks on screen'
                        endif
                        # hotkey 'clear target queue'
                        clearsysmsg
                        hotkey 'Next Murderer Player Target'
                        if insysmsg 'New target'
                            sysmsg '!!!!!!! FOUND PK! RUN!!!!!!!' alert_msg_color
                            setvar! recall_home_now 1
                            replay
                        endif
                    endif


                    if verbose == 1
                        sysmsg 'â—Ž EARTHQUAKE' spell_msg_color
                    endif
                    cast 'earthquake'

                    @settimer 'waiting_target_timer' 0
                    while not insysmsg 'disturbed' and not insysmsg 'cannot cast a spell' and timer 'waiting_target_timer' < 5000

                        if diffhits > max_diffhits_before_healing or poisoned or followers < followers_max_limit
                            replay
                        endif

                        wft 10
                        if insysmsg 'disturbed' or insysmsg 'cannot cast a spell'
                            if verbose == 1
                                sysmsg 'BREAKING WHILE WAITING FOR EARTHQUAKE' warning_msg_color
                            endif

                            wait spell_recovery_delay
                            break
                        endif
                    endwhile

                endif


                # ###############################
                # # POISON STRIKE
                # ###############################

                if diffhits > max_diffhits_before_healing or poisoned or followers < followers_max_limit
                    if debug == 1
                        sysmsg 'replay before poison strike' debug_msg_color
                    endif
                    replay
                endif

                if use_poison_strike == 1
                    if is_necromancer == 1
                        if timer poison_strike_timer >= 30000

                            ########################################
                            # check for pks on screen
                            if auto_escape_pks_on_screen == 1 and recall_home_now != 1
                                if verbose == 1
                                    sysmsg 'â–· searching for pks on screen'
                                endif
                                # hotkey 'clear target queue'
                                clearsysmsg
                                hotkey 'Next Murderer Player Target'
                                if insysmsg 'New target'
                                    sysmsg '!!!!!!! FOUND PK! RUN!!!!!!!' alert_msg_color
                                    setvar! recall_home_now 1
                                    replay
                                endif
                            endif

                            if debug == 1
                                sysmsg 'SCANNING POISON STRIKE TARG {{targ_label}} at {{execution_timer}}' debug_msg_color
                                # overhead '*SCANNING POISON STRIKE*' warning_msg_color current_target_serial
                            endif

                            # if not cooldown 'POISON STRIKE'
                            unsetvar! lethal_poison_ticks
                            unsetvar! deadly_poison_ticks
                            unsetvar! poison_strike_target
                            setvar! poison_strike_now 0

                            if multiple_poison_targets == 0

                                getlabel current_target_serial targ_label
                                if '10 Lethal' in targ_label
                                    setvar! lethal_poison_ticks 10
                                    overhead '*10 LETHAL TICKS*' warning_msg_color current_target_serial
                                elseif '9 Lethal' in targ_label
                                    setvar! lethal_poison_ticks 9
                                    overhead '*9 LETHAL TICKS*' warning_msg_color current_target_serial
                                elseif '8 Lethal' in targ_label
                                    setvar! lethal_poison_ticks 8
                                    overhead '*8 LETHAL TICKS*' warning_msg_color current_target_serial
                                elseif '7 Lethal' in targ_label
                                    setvar! lethal_poison_ticks 7
                                    overhead '*7 LETHAL TICKS*' warning_msg_color current_target_serial
                                elseif '6 Lethal' in targ_label
                                    setvar! lethal_poison_ticks 6
                                    overhead '*6 LETHAL TICKS*' warning_msg_color current_target_serial
                                elseif '5 Lethal' in targ_label
                                    setvar! lethal_poison_ticks 5
                                    overhead '*5 LETHAL TICKS*' warning_msg_color current_target_serial
                                elseif '4 Lethal' in targ_label
                                    setvar! lethal_poison_ticks 4
                                    overhead '*4 LETHAL TICKS*' warning_msg_color current_target_serial
                                elseif '3 Lethal' in targ_label
                                    setvar! lethal_poison_ticks 3
                                    overhead '*3 LETHAL TICKS*' warning_msg_color current_target_serial
                                elseif '2 Lethal' in targ_label
                                    setvar! lethal_poison_ticks 2
                                    overhead '*2 LETHAL TICKS*' warning_msg_color current_target_serial
                                elseif '1 Lethal' in targ_label
                                    setvar! lethal_poison_ticks 1
                                    overhead '*1 LETHAL TICKS*' warning_msg_color current_target_serial

                                # DEADLY TICKS
                                elseif '10 Deadly' in targ_label
                                    overhead '*10 DEADLY TICKS*' warning_msg_color current_target_serial
                                    setvar! lethal_poison_ticks 10
                                elseif '9 Deadly' in targ_label
                                    overhead '*9 DEADLY TICKS*' warning_msg_color current_target_serial
                                    setvar! deadly_poison_ticks 9
                                elseif '8 Deadly' in targ_label
                                    overhead '*8 DEADLY TICKS*' warning_msg_color current_target_serial
                                    setvar! deadly_poison_ticks 8
                                elseif '7 Deadly' in targ_label
                                    overhead '*7 DEADLY TICKS*' warning_msg_color current_target_serial
                                    setvar! deadly_poison_ticks 7
                                elseif '6 Deadly' in targ_label
                                    overhead '*6 DEADLY TICKS*' warning_msg_color current_target_serial
                                    setvar! deadly_poison_ticks 6
                                elseif '5 Deadly' in targ_label
                                    overhead '*5 DEADLY TICKS*' warning_msg_color current_target_serial
                                    setvar! deadly_poison_ticks 5
                                elseif '4 Deadly' in targ_label
                                    overhead '*4 DEADLY TICKS*' warning_msg_color current_target_serial
                                    setvar! deadly_poison_ticks 4
                                elseif '3 Deadly' in targ_label
                                    overhead '*3 DEADLY TICKS*' warning_msg_color current_target_serial
                                    setvar! deadly_poison_ticks 3
                                elseif '2 Deadly' in targ_label
                                    overhead '*2 DEADLY TICKS*' warning_msg_color current_target_serial
                                    setvar! deadly_poison_ticks 2
                                elseif '1 Deadly' in targ_label
                                    overhead '*1 DEADLY TICKS*' warning_msg_color current_target_serial
                                    setvar! deadly_poison_ticks 1
                                endif


                                if lethal_poison_ticks <= 4 or deadly_poison_ticks <= 4
                                    setvar! poison_strike_target current_target_serial
                                    setvar! poison_strike_now 1
                                    if debug == 1
                                        sysmsg 'BREAKING POISON STRIKE DEADLY' debug_msg_color
                                    endif
                                endif


                            elseif multiple_poison_targets == 1
                                # while not dead self

                                #     if diffhits > max_diffhits_before_healing or poisoned or followers < followers_max_limit
                                #         replay
                                #     endif

                                #     hotkey "Next Non-Friendly Monster Target"
                                #     if insysmsg 'New target'
                                #         setvar! targserial lasttarget
                                #         if not inlist poison_targets targserial
                                #             sysmsg 'PUSHING {{targserial}} TO LIST'
                                #             pushlist poison_targets targserial
                                #         else
                                #             sysmsg 'TARGET {{targserial}} ALREADY ON LIST. ASSUMING NO NEW TARGETS' 54
                                #             break
                                #         endif
                                #     endif
                                # endwhile

                                # hotkey 'Clear Target Queue'
                                # hotkey 'Toggle Peace Only'


                                if debug == 1
                                    sysmsg 'BEFORE SCANNING P STRIKE TARGS AT {{execution_timer}}' debug_msg_color
                                endif

                                foreach targ in poisoned_mobs

                                    if dead targ
                                        if debug == 1
                                            # sysmsg 'DEATH TARGET AT POISON STRIKE LOOP' debug_msg_color
                                            # poplist poisoned_mobs 'front'
                                            # break
                                        endif

                                        poplist poisoned_mobs 'front'
                                        # poplist poisoned_mobs targ
                                        if list poisoned_mobs == 0
                                            if debug == 1
                                                sysmsg 'LIST EMPYT AFTER POPLIST P-STRIKE'
                                            endif

                                            break
                                        endif
                                        continue
                                    endif

                                    if not dead targ and find targ ground any any attack_range
                                        getlabel targ targ_label

                                        if debug == 1
                                            sysmsg 'SCANNING POISON STRIKE TARG {{targ_label}}' debug_msg_color
                                            overhead '*SCANNING POISON STRIKE*' warning_msg_color targ
                                        endif

                                        if diffhits > max_diffhits_before_healing or poisoned or followers < followers_max_limit
                                            if debug == 1
                                                rysmsg 'replay while iterating poison targets' debug_msg_color
                                            endif
                                            replay
                                        endif

                                        if '10 Lethal' in targ_label
                                            setvar! lethal_poison_ticks 10
                                            overhead '*10 lethal ticks*' warning_msg_color targ
                                        elseif '9 Lethal' in targ_label
                                            setvar! lethal_poison_ticks 9
                                            overhead '*9 lethal ticks*' warning_msg_color targ
                                        elseif '8 Lethal' in targ_label
                                            setvar! lethal_poison_ticks 8
                                            overhead '*8 lethal ticks*' warning_msg_color targ
                                        elseif '7 Lethal' in targ_label
                                            setvar! lethal_poison_ticks 7
                                            overhead '*7 lethal ticks*' warning_msg_color targ
                                        elseif '6 Lethal' in targ_label
                                            setvar! lethal_poison_ticks 6
                                            overhead '*6 lethal ticks*' warning_msg_color targ
                                        elseif '5 Lethal' in targ_label
                                            setvar! lethal_poison_ticks 5
                                            overhead '*5 lethal ticks*' warning_msg_color targ
                                        elseif '4 Lethal' in targ_label
                                            setvar! lethal_poison_ticks 4
                                            overhead '*4 lethal ticks*' warning_msg_color targ
                                        elseif '3 Lethal' in targ_label
                                            setvar! lethal_poison_ticks 3
                                            overhead '*3 lethal ticks*' warning_msg_color targ
                                        elseif '2 Lethal' in targ_label
                                            setvar! lethal_poison_ticks 2
                                            overhead '*2 lethal ticks*' warning_msg_color targ
                                        elseif '1 Lethal' in targ_label
                                            setvar! lethal_poison_ticks 1
                                            overhead '*1 lethal ticks*' warning_msg_color targ

                                        # DEADLY TICKS
                                        elseif '10 Deadly' in targ_label
                                            overhead '*10 deadly ticks*' warning_msg_color targ
                                            setvar! lethal_poison_ticks 10
                                        elseif '9 Deadly' in targ_label
                                            overhead '*9 deadly ticks*' warning_msg_color targ
                                            setvar! deadly_poison_ticks 9
                                        elseif '8 Deadly' in targ_label
                                            overhead '*8 deadly ticks*' warning_msg_color targ
                                            setvar! deadly_poison_ticks 8
                                        elseif '7 Deadly' in targ_label
                                            overhead '*7 deadly ticks*' warning_msg_color targ
                                            setvar! deadly_poison_ticks 7
                                        elseif '6 Deadly' in targ_label
                                            overhead '*6 deadly ticks*' warning_msg_color targ
                                            setvar! deadly_poison_ticks 6
                                        elseif '5 Deadly' in targ_label
                                            overhead '*5 deadly ticks*' warning_msg_color targ
                                            setvar! deadly_poison_ticks 5
                                        elseif '4 Deadly' in targ_label
                                            overhead '*4 deadly ticks*' warning_msg_color targ
                                            setvar! deadly_poison_ticks 4
                                        elseif '3 Deadly' in targ_label
                                            overhead '*3 deadly ticks*' warning_msg_color targ
                                            setvar! deadly_poison_ticks 3
                                        elseif '2 Deadly' in targ_label
                                            overhead '*2 deadly ticks*' warning_msg_color targ
                                            setvar! deadly_poison_ticks 2
                                        elseif '1 Deadly' in targ_label
                                            overhead '*1 deadly ticks*' warning_msg_color targ
                                            setvar! deadly_poison_ticks 1
                                        endif

                                        # ATTEMPT TO FIX BUG WHERE THIS FOR WOULD LOOP INDEFINETELY, NOT SURE WHY
                                        poplist poisoned_mobs targ

                                        if lethal_poison_ticks <= min_poison_ticks_before_poison_striking or deadly_poison_ticks <= min_poison_ticks_before_poison_striking
                                            setvar! poison_strike_target targ
                                            setvar! poison_strike_now 1
                                            setvar! ticks lethal_poison_ticks
                                            if debug == 1
                                                sysmsg 'BREAKING POISON STRIKE DEADLY' debug_msg_color
                                            endif
                                        endif
                                    endif
                                endfor
                            endif


                            if poison_strike_now == 1
                                getlabel poison_strike_target targlabel

                                if verbose == 1
                                    if varexist deadly_poison_ticks
                                        setvar! ticks deadly_poison_ticks
                                    elseif varexist lethal_poison_ticks
                                        setvar! ticks lethal_poison_ticks
                                    endif

                                    sysmsg 'â—Ž POISON STRIKE {{targlabel}} ({{ticks}} TICKS REMAiNING)' necro_spell_msg_color
                                endif

                                say '[poisonstrike'
                                wft action_delay

                                if targetexists 'neutral'

                                    clearsysmsg
                                    target poison_strike_target
                                    wait action_delay
                                    if insysmsg 'Unholy symbols remaining'
                                        if verbose == 1
                                            sysmsg '>>> POISON STRIKED MOB!' success_msg_color
                                        endif

                                        if use_script_overhead_messages == 1
                                            overhead '*poison striked ({{ticks}} ticks)*' success_msg_color poison_strike_target
                                        endif

                                        settimer poison_strike_timer 0
                                        # also reset poison timer if poison strike succeede since all ticks are consumed
                                        settimer poison_timer 0
                                        cooldown 'POISON STRIKE' 30000
                                    endif
                                endif
                                wait action_delay
                            endif
                        else
                            if verbose == 1
                                sysmsg 'POISON Strike cooldown...' spell_cooldown_msg_color
                            endif
                        endif
                    endif
                endif


                # ###############################
                # # PAIN SPIKE
                # ###############################

                if diffhits > max_diffhits_before_healing or poisoned or followers < followers_max_limit
                    if debug == 1
                        sysmsg 'replay before pain spike' debug_msg_color
                    endif

                    replay
                endif

                if use_pain_spike == 1
                    if is_necromancer == 1 and findtype 'corpse' ground any any 30

                        if timer painspike_timer >= 30000

                            ########################################
                            # check for pks on screen
                            if auto_escape_pks_on_screen == 1 and recall_home_now != 1
                                if verbose == 1
                                    sysmsg 'â–· searching for pks on screen'
                                endif
                                # hotkey 'clear target queue'
                                clearsysmsg
                                hotkey 'Next Murderer Player Target'
                                if insysmsg 'New target'
                                    sysmsg '!!!!!!! FOUND PK! RUN!!!!!!!' alert_msg_color
                                    setvar! recall_home_now 1
                                    replay
                                endif
                            endif


                        # if not cooldown 'PAIN SPIKE'
                            if debug == 1
                                sysmsg 'PAIN SPIKE at {{execution_timer}}' warning_msg_color
                            endif

                            if verbose == 1
                                sysmsg '>>> PAIN SPIKE!' necro_spell_msg_colorf
                            endif

                            say '[painspike'
                            wft action_delay
                            if targetexists 'neutral'

                                clearsysmsg
                                target current_target_serial
                                wait action_delay
                                if insysmsg 'Unholy symbols remaining' and not insysmsg 'You do not see any corpses'
                                    if verbose == 1
                                        sysmsg '>>> EXPLODED CORPSE!' success_msg_color
                                    endif

                                    if use_script_overhead_messages == 1
                                        overhead '*exploded corpse*' success_msg_color
                                    endif

                                    settimer 'painspike_timer' 0
                                    cooldown 'PAIN SPIKE' 30000
                                endif
                            endif
                            wait action_delay
                        else
                            if verbose == 1
                                sysmsg 'PAIN SPIKE COOLDOWN...' spell_cooldown_msg_color
                            endif
                        endif
                    endif
                endif
                # END grimoire spells

            else
                if debug == 1
                    sysmsg 'NAO ENTROU NOTO AQUI 2' debug_msg_color
                    overhead 'LAST BUGADO' 90 'last'
                    hotkey 'Cancel Current Target'
                    break
                endif
            endif

        endif

    # CLOSES while not dead lasttarget or enemy_boat_present == 1
    endwhile


    sysmsg 'AFTER WHILE NOT DEAD LAST AT {{execution_timer}} ms' success_msg_color
else
    if debug == 1
        sysmsg 'NAO ENTROU ATTACK ROUTINE' debug_msg_color
    endif
endif




######################################
# CHECK IF THERE IS ANOTHER TARGET TO ATTACK SO WE DONT GO APPLYING BUFFS WHILE THERE ARE MOBS IN THE SCREEN
######################################

clearsysmsg
hotkey 'Target Closest Non-Friendly Monster'

if insysmsg 'New target set'
    if verbose == 1
        sysmsg 'NEW MOB AFTER ATTACK LOOP. REPLAYING...' warning_msg_color
    endif

    setvar! current_target_serial lasttarget

    replay
endif

######################################
# CHECK IF WE NEED TO REPLAY TO WAIT PLAYER TO LOOT LAST MOB
######################################

if wait_to_loot_now == 1
    if verbose == 1
        sysmsg 'REPLAYING TO WAIT TO LOOT...' warning_msg_color
    endif

    replay
endif


######################################
# HANDLE GMs
######################################

# try to detect GMs on screen and say 'hi'
if auto_detect_gms == 1 and recall_home_now != 1
    sysmsg 'â–· SEARCHING FOR GMs ON SCREEN' warning_msg_color
    hotkey 'Clear Target Queue'
    hotkey 'Next Player Target'
    if insysmsg 'New target'
        sysmsg '> FOUND THIEF! ESCAPING!' alert_msg_color
        setvar! recall_home_now 1
    endif
endif



######################################
# HANDLE THIEVES
######################################

if diffhits > max_diffhits_before_healing or poisoned or followers < followers_max_limit
    if debug == 1
        sysmsg 'replay handle thieves' debug_msg_color
    endif

    replay
endif

if auto_escape_thiefs == 1 and recall_home_now != 1
    if verbose == 1
        sysmsg 'â–· SEARCHING FOR GREY PLAYERS ON SCREEN' warning_msg_color
    endif
    # hotkey 'Clear Target Queue'
    clearsysmsg
    hotkey 'Next Grey Player Target'
    if insysmsg 'New target'
        sysmsg '> FOUND THIEF! ESCAPING!' alert_msg_color
        setvar! recall_home_now 1
        replay
    endif
endif



#####################################
# check for pks on screen
#####################################

if auto_escape_pks_on_screen == 1 and recall_home_now != 1
    if verbose == 1
        sysmsg 'â–· searching for pks on screen'
    endif
    # hotkey 'clear target queue'
    clearsysmsg
    hotkey 'Next Murderer Player Target'
    if insysmsg 'New target'
        sysmsg '!!!!!!! FOUND PK! RUN!!!!!!!' alert_msg_color
        setvar! recall_home_now 1
        replay
    endif
endif



######################################
# HANDLE PKs
######################################
# we need to first check for pks or else the other msgs might not allow us to get to this check

# if diffhits > max_diffhits_before_healing or poisoned or followers < followers_max_limit
    # if debug == 1
    #     sysmsg 'replay handle pks' debug_msg_color
    # endif
#     replay
# endif

# if auto_escape_tracked_pks == 1
#     if cooldown 'TRACKING'
#         sysmsg '>>> PK...' 19
#         sysmsg '>>> PK...' 49
#         sysmsg '>>> PK...' 54
#         overhead '!! PK !!' 19
#         overhead '!! PK !!' 49
#         overhead '!! PK !!' 54

#         sysmsg '>>> ESCAPING PK!!!' 41
#         overhead '!! ESCAPING PK !!' 41

#         replay
#     endif
#     if insysmsg 'now tracking'
#         sysmsg '>>> PK...' 19
#         sysmsg '>>> PK...' 49
#         sysmsg '>>> PK...' 54
#         overhead '!! PK !!' 19
#         overhead '!! PK !!' 49
#         overhead '!! PK !!' 54

#         sysmsg '>>> ESCAPING PK!!!' 41
#         overhead '!! ESCAPING PK !!' 41

#         replay
#     endif
# endif








#####################################
# MOVE REGS TO SATCHEL
#####################################

if diffhits > max_diffhits_before_healing or poisoned or followers < followers_max_limit
    if debug == 1
        sysmsg 'replay before move regs to satchel' debug_msg_color
    endif

    replay
endif

if offensive_mode == 1 and dead lasttarget or offensive_mode == 0 and recall_home_now != 1
    if auto_move_regs_to_satchel == 1

        # CHAR WIZARDS SATCHEL
        if not varexist char_reg_bag or not find char_reg_bag backpack and not find char_reg_bag self
            if findtype 'reagent satchel' as satchel
                if debug == 1
                    sysmsg 'FOUND AND SAVED CHAR REG SATCHEL' script_msg_color
                endif

                setvar! char_reg_bag satchel
            endif
        endif

        if findtype "Blood Moss|Black Pearl%s%|Garlic|Mandrake Root%s%|Ginseng|Nightshade|Sulfurous Ash|Spider's Silk" backpack as reg
        # while findtype "Blood Moss|Black Pearl%s%" backpack as reg
            getlabel reg reg_label
            if find reg backpack and not find reg char_reg_bag

                if verbose == 1
                    sysmsg '>>> MOVING {{reg_label}} TO SATCHEL at {{execution_timer}}.' action_msg_color
                endif
                menu char_reg_bag 0
                wait action_delay
            endif

            @ignore reg
        endif
        @clearignore
    endif
endif




#############################
# HIDE ITENS IN CHOOSEN POUCH
#############################

# if diffhits > max_diffhits_before_healing or poisoned or followers < followers_max_limit
    # if debug == 1
    #     sysmsg 'replay before hide itens' debug_msg_color
    # endif
#     replay
# endif

# if hide_valuables_in_char_loot_pouch == 1 and varexist CHAR_LOOT_POUCH
#     # if offensive_mode == 1 and dead lasttarget or offensive_mode == 0
#         @clearignore
#         unsetvar! found_something_to_hide_in_pouch

#         # hide char sheps crook is char has one (thiefs love to steal sheps crook)
#         if hide_sheps_crook == 1
#             if findtype 3713 backpack as crook

#                 getlabel crook crook_label
#                 if find crook CHAR_LOOT_POUCH
#                     sysmsg " > {{crook_label}}!" 52
#                 endif

#                 # make sure were not just finding the crook inside the loot_pouch already
#                 if not find crook CHAR_LOOT_POUCH
#                     # lets assume here crook is with aspect activated so the recycler doenst pull it it
#                     if hue crook != 0
#                         overhead '*hiding crook in loot pouch!' 63
#                         sysmsg '> Hiding {{crook_label}}' 63
#                         lift crook 1
#                         wait action_delay
#                         drop CHAR_LOOT_POUCH -1 -1 0
#                         wait action_delay
#                         setvar! found_something_to_hide_in_pouch true
#                     endif
#                 endif
#             endif
#         endif

#         # CHAR INSTRUMENT
#         # check if there is a saved instrument already, and if its still in char's backpack
#         if skill 'musicianship' > 0
#             if varexist char_instrument
#                 if not find char_instrument backpack
#                     overhead '! cant find saved instrument !' 39
#                     unsetvar! char_instrument
#                 endif
#             endif


#             # FIND AND SAVE CHAR INSTRUMENT IF NEEDED
#             if not varexist char_instrument
#                 foreach instrument_type in 'instruments'
#                     if findtype instrument_type backpack as instrument
#                         getlabel instrument instrument_label

#                         unsetvar! found_char_instrument
#                         foreach magical_instrument_type in 'magical_instruments_types'
#                             if magical_instrument_type in instrument_label
#                                 setvar! found_something_to_hide_in_pouch true
#                                 setvar! found_char_instrument true
#                                 setvar! char_instrument instrument
#                                 break
#                             endif
#                         endfor
#                     endif

#                     if varexist found_char_instrument
#                         break
#                     endif
#                 endfor
#             endif

#             if varexist char_instrument
#                 getlabel char_instrument instrument_label

#                 if find char_instrument CHAR_LOOT_POUCH
#                     @ignore char_instrument
#                 endif

#                 while find char_instrument backpack and not find char_instrument CHAR_LOOT_POUCH

#                     # razor will always find the item in backpack, even if its already on loot pouch
#                     # so we make sure we dont try to move it again if its already in the pouch
#                     # overhead 'hiding {{instrument_label}} in trap pouch' 51 'self'
#                     overhead '*hiding instrument*' 91 'self'
#                     sysmsg '> Hiding {{instrument_label}}' 91

#                     setvar! found_something_to_hide_in_pouch true

#                     lift char_instrument 9999
#                     wait action_delay
#                     drop CHAR_LOOT_POUCH -1 -1 0
#                     wait action_delay

#                 endwhile
#             endif
#         endif


#         # HIDE RARES IN CHAR_LOOT_POUCH
#         while findtype "29833|42517|29040|52615|17083|map|48261|'bold and arrow keg'|'void orb'|'research materials'|'scroll of calling'|22336|'Book of Truth'|5359|'folded cloth'|sandals|'aspect core'|3836|17686|parchment|carpet|bottle|3838|3839|3843|3842|3843|29025|29036|'blank scroll%s%'|29030" container as found
#             if find found backpack and not find found CHAR_LOOT_POUCH
#                 getlabel found found_label

#                 sysmsg 'Hiding {{found_label}}' 54 'self'
#                 overhead 'hiding {{found_label}}' 91 'self'

#                 if varexist CHAR_LOOT_POUCH
#                     lift found 999
#                     wait 50
#                     while queued
#                     endwhile

#                     drop CHAR_LOOT_POUCH
#                     wait 50
#                     while queued
#                     endwhile
#                 else
#                     hotkey 'Grab Item'
#                     wft action_delay
#                     target found
#                     wait 50
#                     while queued
#                     endwhile
#                 endif
#             endif

#         endwhile
#         @clearignore

# endif


#####################################
# check for pks on screen
#####################################

if auto_escape_pks_on_screen == 1 and recall_home_now != 1
    if verbose == 1
        sysmsg 'â–· searching for pks on screen'
    endif
    # hotkey 'clear target queue'
    clearsysmsg
    hotkey 'Next Murderer Player Target'
    if insysmsg 'New target'
        sysmsg '!!!!!!! FOUND PK! RUN!!!!!!!' alert_msg_color
        setvar! recall_home_now 1
        replay
    endif
endif


########################################
# KEEP CHAR BUFFED UP
########################################

# DELECTABLE
if auto_delectable == 1 and not findbuff 'food satisfaction'
    if findtype 'tray' as delectable
        overhead '*eating deletable*'
        sysmsg 'EATING DELETABLE at {{execution_timer}}' buff_msg_color
        dclick delectable
        wait action_delay
    else
        overhead '*no delectable*'
    endif
endif


# KEEP STR ABOVE 100
if diffhits > max_diffhits_before_healing or poisoned or followers < followers_max_limit
    if debug == 1
        sysmsg 'replay before strength' debug_msg_color
    endif

    replay
endif



#####################################
# check for pks on screen
#####################################

if auto_escape_pks_on_screen == 1 and recall_home_now != 1
    if verbose == 1
        sysmsg 'â–· searching for pks on screen'
    endif
    # hotkey 'clear target queue'
    clearsysmsg
    hotkey 'Next Murderer Player Target'
    if insysmsg 'New target'
        sysmsg '!!!!!!! FOUND PK! RUN!!!!!!!' alert_msg_color
        setvar! recall_home_now 1
        replay
    endif
endif


# if offensive_mode == 1 and dead lasttarget or offensive_mode == 0
if mana >= 2nd_circle_spell_mana_cost
    if use_strength == 1 and not findbuff 'Strength' or str < 110
        if verbose == 1
            sysmsg '>>> STRENGTH' buff_msg_color
        endif

        hotkey 'Clear Target Queue'
        cast 'Strength'

        @settimer 'waiting_target_timer' 0
        while not findbuff 'strength' and not targetexists 'beneficial' and not insysmsg 'disturbed' and not insysmsg 'cannot cast a spell' and timer 'waiting_target_timer' < 1500
            wft 10
            if insysmsg 'disturbed' or insysmsg 'spell will not adhere' or insysmsg 'cannot cast a spell'
                if verbose == 1
                    sysmsg 'BREAKING WHILE WAITING FOR STRENGTH TARGET' warning_msg_color
                endif

                wait spell_recovery_delay
                break
            endif
        endwhile

        if targetexists 'beneficial'
            hotkey 'Target Self'
            wait spell_recovery_delay
        endif

        if findbuff 'strength'
            overhead '+strength' buff_msg_color
        endif
    endif
endif
# else
#     if verbose == 1
#         # sysmsg '[OFFENSIVE MODE] SKIPPING STRENGTH...' warning_msg_color
#     endif
# endif




# MAGIC REFLECTION BUFF

if diffhits > max_diffhits_before_healing or poisoned or followers < followers_max_limit
    if debug == 1
        sysmsg 'replay before magic reflect' debug_msg_color
    endif

    replay
endif

sysmsg 'BEFORE MAGIC REFLECT' warning_msg_color
# if offensive_mode == 1 and dead lasttarget or offensive_mode == 0
if use_magic_reflection == 1 and not findbuff 'magic reflection' and mana >= 4th_circle_spell_mana_cost
    if verbose == 1
        sysmsg '>>> MAGIC REFLECT at {{execution_timer}}' buff_msg_color
    endif
    cast 'magic reflection'

    @settimer 'waiting_spell_timer' 0
    while not findbuff 'magic reflection' and timer 'waiting_spell_timer' < 3000
        wait 10
        if insysmsg 'disturbed' or insysmsg 'spell will not adhere' or insysmsg 'cannot cast a spell'
            if verbose == 1
                sysmsg 'BREAKING WHILE WAITING FOR MAGIC REFLECTION' warning_msg_color
            endif
            wait spell_recovery_delay
            break
        endif
    endwhile

    wait spell_recovery_delay

    if findbuff 'magic reflection'
        overhead '+MAGIC REFLECT' buff_msg_color
    endif
endif
# else
#     if verbose == 1
#         # sysmsg '[OFFENSIVE MODE] SKIPPING MAGIC REFLECTION...' warning_msg_color
#     endif
# endif



# REACTIVE ARMOR BUFF
if diffhits > max_diffhits_before_healing or poisoned or followers < followers_max_limit
    if debug == 1
        sysmsg 'replay before reactive armor' debug_msg_color
    endif

    replay
endif



#####################################
# check for pks on screen
#####################################

if auto_escape_pks_on_screen == 1 and recall_home_now != 1
    if verbose == 1
        sysmsg 'â–· searching for pks on screen'
    endif
    # hotkey 'clear target queue'
    clearsysmsg
    hotkey 'Next Murderer Player Target'
    if insysmsg 'New target'
        sysmsg '!!!!!!! FOUND PK! RUN!!!!!!!' alert_msg_color
        setvar! recall_home_now 1
        replay
    endif
endif


# if offensive_mode == 1 and dead lasttarget or offensive_mode == 0
if use_reactive_armor == 1 and not findbuff 'reactive armor' and mana >= 3rd_circle_spell_mana_cost
    if verbose == 1
        sysmsg '>>> REACTIVE ARMOR' buff_msg_color
    endif

    cast 'reactive armor'
    @settimer 'waiting_spell_timer' 0
    while not findbuff 'reactive armor' and timer 'waiting_spell_timer' < 2000
        wait 10
        if insysmsg 'disturbed' or insysmsg 'spell will not adhere' or insysmsg 'cannot cast a spell'
            if verbose == 1
                sysmsg 'BREAKING WHILE WAITING FOR REACTIVE ARMOR' warning_msg_color
            endif

            wait spell_recovery_delay
            break
        endif
    endwhile

    wait spell_recovery_delay

    if findbuff 'reactive armor'
        overhead '+reactive' buff_msg_color
    endif
endif
# else
#     if verbose == 1
#         # sysmsg '[OFFENSIVE MODE] SKIPPING REACTIVE ARMOR...' warning_msg_color
#     endif
# endif



# PROTECTION ARMOR BUFF
if diffhits > max_diffhits_before_healing or poisoned or followers < followers_max_limit
    if debug == 1
        sysmsg 'replay before protection' debug_msg_color
    endif

    replay
endif

if use_protection == 1 and not findbuff 'protection' and mana >= 2nd_circle_spell_mana_cost
    if verbose == 1
        sysmsg '>>> PROTECTION at {{execution_timer}}' buff_msg_color
    endif

    cast 'protection'

    @settimer 'waiting_spell_timer' 0
    while not findbuff 'protection' and timer 'waiting_spell_timer' < 1500
        wait 10
        if insysmsg 'disturbed' or insysmsg 'spell will not adhere' or insysmsg 'cannot cast a spell'
            if verbose == 1
                sysmsg 'BREAKING WHILE WAITING FOR PROTECTION' warning_msg_color
            endif

            wait spell_recovery_delay
            break
        endif
    endwhile

    wait spell_recovery_delay

    if findbuff 'protection'
        overhead '+PROTECTION' buff_msg_color
    endif
# OR ARCH PROTECTION
elseif use_arch_protection == 1 and not findbuff 'protection' and mana >= 4th_circle_spell_mana_cost

    @settimer 'waiting_target_timer' 0
    while not targetexists 'neutral' and timer 'waiting_spell_timer' < 4000
        wft 100
        if insysmsg 'disturbed' or insysmsg 'spell will not adhere' or insysmsg 'cannot cast a spell'
            if verbose == 1
                sysmsg 'BREAKING WHILE WAITING FOR ARCH PROTECTION TARGET' warning_msg_color
            endif

            wait spell_recovery_delay
            break
        endif
    endwhile

    if targetexists 'neutral'
        hotkey 'Target Self'
        wait 100
    endif

    wait 150
    if findbuff 'protection'
        if verbose == 1
            overhead '+arch protection' buff_msg_color
        endif
    endif
endif
# else
#     if verbose == 1
#         # sysmsg '[OFFENSIVE MODE] SKIPPING PROTECTION...' warning_msg_color
#     endif
# endif





#####################################
# check for pks on screen
#####################################

if auto_escape_pks_on_screen == 1 and recall_home_now != 1
    if verbose == 1
        sysmsg 'â–· searching for pks on screen'
    endif
    # hotkey 'clear target queue'
    clearsysmsg
    hotkey 'Next Murderer Player Target'
    if insysmsg 'New target'
        sysmsg '!!!!!!! FOUND PK! RUN!!!!!!!' alert_msg_color
        setvar! recall_home_now 1
        replay
    endif
endif



######################################
# SKIN CORPSES/FORENSIC
######################################

if diffhits > max_diffhits_before_healing or poisoned or followers < followers_max_limit
    if debug == 1
        sysmsg 'replay before skin corpses' debug_msg_color
    endif

    replay
endif

# if offensive_mode == 1 and dead lasttarget or offensive_mode == 0
#if auto_skin_corpses == 1 and skill 'forensic' > 0 and not findbuff 'Actively Meditating'
if auto_skin_corpses == 1 and not findbuff 'Actively Meditating'
    if debug == 1
        sysmsg 'CHECKING SKIN CORPSES at {{execution_timer}}' debug_msg_color
    endif

    if not listexists skinned_corpses
        createlist skinned_corpses
    endif

    # trying this: only skin if there isnt a active target to attack
    if dead 'last' or not find 'last' ground any any 20
        if findtype corpse ground any any 2 as body
            if not inlist skinned_corpses body
                if not findtype 'elven spellblade' backpack
                    if verbose == 1
                        sysmsg 'NO SKINNING KNIFE!!!' alert_msg_color
                    endif
                endif

                if findtype 'elven spellblade' backpack as knife
                    useobject knife
                    wft action_delay
                    if targetexists 'neutral'
                        hotkey 'Target Self'

                        if use_script_overhead_messages == 1
                            overhead '*skinning corpses*' action_msg_color
                        endif

                        if verbose == 1
                            sysmsg '>>> SKINNING CORPSES NEARBY' action_msg_color
                        endif

                        @pushlist skinned_corpses body
                        wait action_delay
                    endif



                    if insysmsg 'dont see anything'
                        if use_script_overhead_messages == 1
                            overhead '*NOTHING TO CARVE*' 41
                        endif

                        @ignore body
                    elseif insysmsg 'carve materials'
                        if use_script_overhead_messages == 1
                            overhead '*carved materials!*' success_msg_color
                        endif

                        # switched ignore to list control cause spirit speak will ignore corpses and then razor wont skin it anymore since it would be globally ignored
                        # @ignore body
                        @pushlist skinned_corpses body
                    elseif insysmsg 'must wait'
                        if verbose == 1
                            sysmsg '>>> SKILL COOLDOWN (FORENSIC)' skill_cooldown_msg_color
                        endif

                        if use_script_overhead_messages == 1
                            overhead ':: FORENSIC COOLDOWN ::' skill_cooldown_msg_color
                        endif
                        wait action_delay
                    endif
                endif
            endif
        endif
    endif
endif
# else
#     if verbose == 1
#         # sysmsg '[OFFENSIVE MODE] SKIPPING SKINNING...' warning_msg_color
#     endif
# endif



#####################################
# check for pks on screen
#####################################

if auto_escape_pks_on_screen == 1 and recall_home_now != 1
    if verbose == 1
        sysmsg 'â–· searching for pks on screen'
    endif
    # hotkey 'clear target queue'
    clearsysmsg
    hotkey 'Next Murderer Player Target'
    if insysmsg 'New target'
        sysmsg '!!!!!!! FOUND PK! RUN!!!!!!!' alert_msg_color
        setvar! recall_home_now 1
        replay
    endif
endif



######################################
# INCOGNITO
######################################

if diffhits > max_diffhits_before_healing or poisoned or followers < followers_max_limit
    if debug == 1
        sysmsg 'replay before incognito' debug_msg_color
    endif
    replay
endif

if offensive_mode == 1 and dead lasttarget or offensive_mode == 0
    if use_incognito == 1 and not findbuff 'incognito'
        if verbose == 1
            sysmsg '>>> INCOGNITO' buff_msg_color
        endif

        cast 'incognito'

        @settimer 'waiting_spell_timer' 0
        while not findbuff 'incognito' and timer 'waiting_spell_timer' < 3000
            wait 10
            if insysmsg 'disturbed' or insysmsg 'spell will not adhere' or insysmsg 'cannot cast a spell'
                if verbose == 1
                    sysmsg 'BREAKING WHILE WAITING FOR INCOGNITO' warning_msg_color
                endif

                wait spell_recovery_delay
                break
            endif
        endwhile

        wait spell_recovery_delay

        if findbuff 'incognito'
            if use_script_overhead_messages == 1
                overhead '+INCOGNITO' buff_msg_color
            endif
        endif
    endif
else
    if verbose == 1
        # sysmsg '[OFFENSIVE MODE] SKIPPING MAGIC REFLECTION...' warning_msg_color
    endif
endif

if debug == 1
    sysmsg 'AFTER AUTO-BUFFS AT {{execution_timer}} ms' debug_msg_color
endif







##########################################
# PRINT SCRIPT STATS AND INFORMATION
##########################################

# if diffhits > max_diffhits_before_healing or poisoned or followers < followers_max_limit
    # if debug == 1
    #     sysmsg 'replay before print script stats' debug_msg_color
    # endif
#     replay
# endif

# if timer 'script_running_warning_msg_timer' >= 8000
#     if verbose == 1
#         sysmsg 'â˜… MAGE BOT by gugutz â™¥' script_msg_color
#     endif

#     settimer 'script_running_warning_msg_timer' 0
# endif

# # PRINT DEBUGGING STATS
# if first_run_done == 1 and timer 'script_debug_stats_msg_timer' >= 60000
#     sysmsg 'SETTINGS SETUP: {{script_settings_execution_time}}' debug_msg_color
#     sysmsg 'TIMERS SETUP: {{setup_timers_execution_time}}' debug_msg_color
#     settimer 'script_debug_stats_msg_timer' 0
# endif

# # PRINT SCRIPT STATS
# if first_run_done == 1 and timer 'script_stats_msg_timer' >= 60000
#     if verbose == 1
#         sysmsg '#########################' 90
#         sysmsg '# SCRIPT STATS:' warning_msg_color
#         sysmsg 'âˆž Uptime: {{execution_timer}} ms' script_msg_color
#         sysmsg 'âˆž Iterations: {{iteration_number}} ms' script_msg_color

#         if use_mana_drain == 1
#             sysmsg 'â–· Mana Drain Timer: {{mana_drain_timer}} ms' script_msg_color
#         endif
#         if use_curse == 1
#             sysmsg 'â–· Curse Timer: {{curse_timer}} ms' 36
#         endif
#         if use_lightning == 1
#             sysmsg 'â–· Lightning Timer: {{lightning_timer}} ms' 36
#         endif
#         if use_ma == 1
#             sysmsg 'â–· Magic Arrow Timer: {{ma_timer}} ms' 36
#         endif
#         if use_harm == 1
#             sysmsg 'â–· Harm Timer: {{harm_timer}} ms' 36
#         endif
#         if use_fireball == 1
#             sysmsg 'â–· Fireball Timer: {{fireball_timer}} ms' 36
#         endif
#         if use_eb == 1
#             sysmsg 'â–· Energy Bolt Timer: {{eb_timer}} ms' 36
#         endif
#         if use_eb == 1
#             sysmsg 'â–· Energy Bolt Timer: {{eb_timer}} ms' 36
#         endif
#         if use_chain_lightning == 1
#             sysmsg 'â–· Chain Lightning Timer: {{chain_lightning_timer}} ms' 36
#         endif
#         if use_meteor_swarm == 1
#             sysmsg 'â–· Meteor Swarm Timer: {{meteor_swarm_timer}} ms' 36
#         endif
#         if use_earthquake == 1
#             sysmsg 'â–· Earthquake Timer: {{earthquake_timer}} ms' 36
#         endif


#         if offensive_mode == 1
#             sysmsg 'â–· Offensive Mode ON' success_msg_color
#         endif

#         if boating_mode == 1
#             sysmsg 'â–· Boating Mode ON' boating_msg_color
#             if varexist CHAR_BOAT_STATUS_BAR
#                 sysmsg 'â–· Char Boat Status Bar: {{CHAR_BOAT_STATUS_BAR}}' boating_msg_color
#             else
#                 sysmsg 'â–· Char Boat Status Bar NOT FOUND' alert_msg_color
#             endif

#             if varexist CHAR_BOAT_HATCH
#                 sysmsg 'â–· Char Boat Hatch: {{CHAR_BOAT_HATCH}}' boating_msg_color
#             else
#                 sysmsg 'â–· Char Boat Hatch NOT FOUND' alert_msg_color
#             endif
#         endif

#         sysmsg '#########################' 90
#     endif

#     settimer 'script_stats_msg_timer' 0
# endif


#########################################
# QUESTS AND EVENT SPECIFIC CODE
#########################################

# if insysmsg 'Hip Lantern'
#     sysmsg '!!!!!! HIP LANTERN !!!!!!!!!!!!!!!!!!!' 90
#     sysmsg '!!!!!! HIP LANTERN !!!!!!!!!!!!!!!!!!!' 90
#     overhead '!!!!!! HIP LANTERN !!!!!!!!!!!!!!!!!!!' 90
#     overhead '!!!!!! HIP LANTERN !!!!!!!!!!!!!!!!!!!' 90
# endif

# if insysmsg 'You have received a Dungeon Torch!'
#     sysmsg '!!!!!! DUNGEON TORCH!!!!!!!!!!!!!!!!!!!' 90
#     overhead '!!!!!! DUNGEON TORCH!!!!!!!!!!!!!!!!!!!' 90
# endif

# if findtype 'an elusive rabbit' ground any any 30 as rabbit
#     overhead '!! RABBIT !!' 90
#     overhead '!! RABBIT !!' 90 rabbit
# endif


#####################################
# check for pks on screen
#####################################

if auto_escape_pks_on_screen == 1 and recall_home_now != 1
    if verbose == 1
        sysmsg 'â–· searching for pks on screen'
    endif
    # hotkey 'clear target queue'
    clearsysmsg
    hotkey 'Next Murderer Player Target'
    if insysmsg 'New target'
        sysmsg '!!!!!!! FOUND PK! RUN!!!!!!!' alert_msg_color
        setvar! recall_home_now 1
        replay
    endif
endif



#############################
# FUN / MISC
#############################

if diffhits > max_diffhits_before_healing or poisoned or followers < followers_max_limit
    if debug == 1
        sysmsg 'replay before fun/misc' debug_msg_color
    endif

    replay
endif

if offensive_mode == 1 and dead lasttarget or offensive_mode == 0
    if dead lasttarget and diffhits == 0 and diffmana == 0 and diffstam == 0
        if juggle_mode == 1
            if timer 'fun_timer' > 120000
                clearsysmsg
                random 3
                if insysmsg 'Random: 1'
                    if findtype 'juggling torches' backpack
                        dclicktype 'juggling torches' backpack
                        wait action_delay
                    endif
                elseif insysmsg  'Random: 2'
                    if findtype 'juggling bottles' backpack
                        dclicktype 'juggling bottles'
                        wait action_delay
                    endif
                elseif insysmsg  'Random: 3'
                    if findtype 45285 backpack 2466
                        dclicktype 45285
                        wait action_delay
                    endif
                endif

                settimer 'fun_timer' 0
            endif
        endif
    endif
endif


if debug == 1
    sysmsg '>>> FINISHED SCRIPT AT {{execution_timer}} ms' debug_msg_color
endif

setvar! mage_bot_first_run_done 1


replay
