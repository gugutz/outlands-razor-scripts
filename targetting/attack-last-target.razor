#################################
# SMART ATTACK LAST TARGET
# v0.0.2
# by gugutz
################################
#
#
################################
# SCRIPT CONFIGURATION
################################


setvar! action_delay 350


###############################
# TIMERS
###############################

if not timerexists 'choose_target_waiting_msg_timer'
    createtimer 'choose_target_waiting_msg_timer'
endif
settimer 'choose_target_waiting_msg_timer' 10000

if not timerexists 'bloodoath_timer'
    createtimer 'bloodoath_timer'
    settimer 'bloodoath_timer' 30001
endif

if not timerexists 'painspike_timer'
    createtimer 'painspike_timer'
    settimer 'painspike_timer' 30001
endif



setvar! reset_target 0
setvar! current_target_serial lasttarget
# getlabel current_target_serial last_target_label

unsetvar! herded_last_target

if dead current_target_serial and not find current_target_serial ground any any 30
    overhead "last target dead!" 1161
    sysmsg '> LAST TARGET IS DEAD!' 1161
    setvar! reset_target 1
    # stop
endif

if dead current_target_serial and find current_target_serial ground any any 30
    overhead "last target item?" 1161
    sysmsg '> LAST TARGET ITEM? KEEPING TARGET.' 1161
    # setvar! reset_target 1
    # stop
endif

if reset_target != 1 and current_target_serial == self
    overhead 'last == self!' 1161
    setvar! reset_target 1
    # stop
endif

if reset_target != 1 and not dead current_target_serial and not find current_target_serial ground any any 10 and find current_target_serial ground any any 11 as last_target_serial
    overhead 'cant find set target!' 1161
    sysmsgl 'Cant Find Set Target {{current_target_serial}}' 1161
    setvar! reset_target 1
    # stop
endif

if reset_target != 1 and not dead current_target_serial and not find current_target_serial ground any any 10 and find current_target_serial ground any any 11 as last_target_serial
    overhead "out of range" 1161 current_target_serial
    sysmsg 'TARGET {{current_target_serial}} OUT OF RANGE'
endif

if reset_target != 1 and not dead current_target_serial
    if noto current_target_serial == friend or noto current_target_serial == friendly
        overhead 'last == friendly!' 52
        overhead 'cant attack (friendly)' 52 current_target_serial
        setvar! reset_target 1
        # clearall
        # stop
    endif
endif


# overhead '! no last target !' 39


if reset_target == 1
    hotkey 'Set Last Target'
    sysmsg 'SET NEW TARGET' 1161
    while targetexists 'neutral'
        wait 10
    endwhile

    setvar! current_target_serial current_target_serial
    # getlabel current_target_serial last_target_label
endif


if followers > 1
    if skill 'taming' > 20 or skill 'magery' > 80
        say 'all guard'
        wft action_delay
        # if targetexists 'harmful'
        #     hotkey "Last Target"
        # endif
    endif
endif


if boating_mode == 1
    sysmsg 'FIRING CANNONS!' 1161
    whisper '[FireCannons'
endif

if not dead current_target_serial
    attack current_target_serial
    sysmsg 'ATTACKING: {{current_target_serial}}' 1161
    overhead '▼▼▼▼▼▼ ATTACKING ▼▼▼▼▼▼' 1161 current_target_serial
endif


###############################
# HERDING
###############################

if skill 'herding' > 0
    if followers <= 1
        overhead '! no followers to herd !' 40

    elseif not findtype 3713 backpack
        overhead '! no sheps crook !' 39
        # overhead '! cant focus aggresion !' 39 current_target_serial

    elseif findtype 3713 backpack as crook
        if crook != ACTIVE_SHEPS_CROOK
            clearsysmsg
            dclick crook
            if insyusmsg 'Activated'
                sysmsg 'SETTING ACTIVE CROOK AS {{crook}}' 1161
                setvar! ACTIVE_SHEPS_CROOK crook
            endif
        endif

        say '[focusaggression'
        wft action_delay
        if targetexists 'harmful'

            while targetexists 'harmful'
                if timer  'choose_target_waiting_msg_timer' >= 3000
                    overhead 'herd against who?' 91
                    settimer 'choose_target_waiting_msg_timer' 0
                endif
            endwhile

            wait 100

            if insysmsg 'You focus'
                overhead '▼ HERDED ▼' 40 current_target_serial

                # update last herded mob to be this one
                setvar! last_herded_mob_serial current_target_serial
                setvar! herded_last_target 1
            endif

        endif
    endif
endif

clearsysmsg








###############################
# BLOODOATH
###############################

# if skill 'necromancy' > 20
#     if timer 'bloodoath_timer' >= 30000
#         sysmsg '>>> Using bloodoath...'
#         say '[bloodoath'
#         wait action_delay
#         if insysmsg 'Unholy symbols remaining'
#             settimer 'bloodoath_timer' 0
#             overhead '*bloodoath*' 30
#             sysmsg '>>> BLOODOATH!' 30
#         endif
#     else
#         sysmsg 'Bloodoath cooldown...' 56
#     endif
# endif



#################################
# CHANGELOG
#
# v0.0.2
# - Adapts script to the new patched mechanic of auto all kill when herding ('[FocusAggressionAllKill')
# - Saves duplicated herding actions if current last target is the last herded mob
#
# v0.0.1
# - Initial Release
#
#