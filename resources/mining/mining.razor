sysmsg '#########################' 90
sysmsg '>>> MINING BOT' 55
sysmsg 'by gugutz' 45
sysmsg 'version v5.1.0' 31
sysmsg '########################' 90


###################################
# CONFIGURATION

setvar! average_ping 200
setvar! movement_delay 150


# should script use runetomes to travel to mine
setvar! auto_cycle_runetomes 1
# how many runes script should attempt to recall for each runebook
setvar! max_runes_to_use_per_runebook 6

# set to 1 to activate void armor on start
setvar! use_harvest_aspect 0
setvar! use_void_aspect 0

# should script recall home when tracking pks or finding thiefs
setvar! auto_escape_tracked_pks 1
setvar! auto_escape_pks_on_screen 0
setvar! auto_escape_thiefs 0

# max resources a packie can have before being set as full
setvar! max_resources_on_packie_before_unloading 600

# should script try to enter hotel room when traveling home
setvar! use_hotel_room 0
# set if characters should use own rooms or enter a friends room
setvar! use_own_room 0


# should script autosmelt if close to a forge
setvar! auto_smelt_ores_when_close_to_forges 1

# should script smelt colored ores or just regular ones
setvar! smelt_colored_ores 0


#############################
# CHARACTER CONFIG OVERRIDES

if name == 'Emacs'
    setvar! use_void_aspect 1
    setvar! max_runes_to_use_per_runebook 6
endif

if name == 'Nazareno'
    setvar! use_void_aspect 1
    setvar! max_runes_to_use_per_runebook 6
    setvar! auto_cycle_runetomes 1
endif

if name == 'Heduardoh'
    setvar! use_harvest_aspect 1
    setvar! max_runes_to_use_per_runebook 6
    setvar! auto_cycle_runetomes 1
endif

if name == 'Darren'
    setvar! auto_summon 0
    setvar! auto_smelt_ores_when_close_to_forges 0
    setvar! smelt_colored_ores 0
    setvar! auto_escape_tracked_pks 0
endif

if name == 'Minerationtion'
    setvar! use_void_aspect 1
    setvar! max_runes_to_use_per_runebook 6
    setvar! auto_cycle_runetomes 1
endif

if name == 'BastoZ'
    setvar! use_void_aspect 1
    setvar! max_runes_to_use_per_runebook 6
    setvar! auto_cycle_runetomes 1
endif


#####################################
setvar! action_delay 600
setvar! spell_recovery_delay 120
setvar! world_save_delay 8000


if skill 'magery' < 90 and auto_summon == 1
    sysmsg 'DISABLING AUTO SUMMON (LOW MAGERY)'
    setvar! auto_summon 0
endif

if auto_summon == 0
    setvar! summon_max_limit 0
endif

setvar! runetome_home_rune_use_charge_btn_number 100
setvar! runebook_home_rune_use_charge_btn_number 2


#####################################
# TEST IF REQUIRED COOLDOWN WAS CREATED
#####################################

cooldown RESOURCES 3000
if not cooldown RESOURCES
    sysmsg "Cooldown resources not found. Please read instructions in README file" 34
    sysmsg "https://github.com/gugutz/outlands-razor-scripts/resources/mining/README.md" 34
    stop
endif



#############################
# SET THE HOME BOOK
#############################

# search runetomes first
while findtype 'runetome' backpack as found
    getlabel found rtome_label
    if 'home' in rtome_label or 'Home' in rtome_label or 'HOME' in rtome_label
        setvar! home_book found
        setvar! home_book_gump_id 167090027
        setvar! home_rune_btn_number runetome_home_rune_use_charge_btn_number
    endif

    @ignore found
endwhile
@clearignore

# if we couldnt find a home runetome, search for a home runebook
if not varexist home_book
    while findtype 'runebook' backpack as found
        getlabel found rbook_label
        if 'home' in rbook_label or 'Home' in rbook_label or 'HOME' in rbook_label
            setvar! home_book found
            setvar! home_book_gump_id 167090027
            setvar! home_rune_btn_number runetome_home_rune_use_charge_btn_number
        endif

        @ignore found
    endwhile
    @clearignore
endif

if not varexist home_book
    sysmsg "YOU NEED A RUNEBOOK OR RUNETOME NAMED 'HOME' WITH YOUR HOME RUNE SET TO DEFAULT TO RUN THIS SCRIPT" 54
    stop
endif



#############################
# SET THE MINING RUNEBOOKS
#############################

if auto_cycle_runetomes == 1
    clearlist 'mining_runetomes'
    createlist 'mining_runetomes'
    clearlist 'original_mining_runetomes'
    createlist 'original_mining_runetomes'

    while findtype 'runetome' backpack as found
        getlabel found rbook_label
        if 'mining' in rbook_label or 'Mining' in rbook_label or 'MINING' in rbook_label
            pushlist 'mining_runetomes' found
            pushlist 'original_mining_runetomes' found
        endif

        @ignore found
    endwhile

    @clearignore


    if list 'mining_runetomes' == 0
        sysmsg "YOU NEED AT LAST 1 RUNETOME WITH THE WORD 'MINING' ON ITS NAME IF YOU WANT TO CYCLE RUNES" 54
        # stop
    endif

    foreach x in 'mining_runetomes'
        sysmsg 'MINING RUNEBOOK {{index}}: {{x}}'
    endfor
endif



###################################
# SCRIPT ROUTINE RELATED VARIABLES
# (USUALLY THERES NO NEED TO EDIT THESE)
###################################

setvar! debug 1
setvar! resource_cooldown_value 10000
setvar! recall_casting_time 4500


setvar! use_strength 1
setvar! max_diffhits_before_buffing 5

# VARIABLES FOR MESSAGE COLORS
setvar! debug_msg_color 41
setvar! script_msg_color 2213
setvar! default_sysmsg_color 1360
setvar! default_overhead_color 1360
setvar! status_msg_color 91

setvar! spell_msg_color 49
setvar! buff_msg_color 92
setvar! warning_msg_color 1196
setvar! alert_msg_color 37
setvar! success_msg_color 1272
setvar! action_msg_color 90
setvar! rail_msg_color 89
setvar! on_cooldown_msg_color 53
setvar! reset_timer_msg_color 1258
setvar! boating_msg_color 84

# delay between pickaxes uses
setvar! max_wait_for_last_sysmsg_to_use_pickaxe  1300
# delay before suspecting captcha gump
setvar! max_wait_for_last_sysmsg_to_suspect_gump 8000

setvar! max_diffhits_before_starting_heal_routine 0
setvar! max_diffhits_before_starting_defense_routine 2

setvar! max_diffhits_before_healing_with_potion 20
setvar! max_diffhits_before_healing_with_magery 20
setvar! max_diffhits_before_healing_with_bandages 10
setvar! min_healing_to_use_bandages 30

setvar! max_diffweight_before_unloading 50




setvar! max_mob_range_to_attack 2
if skill 'archery' >= 50
    setvar! max_mob_range_to_attack 12
endif


# runetomes recall via scroll buttons have a interval of 6, so first button is 2, second is 8, and so on...
if not listexists 'runetome_page_numbers'
    createlist 'runetome_page_numbers'

    # runetome page 1
    # we dont push the first rune since its the home rune
    pushlist 'runetome_page_numbers' 200
    pushlist 'runetome_page_numbers' 201
    pushlist 'runetome_page_numbers' 202
    pushlist 'runetome_page_numbers' 203
    pushlist 'runetome_page_numbers' 204
    pushlist 'runetome_page_numbers' 205
    pushlist 'runetome_page_numbers' 206
    pushlist 'runetome_page_numbers' 207
    pushlist 'runetome_page_numbers' 208
    pushlist 'runetome_page_numbers' 209
    pushlist 'runetome_page_numbers' 210
    pushlist 'runetome_page_numbers' 211
    pushlist 'runetome_page_numbers' 212
    pushlist 'runetome_page_numbers' 213

    # runetome page 2
    pushlist 'runetome_page_numbers' 214
    pushlist 'runetome_page_numbers' 215
    pushlist 'runetome_page_numbers' 216
    pushlist 'runetome_page_numbers' 217
    pushlist 'runetome_page_numbers' 218
    pushlist 'runetome_page_numbers' 219
    pushlist 'runetome_page_numbers' 220
    pushlist 'runetome_page_numbers' 221
    pushlist 'runetome_page_numbers' 222
    pushlist 'runetome_page_numbers' 223
    pushlist 'runetome_page_numbers' 224
endif

# create a duplicate list so we can restore the main list when needed (like when reaching max rune set to use on runetome)
if not listexists 'runetome_page_numbers_unchanged'
    createlist 'runetome_page_numbers_unchanged'

    foreach x in 'runetome_page_numbers'
        pushlist 'runetome_page_numbers_unchanged' x
    endfor
endif

#####################################
# CONSTANTS FOR IN-GAME TYPES
#####################################

setvar! ORES 6585
setvar! INGOTS 7154

setvar! max_mob_range_to_attack 2



#####################################
# SUMMON SETTINGS
#####################################


if not listexists 'summons'
    createlist 'summons'
endif

clearlist 'summons'
pushlist 'summons' 'an earth elemental'
pushlist 'summons' 'a fire elemental'
pushlist 'summons' 'summ. creature'


if skill 'magery' > 90

    # SPELLS TO AUTO CAST
    setvar! use_reactive_armor 1
    setvar! use_magic_reflection 1

    setvar! auto_summon 1
    setvar! use_undead_summons 0
    setvar! auto_all_guard 1
    setvar! auto_patrol_when_no_active_lasttarget 0
    setvar! auto_vampiric_embrace 1
    setvar! patrol_first_relative_direction 0
    setvar! patrol_second_relative_direction -10
    setvar! find_summon_range 8

    setvar! use_mushroom_delay 60000
    setvar! all_guard_delay 15000
    setvar! all_patrol_delay 6000
    setvar! cast_summons_delay 6000
endif

# if summ creature is one of players summons, change limit to 5 so even with 4 followers, we still make the char cast to summon the fifth creature
# if not, then we just want 2 elementals so limit should be 4, since they take up 2 slots each and the fifth wouldnt be possible
if inlist 'summons' 'summ. creature'
    setvar! summon_max_limit 5
else
    setvar! summon_max_limit 4
endif

# SUMMONS SPELL LISTS
if not listexists 'summonspells'
    createlist 'summonspells'
endif
clearlist 'summonspells'

if inlist 'summons' 'an air elemental'
    @pushlist 'summonspells' 'air elemental'
endif
if inlist 'summons' 'an earth elemental'
    @pushlist 'summonspells' 'earth elemental'
endif
if inlist 'summons' 'a water elemental'
    @pushlist 'summonspells' 'water elemental'
endif
if inlist 'summons' 'a fire elemental'
    @pushlist 'summonspells' 'fire elemental'
endif
if inlist 'summons' 'a daemon'
    @pushlist 'summonspells' 'summon daemon'
endif
if inlist 'summons' 'an energy vortex'
    @pushlist 'summonspells' 'energy vortex'
endif
if inlist 'summons' 'a blade spirit'
    @pushlist 'summonspells' 'blade spirits'
endif
if inlist 'summons' 'summ. creature'
    @pushlist 'summonspells' 'summ. creature'
endif


# LIST TO CONTROL WHICH CORPSES HAVE ALREADY BEEN DRAINED BY SPIRIT SPEAK
if skill 'spirit' > 0 and not listexists 'drained_corpses'
    sysmsg '$$$ Creating list to control drained corpses...' script_msg_color
    createlist 'drained_corpses'
endif


###################################
# TIMERS
###################################
sysmsg 'Creating timers...'

createlist 'mining_script_timers'
pushlist 'mining_script_timers' 'waiting_save'
pushlist 'mining_script_timers' 'last_sysmsg_timer'
pushlist 'mining_script_timers' 'waiting_target_timer'
pushlist 'mining_script_timers' 'loop_on_warning_msg'
pushlist 'mining_script_timers' 'last_gump_warning_timer'
pushlist 'mining_script_timers' 'mining_uptime'
pushlist 'mining_script_timers' 'last_gump_tracking_timer'

pushlist 'mining_script_timers' 'all_guard_timer'
pushlist 'mining_script_timers' 'low_mana_for_summoning_warning_msg_timer'

pushlist 'mining_script_timers' 'spirit_speak_cooldown_timer'

pushlist 'mining_script_timers' 'waiting_cooldown_timer'
pushlist 'mining_script_timers' 'waiting_journal_timer'
pushlist 'mining_script_timers' 'waiting_runebook_gump_timer'





foreach timer in 'mining_script_timers'
    if not timerexists timer
        createtimer timer
        settimer timer 100000
    endif
endfor


###################################
# POPULATE SOME LISTS
###################################

if not listexists 'resource_types'
    createlist 'resource_types'
    pushlist 'resource_types' ORES
    pushlist 'resource_types' INGOTS
endif


# CREATE A LIST WITH ALL POSSIBLE WEAPONS CHAR
# CAN EQUIP BASED ON HIS WEAPON SKILL
if not listexists 'char_combat_skill_weapons'
    createlist 'char_combat_skill_weapons'
    if skill 'archery' >= 50
        pushlist 'char_combat_skill_weapons' 'bow'
        pushlist 'char_combat_skill_weapons' 'crossbow'
        pushlist 'char_combat_skill_weapons' 'heavy crossbow'
    elseif skill 'swordsmanship' >= 50
        pushlist 'char_combat_skill_weapons' 'halberd'
        pushlist 'char_combat_skill_weapons' 'bardiche'
        pushlist 'char_combat_skill_weapons' 'katana'
        pushlist 'char_combat_skill_weapons' 'axe'
        pushlist 'char_combat_skill_weapons' 'viking sword'
        pushlist 'char_combat_skill_weapons' 'longsword'
        pushlist 'char_combat_skill_weapons' 'broadsword'
        pushlist 'char_combat_skill_weapons' 'double axe'
        pushlist 'char_combat_skill_weapons' "executioner's axe"
    # elseif skill 'mace fighting' >= 50
    #     pushlist 'char_combat_skill_weapons' 'war mace'
    #     pushlist 'char_combat_skill_weapons' 'mace'
    #     pushlist 'char_combat_skill_weapons' 'club'
    #     pushlist 'char_combat_skill_weapons' 'black staff'
    #     pushlist 'char_combat_skill_weapons' 'gnarled staff'
    #     pushlist 'char_combat_skill_weapons' 'war hammer'
    endif
endif

###################################
# PACK ANIMALS
###################################

sysmsg 'Searching for pack animals...' 87

if not listexists 'packies'
    createlist 'packies'
endif

# if we cant find the saved packies, its time to remake the list
# this also prevents the script from re-adding the same packies over and over
# when player re-plays the script several times with the same client open

if list 'packies' == 0
    setvar! remake_packies_list 1
else
    foreach packie in 'packies'
        if find packie ground any any 20
            overhead '*found previous saved packie*' 72 packie
        else
            overhead '*cant find packie {{packie}}. resetting list*' 54
            setvar! remake_packies_list 1
        endif
    endfor
endif


if varexist remake_packies_list
    unsetvar! remake_packies_list
    clearlist 'packies'
    sysmsg 'POPULATING PACKIES LIST...' 54

    while findtype 292 ground any any 2 as packie
        if noto packie = friend
            pushlist 'packies' packie
            overhead '*adding to packies list*' 56 packie
        endif
        @ignore packie
    endwhile

    while findtype 291 ground any any 2 as packie
        if noto packie = friend
            pushlist 'packies' packie
            overhead '*adding to packies list*' 56 packie
        endif
        @ignore packie
    endwhile

    clearignore
endif

foreach packanimal in 'packies'
    overhead '*opening bag*' 91 packanimal
    dclick packanimal
    wait action_delay

    # check packie weight to determine if its full or not
    if counttype ORES packanimal >= max_resources_on_packie_before_unloading
        # sysmsg 'COUNT ORE 1' 92
        setvar! packie_heavy 1
    elseif counttype ORES packanimal >= 200 and counttype INGOTS packanimal >= 500
        # sysmsg 'COUNT ORE 2' 92
        setvar! packie_heavy 1
    elseif counttype ORES packanimal >= 150 and counttype INGOTS packanimal >= 800
        # sysmsg 'COUNT ORE 3' 92
        setvar! packie_heavy 1
    elseif counttype ORES packanimal >= 100 and counttype INGOTS packanimal >= 1100
        # sysmsg 'COUNT ORE 4' 92
        setvar! packie_heavy 1

    # check if packie is actually empty
    elseif counttype ORES packanimal == 0 and counttype INGOTS packanimal == 0
        overhead '*empty*' 56 packanimal
        rename packanimal 'emptypackie'
    # if its not heavy and its not empty, its "light"
    elseif counttype ORES packanimal > 0 or counttype INGOTS packanimal >= 0
        overhead '*empty*' 56 packanimal
        rename packanimal 'lightpackie'
    endif

    # add or remove packie to full 0packies list based on if its heavy or not
    if varexist packie_heavy
        overhead '*heavy*' 56 packanimal
        unsetvar! packie_heavy
        rename packie 'fullpackie'
    endif
endfor

###################################
# PREPARING TO START
###################################


# IF THERES A SHELF NEARBY, RESSUPLY
if findtype 'storage shelf' ground any any 2 as shelf
    sysmsg 'RESSUPLYING...' 55
    menu shelf 1
    waitforgump 3232825965 600
else
    overhead 'NO SHELFS FOUND TO RESSUPLY!'
endif



if list 'packies' >= 1
    say 'all follow me'
endif

if list 'packies' == 0
    overhead '!COULDNT FIND ANY PACKIES!' 43
    overhead '!COULDNT FIND ANY PACKIES!' 43
    sysmsg '!COULDNT FIND ANY PACKIES!' 43
    sysmsg '!COULDNT FIND ANY PACKIES!' 43
endif

# check and equip pickaxe if needed before starting so we dont waist the main timer equiping the axe
# which was causing the timer to be greater then the mining value and the char wouldnt mine when that happened
#
if not rhandempty and not findtype 'pickaxe' righthand
    overhead 'undressing hands for pickaxe'
    hotkey "Undress Both Hands"
    wait action_delay
endif


###################################
# TRACKING - BEGIN HUNTING
###################################


if not varexist tracking_gump_id
    @setvar tracking_gump_id 4267467659
endif


if not findbuff 'Tracking Hunting'
    while not gumpexists tracking_gump_id
        sysmsg 'Opening tracking gump...' 53
        skill 'tracking'
        waitforgump tracking_gump_id 600
    endwhile

    if gumpexists tracking_gump_id
        if not ingump 'Stop Hunting' 4267467659
            sysmsg 'STARTING HUNTING' 65
            gumpresponse 6 tracking_gump_id
            waitforgump tracking_gump_id action_delay
        else
            overhead 'already hunting' 55
        endif

        gumpclose tracking_gump_id
    endif

else
    overhead 'Tracking already ON!' 55
endif
# endif

#############################
# ACTIVATE VOID ASPECT IF NEEDED
#############################


if use_harvest_aspect == 1
    setvar! activate_aspect 1
    setvar! aspect_color 2086
elseif use_void_aspect == 1
    setvar! activate_aspect 1
    setvar! aspect_color 2599
endif

if activate_aspect == 1
    if not varexist aspect_gump_id
        @setvar aspect_gump_id 2424293173
    endif

    setvar! switch_aspect_btn_number 15
    setvar! activate_aspect_btn_number 17

    if findlayer 'self' innertorso as tunic
        if hue tunic != aspect_color
            sysmsg 'ASPECT NOT ACTIVE. ACTIVATING IT'

            # OPEN ASPECT GUMP
            while not gumpexists aspect_gump_id
                sysmsg 'Opening Aspect Gump'
                say '[aspects'
                waitforgump aspect_gump_id action_delay
            endwhile

            # CHANGE ARMOR ASPECT TO CORRECT ASPECT
            if use_harvest_aspect == 1
                if not ingump 'Harvest or Chests' 2424293173
                    overhead "Changing aspect to {{aspect_name}}"
                    # while not ingump aspect_unique_text 2424293173
                    while not ingump 'Harvest or Chests' 2424293173
                        gumpresponse switch_aspect_btn_number aspect_gump_id
                        waitforgump aspect_gump_id action_delay
                    endwhile
                endif
            elseif use_void_aspect == 1
                if not ingump 'Auto Stats Restoration' 2424293173
                    overhead "Changing aspect to {{aspect_name}}"
                    # while not ingump aspect_unique_text 2424293173
                    while not ingump 'Auto Stats Restoration' 2424293173
                        gumpresponse switch_aspect_btn_number aspect_gump_id
                        waitforgump aspect_gump_id action_delay
                    endwhile
                endif


            # ACTIVATE ASPECT ON ARMOR
            waitforgump aspect_gump_id action_delay
            gumpresponse activate_aspect_btn_number aspect_gump_id
            waitforgump aspect_gump_id action_delay
            gumpresponse activate_aspect_btn_number aspect_gump_id
            waitforgump aspect_gump_id action_delay


            # CHECK IF ASPECT IN FACT ACTIVATED
            if findlayer 'self' innertorso as tunic
                if hue tunic == aspect_color
                    overhead "activated void on armor!" 48
                    sysmsg "Activated void On Armor!" 48
                endif
            endif

        endif
    endif

    setvar! activate_aspect 0
endif


#############################
# SET THE MINING RUNEBOOK BUTTONS TO PRESS TO RECALL
#############################

# runebooks recall via scroll buttons have a interval of 6, so first button is 2, second is 8, and so on...
if not listexists 'runebook_rune_btns'
    createlist 'runebook_rune_btns'

    # runebook page 1
    # we dont push the first rune since its the home rune
    pushlist 'runebook_rune_btns' 11
    pushlist 'runebook_rune_btns' 17
    pushlist 'runebook_rune_btns' 23
    pushlist 'runebook_rune_btns' 29
    pushlist 'runebook_rune_btns' 35
    pushlist 'runebook_rune_btns' 41
    pushlist 'runebook_rune_btns' 47

    # runebook page 2
    pushlist 'runebook_rune_btns' 53
    pushlist 'runebook_rune_btns' 59
    pushlist 'runebook_rune_btns' 65
    pushlist 'runebook_rune_btns' 71
    pushlist 'runebook_rune_btns' 77
    pushlist 'runebook_rune_btns' 83
    pushlist 'runebook_rune_btns' 89
    pushlist 'runebook_rune_btns' 95
endif

setvar! runetome_gump_id 167090027
setvar! runebook_gump_id 1551740969

setvar! recall_travel_time 3000

setvar! 1st_circle_spell_mana_cost 8
setvar! 2nd_circle_spell_mana_cost 9
setvar! 3rd_circle_spell_mana_cost 10
setvar! 4th_circle_spell_mana_cost 12



###################################
sysmsg 'Opening Reg Bag...' 18
###################################


if findtype 'bag' backpack as reg_bag
    sysmsg 'Opening reagent bag first time...' 91
    overhead 'opening reg bag...' 91
    dclick reg_bag
    wait 550
    if insysmsg 'You must wait to perform another action'
        overhead 'failed to open reg bag!' 41
        while insysmsg 'You must wait to perform another action'
            dclick reg_bag
            wait 550
        endwhile
    endif
    setvar! reg_bag_opened_once 1
endif

###################################
sysmsg 'STARTING...' 18
###################################


# all guard right now so summons protect char if we start script in the middle of a fight
if followers > 0
    say 'all guard me'
endif

clearsysmsg

# if stockpile nearby, check if logs or boards to unload before starting
if findtype ORES backpack or findtype INGOTS backpack
    if findtype 'resource container' ground any any 2 as stockpile
        sysmsg 'UNLOADING AT START ON STOCKPILE.' 90
        # smelt ores in backpack
        while findtype ORES backpack as ores
            overhead 'smelting!'
            dclick ores
            wait action_delay
            setvar! reset_last_sysmsg_timer 1

            if insysmsg 'You do not see any nearby forges to smelt this ore on'
                overhead 'got far from forge!' 41
                sysmsg 'Got Far From Forge! Breaking smelting loop...' 41
                break
            endif
        endwhile

        # smelt ores in pack animals
        foreach packanimal in 'packies'
            dclick packanimal
            wait action_delay

            if findtype ORES packanimal as ores and diffweight > 10
                overhead 'smelting ores in animal' 56 packanimal
                while findtype ORES packanimal as ores and diffweight > 10
                    sysmsg 'smelting ore in packie' 56
                    overhead 'smelting ores' 56 packanimal
                    dclick ores
                    wait action_delay

                    setvar! reset_last_sysmsg_timer 1

                    if insysmsg 'You do not see any nearby forges to smelt this ore on'
                        overhead 'got far from forge!' 41
                        sysmsg 'Got Far From Forge! Breaking smelting loop...' 41
                        setvar! escape_parent_loop 1
                        break
                    endif

                endwhile
            endif

            if varexist escape_parent_loop
                unsetvar escape_parent_loop
                break
            endif

        endfor

        setvar! resource_stockpile stockpile
        menu resource_stockpile 0
        wft 600
        if targetexists 'neutral'
            sysmsg '> Restocking Resource Stockpile...' sysmsgs_color
            target 'self'
        endif

        if gumpexists 1859005118
            gumpclose 1859005118
        endif

        # since char is alredy home, make sure to not try to recall there
        setvar! recall_home_now 0
    endif
else
    sysmsg 'NO RESOURCES TO UNLOAD IN STOCKPILE' 54
endif


# before starting check if char is not heavy and go home unload
# same conditions as bellow to check if needs to go home and unload
setvar! recall_home_now 0
if diffweight <= max_diffweight_before_unloading and findtype ORES backpack or findtype INGOTS backpack
    sysmsg 'HEAVY. GOING HOME TO UNLOAD' 54
    setvar! recall_home_now 1
endif



########################################
# SUMMON BEFORE STARTING
########################################

# PS: this is important so char do3enst recall first then summon later, having chance to recall into a mob and dying without summons to guard him
# this is just a print to inform char is under summon_limit and is getting ready to summon up
if auto_summon == 1 and followers < summon_max_limit
    sysmsg 'UNDER SUMMON LIMIT. PREPARING TO SUMMON...' alert_msg_color

    foreach summon in 'summons'
        if list 'summons' == 1 and followers == 4
            if verbose == 1
                sysmsg 'SUMMONS LIST ONLY HAS 1 SUMMON TYPE AND CHAR ALREADY HAVE 4 HAVE FOLLOWERS {{summon}}' warning_msg_color
            endif

            if debug == 1
                sysmsg 'BREAKING 1 ON CHECKING SUMMON {{summon}}' warning_msg_color
            endif
            break
        elseif list 'summons' > 1 and followers == 5
            if verbose == 1
                sysmsg 'SUMMONS LIST ONLY HAS 1 SUMMON TYPE AND CHAR ALREADY HAVE 5 HAVE FOLLOWERS {{summon}}' warning_msg_color
            endif

            if debug == 1
                sysmsg 'BREAKING 2 ON CHECKING SUMMON {{summon}}' warning_msg_color
            endif
            break
        endif

        unsetvar! found_summon
        unsetvar! cast_summon_spell

        # determine summon name by whether char has necromancy or not
        if use_undead_summons == 1
            # on each iteration, clear and populate this list to set the undead alternative summon based on current summon
            if not listexists 'undead_summons'
                createlist 'undead_summons'
            endif
            clearlist 'undead_summons'

            if 'earth' in summon
                pushlist 'undead_summons' 'an ancient mummy'
            elseif 'fire' in summon
                pushlist 'undead_summons' 'a lich'
            elseif 'air' in summon
                pushlist 'undead_summons' 'a skeletal fiend'
            elseif 'daemon' in summon
                pushlist 'undead_summons' 'a vampire thrall'
            elseif 'water' in summon
                pushlist 'undead_summons' 'a rag witch'
            endif

            # if char is necro, make sure vengeful spirit is activated before summoning
            if list 'undead_summons' > 0
                if timer 'vengeful_spirit_timer' >= 30000
                    if verbose == 1
                        sysmsg '>>> VENGEFUL SPIRIT...' spell_msg_color
                    endif
                    say '[vengefulspirit'

                    wait action_delay

                    if verbose == 1
                        sysmsg '>>> WITHER...' spell_msg_color
                    endif

                    say '[wither'
                    settimer 'vengeful_spirit_timer' 0
                else
                    if verbose == 1
                        sysmsg 'Vengeful Spirit Cooldown..' on_cooldown_msg_color
                    endif
                endif
            endif
        endif


        #########################
        # try to find a similir creature summon to see if we need to cast this one or skip to next one


        if findtype summon ground any 1 find_summon_range as summonserial
            if noto summonserial = friend
                if verbose == 1
                    overhead '*found {{summon}}*' 91 summonserial
                endif

                setvar! found_summon true
            endif
        # if the 'undead_summons' list has elements, we need to check for those undead summons as well
        elseif use_undead_summons == 1
            if list 'undead_summons' > 0
                foreach necro_summon in 'undead_summons'
                    if findtype necro_summon ground any 1 find_summon_range as summonserial
                        if noto summonserial = friend
                            overhead '*found {{summon}}*' 91 summonserial
                            setvar! found_summon true

                            # TESTING HERE (this break was disabled before)
                            # break
                        endif
                    endif
                endfor
            endif
        endif

        # even if we found this summon type, we still might need to cast it (if only 1 summon in list for instance)
        if varexist found_summon
            # clearlist 'found_summon'

            # if theres only one summon in the 'summons' list, even if we found the summon above,
            # we still need to cast it again
            if list 'summons' == 1 and followers < 4
                setvar! cast_summon_spell true
            # if one of our summons is summ creature and we only have 3 followers, we can still cast another more usefull
            # summon before actually casting summ.creature
            elseif list 'summons' == 2 and followers <= 3 and inlist 'summons' 'summ. creature'
                setvar! cast_summon_spell 1
            elseif list 'summons' >= 3 and followers <= 1
                setvar! cast_summon_spell 1
            # else if theres more than one summon in 'summons' list and we didnt find this specific summon
            # we need to cast ig
            endif
        else
            if verbose == 1
                sysmsg '[DEBUG] {{summon}} NOT FOUND. CASTING' debug_msg_color
            endif

            setvar! cast_summon_spell 1
        endif

        #########################
        # prepare to cast the summon spell for this summon
        if cast_summon_spell == 1
            foreach summonspell in 'summonspells'
                if summonspell in summon
                    unsetvar! summon_spell_required_mana

                    # first make a mana check for this specific summon spell
                    if 'creature' in summonspell or 'blade' in summonspell
                        setvar! 'summon_spell_required_mana' 14
                    else
                        setvar! 'summon_spell_required_mana' 50
                    endif

                    if varexist summon_spell_required_mana
                        if mana < summon_spell_required_mana

                            if timer 'low_mana_for_summoning_warning_msg_timer' >= 2000
                                if verbose == 1
                                    sysmsg "!!! LOW MANA FOR SUMMONING {{summon}}. (NEEDS {{summon_spell_required_mana}})..." alert_msg_color
                                    overhead "low mana for summoning" alert_msg_color
                                endif

                                settimer 'low_mana_for_summoning_warning_msg_timer' 0
                            endif
                        else
                            if verbose == 1
                                sysmsg ">>> SUMMONING {{summon}}..." action_msg_color
                            endif

                            # temporary fix for bug when char keeps trying to cast a 2 slot summon when only 1 slot available
                            if followers == 4 and inlist 'summons' 'summ. creature'
                                cast 'Summ. Creature'
                            else
                                cast summonspell
                            endif

                            if 'blade' in summonspell or 'vortex' in summonspell
                                if verbose == 1
                                    sysmsg 'WAITING FOR {{summonspell}} TARGET..' alert_msg_color
                                    overhead 'Waiting for {{summonspell}} target..' alert_msg_color
                                endif

                                @settimer 'waiting_summon_timer' 0
                                while not targetexists 'neutral' and timer 'waiting_summon_timer' < cast_summons_delay
                                    wft 10
                                    if insysmsg 'disturbed'
                                        @settimer 'waiting_summon_timer' 0
                                        if verbose == 1
                                            sysmsg 'BREAKING WHILE WAITING FOR SUMMONING {{summon}}' alert_msg_color
                                        endif

                                        wait spell_recovery_delay
                                        break
                                    endif
                                endwhile

                                if targetexists 'neutral'
                                    if verbose == 1
                                        sysmsg 'CASTING BLADE OR VORTEX IN GROUND' 55
                                    endif

                                    targetrelloc 0 1
                                    break
                                endif
                            else
                                @settimer 'waiting_summon_timer' 0
                                while timer 'waiting_summon_timer' < cast_summons_delay
                                    wait 10
                                    if insysmsg 'disturbed'
                                        @settimer 'waiting_summon_timer' 0
                                        if verbose == 1
                                            sysmsg 'BREAKING WHILE WAITING FOR SUMMONING {{summon}}' alert_msg_color
                                        endif

                                        wait spell_recovery_delay
                                        break
                                    endif
                                endwhile

                                say 'all guard me'
                            endif

                            break

                        endif
                    endif
                endif
            endfor
        endif
    endfor
# CLOSES auto_summon
endif


########################################
# STARTING LOOPING THE RUNEBOOKS
########################################

settimer 'mining_uptime' 0
setvar! possible_captcha_detected 0

setvar! rune_number 10

# trigger the cooldown once at start so char can start mining
cooldown RESOURCES 30000

# endif
# END if varexist setting_rail

###########################################

foreach runebook in 'mining_runetomes'
    if runebook != 0
        sysmsg '>>> STARTING RUNETOME {{index}}: {{runebook}}'
    endif

    if index == 1
        setvar! runebook_number 1
    elseif index == 2
        setvar! runebook_number 2
    elseif index == 3
        setvar! runebook_number 3
    elseif index == 4
        setvar! runebook_number 4
    endif

    foreach page_number in 'runetome_page_numbers'
        if page_number == 200
            setvar! current_rune_position 1
        elseif page_number == 201
            setvar! current_rune_position 2
        elseif page_number == 202
            setvar! current_rune_position 3
        elseif page_number == 203
            setvar! current_rune_position 4
        elseif page_number == 204
            setvar! current_rune_position 5
        elseif page_number == 205
            setvar! current_rune_position 6
        elseif page_number == 206
            setvar! current_rune_position 7
        elseif page_number == 207
            setvar! current_rune_position 8
        elseif page_number == 208
            setvar! current_rune_position 9
        elseif page_number == 209
            setvar! current_rune_position 10
        elseif page_number == 210
            setvar! current_rune_position 11
        elseif page_number == 211
            setvar! current_rune_position 12
        elseif page_number == 212
            setvar! current_rune_position 13

        # runebook page 2
        elseif page_number == 213
            setvar! current_rune_position 14
        elseif page_number == 214
            setvar! current_rune_position 15
        elseif page_number == 215
            setvar! current_rune_position 16
        elseif page_number == 216
            setvar! current_rune_position 17
        elseif page_number == 217
            setvar! current_rune_position 18
        elseif page_number == 218
            setvar! current_rune_position 19
        elseif page_number == 219
            setvar! current_rune_position 20
        elseif page_number == 220
            setvar! current_rune_position 21
        elseif page_number == 221
            setvar! current_rune_position 22
        elseif page_number == 222
            setvar! current_rune_position 23
        elseif page_number == 223
            setvar! current_rune_position 24
        elseif page_number == 224
            setvar! current_rune_position 25
        elseif page_number == 225
            setvar! current_rune_position 26
        endif

        if runebook != 0
            sysmsg 'RUNE: {{current_rune_position}} (PAGE: {{page_number}})' 90
        endif


        if auto_cycle_runetomes == 1 and recall_home_now != 1
            # travel to the rune

            # meditate before travel if needed
            while mana <= 11
                sysmsg 'MEDITATING TO RECALL' warning_msg_color
                if not findbuff 'actively meditating'
                    skill meditation
                    wait action_delay
                endif
                wait action_delay
            endwhile

            sysmsg 'OPENING RUNEBOOK {{runebook}}'
            dclick runebook

            settimer 'waiting_runebook_gump_timer' 0
            if not gumpexists runetome_gump_id and timer 'waiting_runebook_gump_timer' < 2000
                if insysmsg 'You must wait'
                    while insysmsg 'You must wait'
                        clearsysmsg
                        dclick steal_container
                        wait action_delay
                    endwhile
                endif

                sysmsg 'waiting_runebook_gump_timer'
                while not gumpexists runetome_gump_id and timer 'waiting_runebook_gump_timer' < 2000
                    waitforgump runetome_gump_id action_delay
                endwhile
            endif

            if gumpexists runetome_gump_id
                waitforgump runetome_gump_id action_delay
                gumpresponse page_number runetome_gump_id
                waitforgump runetome_gump_id action_delay
                sysmsg 'TRAVELLING RUNEBOOK {{runebook}} PAGE NUMBER {{page_number}} RUNE: {{rune_number}}'
                gumpresponse rune_number runetome_gump_id
                wait recall_travel_time
            else
                sysmsg 'COULDNT OPEN RUNEBOOK TO TRAVEL!' 37
            endif
        endif

        # BEFORE EVERY START
        setvar! reset_last_sysmsg_timer 0
        settimer 'last_sysmsg_timer' 0

        setvar! attempts_to_find_new_ore_veins 0

        say 'all guard me'
        wait action_delay
        setvar! failed_rail_attempts 0


        while not dead 'self'

            setvar! main_loop_index index

            # remember player the loop is active every 60s
            if timer 'loop_on_warning_msg' >= 60000
                settimer 'loop_on_warning_msg' 0
                sysmsg 'Mining Bot by gugutz.' 89
                sysmsg 'Last captcha was: {{last_gump_tracking_timer}}ms ago' stats_msg_color
                sysmsg 'Uptime: {{mining_uptime}}ms' stats_msg_color
                sysmsg 'Current Runebook: {{runebook_number}}' stats_msg_color
                sysmsg 'Current Rune: {{current_rune_position}}' stats_msg_color
                #if list 'problematic_rails' > 0
                #    sysmsg 'Problematic Rails:'
                #    foreach x in 'problematic_rails'
                #        sysmsg x stats_msg_color
                #    endfor
                #endif


                # sysmsg '************************' 90
            endif

            if not cooldown RESOURCES
                if timer 'waiting_cooldown_timer' > max_wait_for_last_sysmsg_to_suspect_gump
                    settimer 'waiting_cooldown_timer' 0
                    if possible_captcha_detected == 0
                        setvar! possible_captcha_detected 1
                        settimer 'last_gump_tracking_timer' 0
                    endif

                    overhead "✩ GUMP PRESENT or LAGGED ✩" 33
                    sysmsg "✩ GUMP PRESENT or LAGGED ✩" 33
                    sysmsg "✩ GUMP PRESENT or LAGGED ✩" 34
                    sysmsg "✩ GUMP PRESENT or LAGGED ✩" 35


                    # play an instrument as a way of playing a sound to notify about the captcha
                    if findtype 3763|3740|10245|3742|3762 backpack as instrument
                        wait action_delay
                        dclick instrument
                        wait action_delay
                    endif
                else
                    wait 10
                endif
            endif

            # TOGGLE LANTERN TO MAKE CHAR SKIP CURRENT RUNE
            if findtype 2594|2598|2578|30580 self
            elseif not findtype 2597|3947 backpack and findtype 2597|3947 self as lights
                sysmsg '[LANTERN OFF] SKIPING TO NEXT RUNE' 54
                wait action_delay
                dclick lights
                wait action_delay
                setvar! go_to_next_rune 1
            endif

            ########################################
            # MOST IMPORTANT ROUTINE - KEEP SUMMONS UP!
            ########################################

            # this is just a print to inform char is under summon_limit and is getting ready to summon up
            if auto_summon == 1 and followers < summon_max_limit
                if verbose == 1
                    sysmsg 'UNDER SUMMON LIMIT. PREPARING TO SUMMON...' alert_msg_color
                endif

                foreach summon in 'summons'
                    # if debug == 1
                    #     sysmsg 'CHECKING {{summon}}: {{index}}' default_sysmsg_color
                    # endif

                    if list 'summons' == 1 and followers == 4
                        if verbose == 1
                            sysmsg 'SUMMONS LIST ONLY HAS 1 SUMMON TYPE AND CHAR ALREADY HAVE 4 HAVE FOLLOWERS {{summon}}' warning_msg_color
                        endif

                        if debug == 1
                            sysmsg 'BREAKING 1 ON CHECKING SUMMON {{summon}}' warning_msg_color
                        endif
                        break
                    elseif list 'summons' > 1 and followers == 5
                        if verbose == 1
                            sysmsg 'SUMMONS LIST ONLY HAS 1 SUMMON TYPE AND CHAR ALREADY HAVE 5 HAVE FOLLOWERS {{summon}}' warning_msg_color
                        endif

                        if debug == 1
                            sysmsg 'BREAKING 2 ON CHECKING SUMMON {{summon}}' warning_msg_color
                        endif
                        break
                    endif

                    unsetvar! found_summon
                    setvar! cast_summon_spell 0

                    # determine summon name by whether char has necromancy or not
                    if use_undead_summons == 1
                        # on each iteration, clear and populate this list to set the undead alternative summon based on current summon
                        if not listexists 'undead_summons'
                            createlist 'undead_summons'
                        endif
                        clearlist 'undead_summons'

                        if 'earth' in summon
                            pushlist 'undead_summons' 'an ancient mummy'
                        elseif 'fire' in summon
                            pushlist 'undead_summons' 'a lich'
                        elseif 'air' in summon
                            pushlist 'undead_summons' 'a skeletal fiend'
                        elseif 'daemon' in summon
                            pushlist 'undead_summons' 'a vampire thrall'
                        elseif 'water' in summon
                            pushlist 'undead_summons' 'a rag witch'
                        endif

                        # if char is necro, make sure vengeful spirit is activated before summoning
                        if list 'undead_summons' > 0
                            if timer 'vengeful_spirit_timer' >= 30000
                                if verbose == 1
                                    sysmsg '>>> VENGEFUL SPIRIT...' spell_msg_color
                                endif
                                say '[vengefulspirit'

                                wait action_delay

                                if verbose == 1
                                    sysmsg '>>> WITHER...' spell_msg_color
                                endif

                                say '[wither'
                                settimer 'vengeful_spirit_timer' 0
                            else
                                if verbose == 1
                                    sysmsg 'Vengeful Spirit Cooldown..' on_cooldown_msg_color
                                endif
                            endif
                        endif
                    endif


                    #########################
                    # try to find a similir creature summon to see if we need to cast this one or skip to next one


                    if findtype summon ground any 1 find_summon_range as summonserial
                        if noto summonserial = friend
                            if verbose == 1
                                overhead '*found {{summon}}*' 91 summonserial
                            endif

                            setvar! found_summon true
                        endif
                    # if the 'undead_summons' list has elements, we need to check for those undead summons as well
                    elseif use_undead_summons == 1
                        if list 'undead_summons' > 0
                            foreach necro_summon in 'undead_summons'
                                if findtype necro_summon ground any 1 find_summon_range as summonserial
                                    if noto summonserial = friend
                                        overhead '*found {{summon}}*' 91 summonserial
                                        setvar! found_summon true

                                        # TESTING HERE (this break was disabled before)
                                        # break
                                    endif
                                endif
                            endfor
                        endif
                    endif

                    # even if we found this summon type, we still might need to cast it (if only 1 summon in list for instance)
                    if varexist found_summon
                        # clearlist 'found_summon'

                        # if theres only one summon in the 'summons' list, even if we found the summon above,
                        # we still need to cast it again
                        if list 'summons' == 1 and followers < 4
                            setvar! cast_summon_spell 1
                        # if one of our summons is summ creature and we only have 3 followers, we can still cast another more usefull
                        # summon before actually casting summ.creature
                        elseif list 'summons' == 2 and followers <= 3 and inlist 'summons' 'summ. creature'
                            setvar! cast_summon_spell 1
                        elseif list 'summons' >= 3 and followers <= 1
                            setvar! cast_summon_spell 1
                        # else if theres more than one summon in 'summons' list and we didnt find this specific summon
                        # we need to cast ig
                        endif
                    else
                        if debug == 1
                            sysmsg '[DEBUG] setting to cast summon spell (summon not found)' debug_msg_color
                        endif
                        setvar! cast_summon_spell 1
                    endif

                    #########################
                    # prepare to cast the summon spell for this summon
                    if cast_summon_spell == 1
                        foreach summonspell in 'summonspells'
                            if summonspell in summon
                                unsetvar! summon_spell_required_mana

                                # first make a mana check for this specific summon spell
                                if 'creature' in summonspell or 'blade' in summonspell
                                    setvar! 'summon_spell_required_mana' 14
                                else
                                    setvar! 'summon_spell_required_mana' 50
                                endif

                                if varexist summon_spell_required_mana
                                    if mana < summon_spell_required_mana

                                        if timer 'low_mana_for_summoning_warning_msg_timer' >= 2000
                                            if verbose == 1
                                                sysmsg "!!! LOW MANA FOR SUMMONING {{summon}}. (NEEDS {{summon_spell_required_mana}})..." alert_msg_color
                                                overhead "low mana for summoning" alert_msg_color
                                            endif

                                            settimer 'low_mana_for_summoning_warning_msg_timer' 0
                                        endif
                                    else
                                        if verbose == 1
                                            sysmsg ">>> SUMMONING {{summon}}..." action_msg_color
                                        endif

                                        # temporary fix for bug when char keeps trying to cast a 2 slot summon when only 1 slot available
                                        if followers == 4 and inlist 'summons' 'summ. creature'
                                            cast 'Summ. Creature'
                                        else
                                            cast summonspell
                                        endif

                                        if 'blade' in summonspell or 'vortex' in summonspell
                                            if verbose == 1
                                                sysmsg 'WAITING FOR {{summonspell}} TARGET..' alert_msg_color
                                                overhead 'Waiting for {{summonspell}} target..' alert_msg_color
                                            endif

                                            @settimer 'waiting_summon_timer' 0
                                            while not targetexists 'neutral' and timer 'waiting_summon_timer' < cast_summons_delay
                                                wft 10
                                                if insysmsg 'disturbed'
                                                    @settimer 'waiting_summon_timer' 0
                                                    if verbose == 1
                                                        sysmsg 'BREAKING WHILE WAITING FOR SUMMONING {{summon}}' alert_msg_color
                                                    endif

                                                    wait spell_recovery_delay
                                                    break
                                                endif
                                            endwhile

                                            if targetexists 'neutral'
                                                if verbose == 1
                                                    sysmsg 'CASTING BLADE OR VORTEX IN GROUND' 55
                                                endif

                                                targetrelloc 0 1
                                                break
                                            endif
                                        else
                                            @settimer 'waiting_summon_timer' 0
                                            while timer 'waiting_summon_timer' < cast_summons_delay
                                                wait 10
                                                if insysmsg 'disturbed'
                                                    @settimer 'waiting_summon_timer' 0
                                                    if verbose == 1
                                                        sysmsg 'BREAKING WHILE WAITING FOR SUMMONING {{summon}}' alert_msg_color
                                                    endif

                                                    wait spell_recovery_delay
                                                    break
                                                endif
                                            endwhile

                                            say 'all guard me'
                                        endif

                                        break

                                    endif
                                endif
                            endif
                        endfor

                        setvar! reset_last_sysmsg_timer 1
                    # CLOSES if varexist cast_summon_spell

                    endif
                endfor
            # CLOSES auto_summon
            endif


            #####################################
            # KEEP MOBS GUARDING PLAYER
            #####################################

            # TESTING also checking if dead so it doenst all guard before the 2 all follows for luring current lasttarget
            # if auto_all_guard == 1 and timer 'all_guard_timer' >= all_guard_delay
            # if auto_all_guard == 1 and timer 'all_guard_timer' >= all_guard_delay
            #     say 'all guard me'
            #     settimer 'all_guard_timer' 0
            #     # setvar! reset_last_sysmsg_timer 1
            # endif


            #####################################
            # DRAIN CORPSES NEARBY TO EXTEND SUMMONS LIFE
            #####################################

            if timer 'spirit_speak_cooldown_timer' > 1000
                settimer 'spirit_speak_cooldown_timer' 0
                if findtype 'corpse' ground any any 10 as body
                    if not inlist 'drained_corpses' body
                        if verbose_mode == 1
                            sysmsg '>>> DRANING NEARBY CORPSES' action_msg_color
                            overhead '*spirit speak*' action_msg_color
                        endif

                        skill 'spirit'
                        # avoiding using global ignore here, switching to list control to avoid imprevisiblities
                        @pushlist 'drained_corpses' body
                        wait action_delay
                        # @ignore body
                    endif
                endif
            endif

            ########################################
            # KEEP CHAR BUFFED UP
            ########################################

            # reflect buff
            if followers >= summon_max_limit and diffhits < max_diffhits_before_buffing
                if use_magic_reflection == 1 and not findbuff 'magic reflection' and mana >= 4th_circle_spell_mana_cost
                    sysmsg '>>> MAGIC REFLECT' spell_msg_color
                    cast 'magic reflection'

                    @settimer 'waiting_spell_timer' 0
                    while not findbuff 'magic reflection' and timer 'waiting_spell_timer' < 3000
                        wait 10
                        if insysmsg 'disturbed' or insysmsg 'spell will not adhere' or insysmsg 'cannot cast a spell'
                            sysmsg 'BREAKING WHILE WAITING FOR MAGIC REFLECTION' warning_msg_color
                            wait spell_recovery_delay
                            break
                        endif
                    endwhile

                    wait spell_recovery_delay

                    if findbuff 'magic reflection'
                        overhead '+MAGIC REFLECT' buff_msg_color
                    endif
                endif

            endif

            # reactive armor buff
            if followers >= summon_max_limit and diffhits < max_diffhits_before_buffing
                if use_reactive_armor == 1 and not findbuff 'reactive armor' and mana >= 3rd_circle_spell_mana_cost
                    if verbose == 1
                        sysmsg '>>> REACTIVE ARMOR' spell_msg_color
                    endif

                    cast 'reactive armor'
                    @settimer 'waiting_spell_timer' 0
                    while not findbuff 'reactive armor' and timer 'waiting_spell_timer' < 2000
                        wait 10
                        if insysmsg 'disturbed' or insysmsg 'spell will not adhere' or insysmsg 'cannot cast a spell'
                            if verbose == 1
                                sysmsg 'BREAKING WHILE WAITING FOR REACTIVE ARMOR' warning_msg_color
                            endif

                            wait spell_recovery_delay
                            break
                        endif
                    endwhile

                    wait spell_recovery_delay

                    if findbuff 'reactive armor'
                        overhead '+reactive' buff_msg_color
                    endif

                endif
            endif



            ########################################
            # MAIN MINING ROUTINE
            ########################################

            if is_detecter == 1
                useskill 'detectinghidden'
                wait action_delay
                if targetexists 'neutral'
                    target self
                endif

                if insysmsg 'you reveal what was hidden.'
                    sysmsg '!FOUND HIDDEN PLAYER!' alert_msg_color
                    sysmsg '> FOUND HIDDEN PLAYER! PROBABLY THIEF!' alert_msg_color
                endif
            endif

            # this piece has to run after using detecting hiden to find the player revealed
            if auto_escape_thiefs == 1
                sysmsg '▷ SEARCHING FOR GREY PLAYERS ON SCREEN'
                # hotkey 'Clear Target Queue'
                hotkey 'Next Grey Player Target'
                if insysmsg 'New target'
                    sysmsg '> FOUND THIEF! ESCAPING!' alert_msg_color
                    setvar! recall_home_now 1
                endif
            endif

            # try to get pks that already appeared on screen and couldnt get tracked first
            if auto_escape_pks_on_screen == 1
                sysmsg '▷ SEARCHING FOR PKS ON SCREEN'
                # hotkey 'Clear Target Queue'
                hotkey 'Next Murderer Player Target'
                if insysmsg 'New target'
                    sysmsg '!!!!!!! FOUND PK! RUN!!!!!!!' alert_msg_color
                    sysmsg '!!!!!!! FOUND PK! RUN!!!!!!!' alert_msg_color
                    sysmsg '!!!!!!! FOUND PK! RUN!!!!!!!' alert_msg_color
                    sysmsg '!!!!!!! FOUND PK! RUN!!!!!!!' alert_msg_color

                    overhead '!!!!!!! FOUND PK! RUN!!!!!!!' alert_msg_color
                    overhead '!!!!!!! FOUND PK! RUN!!!!!!!' alert_msg_color
                    overhead '!!!!!!! FOUND PK! RUN!!!!!!!' alert_msg_color
                    overhead '!!!!!!! FOUND PK! RUN!!!!!!!' alert_msg_color

                    setvar! recall_home_now 1
                endif

                if cooldown 'UNDER ATTACK' or insysmsg 'Attacking you'
                    if verbose == 1
                        sysmsg '>>> BEING ATTACKED! TRYING TO ESCAPE...' alert_msg_color
                        sysmsg '>>> BEING ATTACKED! TRYING TO ESCAPE...' alert_msg_color
                        sysmsg '>>> BEING ATTACKED! TRYING TO ESCAPE...' alert_msg_color
                        sysmsg '>>> BEING ATTACKED! TRYING TO ESCAPE...' alert_msg_color
                    endif

                    setvar! recall_home_now 1
                endif
            endif

            # if cooldown 'OUT OF REGS' > 0
            #     sysmsg 'OUT OF REGS! GONNA TRAVEL HOME TO RESSUPLY' 54
            #     setvar! recall_home_now 1
            # endif

            # check and equip pickaxe if needed
            if rhandempty
                if findtype 'pickaxe' true
                    dclicktype 'pickaxe'
                    overhead "✩equiped new pickaxe✩"
                    wait 1500
                else
                    overhead "✩OUT OF PICKAXES✩" 40
                    sysmsg "OUT OF PICKAXES! GOING HOME TO RESSUPLY!" warning_msg_color
                    setvar! recall_home_now 1
                endif
            endif

            if cooldown RESOURCES and recall_home_now != 1
                settimer 'waiting_cooldown_timer' 0

                if possible_captcha_detected == 1
                    setvar! possible_captcha_detected 0
                endif


                # mine
                if not rhandempty and cooldown RESOURCES
                    sysmsg '>>> ITEM IN RIGHT HAND... ' 87
                    cooldown RESOURCES 0

                    clearsysmsg
                    settimer 'waiting_journal_timer' 0
                    hotkey 'Use Item in Right Hand'
                    while timer 'waiting_journal_timer' < action_delay
                        if insysmsg 'must wait'
                            while insysmsg 'must wait'
                                sysmsg 'MUST WAIT FIX!!!!!!!!!!!!!'
                                clearsysmsg
                                hotkey 'Use Item in Right Hand'
                                wait action_delay
                            endwhile
                            sysmsg 'break 4'
                            break
                        elseif insysmsg 'dig some'
                            sysmsg 'break 1'
                            break
                        elseif insysmsg 'loosen some rocks'
                            sysmsg 'break 2'
                            break
                        elseif insysmsg 'You have recently traveled'
                            sysmsg 'break 3'
                            break
                        endif
                        # clearsysmsg
                        # sysmsg 'aqui dentro'
                        wait 10
                    endwhile
                    sysmsg 'SAIU MUST WAIT 1'

                    while insysmsg 'must wait'
                        clearsysmsg
                        sysmsg '>>>>>>>>>>>>> ITEM IN HAND (MUST WAIT... ' 89

                        clearsysmsg
                        settimer 'waiting_journal_timer' 0
                        hotkey 'Use Item in Right Hand'
                        while timer 'waiting_journal_timer' < action_delay
                            if insysmsg 'must wait'
                                sysmsg 'break 4'
                                break
                            elseif insysmsg 'dig some'
                                sysmsg 'break 1'
                                break
                            elseif insysmsg 'loosen some rocks'
                                sysmsg 'break 2'
                                break
                            elseif insysmsg 'You have recently traveled'
                                sysmsg 'break 3'
                                break
                            endif
                            # clearsysmsg
                            # sysmsg 'aqui dentro'
                            wait 10
                        endwhile
                    endwhile
                    sysmsg 'SAIU MUST WAIT 2'

                endif

                #############################################
                # SMELTING ROUTINE
                #
                # smelt if close to a forge

                if auto_smelt_ores_when_close_to_forges == 1

                    # only start smelting routine if either char or packies have ores in them
                    if findtype ORES backpack
                        setvar! enter_smelting_routine 1
                    else
                        # smelt ores in pack animals
                        foreach packanimal in 'packies'
                            if findtype ORES packanimal
                                setvar! enter_smelting_routine 1
                                break
                            endif
                        endfor
                    endif

                    if varexist enter_smelting_routine
                        unsetvar! enter_smelting_routine

                        if findtype 'forge' ground any any 2 as forg
                            setvar! smelt_ores_now 1
                        elseif findtype 0x1996 ground any any 2 as forg
                            setvar! smelt_ores_now 1

                        # shelter island forge
                        elseif position 1979 2554
                            setvar! smelt_ores_now 1
                        # mining cave near andaria
                        elseif position 1916 744 or position 1916 743
                            setvar! smelt_ores_now 1
                        # placeholder
                        elseif position 1916 744 or position 1916 743
                            setvar! smelt_ores_now 1
                        # brigand camp 2 mine 1, near Horseshoe 01
                        elseif position 2108 2220 or position 2108 2221 or position 2108 2222 or position 2108 2223 or position 2108 2224
                            setvar! smelt_ores_now 1
                        elseif position 2107 2220 or position 2107 2221 or position 2107 2222 or position 2107 2223 or position 2107 2224
                            setvar! smelt_ores_now 1
                        elseif position 2106 2220 or position 2106 2221 or position 2106 2222 or position 2106 2223 or position 2106 2224
                            setvar! smelt_ores_now 1
                        elseif position 2105 2220 or position 2105 2221 or position 2105 2222 or position 2105 2223 or position 2105 2224
                            setvar! smelt_ores_now 1
                        elseif position 2104 2220 or position 2104 2221 or position 2104 2222 or position 2104 2223 or position 2104 2224
                            setvar! smelt_ores_now 1
                        # brigand camp 2 mine 1, near Horseshoe 02
                        elseif position 2115 2177 or position 2115 2176 or position 2115 2175 or position 2115 2174 or position 2115 2173
                            setvar! smelt_ores_now 1
                        elseif position 2114 2177 or position 2114 2176 or position 2114 2175 or position 2114 2174 or position 2114 2173
                            setvar! smelt_ores_now 1
                        elseif position 2113 2177 or position 2113 2176 or position 2113 2175 or position 2113 2174 or position 2113 2173
                            setvar! smelt_ores_now 1
                        elseif position 2112 2177 or position 2112 2176 or position 2112 2175 or position 2112 2174 or position 2112 2173
                            setvar! smelt_ores_now 1
                        elseif position 2111 2177 or position 2111 2176 or position 2111 2175 or position 2111 2174 or position 2111 2173
                            setvar! smelt_ores_now 1
                        # brigand camp 2 mine 1, near Horseshoe 03
                        elseif position 2143 2166 or position 2143 2165 or position 2143 2164 or position 2143 2163 or position 2143 2162
                            setvar! smelt_ores_now 1
                        elseif position 2142 2166 or position 2142 2165 or position 2142 2164 or position 2142 2163 or position 2142 2162
                            setvar! smelt_ores_now 1
                        elseif position 2141 2166 or position 2141 2165 or position 2141 2164 or position 2141 2163 or position 2141 2162
                            setvar! smelt_ores_now 1
                        elseif position 2140 2166 or position 2140 2165 or position 2140 2164 or position 2140 2163 or position 2140 2162
                            setvar! smelt_ores_now 1
                        elseif position 2139 2166 or position 2139 2165 or position 2139 2164 or position 2139 2163 or position 2139 2162
                            setvar! smelt_ores_now 1
                        elseif position 2105 2222 or position 2104 2222 or position 2104 2223 or position 2104 2224
                            setvar! smelt_ores_now 1
                        # brigand camp 2 mine 1, near cambria
                        elseif position 1531 2708 or position 1530 2709 or position 1532 2710
                            setvar! smelt_ores_now 1
                        elseif position 1524 2699 or position 1525 2698
                            setvar! smelt_ores_now 1
                        # brigand camp 2 mine 2, near cambria
                        elseif position 1560 2670 or position 1561 2672
                            setvar! smelt_ores_now 1
                        elseif position 1564 2654 or position 1563 2653
                            setvar! smelt_ores_now 1
                        # mine 1, near cambria 01
                        elseif position 1565 2652 or position 1565 2653 or position 1565 2654 or position 1565 2655 or position 1565 2656
                            setvar! smelt_ores_now 1
                        elseif position 1564 2652 or position 1564 2653 or position 1564 2654 or position 1564 2655 or position 1564 2656
                            setvar! smelt_ores_now 1
                        elseif position 1563 2652 or position 1563 2653 or position 1563 2654 or position 1563 2655 or position 1563 2656
                            setvar! smelt_ores_now 1
                        elseif position 1562 2652 or position 1562 2653 or position 1562 2654 or position 1562 2655 or position 1562 2656
                            setvar! smelt_ores_now 1
                        elseif position 1561 2652 or position 1561 2653 or position 1561 2654 or position 1561 2655 or position 1561 2656
                            setvar! smelt_ores_now 1
                        elseif position 1562 2669 or position 1562 2670 or position 1562 2671 or position 1562 2672 or position 1562 2673
                            setvar! smelt_ores_now 1
                        elseif position 1561 2669 or position 1561 2670 or position 1561 2671 or position 1561 2672 or position 1561 2673
                            setvar! smelt_ores_now 1
                        elseif position 1560 2669 or position 1560 2670 or position 1560 2671 or position 1560 2672 or position 1560 2673
                            setvar! smelt_ores_now 1
                        elseif position 1559 2669 or position 1559 2670 or position 1559 2671 or position 1559 2672 or position 1559 2673
                            setvar! smelt_ores_now 1
                        elseif position 1558 2669 or position 1558 2670 or position 1558 2671 or position 1558 2672 or position 1558 2673
                            setvar! smelt_ores_now 1
                        # mine 2, near cambria
                        elseif position 1533 2707 or position 1533 2708 or position 1533 2709 or position 1533 2710 or position 1533 2711
                            setvar! smelt_ores_now 1
                        elseif position 1532 2707 or position 1532 2708 or position 1532 2709 or position 1532 2710 or position 1532 2711
                            setvar! smelt_ores_now 1
                        elseif position 1531 2707 or position 1531 2708 or position 1531 2709 or position 1531 2710 or position 1531 2711
                            setvar! smelt_ores_now 1
                        elseif position 1530 2707 or position 1530 2708 or position 1530 2709 or position 1530 2710 or position 1530 2711
                            setvar! smelt_ores_now 1
                        elseif position 1529 2707 or position 1529 2708 or position 1529 2709 or position 1529 2710 or position 1529 2711
                            setvar! smelt_ores_now 1

                        elseif position 1526 2696 or position 1526 2697 or position 1526 2698 or position 1526 2699 or position 1526 2700
                            setvar! smelt_ores_now 1
                        elseif position 1525 2696 or position 1525 2697 or position 1525 2698 or position 1525 2699 or position 1525 2700
                            setvar! smelt_ores_now 1
                        elseif position 1524 2696 or position 1524 2697 or position 1524 2698 or position 1524 2699 or position 1524 2700
                            setvar! smelt_ores_now 1
                        elseif position 1523 2696 or position 1523 2697 or position 1523 2698 or position 1523 2699 or position 1523 2700
                            setvar! smelt_ores_now 1
                        elseif position 1522 2696 or position 1522 2697 or position 1522 2698 or position 1522 2699 or position 1522 2700
                            setvar! smelt_ores_now 1
                        # necromancers swamp nearby mines
                        elseif position 1916 713 or position 1916 714 or position 1915 715
                            setvar! smelt_ores_now 1
                        elseif position 1935 700 or position 1937 700 or position 1937 699
                            setvar! smelt_ores_now 1
                        elseif position 1889 739 or position 1889 740 or position 1888 740
                            setvar! smelt_ores_now 1
                        # orc fort mines (near orc fort / honor shrine)
                        elseif position 1194 1066 or position 1194 1065 or position 1193 1065
                            setvar! smelt_ores_now 1
                        elseif position 1340 1189 or position 1340 1188 or position 1339 1188
                            setvar! smelt_ores_now 1

                        endif



                        if varexist smelt_ores_now
                            unsetvar! smelt_ores_now
                            overhead 'close to forge!'

                            # smelt ores in backpack
                            if smelt_colored_ores == 0
                                setvar! ore_hue 1
                            else
                                setvar! ore_hue -1
                            endif

                            while findtype ORES backpack ore_hue as ores
                                sysmsg 'CLOSE TO FORGE -> TRYING TO SMELT' 54
                                if insysmsg 'You do not see any nearby forges to smelt this ore on'
                                    overhead 'got far from forge!' 41
                                    sysmsg 'Got Far From Forge! Breaking smelting loop...' 41
                                    break
                                endif

                                if smelt_colored_ores == 0
                                    if hue ores == 0
                                        setvar! smelt_this_ore 1
                                    endif
                                else
                                    setvar! smelt_this_ore 1
                                endif

                                if smelt_this_ore == 1
                                    setvar! smelt_this_ore 0
                                    overhead 'smelting!'
                                    dclick ores
                                    wait action_delay
                                    setvar! reset_last_sysmsg_timer 1
                                endif
                                @ignore ores
                            endwhile
                            @clearignore

                            # smelt ores in pack animals
                            foreach packanimal in 'packies'
                                dclick packanimal
                                wait action_delay

                                if findtype ORES packanimal as ores and diffweight > 10
                                    overhead 'FOUND ORES INSIDE' 56 packanimal
                                    sysmsg 'FOUND ORES IN PACKANIMAL TO SMELT' 56

                                    while findtype ORES packanimal as ores and diffweight > 10
                                        if insysmsg 'You do not see any nearby forges to smelt this ore on'
                                            overhead 'got far from forge!' 41
                                            sysmsg 'Got Far From Forge! Breaking smelting loop...' 41
                                            setvar! escape_parent_loop 1
                                            break
                                        endif

                                        if smelt_colored_ores == 0
                                            if hue ores == 0
                                                setvar! smelt_this_ore 1
                                            endif
                                        else
                                            setvar! smelt_this_ore 1
                                        endif

                                        if smelt_this_ore == 1
                                            setvar! smelt_this_ore 0
                                            sysmsg 'smelting ore in packie' 56
                                            overhead 'smelting ores' 56 packanimal
                                            dclick ores
                                            wait action_delay
                                        endif

                                        @ignore ore
                                    endwhile

                                    @clearignore
                                endif

                                if varexist escape_parent_loop
                                    unsetvar escape_parent_loop
                                    break
                                endif

                            endfor
                        endif
                    endif
                endif


                ##############################################
                # GRAB ORES AND INGOTS FROM GROUND
                ##############################################


                while findtype ORES|INGOTS ground any any 2 as ore and diffweight > 50
                    hotkey 'Grab Item'
                    wft action_delay

                    if targetexists 'any'
                        sysmsg 'GETTING ORE FROM GROUND' 51
                        overhead '* ore from ground *' 51
                        target ore
                    endif
                endwhile


                ##############################################
                # ORE MAPS ROUTINE
                ##############################################

                # if heavy and there are packies nearby, unload

                if findtype 'map' backpack 2796 any as ore_map
                    getlabel ore_map ore_map_label
                    if "completed by" in ore_map_label
                        overhead 'ORE MAP COMPLETE!' 90
                        sysmsg 'ORE MAP COMPLETE!' 90

                        # drop completed ore map
                        lift ore_map 1
                        wait action_delay
                        overhead "dropping completed ore map"
                        if findtype 'barrel' ground 0 1 2 as trashcan
                            sysmsg "Dropping Completed Map On Trash Barrel" sysmsgs_color
                            drop trashcan -1 -1 0
                        else
                            sysmsg "Dropping Completed Map On The Ground" sysmsgs_color
                            droprelloc 0 0
                        endif

                        clearsysmsg
                        sysmsg 'STOPPING SCRIPT...' 90
                        stop
                    else
                        sysmsg 'Doing Ore Map...' 49
                        # setvar! reset_last_sysmsg_timer 1
                        # cooldown RESOURCES resource_cooldown_value
                    endif
                endif


                ##############################################
                # CHECK EACH PACK ANIMAL TO DETERMINE IF ITS HEAVY OR NOT
                ##############################################

                if not listexists 'full_packies'
                    createlist 'full_packies'
                endif

                clearlist 'full_packies'

                foreach packanimal in 'packies'

                    setvar! packie_heavy 0

                    dclick packanimal
                    wait action_delay

                    # if razor thinks there are no resources at all, we might need to open the packie bag so razor can "see" whats inside first
                    if counttype ORES packanimal == 0 and counttype INGOTS packanimal == 0
                        # overhead '*opening backpack to count resources*' 54
                        dclick packanimal
                        wait action_delay
                    endif

                    # check packie weight to determine if its full or not
                    setvar! ores_in_packie 0
                    setvar! ingots_in_packie 0
                    if counttype ORES packanimal any any as amount
                        setvar! ores_in_packie amount
                    endif
                    if counttype INGOTS packanimal any any as amount
                        setvar! ingots_in_packie amount
                    endif

                    if ores_in_packie >= max_resources_on_packie_before_unloading or ingots_in_packie >= max_resources_on_packie_before_unloading
                        # sysmsg 'COUNT INGOTS 1' 92
                        setvar! packie_heavy 1
                    # check if packie is actually empty
                    elseif ores_in_packie == 0 and ingots_in_packie == 0
                        # sysmsg 'COUNT ORE EMPTY' 92
                        rename packanimal 'emptypackie'
                    # if its not heavy and its not empty, its "light"
                    elseif ores_in_packie > 0 or ingots_in_packie >= 0
                        # sysmsg 'COUNT ORE LIGHT' 92
                        rename packanimal 'lightpackie'
                    endif

                    # add or remove packie to full 0packies list based on if its heavy or not
                    if packie_heavy == 1
                        sysmsg 'PACK IS HEAVY, MARKING TO GO HOME AND UNLOAD!' 39
                        setvar! recall_home_now 1
                        overhead '! packie heavy !' 34 packanimal
                        rename packanimal 'fullpackie'

                        if poplist 'packies' packanimal as removed_packie
                            overhead 'moved to end of packies list' 54 removed_packie
                            pushlist 'packies' packanimal 'back'
                        endif

                        if not inlist 'full_packies' packanimal
                            overhead 'ADDING TO FULL LIST' 54 packanimal
                            sysmsg 'ADDING PACKIE {{packanimal}} TO FULL LIST' 54 packanimal
                            pushlist 'full_packies' packanimal
                        endif
                    # else
                    #     if inlist 'full_packies' packanimal
                    #         # poplist 'full_packies' packanimal
                    #         overhead 'CLEARING FULL_PACKIES LIST' 52
                    #         sysmsg 'CLEARING FULL_PACKIES LIST...' 52
                    #     endif
                    endif
                endfor

                if list 'packies' > 0 and list 'full_packies' > 0 and list 'packies' == list 'full_packies'
                    overhead 'all packies full! going home!' 53
                    overhead 'all packies full! going home!' 54
                    sysmsg 'ALL PACKIES FULL! GOING HOME!' 52
                    sysmsg 'ALL PACKIES FULL! GOING HOME!' 53
                    sysmsg 'ALL PACKIES FULL! GOING HOME!' 54
                    setvar! recall_home_now 1
                endif

                ##############################################
                # UNLOADING ROUTINE
                ##############################################

                # if heavy and there are packies nearby, unload
                if diffweight <= max_diffweight_before_unloading and findtype ORES backpack

                    if list 'packies' > 0
                        foreach packanimal in 'packies'
                            if not inlist 'full_packies' packanimal
                                # getlabel packanimal packie_label
                                # sysmsg packie_label 99


                                # call packies if they are not within 2 tiles
                                while not find packanimal ground any any 2
                                    say 'all follow me'
                                    wait action_delay
                                endwhile


                                foreach resource_type in 'resource_types'
                                    if resource_type == ORES
                                        setvar! max_resource_in_packie 500
                                    elseif resource_type == INGOTS
                                        setvar! max_resource_in_packie 700
                                    endif

                                    while findtype resource_type backpack as resource_serial and counttype resource_type packanimal < max_resource_in_packie
                                        getlabel resource_serial resource_label

                                        sysmsg '>>> MOVING {{resource_label}} TO PACKIE' 56
                                        sysmsg 'Unloading {{resource_label}} in packie {{packanimal}}' 56
                                        overhead '*unloading {{resource_label}}*' 56 packanimal

                                        lift resource_serial 999
                                        wait 100
                                        while queued
                                        endwhile

                                        drop packanimal -1 -1 0
                                        wait 100
                                        while queued
                                        endwhile

                                        if findtype resource_type ground any any 1
                                            # put this animal to the end of the list so we use the next one next time
                                            overhead 'heavy?? moving to end of list' 53 packanimal
                                            # poplist 'packies' packanimal
                                            # pushlist 'packies' packanimal 'back'

                                            sysmsg 'Found {{resource_label}} on ground. Pet is probably heavy...' 53

                                            # we open the packies bag here to make sure in the next iteration the script will be able
                                            # to count the resources it in.
                                            dclick packanimal
                                            wait action_delay

                                            rename packanimal 'fullpackie'
                                            pushlist 'full_packies' packanimal

                                            while findtype resource_type ground any any 1 as ground_resouce_serial and diffweight > 50
                                                getlabel ground_resource_serial ground_resource_label
                                                hotkey 'Grab Item'
                                                wft action_delay
                                                sysmsg 'Getting {{ground_resource_label}} from ground' 51
                                                overhead '* {{ground_resource_label}} from ground *' 51
                                                target ground_resouce_serial
                                                # setvar! reset_last_sysmsg_timer 1
                                                # cooldown RESOURCES resource_cooldown_value
                                            endwhile
                                        endif

                                    endwhile
                                endfor

                            endif

                            # dont iterate thgouth other packies if theres no need
                            if diffweight > max_diffweight_before_unloading or not findtype ORES backpack
                                overhead "*no more resources to unload*" 52
                                sysmsg "No More Resources To Unload. Breaking..." 52
                                break
                            endif
                        endfor

                    else
                        overhead '! HEAVY !' 90
                    endif
                endif
            endif


            ###############################################
            # JOURNAL MESSAGES CHECKS

            # we need to first check for pks or else the other msgs might not allow us to get to this check
            if insysmsg 'now tracking'
                    sysmsg '>>> PK...' 19
                    sysmsg '>>> PK...' 49
                    sysmsg '>>> PK...' 54
                    overhead '!! PK !!' 19
                    overhead '!! PK !!' 49
                    overhead '!! PK !!' 54

                    if auto_escape_tracked_pks == 1
                        sysmsg '>>> ESCAPING PK!!!' 41
                        overhead '!! ESCAPING PK !!' 41

                        setvar! recall_home_now 1
                    endif



            # handle world saves
            elseif insysmsg "The world is saving"
                overhead '*WORLD SAVING*' 90
                settimer 'waiting_world_save_timer' 0
                while not insysmsg 'World save complete'
                    wait 100
                    if timer 'waiting_world_save_timer' >= world_save_delay
                        sysmsg 'BREAKING WAITING FOR SAVE' 49
                        break
                    endif
                endwhile

                if insysmsg 'World save complete in {{waiting_world_save_timer}}'
                    overhead '*save complete!*' 90
                endif

            # handle tools breaking
            elseif insysmsg "You have worn out your tool"
                overhead 'PICKAXE BROKE!' 90

                while not rhandempty
                    overhead 'undressing hands for pickaxe'
                    hotkey "Undress Both Hands"
                    wait action_delay
                endwhile

                if rhandempty
                    if findtype 'pickaxe' backpack
                        dclicktype 'pickaxe'
                        wait action_delay
                        overhead "✩equiped new pickaxe✩"
                    else
                        overhead "✩ You are out of pickaxes✩"
                        setvar! recall_home_now 1
                    endif
                endif


            # no resources where char is
            elseif insysmsg "You do not see any harvestable resources nearby"

                overhead '! NO ORES HERE !' 54

                # update attempt number
                if auto_skip_runes_after_fails == 1
                    if attempts_to_find_new_ore_veins == 0
                        setvar! attempts_to_find_new_ore_veins 1
                    elseif attempts_to_find_new_ore_veins == 1
                        setvar! attempts_to_find_new_ore_veins 2
                    elseif attempts_to_find_new_ore_veins == 2
                        setvar! attempts_to_find_new_ore_veins 3
                    elseif attempts_to_find_new_ore_veins == 3
                        setvar! attempts_to_find_new_ore_veins 4
                    elseif attempts_to_find_new_ore_veins == 4
                        setvar! attempts_to_find_new_ore_veins 5
                    elseif attempts_to_find_new_ore_veins == 5
                        setvar! attempts_to_find_new_ore_veins 6
                    elseif attempts_to_find_new_ore_veins == 6
                        setvar! attempts_to_find_new_ore_veins 7
                    elseif attempts_to_find_new_ore_veins == 7
                        setvar! attempts_to_find_new_ore_veins 8
                    elseif attempts_to_find_new_ore_veins == 8
                        setvar! attempts_to_find_new_ore_veins 9
                    elseif attempts_to_find_new_ore_veins == 9
                        setvar! attempts_to_find_new_ore_veins 10
                    elseif attempts_to_find_new_ore_veins == 10
                        setvar! attempts_to_find_new_ore_veins 11
                    elseif attempts_to_find_new_ore_veins == 11
                        setvar! attempts_to_find_new_ore_veins 12
                    elseif attempts_to_find_new_ore_veins == 12
                        setvar! attempts_to_find_new_ore_veins 13
                    elseif attempts_to_find_new_ore_veins == 13
                        setvar! attempts_to_find_new_ore_veins 14
                    elseif attempts_to_find_new_ore_veins == 14
                        setvar! attempts_to_find_new_ore_veins 15
                    elseif attempts_to_find_new_ore_veins == 15
                        setvar! attempts_to_find_new_ore_veins 16
                    elseif attempts_to_find_new_ore_veins == 16
                        setvar! attempts_to_find_new_ore_veins 17
                    elseif attempts_to_find_new_ore_veins == 17
                        setvar! attempts_to_find_new_ore_veins 18
                    elseif attempts_to_find_new_ore_veins == 18
                        setvar! attempts_to_find_new_ore_veins 19
                    elseif attempts_to_find_new_ore_veins == 19
                        setvar! attempts_to_find_new_ore_veins 20
                    endif

                    if attempts_to_find_new_ore_veins == max_fails_before_going_to_next_rune
                        sysmsg '[RUNEBOOK {{runebook}} | RUNE {{rune_number}}] MAX ATTEMPTS REACHED: {{attempts_to_find_new_ore_veins}}' 40
                        setvar! go_to_next_rune 1
                    else
                        sysmsg '[RUNEBOOK {{runebook}} | RUNE {{rune_number}}] ATTEMPT {{attempts_to_find_new_ore_veins}}' 90
                    endif
                endif

            endif


            # mining fail message
            elseif insysmsg "loosen some rocks but fail"
                overhead ': fail :' 43


            # when char is on cooldown for having traveled recently
            elseif insysmsg "You have recently traveled"
                overhead '! travel cooldown !' 43


            # action cooldown
            elseif insysmsg "You must wait to perform another action"
                overhead '! action cooldown !' 54


            # action cooldowns (when sysmsg prints 'You must wait...') will break the macro, so we need to get them as well
            elseif insysmsg "Harvesting is not allowed in this area"
                overhead 'harvest not allowed. move!' 53


            # I TRIED LOOPING THROUGH A LIST INSTEAD OF USING MULTIPLE IF/ELSE AND DIDNT WORK, THE LOOP BREAKS THE MACRO
            elseif insysmsg 'some Iron'
                overhead '⥏ IRON ⥑' 15
            elseif insysmsg 'Dull Copper'
                overhead '✩ DULL COOPER ✩' 245
            elseif insysmsg 'shadow Iron'
                overhead '✩ SHADOW IRON ✩' 193
            elseif insysmsg 'Copper'
                overhead '✩ COPPER ✩' 248
            elseif insysmsg 'Bronze'
                overhead '✩ BRONZE ✩' 248
            elseif insysmsg 'Gold'
                overhead '✩ GOLD ✩' 53
            elseif insysmsg 'Agapite'
                overhead '✩ agapite ✩' 58
            elseif insysmsg 'Verite'
                overhead '✩ VERITE ✩' 70
            elseif insysmsg 'Valorite'
                overhead '✩ VALORITE ✩' 80
            elseif insysmsg 'Avarite'
                overhead '✩ AVARITE ✩' 17


            # catch captcha successful msgs
            elseif insysmsg "Captcha successful"
                overhead 'captcha anwsered succesfully' 90
                sysmsg 'Captcha Anwsered Succesfully!' 90


            # catch captcha failure msgs
            elseif insysmsg "Due to previous captcha failures"
                overhead '! resource locked !' 33
                sysmsg 'CAPTCHA FAILED AND CHAR IS RESOURCE LOCKED. STOPPING MACRO...' 33
                stop


            endif


            ########################################
            # GO HOME AND UNLOAD ROUTINE
            ########################################

            if recall_home_now == 1

                setvar! use_charges 0
                if skill 'magery' == 0 or counttype "Black Pearl%s%" == 0 or counttype "Blood Moss" == 0 or counttype "Mandrake Root%s%" == 0
                    if counttype "Recall"
                        overhead 'no regs. trying scroll...' 54
                        setvar! use_recall_scroll 1
                    else
                        overhead 'no regs. trying charges...' 54
                        setvar! use_charges 1
                    endif
                endif

                # meditate before travel if needed
                while mana <= 11
                    sysmsg 'MEDITATING TO RECALL' warning_msg_color
                    if not findbuff 'actively meditating'
                        skill meditation
                        wait action_delay
                    endif
                    wait action_delay
                endwhile

                if use_charges == 1
                    sysmsg 'TRAVELLING VIA CHARGES'
                    dclick home_book
                    waitforgump recall_book_gump_id action_delay
                    gumpresponse recall_rune_btn_number recall_book_gump_id
                    setvar! use_charges 0
                else
                    # dclick recall_book
                    # waitforgump recall_book_gump_id action_delay
                    # gumpresponse recall_rune_btn_number recall_book_gump_id
                    sysmsg 'TRAVELLING VIA SPELL WITH RUNEBOOK {{home_book}}'
                    while not cooldown 'CASTING RECALL'
                        hotkey 'Recall'
                        wait spell_recovery_delay
                    endwhile


                    clearsysmsg
                    @settimer 'waiting_target_timer' 0
                    while not targetexists 'neutral' and not insysmsg 'disturbed' and not insysmsg 'cannot cast a spell' and timer 'waiting_target_timer' < recall_casting_time
                        wft 10
                        if insysmsg 'disturbed' or insysmsg 'spell will not adhere' or insysmsg 'cannot cast a spell'
                            if verbose == 1
                                overhead '▽▽ BREAKING RECALL ▽▽' warning_msg_color
                                sysmsg 'BREAKING WHILE WAITING FOR RECALL ' warning_msg_color
                            endif

                            wait spell_recovery_delay
                            break
                        endif

                        if diffhits >= max_diffhits_before_healing_with_potion
                            if findtype 'yellow potion' backpack as pot
                                sysmsg '>>> LOW HP! USING HEAL POTION.. ' action_msg_color
                                overhead '*using heal potion*' action_msg_color

                                useobject pot
                                wait action_delay
                            endif
                        endif

                    endwhile

                    if targetexists 'neutral'
                        sysmsg 'TARGETING HOME BOOK {{home_book}}'
                        target home_book
                        wait spell_recovery_delay
                    endif
                endif

                wait recall_travel_time

                sysmsg 'ASSUMING CHAR IS HOME. START UNLOADING'

                if use_hotel_room == 1
                    say 'room'
                    waitforgump 2393832411 action_delay
                    if ingump 'Your Room' 2393832411 action_delay
                        if use_own_room == 1
                            overhead 'entering own room'
                            gumpresponse 4 2393832411
                        else
                            overhead 'entering friend room'
                            gumpresponse 5 2393832411
                            waitforgump 2393832411 action_delay
                            gumpresponse 100 2393832411
                        endif
                    else
                        overhead 'entering friend room'
                        gumpresponse 5 2393832411
                        waitforgump 2393832411 action_delay
                        gumpresponse 100 2393832411
                    endif

                    wait 1500
                endif



                # after escaping, smelt ores from char
                while findtype ORES backpack as ores_from_backpack
                    # check if char is close to a player or a static map forge to smelt
                    if findtype 'forge' ground any any 2 or findtype 'large forge' ground any any 2
                        setvar! smelt_ores_now 1
                    # outpost forge
                    elseif position 3031 539 or position 3031 540 or position 3031 541
                        setvar! smelt_ores_now 1
                    endif

                    if varexist smelt_ores_now
                        unsetvar! smelt_ores_now
                        overhead '*smelting ores*' 49
                        sysmsg '> Smelting Ores In Pack Animal' 49
                        dclick ores_from_backpack
                        wait action_delay
                    else
                        sysmsg 'Found Ores in backpack but no forge nearby to smelt it...' 40
                        break
                    endif
                endwhile


                # after escaping, smelt ores from all packies
                if list 'packies' > 0
                    foreach packanimal in 'packies'

                        dclick packanimal
                        wait action_delay
                        # smelt ores
                        while findtype ORES packanimal any any 2 as ores_from_packie

                            # check if char is close to a player or a static map forge to smelt
                            if findtype 'forge' ground any any 2 or findtype 'large forge' ground any any 2
                                setvar! smelt_ores_now 1
                            # outpost forge
                            elseif position 3031 539 or position 3031 540 or position 3031 541
                                setvar! smelt_ores_now 1
                            endif

                            if varexist smelt_ores_now
                                unsetvar! smelt_ores_now
                                overhead '*smelting ores*' 49 packanimal
                                sysmsg '> Smelting Ores In Pack Animal' 49
                                dclick ores_from_packie
                                wait action_delay
                            else
                                sysmsg 'Found Ores in pack animal but no forge nearby to smelt it...' 40
                                overhead 'found ores but no forge' 40 packanimal
                                break
                            endif
                        endwhile
                    endfor
                endif

                # unload everything on resource stockpile
                if findtype 'resource container' ground any any 2 as stockpile
                    if not varexist resource_stockpile
                        @setvar resource_stockpile stockpile
                    endif
                    menu resource_stockpile 0
                    wft 600
                    if targetexists 'neutral'
                        sysmsg '> Restocking Resource Stockpile...' sysmsgs_color
                        target 'self'
                    endif

                    # restock stockpile from packies
                    if list 'packies' > 0 and varexist resource_stockpile
                        foreach packanimal in 'packies'
                            if noto packanimal = friend
                                sysmsg '> Restocking Stockpile From Pack Animal...' sysmsgs_color
                                menu resource_stockpile 0
                                wft 600
                                if targetexists 'neutral'
                                    overhead "unloading on stockpile" 56 packanimal
                                    target packanimal
                                endif
                            endif
                        endfor
                    endif
                    if gumpexists 1859005118
                        gumpclose
                    endif
                endif

                if findtype 'storage shelf' ground any any 2 as shelf
                    sysmsg 'RESSUPLYING...' 55
                    menu shelf 1
                    waitforgump 3232825965 600
                else
                    overhead 'NO SHELFS FOUND TO RESSUPLY!'
                endif

                sysmsg 'SETTING TO TRAVEL TO NEXT RUNE' 54
                setvar! go_to_next_rune 1

                setvar! recall_home_now 0

            endif
            # END GO HOME AND UNLOAD ROUTINE
            ########################################


            ########################################
            # HANDLE POISON
            ########################################
            if poisoned
                if findtype 'orange potion' backpack
                    sysmsg 'Curing poison with potion...' 90
                    hotkey 'Drink Cure'
                elseif magery >= 50 and counttype 'Garlic' > 0 and counttype 'Ginseng' > 0
                    sysmsg 'Curing poison with magery...' 90
                    cast 'Cure'

                    @settimer 'waiting_target_timer' 0
                    while not targetexists 'beneficial' and timer 'waiting_target_timer' < 1500
                        wait 100
                        if insysmsg 'disturbed' or insysmsg 'cannot cast a spell while frozen'
                            sysmsg 'BREAKING WHILE WAITING FOR GREATER HEAL TARGET'
                            break
                        endif
                    endwhile

                    if targetexists 'beneficial'
                        target 'self'
                    endif
                elseif healing >= 30 and counttype 'clean bandage%s%' > 0
                    if bandaging == 0
                        overhead '*applying bandages*' 65
                        hotkey 'Bandage Self'

                        wait action_delay
                    elseif bandaging > 10
                        overhead '10+ secs till next bandage!' 52
                    elseif bandaging > 5
                        overhead '5+ secs till next bandage!' 52
                    else
                        overhead 'less than 5 secs till next bandage!' 52
                    endif
                endif
            endif


            ########################################
            # MAINTAIN CHAR HP
            ########################################

            if diffhits > max_diffhits_before_starting_heal_routine
                # heal with pots
                if diffhits > max_diffhits_before_healing_with_potion
                    if findtype 'yellow potion' backpack
                        hotkey 'Drink Heal'
                        wait action_delay
                    endif
                endif

                # heal with healing
                if diffhits > max_diffhits_before_healing_with_bandages and skill 'healing' >= min_healing_to_use_bandages
                    if bandaging == 0
                        overhead '*applying bandages*' 65
                        hotkey 'Bandage Self'

                        wait action_delay
                    elseif bandaging > 10
                        overhead '10+ secs till next bandage!' 52
                    elseif bandaging > 5
                        overhead '5+ secs till next bandage!' 52
                    else
                        overhead 'less than 5 secs till next bandage!' 52
                    endif
                endif

                # heal with magery
                if diffhits > max_diffhits_before_healing_with_magery and skill 'magery' >= 50 and mana >= 11
                    cast 'greater heal'

                    @settimer 'waiting_target_timer' 0
                    while not targetexists 'beneficial' and timer 'waiting_target_timer' < 3500
                        wait 100
                        if insysmsg 'disturbed' or insysmsg 'cannot cast a spell while frozen'
                            sysmsg 'BREAKING WHILE WAITING FOR GREATER HEAL TARGET'
                            break
                        endif
                    endwhile

                    if targetexists 'beneficial'
                        hotkey 'Target Self'
                    endif
                endif
            endif



            ########################################
            # DEFEND AGAINST MONSTERS ROUTINE
            ########################################

            if diffhits > max_diffhits_before_starting_defense_routine
                if not find 'last' ground any any 2 or not dead 'last' or noto 'last' != hostile
                    overhead 'searching for mobs to kill...' 52
                    hotkey 'Target Closest Non-Friendly Monster'
                    # hotkey 'Next Non-Friendly Monster Target'
                    wait action_delay

                    # if there is not a captcha present already, reset timer to make sure the script wont bug after killing the mob
                    if timer 'last_sysmsg_timer' < max_wait_for_last_sysmsg_to_suspect_gump

                        if debug == 1
                            sysmsg '[DEBUG]: RESET 014 DEFEND 1' debug_msg_color
                        endif

                        sysmsg 'Flaging to reset catpcha timer while searching for mobs...' 54
                        setvar! reset_last_sysmsg_timer 1
                    endif

                endif


                while find 'last' ground any any max_mob_range_to_attack and not dead 'last'

                    if debug == 1
                        sysmsg '[DEBUG]: INSIDE WHILE DEFEND LOOP' debug_msg_color
                    endif


                    if noto lasttarget == friendly
                        overhead 'cancelling friendly target!' 52
                        hotkey 'Cancel Current Target'

                        if debug == 1
                            sysmsg '[DEBUG]: RESET 015 DEFEND 2 CANCEL TARGET' debug_msg_color
                        endif

                        setvar! reset_last_sysmsg_timer 1
                    elseif noto lasttarget != friend and noto lasttarget != friendly
                    # elseif noto lasttarget == hostile
                        overhead '|| MINER TARGET ||' 90 'last'
                        setvar found_mob 1

                        if not varexist entered_combat_mode
                            setvar! entered_combat_mode 1
                        endif

                        #make sure we dont have a captcha gump before trying to arm for fightning
                        if timer 'last_sysmsg_timer' < max_wait_for_last_sysmsg_to_suspect_gump
                            if debug == 1
                                sysmsg '[DEBUG]: RESET 016 DEFEND 3 CATCHA CHECK' debug_msg_color
                            endif

                            setvar! reset_last_sysmsg_timer 1

                            overhead '*ATTACKING*' 39 lasttarget
                            sysmsg 'Hostile Last Target Detected! Entering Defense Routine...' 56

                            # equip pickaxe if needed
                            if skill 'mace fighting' > 0
                                if not findtype 'pickaxe' righthand

                                    if findtype 'pickaxe' backpack as pickaxe
                                        # undress hands if necessary to equip pickaxe found
                                        if not lhandempty and not rhandempty
                                            overhead 'undressing hands to put pickaxe' 54
                                            hotkey "Undress Both Hands"
                                            wait action_delay
                                        endif

                                        if debug == 1
                                            sysmsg '[DEBUG]: EQUIPING PICKAXE' debug_msg_color
                                        endif

                                        setvar! found_weapon 1
                                        dclick pickaxe
                                        wait action_delay
                                    else
                                        overhead 'OUT OF PICKAXES!' 39
                                    endif
                                endif
                            else
                                # first make sure char is empty handed to equip the weapon afterwards
                                if not lhandempty and not rhandempty
                                    overhead 'undressing hands to put combat weaopn' 54
                                    hotkey "Undress Both Hands"
                                    wait action_delay

                                # if char is not macer, we got to equip a different weaopn equip weapon if needed according to weaopn skill
                                else
                                    foreach weapon_type in 'char_combat_skill_weapons'
                                        if findtype weapon_type backpack as weap
                                            setvar! found_weapon 1
                                            dclick weap
                                            overhead "::equiped {{weapon_type}} weapon::"
                                            wait action_delay
                                            break
                                        endif
                                    endfor
                                endif

                                if not varexist found_weapon and lhandempty and rhandempty
                                    overhead 'CANT FIND WEAPON'
                                endif

                                unsetvar! found_weapon
                            endif


                            if not rhandempty or not lhandempty
                                sysmsg 'Attacking last target'
                                hotkey 'Attack Last Target'
                            endif

                        endif

                        # HANDLE POISON
                        if poisoned
                            if findtype 'orange potion' backpack
                                sysmsg 'Curing poison with potion...' 90
                                hotkey 'Drink Cure'
                            elseif magery >= 50 and counttype 'Garlic' > 0 and counttype 'Ginseng' > 0
                                sysmsg 'Curing poison with magery...' 90
                                cast 'Cure'

                                @settimer 'waiting_target_timer' 0
                                while not targetexists 'beneficial' and timer 'waiting_target_timer' < 1500
                                    wait 100
                                    if insysmsg 'disturbed' or insysmsg 'cannot cast a spell while frozen'
                                        sysmsg 'BREAKING WHILE WAITING FOR GREATER HEAL TARGET'
                                        break
                                    endif
                                endwhile

                                if targetexists 'beneficial'
                                    target 'self'
                                endif
                            elseif healing >= 50 and counttype 'clean bandage%s%' > 0
                                if bandaging == 0
                                    overhead '*applying bandages*' 65
                                    hotkey 'Bandage Self'

                                    wait action_delay
                                elseif bandaging > 10
                                    overhead '10+ secs till next bandage!' 52
                                elseif bandaging > 5
                                    overhead '5+ secs till next bandage!' 52
                                else
                                    overhead 'less than 5 secs till next bandage!' 52
                                endif
                            endif
                        endif

                        # MAINTAIN CHAR HP
                        if diffhits > 0
                            # heal with pots
                            if diffhits > max_diffhits_before_healing_with_potion
                                if findtype 'yellow potion' backpack
                                    hotkey 'Drink Heal'
                                    wait action_delay
                                endif
                            endif

                            # heal with healing
                            if diffhits > max_diffhits_before_healing_with_bandages and skill 'healing' >= min_healing_to_use_bandages
                                if bandaging == 0
                                    overhead '*applying bandages*' 65
                                    hotkey 'Bandage Self'

                                    wait action_delay
                                elseif bandaging > 10
                                    overhead '10+ secs till next bandage!' 52
                                elseif bandaging > 5
                                    overhead '5+ secs till next bandage!' 52
                                else
                                    overhead 'less than 5 secs till next bandage!' 52
                                endif
                            endif

                            # heal with magery
                            if diffhits > max_diffhits_before_healing_with_magery and skill 'magery' >= 50 and mana >= 11
                                cast 'greater heal'

                                @settimer 'waiting_target_timer' 0
                                while not targetexists 'beneficial' and timer 'waiting_target_timer' < 3500
                                    wait 100
                                    if insysmsg 'disturbed' or insysmsg 'cannot cast a spell while frozen'
                                        sysmsg 'BREAKING WHILE WAITING FOR GREATER HEAL TARGET'
                                        break
                                    endif
                                endwhile

                                if targetexists 'beneficial'
                                    hotkey 'Target Self'
                                endif
                            endif
                        endif
                    # end if last == hostile
                    endif


                endwhile

                # clearsysmsg

                if dead 'last' and varexist found_mob
                    unsetvar found_mob

                    if debug == 1
                        sysmsg '[DEBUG]: RESET 017 DEFEND 4 AFTER LOOP' debug_msg_color
                    endif

                    setvar! reset_last_sysmsg_timer 1
                endif

                if debug == 1
                    sysmsg '[DEBUG]: LAST ENDIF DEFEND ROUTINE' debug_msg_color
                endif

            # END if diffhits > max_diffhits_before_starting_defense_routine
            endif

            # if debug == 1
            #     sysmsg '[DEBUG]: AFTER DEFEND ROUTINE' debug_msg_color
            # endif


            # check if we got any sysmsg that should reset the timer in each iteration
            if reset_last_sysmsg_timer == 1
                setvar! reset_last_sysmsg_timer 0
                # RESET THE TIMER
                settimer 'last_sysmsg_timer' 0

                clearsysmsg
            elseif varexist entered_combat_mode
                unsetvar! entered_combat_mode

                if debug == 1
                    sysmsg '[DEBUG]: RESETING SYSMSG TIMER AFTER FLAGING COMBAT MODE' debug_msg_color
                endif
                sysmsg 'Reseting sysmsg timer after flaging combat mode...' 52
                settimer 'last_sysmsg_timer' 0

                clearsysmsg
            endif

            # breaks from the loop and pops the current rune from front of list into the back, so we can
            # bypass the razor bug that keeps on same iteration when you from from a while inside a for
            if go_to_next_rune == 1
                # increase the cooldown timer to make sure it wont be gone after we recall
                if cooldown RESOURCES
                    cooldown RESOURCES 60000
                endif

                setvar! go_to_next_rune 0


                sysmsg 'GOING TO NEXT RUNE' 54
                # poplist 'runebook_rune_btns' 'front'
                # pushlist 'runebook_rune_btns' rune_number 'back'
                # say 'all follow me'


                ########################################
                # SET NEXT RUNE TO TRAVEL
                ########################################
                if rune_number == 10
                    setvar! rune_number 20
                elseif rune_number == 20
                    setvar! rune_number 10
                endif


                ########################################
                # SET NEXT RUNETOME PAGE
                ########################################

                poplist 'runetome_page_numbers' 'front'
                pushlist 'runetome_page_numbers' page_number 'back'

                ########################################
                # CHANGE RUNEBOOK AND RESET PAGE
                # NUMBERS IF CURRENT IS COMPLETED
                ########################################

                # if we reached the max rune set to use, reset the runetome page numbers so we can start cycling it azgain from the first rune
                if current_rune_position == max_runes_to_use_per_runebook

                    if atlist 'mining_runetomes' 1 as found
                        sysmsg 'REACHED LAST RUNE {{max_runes_to_use_per_runebook}}. STARTING NEXT RUNEBOOK {{found}}...' 54
                    else
                        sysmsg 'REACHED LAST RUNE {{max_runes_to_use_per_runebook}}. STARTING RUNEBOOK AGAIN' 54
                    endif

                    # move current runebook to back of the list
                    poplist 'mining_runetomes' 'front'
                    pushlist 'mining_runetomes' runebook 'back'
                    say 'all follow me'

                    # reset the page numbers to original format including all rune positions to start from the first rune
                    clearlist 'runetome_page_numbers'
                    foreach x in 'runetome_page_numbers_unchanged'
                        pushlist 'runetome_page_numbers' x
                    endfor

                    # reset rune btn on runetome to first btn of each page
                    setvar! rune_number 10
                endif

                break
            endif

            # sysmsg 'ITERATION: {{main_loop_index}}' 90
            # sysmsg 'UPTIME: {{mining_uptime}}' 90

        endwhile

        setvar! mining_first_run_done 1

    endfor
    # CLOSES foreach runebook in 'mining_runetomes'
endfor


