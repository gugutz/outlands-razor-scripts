sysmsg '#########################' 90
sysmsg '>>> LUMBERJACKING BOT' 55
sysmsg 'by gugutz' 45
sysmsg 'version 0.3.0-rc1' 31
sysmsg '########################' 90

#################################
# IN GAME INSTRUCTIONS / OBSERVATIONS
#################################

sysmsg '************************' 90
sysmsg 'FOR THIS SCRIPT TO WORK PROPERLY, YOU MUST:' 53
sysmsg "." 55
sysmsg "* uncheck option 'filter repeating system messages' on razor" 55
sysmsg "* uncheck option 'Auto Stack Ore/Fish/Logs at feet' on razor" 55
sysmsg "* first run far from other friends pack animals" 55
sysmsg "." 55
sysmsg '***********************' 90


# TEST IF REQUIRED COOLDOWN WAS CREATED
cooldown RESOURCES 3000

if not cooldown RESOURCES
    overhead "REQUIRED COOLDOWNS DONT EXIST" 34
    overhead "READ SYSMSG INSTRUCTIONS AT CORNER OF YOUR SCREEN" 34

    sysmsg "REQUIRED COOLDOWNS DONT EXIST" 34
    sysmsg "PLEASE READ INSTRUCTIONS AT:" 34
    sysmsg "https://github.com/gugutz/outlands-razor-scripts/resources/lumber" 88
    sysmsg "." 88

    sysmsg "OR SETUP A COOLDOWN NAMED 'RESOURCES' WITH DEFAULT 60 SECONDS DEFAULT TIMER AND THE FOLLOWING TRIGGERS:" 88
    sysmsg "Type: sysmsg | Text: You hack" 87
    sysmsg "Type: sysmsg | Text: You chop some" 87
    sysmsg "Type: sysmsg | Text: You have worn out your tool" 87
    sysmsg "Type: sysmsg | Text: You do not see any harvestable resources nearby" 87
    sysmsg "Type: sysmsg | Text: before you may begin harvesting" 87
    sysmsg "Type: sysmsg | Text: Harvesting is not allowed in this area" 87
    sysmsg "Type: OverheadMessage | Text: You gather some" 87
    sysmsg "Type: OverheadMessage | Text: Captcha successful" 87
    sysmsg "." 88
    stop
endif


# make sure no old var is fucking up the script
unsetvar runebook
unsetvar runetome
createlist 'void_characters'
clearlist 'void_characters'
createlist 'hotel_room_owners'
clearlist 'hotel_room_owners'
createlist 'hotel_room_renters'
clearlist 'hotel_room_renters'

###################################
# SCRIPT CONFIGURATION
###################################

sysmsg 'Applying configuration...'

setvar! debug 1
setvar! action_delay 600
setvar! world_save_delay 8000
setvar! spell_recovery_delay 120

setvar! manual_lumber_mode 0

# max ores a packie can have before being set as full
setvar! max_boards_before_unloading 50

# set if char should escape home when tracking PKs
setvar! auto_escape_pks 1
setvar! auto_escape_thiefs 0

# escape rune button number on runebook
setvar! runetome_rune_position 100

# escape rune button number on runebook
setvar! runebook_rune_position 5

# set to make char walk randomly to find new trees
setvar! auto_walk_randomly 1

# how many attempts should char make to find new trees
setvar! max_walk_attempts_per_rune 20

# how many steps should char take per attempt when walking randomly
clearlist number_of_steps_per_walk
createlist number_of_steps_per_walk
pushlist number_of_steps_per_walk 1
pushlist number_of_steps_per_walk 2
pushlist number_of_steps_per_walk 3
pushlist number_of_steps_per_walk 4
pushlist number_of_steps_per_walk 5
pushlist number_of_steps_per_walk 6


setvar! auto_walk_to_direction 0
# direction to walk to when 'auto_walk_to_direction' is ON!
if auto_walk_to_direction == 1 and not listexists 'direction_to_walk'
    createlist 'direction_to_walk'
    pushlist 'direction_to_walk' 'right'
endif

setvar! use_strength 1
setvar! max_diffhits_before_buffing 5

setvar! use_void_aspect 0

# set if char uses a hotel room instead of a house
setvar! use_hotel_room 0
# set if characters should use own rooms or enter a friends room
setvar! use_own_room 1

# this requires you to run before my loot-organizer script to set the variable CHAR_LOOT_POUCH
setvar! hide_colored_resources_in_char_loot_pouch 1

# ADD YOUR CHAR TO THIS LIST IF IT USES VOID ASPECT
pushlist 'void_characters' 'Nazareno'
pushlist 'void_characters' 'Emacs'
pushlist 'void_characters' 'Heduardoh'
pushlist 'void_characters' 'Nonires'


# ADD YOUR CHAR TO THIS LIST IF IT USES ANOTHER FRIEND HOTEL ROOM
pushlist 'hotel_room_owners' 'Neron'
pushlist 'hotel_room_owners' 'OTHER CHAR NAME'

# ADD YOUR CHAR TO THIS LIST IF IT USES ANOTHER FRIEND HOTEL ROOM
pushlist 'hotel_room_owners' 'Neron'
pushlist 'hotel_room_owners' 'OTHER CHAR NAME'



#############################
# SET SCRIPT STUFF
#############################

if skill 'detectinghidden' >= 80
    sysmsg 'DETECTER DETECTED. OPTIMIZING...' script_msg_color
    setvar! is_detecter 1
endif

# default cooldown value to set the lumber cooldown on script actions
setvar! resource_cooldown_value 10000
setvar! recall_casting_time 4500

# set all characters that should use void
foreach charname in 'void_characters'
    if name == charname
        sysmsg 'USING VOID ASPECT'
        setvar! use_void_aspect 1
    endif
endfor

# set all characters who own a hotel room
foreach charname in 'hotel_room_owners'
    if name == charname
        sysmsg 'USING OWN HOTEL ROOM FOR TRIS CHARACTER' 90
        setvar! use_hotel_room 1
        setvar! use_own_room 1
    endif
endfor

# set all characters who own a hotel room
foreach charname in 'hotel_room_renters'
    if name == charname
        sysmsg 'USING FRIENDS HOTEL ROOM FOR TRIS CHARACTER' 90
        setvar! use_hotel_room 1
        setvar! use_own_room 0
    endif
endfor


#############################
# SET THE HOME BOOK
#############################

# search runetomes first
unsetvar! home_book
while findtype 'runetome' backpack as found
    getlabel found rtome_label
    if 'home' in rtome_label or 'Home' in rtome_label or 'HOME' in rtome_label
        sysmsg 'FOUND HOME RUNETOME {{rtome_label}}' success_msg_color
        setvar! home_book found
        setvar! home_book_gump_id 167090027
        setvar! home_rune_btn_number runetome_rune_position
        break
    endif

    @ignore found
endwhile
@clearignore

# if we couldnt find a home runetome, search for a home runebook
if not varexist home_book
    while findtype 'runebook' backpack as found
        getlabel found rbook_label
        if 'home' in rbook_label or 'Home' in rbook_label or 'HOME' in rbook_label
            sysmsg 'FOUND HOME RUNEBOOK {{rbook_label}}' success_msg_color
            setvar! home_book found
            setvar! home_book_gump_id 167090027
            setvar! home_rune_btn_number runetome_rune_position
            break
        endif

        @ignore found
    endwhile
    @clearignore
endif

if not varexist home_book
    sysmsg "YOU NEED A RUNEBOOK OR RUNETOME NAMED 'HOME' WITH YOUR HOME RUNE SET TO DEFAULT TO RUN THIS SCRIPT" 54
    stop
endif

#############################
# SET THE LUMBER RUNEBOOKS
#############################

clearlist 'lumber_runetomes'
createlist 'lumber_runetomes'

while findtype 'runetome' backpack as found
    getlabel found rbook_label
    if 'lumber' in rbook_label or 'Lumber' in rbook_label or 'LUMBER' in rbook_label
        sysmsg 'ADDING RUNEBOOK {{found}} TO LIST' 54
        pushlist 'lumber_runetomes' found
    endif

    @ignore found
endwhile

@clearignore


if manual_lumber_mode != 1 and list 'lumber_runetomes' == 0
    sysmsg "YOU NEED AT LAST 1 RUNETOME WITH THE WORD 'LUMBER' ON ITS NAME IF YOU WANNA CYCLE RUNES" 54
    # stop
 endif

foreach x in 'lumber_runetomes'
    sysmsg 'LUMBER RUNEBOOK {{index}}: {{x}}'
endfor




###################################
# SCRIPT ROUTINE RELATED VARIABLES
# (USUALLY THERES NO NEED TO EDIT THESE)
###################################

# VARIABLES FOR MESSAGE COLORS
setvar! debug_msg_color 56
setvar! script_msg_color 2213
setvar! default_sysmsg_color 1360
setvar! default_overhead_color 1360
setvar! spell_msg_color 49
setvar! buff_msg_color 92
setvar! warning_msg_color 1196
setvar! alert_msg_color 37
setvar! success_msg_color 1272
setvar! action_msg_color 90
setvar! rail_msg_color 116
setvar! on_cooldown_msg_color 53
setvar! reset_timer_msg_color 1258
setvar! boating_msg_color 84

# max time we should wait for hatchet target to open before reclicking it
setvar! max_wait_for_hatchet_target 2000
# delay between pickaxes uses
# setvar! max_wait_for_last_sysmsg_to_use_hatchet  1000
# delay before suspecting captcha gump
setvar! max_wait_for_last_sysmsg_to_suspect_gump 5000
# how oftect captcha gump usually pops up (default: 600000ms (10 minutes))
setvar! average_captcha_gump_interval 600000

setvar! max_diffhits_before_starting_heal_routine 0
setvar! max_diffhits_before_starting_defense_routine 2

# auto maintain char status settings
setvar! max_diffhits_before_healing_with_potion 20
setvar! max_diffhits_before_healing_with_magery 20
setvar! max_diffhits_before_healing_with_bandages 10
setvar! min_healing_to_use_bandages 30

setvar! max_diffweight_before_unloading 50
setvar! max_attempts_to_find_new_tree_before_travelling_to_next_rune 19

# set max range to attack with archery
if skill 'archery' >= 50
    setvar! max_mob_range_to_attack 12
endif


# runetomes recall via scroll buttons have a interval of 6, so first button is 2, second is 8, and so on...
if not listexists 'runetome_page_numbers'
    createlist 'runetome_page_numbers'

    # runetome page 1
    # we dont push the first rune since its the home rune
    pushlist 'runetome_page_numbers' 200
    pushlist 'runetome_page_numbers' 201
    pushlist 'runetome_page_numbers' 202
    pushlist 'runetome_page_numbers' 203
    pushlist 'runetome_page_numbers' 204
    pushlist 'runetome_page_numbers' 205
    pushlist 'runetome_page_numbers' 206
    pushlist 'runetome_page_numbers' 207
    pushlist 'runetome_page_numbers' 208
    pushlist 'runetome_page_numbers' 209
    pushlist 'runetome_page_numbers' 210
    pushlist 'runetome_page_numbers' 211
    pushlist 'runetome_page_numbers' 212
    pushlist 'runetome_page_numbers' 213
    
    # runetome page 2
    pushlist 'runetome_page_numbers' 214
    pushlist 'runetome_page_numbers' 215
    pushlist 'runetome_page_numbers' 216
    pushlist 'runetome_page_numbers' 217
    pushlist 'runetome_page_numbers' 218
    pushlist 'runetome_page_numbers' 219
    pushlist 'runetome_page_numbers' 220
    pushlist 'runetome_page_numbers' 221
    pushlist 'runetome_page_numbers' 222
    pushlist 'runetome_page_numbers' 223
    pushlist 'runetome_page_numbers' 224
endif

#####################################
# CONSTANTS FOR IN-GAME TYPES
#####################################
setvar! LOGS 7133
setvar! BOARDS 7127

setvar! max_mob_range_to_attack 2



#####################################
# SUMMON SETTINGS
#####################################

if not listexists 'summons'
    createlist 'summons'
endif

clearlist 'summons'
pushlist 'summons' 'an earth elemental'
pushlist 'summons' 'a fire elemental'
pushlist 'summons' 'summ. creature'


if skill 'magery' > 90

    # SPELLS TO AUTO CAST
    setvar! use_reactive_armor 1
    setvar! use_magic_reflection 1

    setvar! auto_summon 1
    setvar! use_undead_summons 0
    setvar! auto_all_guard 1
    setvar! auto_patrol_when_no_active_lasttarget 0
    setvar! auto_vampiric_embrace 1
    setvar! patrol_first_relative_direction 0
    setvar! patrol_second_relative_direction -10
    setvar! find_summon_range 8
    
    setvar! use_mushroom_delay 60000
    setvar! all_guard_delay 15000
    setvar! all_patrol_delay 6000
    setvar! cast_summons_delay 6000
endif

# if summ creature is one of players summons, change limit to 5 so even with 4 followers, we still make the char cast to summon the fifth creature
# if not, then we just want 2 elementals so limit should be 4, since they take up 2 slots each and the fifth wouldnt be possible
if inlist 'summons' 'summ. creature'
    setvar! summon_max_limit 5
else
    setvar! summon_max_limit 4
endif

# SUMMONS SPELL LISTS
if not listexists 'summonspells'
    createlist 'summonspells'
endif
clearlist 'summonspells'

if inlist 'summons' 'an air elemental'
    @pushlist 'summonspells' 'air elemental'
endif
if inlist 'summons' 'an earth elemental'
    @pushlist 'summonspells' 'earth elemental'
endif
if inlist 'summons' 'a water elemental'
    @pushlist 'summonspells' 'water elemental'
endif
if inlist 'summons' 'a fire elemental'
    @pushlist 'summonspells' 'fire elemental'
endif
if inlist 'summons' 'a daemon'
    @pushlist 'summonspells' 'summon daemon'
endif
if inlist 'summons' 'an energy vortex'
    @pushlist 'summonspells' 'energy vortex'
endif
if inlist 'summons' 'a blade spirit'
    @pushlist 'summonspells' 'blade spirits'
endif
if inlist 'summons' 'summ. creature'
    @pushlist 'summonspells' 'summ. creature'
endif



###################################
# TIMERS
###################################

sysmsg 'Creating timers...'

createlist 'lumber_script_timers'
clearlist 'lumber_script_timers'
pushlist 'lumber_script_timers' 'waiting_world_save_timer'
pushlist 'lumber_script_timers' 'last_sysmsg_timer'
pushlist 'lumber_script_timers' 'waiting_target_timer'
pushlist 'lumber_script_timers' 'bandage_timer'
pushlist 'lumber_script_timers' 'waiting_runebook_gump_timer'
pushlist 'lumber_script_timers' 'all_guard_timer'
pushlist 'lumber_script_timers' 'waiting_hatchet_target_timer'
pushlist 'lumber_script_timers' 'low_mana_for_summoning_warning_msg_timer'
pushlist 'lumber_script_timers' 'loop_on_warning_msg'
pushlist 'lumber_script_timers' 'lumber_uptime'
pushlist 'lumber_script_timers' 'last_gump_tracking_timer'
pushlist 'lumber_script_timers' 'waiting_target_timer'
pushlist 'lumber_script_timers' 'waiting_cooldown_timer'

foreach timer in 'lumber_script_timers'
    if not timerexists timer
        createtimer timer
        settimer timer 0
    endif
endfor


settimer 'all_guard_timer' 5000
settimer 'low_mana_for_summoning_warning_msg_timer' 5000
# this will make the script use bandage right at start if needed without having to wait for the bandage_delay first time
# settimer 'bandage_timer' bandage_delay


###################################
# POPULATE SOME LISTS
###################################


if not listexists 'resource_types'
    createlist 'resource_types'
    pushlist 'resource_types' LOGS
    pushlist 'resource_types' BOARDS
endif



if not listexists 'char_combat_skill_weapons'
    createlist 'char_combat_skill_weapons'
    if skill 'archery' >= 50
        pushlist 'char_combat_skill_weapons' 'bow'
        pushlist 'char_combat_skill_weapons' 'crossbow'
        pushlist 'char_combat_skill_weapons' 'heavy crossbow'
    elseif skill 'swordsmanship' >= 50
        pushlist 'char_combat_skill_weapons' 'halberd'
        pushlist 'char_combat_skill_weapons' 'bardiche'
        pushlist 'char_combat_skill_weapons' 'katana'
        pushlist 'char_combat_skill_weapons' 'axe'
        pushlist 'char_combat_skill_weapons' 'viking sword'
        pushlist 'char_combat_skill_weapons' 'longsword'
        pushlist 'char_combat_skill_weapons' 'broadsword'
        pushlist 'char_combat_skill_weapons' 'double axe'
        pushlist 'char_combat_skill_weapons' "executioner's axe"
    elseif skill 'mace fighting' >= 50
        pushlist 'char_combat_skill_weapons' 'war mace'
        pushlist 'char_combat_skill_weapons' 'mace'
        pushlist 'char_combat_skill_weapons' 'club'
        pushlist 'char_combat_skill_weapons' 'black staff'
        pushlist 'char_combat_skill_weapons' 'gnarled staff'
        pushlist 'char_combat_skill_weapons' 'war hammer'
    endif
endif

###################################
# PACK ANIMALS
###################################

sysmsg 'Searching for pack animals...' 87
createlist 'packies'

while findtype 292 ground any any 2 as packie
    if noto packie = friend
        pushlist 'packies' packie
        overhead '*opening bag*' 56 packie
        wait action_delay
    endif
    @ignore packie
endwhile

while findtype 291 ground any any 2 as packie
    if noto packie = friend
        pushlist 'packies' packie
        overhead '*opening bag*' 56 packie
        wait action_delay
    endif
    @ignore packie
endwhile
@clearignore


###################################
# PREPARING TO START
###################################

# set bandage_delay based on char dex
# if dex >= 100
#     sysmsg 'Setting bandage_delay to 10s' 53
#     setvar! bandage_delay 10000
# else
#     sysmsg 'Setting bandage_delay to 14s' 53
#     setvar! bandage_delay 14000
# endif


# IF THERES A SHELF NEARBY, RESSUPLY
if findtype 'storage shelf' ground any any 2 as shelf
    sysmsg 'RESSUPLYING...' 55
    menu shelf 1
    waitforgump 3232825965 600
else
    overhead 'NO SHELFS FOUND TO RESSUPLY!'
endif

if list 'packies' >= 1
    say 'all follow me'
endif

# check and equip axe if needed before starting so we dont waist the main timer equiping the axe
# which was causing the timer to be greater then the lumber timer and the char wouldnt mine when that happened
if lhandempty or not findtype 'hatchet' lefthand
    if not findtype 'hatchet' true
        overhead "| You are out of hatchets|"
        wait 1500
    endif

    if findtype 'hatchet' true
        dclicktype 'hatchet'
        overhead "|equipped new hatchet|"
        wait action_delay
    endif
endif


# # # TRY TO GENERATE A CAPTCHA RIGHT AT THE START
# if lhandempty
#     if findtype 'hatchet' backpack
#         dclicktype 'hatchet'
#         overhead "✩equiped new hatchet✩"
#         wait action_delay
#     else
#         overhead "✩ You are out of hatchets✩"
#         sysmsg "YOU ARE OUT OF HATCHETS!!!" 37
#         sysmsg "YOU ARE OUT OF HATCHETS!!!" 37
#         stop
#     endif
# endif
# 
# sysmsg 'Clicking hatchet to see if captcha appears'
# hotkey 'Use Item in Left Hand'
# wft 1000
# target self


###################################
# TRACKING - BEGIN HUNTING
###################################


if not varexist tracking_gump_id
    @setvar tracking_gump_id 4267467659
endif


if not findbuff 'Tracking Hunting'
    while not gumpexists tracking_gump_id
        sysmsg 'Opening tracking gump...' 53
        skill 'tracking'
        waitforgump tracking_gump_id 600
    endwhile

    if gumpexists tracking_gump_id
        if not ingump 'Stop Hunting' 4267467659
            overhead 'STARTING HUNTING' 65
            gumpresponse 6 tracking_gump_id
            waitforgump tracking_gump_id action_delay
        else
            overhead 'already hunting' 55
        endif

        gumpclose tracking_gump_id
    endif

else
    overhead 'Tracking already ON!' 55
endif


#############################
# ACTIVATE VOID ASPECT IF NEEDED
#############################

if use_void_aspect == 1
    if not varexist aspect_gump_id
        @setvar aspect_gump_id 2424293173
    endif
    
    setvar! aspect_color 2599
    setvar! switch_aspect_btn_number 15
    setvar! activate_aspect_btn_number 17
    
    if findlayer 'self' innertorso as tunic
        if hue tunic != 2599
            sysmsg 'VOID ASPECT NOT ACTIVE. ACTIVATING IT'
    
            # OPEN ASPECT GUMP
            while not gumpexists aspect_gump_id
                sysmsg 'Opening Aspect Gump'
                say '[aspects'
                waitforgump aspect_gump_id action_delay
            endwhile
    
            # CHANGE ARMOR ASPECT TO CORRECT ASPECT
            if not ingump 'Auto Stats Restoration' 2424293173
                overhead "Changing aspect to {{aspect_name}}"
                # while not ingump aspect_unique_text 2424293173
                while not ingump 'Auto Stats Restoration' 2424293173
                    gumpresponse switch_aspect_btn_number aspect_gump_id
                    waitforgump aspect_gump_id action_delay
                endwhile
            endif
    
    
            # ACTIVATE ASPECT ON ARMOR
            waitforgump aspect_gump_id action_delay
            gumpresponse activate_aspect_btn_number aspect_gump_id
            waitforgump aspect_gump_id action_delay
            gumpresponse activate_aspect_btn_number aspect_gump_id
            waitforgump aspect_gump_id action_delay
    
    
            # CHECK IF ASPECT IN FACT ACTIVATED
            if findlayer 'self' innertorso as tunic
                if hue tunic == aspect_color
                    overhead "activated void on armor!" 48
                    sysmsg "Activated void On Armor!" 48
                endif
            endif
    
        endif
    endif
endif


#############################
# SET THE HOME RUNEBOOK
#############################


    #     # unsetvar! next_pouch_index
    # if index == 0
    #     sysmsg 'LIST 0'
    # elseif index == 1
    #     sysmsg 'LIST 1'
    # elseif index == 2
    #     sysmsg 'LIST 2'
    # elseif index == 3
    #     sysmsg 'LIST 3'
    # elseif index == 4
    #     sysmsg 'LIST 4'
    # elseif index == 5
    #     sysmsg 'LIST 0'
    # elseif index == 6
    #     sysmsg 'LIST 0'
    # elseif index == 7
    #     sysmsg 'LIST 0'
    # elseif index == 8
    #     sysmsg 'LIST 8'
    # elseif index == 9
    #     sysmsg 'LIST 9'
    # elseif index == 10
    #     sysmsg 'LIST 10'
    # elseif index == 11
    #     sysmsg 'LIST 11'
    # elseif index == 12
    #     sysmsg 'LIST 12'
    # endif

#############################
# SET THE LUMBER RUNEBOOK BUTTONS TO PRESS TO RECALL
#############################

# runebooks recall via scroll buttons have a interval of 6, so first button is 2, second is 8, and so on...
if not listexists 'runebook_rune_btns'
    createlist 'runebook_rune_btns'

    # runebook page 1
    # we dont push the first rune since its the home rune
    pushlist 'runebook_rune_btns' 11
    pushlist 'runebook_rune_btns' 17
    pushlist 'runebook_rune_btns' 23
    pushlist 'runebook_rune_btns' 29
    pushlist 'runebook_rune_btns' 35
    pushlist 'runebook_rune_btns' 41
    pushlist 'runebook_rune_btns' 47
    
    # runebook page 2
    pushlist 'runebook_rune_btns' 53
    pushlist 'runebook_rune_btns' 59
    pushlist 'runebook_rune_btns' 65
    pushlist 'runebook_rune_btns' 71
    pushlist 'runebook_rune_btns' 77
    pushlist 'runebook_rune_btns' 83
    pushlist 'runebook_rune_btns' 89
    pushlist 'runebook_rune_btns' 95
endif

setvar! runetome_gump_id 167090027
setvar! runebook_gump_id 1551740969

setvar! recall_travel_time 3000

setvar! 1st_circle_spell_mana_cost 8
setvar! 2nd_circle_spell_mana_cost 9
setvar! 3rd_circle_spell_mana_cost 10
setvar! 4th_circle_spell_mana_cost 12



###################################
sysmsg 'STARTING...' 87
###################################

if manual_lumber_mode == 1
    sysmsg 'MANUAL LUMBER MODE SELECTED. ADJUSTING SCRIPT SETTINGS...' 90
    setvar! auto_walk_randomly 0
    setvar! auto_walk_to_direction 1
    clearlist 'lumber_runetomes'
    pushlist 'lumber_runetome' 0
endif


# all guard right now so summons protect char if we start script in the middle of a fight
if followers > 0
    say 'all guard me'
endif

wait action_delay

clearsysmsg
# settimer 'last_sysmsg_timer' 0

# if stockpile nearby, check if logs or boards to unload before starting
if findtype LOGS backpack or findtype BOARDS backpack
    sysmsg 'UNLOADING AT START ON STOCKPILE.'

    if findtype 'resource container' ground any any 2 as stockpile

        while findtype LOGS backpack as boards
            # equip hatchet to cut boards, ressuply from shelf if cant find one
            while lhandempty
                sysmsg 'EQUIPING HATCHET TO CUT BOARDS HOME' 54
    
                if findtype 'hatchet' backpack as hatchet
                    dclick hatchet
                else
                    sysmsg 'NO HATCHET FOUND!' 39
    
                    if findtype 'storage shelf' ground any any 2 as shelf
                        sysmsg 'RESSUPLYING...' 55
                        menu shelf 1
                        waitforgump 3232825965 600
                    endif
                endif
            endwhile
            overhead '*cutting boards*' 49
            sysmsg '> Cutting Boards' 49
            dclick boards
            wait action_delay

        endwhile

        setvar! resource_stockpile stockpile
        menu resource_stockpile 0
        wft 600
        if targetexists 'neutral'
            sysmsg '> Restocking Resource Stockpile...' sysmsgs_color
            target 'self'
        endif
    
        if gumpexists 1859005118
            gumpclose 1859005118
        endif

        # since char is alredy home, make sure to not try to recall there
        setvar recall_home_now 0
    endif
endif

sysmsg '2'

# before starting check if char is not heavy and go home unload
# same conditions as bellow to check if needs to go home and unload
setvar! recall_home_now 0
if diffweight <= max_diffweight_before_unloading and findtype LOGS backpack
    sysmsg 'HEAVY. GOING HOME TO UNLOAD WEIGTH' 54
    setvar recall_home_now 1
endif
sysmsg '8'

if counttype LOGS >= max_boards_before_unloading or counttype BOARDS >= max_boards_before_unloading
    sysmsg 'OVER {{max_boards_before_unloading}} LOGS OR BOARDS. GOING HOME TO UNLOAD WEIGTH' 54
    setvar recall_home_now 1
endif


sysmsg '3'



########################################
# SUMMON BEFORE STARTING
########################################

# PS: this is important so char do3enst recall first then summon later, having chance to recall into a mob and dying without summons to guard him
# this is just a print to inform char is under summon_limit and is getting ready to summon up
# ADDED: only summon if not already going home to unload
if recall_home_now != 1 and auto_summon == 1 and followers < summon_max_limit
    if verbose == 1
        sysmsg 'UNDER SUMMON LIMIT. PREPARING TO SUMMON...' alert_msg_color
    endif




    foreach summon in 'summons'

        if debug == 1
            sysmsg 'CHECKING {{summon}}: {{index}}' default_sysmsg_color
        endif

        if list 'summons' == 1 and followers == 4
            if verbose == 1
                sysmsg 'SUMMONS LIST ONLY HAS 1 SUMMON TYPE AND CHAR ALREADY HAVE 4 HAVE FOLLOWERS {{summon}}' warning_msg_color
            endif

            if debug == 1
                sysmsg 'BREAKING 1 ON CHECKING SUMMON {{summon}}' warning_msg_color
            endif
            break
        elseif list 'summons' > 1 and followers == 5
            if verbose == 1
                sysmsg 'SUMMONS LIST ONLY HAS 1 SUMMON TYPE AND CHAR ALREADY HAVE 5 HAVE FOLLOWERS {{summon}}' warning_msg_color
            endif

            if debug == 1
                sysmsg 'BREAKING 2 ON CHECKING SUMMON {{summon}}' warning_msg_color
            endif
            break
        endif

        unsetvar! found_summon
        setvar! cast_summon_spell 0

        # determine summon name by whether char has necromancy or not
        if use_undead_summons == 1
            # on each iteration, clear and populate this list to set the undead alternative summon based on current summon
            if not listexists 'undead_summons'
                createlist 'undead_summons'
            endif
            clearlist 'undead_summons'

            if 'earth' in summon
                pushlist 'undead_summons' 'an ancient mummy'
            elseif 'fire' in summon
                pushlist 'undead_summons' 'a lich'
            elseif 'air' in summon
                pushlist 'undead_summons' 'a skeletal fiend'
            elseif 'daemon' in summon
                pushlist 'undead_summons' 'a vampire thrall'
            elseif 'water' in summon
                pushlist 'undead_summons' 'a rag witch'
            endif

            # if char is necro, make sure vengeful spirit is activated before summoning
            if list 'undead_summons' > 0
                if timer 'vengeful_spirit_timer' >= 30000
                    if verbose == 1
                        sysmsg '>>> VENGEFUL SPIRIT...' spell_msg_color
                    endif
                    say '[vengefulspirit'

                    wait action_delay

                    if verbose == 1
                        sysmsg '>>> WITHER...' spell_msg_color
                    endif

                    say '[wither'
                    settimer 'vengeful_spirit_timer' 0
                else
                    if verbose == 1
                        sysmsg 'Vengeful Spirit Cooldown..' on_cooldown_msg_color
                    endif
                endif
            endif
        endif


        #########################
        # try to find a similir creature summon to see if we need to cast this one or skip to next one


        if findtype summon ground any 1 find_summon_range as summonserial
            if noto summonserial = friend
                if verbose == 1
                    overhead '*found {{summon}}*' 91 summonserial
                endif

                setvar! found_summon true
            endif
        # if the 'undead_summons' list has elements, we need to check for those undead summons as well
        elseif use_undead_summons == 1
            if list 'undead_summons' > 0
                foreach necro_summon in 'undead_summons'
                    if findtype necro_summon ground any 1 find_summon_range as summonserial
                        if noto summonserial = friend
                            overhead '*found {{summon}}*' 91 summonserial
                            setvar! found_summon true

                            # TESTING HERE (this break was disabled before)
                            # break
                        endif
                    endif
                endfor
            endif
        endif

        # even if we found this summon type, we still might need to cast it (if only 1 summon in list for instance)
        if varexist found_summon
            # clearlist 'found_summon'

            # if theres only one summon in the 'summons' list, even if we found the summon above,
            # we still need to cast it again
            if list 'summons' == 1 and followers < 4
                setvar! cast_summon_spell 1
            # if one of our summons is summ creature and we only have 3 followers, we can still cast another more usefull
            # summon before actually casting summ.creature
            elseif list 'summons' == 2 and followers <= 3 and inlist 'summons' 'summ. creature'
                setvar! cast_summon_spell 1
            elseif list 'summons' >= 3 and followers <= 1
                setvar! cast_summon_spell 1
            # else if theres more than one summon in 'summons' list and we didnt find this specific summon
            # we need to cast ig
            endif
        else
            setvar! cast_summon_spell 1
        endif

        #########################
        # prepare to cast the summon spell for this summon
        if cast_summon_spell == 1
            sysmsg 'msg 1'


            foreach summonspell in 'summonspells'
                if summonspell in summon
                    sysmsg 'inside summonspell {{summonspell}} 2'

                    # first make a mana check for this specific summon spell
                    unsetvar! summon_spell_required_mana
                    if 'creature' in summonspell or 'blade' in summonspell
                        setvar! 'summon_spell_required_mana' 14
                    else
                        setvar! 'summon_spell_required_mana' 50
                    endif

                    if mana < summon_spell_required_mana

                        if timer 'low_mana_for_summoning_warning_msg_timer' >= 2000
                            if verbose == 1
                                sysmsg "!!! LOW MANA FOR {{summon}}. (NEEDS {{summon_spell_required_mana}})..." alert_msg_color
                                overhead "low mana for summoning" alert_msg_color
                            endif

                            settimer 'low_mana_for_summoning_warning_msg_timer' 0
                        endif

                        while mana < summon_spell_required_mana
                            if timer 'low_mana_for_summoning_warning_msg_timer' >= 2000
                                sysmsg 'Meditating to summon {{summon}}...' warning_msg_color
                                settimer 'low_mana_for_summoning_warning_msg_timer' 0
                            endif

                            if not findbuff 'actively meditating'
                                skill 'meditation'
                                wait action_delay
                            endif
                            wait 100

                        endwhile
                    else
                        if verbose == 1
                            sysmsg ">>> SUMMONING {{summon}}..." action_msg_color
                        endif

                        # temporary fix for bug when char keeps trying to cast a 2 slot summon when only 1 slot available
                        if followers == 4 and inlist 'summons' 'summ. creature'
                            cast 'Summ. Creature'
                        else
                            cast summonspell
                        endif

                        if 'blade' in summonspell or 'vortex' in summonspell
                            if verbose == 1
                                sysmsg 'WAITING FOR {{summonspell}} TARGET..' alert_msg_color
                                overhead 'Waiting for {{summonspell}} target..' alert_msg_color
                            endif

                            @settimer 'waiting_summon_timer' 0
                            while not targetexists 'neutral' and timer 'waiting_summon_timer' < cast_summons_delay
                                wft 10
                                if insysmsg 'disturbed'
                                    @settimer 'waiting_summon_timer' 0
                                    if verbose == 1
                                        sysmsg 'BREAKING WHILE WAITING FOR SUMMONING {{summon}}' alert_msg_color
                                    endif

                                    wait spell_recovery_delay
                                    break
                                endif
                            endwhile

                            if targetexists 'neutral'
                                if verbose == 1
                                    sysmsg 'CASTING BLADE OR VORTEX IN GROUND' 55
                                endif

                                targetrelloc 0 1
                                break
                            endif
                        else
                            @settimer 'waiting_summon_timer' 0
                            # TESTING ADDING CLEARSYSMSG HERE AND REMOVING SETTIMER 0
                            clearsysmsg
                            while timer 'waiting_summon_timer' < cast_summons_delay and not insysmsg 'disturbed'
                                wait 10
                                if insysmsg 'disturbed'
                                # TESTING REMOVING THIS
                                    # @settimer 'waiting_summon_timer' 0
                                    if verbose == 1
                                        sysmsg 'BREAKING WHILE WAITING FOR SUMMONING {{summon}}' alert_msg_color
                                    endif

                                    wait spell_recovery_delay
                                    # TESTING REMOVING THIS
                                    # break
                                endif
                            endwhile

                            say 'all guard me'
                        endif

                        # break

                    endif
                endif
            endfor
        endif
    endfor
# CLOSES auto_summon
endif




########################################
# STARTING LOOPING THE RUNEBOOKS
########################################


settimer 'lumber_uptime' 0
setvar! possible_captcha_detected 0

setvar! rune_number 10

# trigger the cooldown once at start so char can start lumbering
cooldown RESOURCES 30000

foreach runebook in 'lumber_runetomes'
    if runebook != 0
        sysmsg '>>> STARTING RUNETOME {{index}}: {{runebook}}'
    endif

    if index == 1
        setvar! runebook_number 1
    elseif index == 2
        setvar! runebook_number 2
    elseif index == 3
        setvar! runebook_number 3
    elseif index == 4
        setvar! runebook_number 4
    endif

    foreach page_number in 'runetome_page_numbers'
        if page_number == 200
            setvar! current_rune_position 1
        elseif page_number == 201
            setvar! current_rune_position 2
        elseif page_number == 202
            setvar! current_rune_position 3
        elseif page_number == 203
            setvar! current_rune_position 4
        elseif page_number == 204
            setvar! current_rune_position 5
        elseif page_number == 205
            setvar! current_rune_position 6
        elseif page_number == 206
            setvar! current_rune_position 7
        elseif page_number == 207
            setvar! current_rune_position 8
        elseif page_number == 208
            setvar! current_rune_position 9
        elseif page_number == 209
            setvar! current_rune_position 10
        elseif page_number == 210
            setvar! current_rune_position 11
        elseif page_number == 211
            setvar! current_rune_position 12
        elseif page_number == 212
            setvar! current_rune_position 13

        # runebook page 2
        elseif page_number == 213
            setvar! current_rune_position 14
        elseif page_number == 214
            setvar! current_rune_position 15
        elseif page_number == 215
            setvar! current_rune_position 16
        elseif page_number == 216
            setvar! current_rune_position 17
        elseif page_number == 217
            setvar! current_rune_position 18
        elseif page_number == 218
            setvar! current_rune_position 19
        elseif page_number == 219
            setvar! current_rune_position 20
        elseif page_number == 220
            setvar! current_rune_position 21
        elseif page_number == 221
            setvar! current_rune_position 22
        elseif page_number == 222
            setvar! current_rune_position 23
        elseif page_number == 223
            setvar! current_rune_position 24
        elseif page_number == 224
            setvar! current_rune_position 25
        elseif page_number == 225
            setvar! current_rune_position 26
        endif

        if runebook != 0
            sysmsg 'RUNE: {{current_rune_position}} (PAGE: {{page_number}})' 90
        endif


        # travel to the rune
        if recall_home_now != 1

            while mana <= 11
                sysmsg 'MEDITATING TO RECALL' warning_msg_color
                if not findbuff 'actively meditating'
                    skill meditation
                    wait action_delay
                endif
                wait action_delay
            endwhile

            sysmsg 'OPENING RUNEBOOK {{runebook}}'
            dclick runebook

            settimer 'waiting_runebook_gump_timer' 0
            if not gumpexists runetome_gump_id and timer 'waiting_runebook_gump_timer' < 2000
                if insysmsg 'You must wait'
                    while insysmsg 'You must wait'
                        clearsysmsg
                        dclick steal_container
                        wait action_delay
                    endwhile
                endif

                sysmsg 'waiting for runebook gump'
                while not gumpexists runetome_gump_id and timer 'waiting_runebook_gump_timer' < 2000
                    waitforgump runetome_gump_id action_delay
                endwhile
            endif

            if gumpexists runetome_gump_id
                waitforgump runetome_gump_id action_delay
                gumpresponse page_number runetome_gump_id
                waitforgump runetome_gump_id action_delay
                sysmsg 'TRAVELLING RUNEBOOK {{runebook}} PAGE NUMBER {{page_number}} RUNE: {{rune_number}}'
                gumpresponse rune_number runetome_gump_id
                wait recall_travel_time
            else
                sysmsg 'COULDNT OPEN RUNEBOOK TO TRAVEL!' 37
            endif
        endif
    
    
        # BEFORE EVERY START
        say 'all guard me'
        wait action_delay

        setvar! attempts_to_find_new_tree_with_logs 0
        setvar! reset_last_sysmsg_timer 0
        settimer 'last_sysmsg_timer' 0
        while not dead 'self'
    
            ########################################
            # PRINT LOOP ON MESSAGE AND SCRIPT STATS
            ########################################
    
            # remember player the loop is active every 30s
            if timer 'loop_on_warning_msg' >= 30000
                settimer 'loop_on_warning_msg' 0

                # sysmsg '************************' 90
                sysmsg '∞ Lumber Bot by gugutz. Uptime: {{lumber_uptime}} ms' 89
                sysmsg 'Last captcha was: {{last_gump_tracking_timer}}ms ago' 90
                sysmsg 'Uptime: {{lumber_uptime}}'


                # print when last captcha was detected
                # warn when captcha is close to average catcha interval
                if timer 'last_gump_tracking_timer' > 1200000
                    sysmsg "▷ LAST CAPTCHA OVER 20 MINUTES AGO!" 40
                # elseif timer 'last_gump_tracking_timer' > average_captcha_gump_interval
                elseif timer 'last_gump_tracking_timer' > 900000
                    sysmsg "▷ LAST CAPTCHA OVER 15 MINUTES AGO!" 41
                elseif timer 'last_gump_tracking_timer' > 600000
                    sysmsg "▷ LAST CAPTCHA OVER 10 MINUTES AGO!" 52
                elseif timer 'last_gump_tracking_timer' > 300000
                    sysmsg "▷ LAST CAPTCHA OVER 5 MINUTES AGO!" 57
                endif
                # sysmsg '************************' 90

            endif
    
            if not cooldown RESOURCES
                if timer 'waiting_cooldown_timer' > max_wait_for_last_sysmsg_to_suspect_gump
                    settimer 'waiting_cooldown_timer' 0
                    if possible_captcha_detected == 0
                        setvar! possible_captcha_detected 1
                        settimer 'last_gump_tracking_timer' 0
                    endif
    
                    overhead "✩ GUMP PRESENT or LAGGED ✩" 33
                    sysmsg "✩ GUMP PRESENT or LAGGED ✩" 33
                    sysmsg "✩ GUMP PRESENT or LAGGED ✩" 34
                    sysmsg "✩ GUMP PRESENT or LAGGED ✩" 35
    
    
                    # play an instrument as a way of playing a sound to notify about the captcha
                    if findtype 3763|3740|10245|3742|3762 backpack as instrument
                        wait action_delay
                        dclick instrument
                        wait action_delay
                        break
                    endif
                else
                    wait 10
                endif
            endif

            # TOGGLE LANTERN TO MAKE CHAR SKIP CURRENT RUNE
            if findtype 2594|2598|2578|30580 self
            elseif not findtype 2597|3947 backpack and findtype 2597|3947 self as lights
                sysmsg '[LANTERN OFF] SKIPING TO NEXT RUNE' 54
                wait action_delay
                dclick lights
                wait action_delay
                setvar! go_to_next_rune 1
            endif


            ########################################
            # MOST IMPORTANT ROUTINE - KEEP SUMMONS UP!
            ########################################
        
            # this is just a print to inform char is under summon_limit and is getting ready to summon up
            if auto_summon == 1 and followers < summon_max_limit
                if debug == 1
                    sysmsg '[DEBUG] PREPARING TO RESUMMON' debug_msg_color
                endif
        
                if verbose == 1
                    sysmsg 'UNDER SUMMON LIMIT. PREPARING TO SUMMON...' alert_msg_color
                endif
        
        
        
        
                foreach summon in 'summons'
        
                    if debug == 1
                        sysmsg 'CHECKING {{summon}}: {{index}}' default_sysmsg_color
                    endif
        
                    if list 'summons' == 1 and followers == 4
                        sysmsg 'SUMMONS LIST ONLY HAS 1 SUMMON TYPE AND CHAR ALREADY HAVE 4 HAVE FOLLOWERS {{summon}}' warning_msg_color
        
                        sysmsg 'BREAKING 1 ON CHECKING SUMMON {{summon}}' warning_msg_color
                        break
                    elseif list 'summons' > 1 and followers == 5
                        if verbose == 1
                            sysmsg 'SUMMONS LIST ONLY HAS 1 SUMMON TYPE AND CHAR ALREADY HAVE 5 HAVE FOLLOWERS {{summon}}' warning_msg_color
                        endif
        
                        sysmsg 'BREAKING 2 ON CHECKING SUMMON {{summon}}' warning_msg_color
                        break
                    endif
        
                    setvar! found_summon 0
                    setvar! cast_summon_spell 0
        
                    # determine summon name by whether char has necromancy or not
                    if use_undead_summons == 1
                        # on each iteration, clear and populate this list to set the undead alternative summon based on current summon
                        if not listexists 'undead_summons'
                            createlist 'undead_summons'
                        endif
                        clearlist 'undead_summons'
        
                        if 'earth' in summon
                            pushlist 'undead_summons' 'an ancient mummy'
                        elseif 'fire' in summon
                            pushlist 'undead_summons' 'a lich'
                        elseif 'air' in summon
                            pushlist 'undead_summons' 'a skeletal fiend'
                        elseif 'daemon' in summon
                            pushlist 'undead_summons' 'a vampire thrall'
                        elseif 'water' in summon
                            pushlist 'undead_summons' 'a rag witch'
                        endif

                        # if char is necro, make sure vengeful spirit is activated before summoning
                        if list 'undead_summons' > 0
                            if timer 'vengeful_spirit_timer' >= 30000
                                if verbose == 1
                                    sysmsg '>>> VENGEFUL SPIRIT...' spell_msg_color
                                endif
                                say '[vengefulspirit'
            
                                wait action_delay
            
                                if verbose == 1
                                    sysmsg '>>> WITHER...' spell_msg_color
                                endif
            
                                say '[wither'
                                settimer 'vengeful_spirit_timer' 0
                            else
                                if verbose == 1
                                    sysmsg 'Vengeful Spirit Cooldown..' on_cooldown_msg_color
                                endif
                            endif
                        endif
                    endif
        
        
                    #########################
                    # try to find a similir creature summon to see if we need to cast this one or skip to next one
        
        
                    if findtype summon ground any 1 find_summon_range as summonserial
                        if noto summonserial = friend
                            if verbose == 1
                                overhead '*found {{summon}}*' 91 summonserial
                            endif
        
                            setvar! found_summon 1
                        endif
                    # if the 'undead_summons' list has elements, we need to check for those undead summons as well
                    elseif use_undead_summons == 1
                        if list 'undead_summons' > 0
                            foreach necro_summon in 'undead_summons'
                                if findtype necro_summon ground any 1 find_summon_range as summonserial
                                    if noto summonserial = friend
                                        overhead '*found {{summon}}*' 91 summonserial
                                        setvar! found_summon 1
            
                                        # TESTING HERE (this break was disabled before)
                                        # break
                                    endif
                                endif
                            endfor
                        endif
                    endif
        
                    # even if we found this summon type, we still might need to cast it (if only 1 summon in list for instance)
                    if found_summon == 1
                        # clearlist 'found_summon'
        
                        # if theres only one summon in the 'summons' list, even if we found the summon above,
                        # we still need to cast it again
                        if list 'summons' == 1 and followers < 4
                            setvar! cast_summon_spell 1
                        # if one of our summons is summ creature and we only have 3 followers, we can still cast another more usefull
                        # summon before actually casting summ.creature
                        elseif list 'summons' == 2 and followers <= 3 and inlist 'summons' 'summ. creature'
                            setvar! cast_summon_spell 1
                        elseif list 'summons' >= 3 and followers <= 1
                            setvar! cast_summon_spell 1
                        # else if theres more than one summon in 'summons' list and we didnt find this specific summon
                        # we need to cast ig
                        endif
                    else
                        if debug == 1
                            sysmsg '[DEBUG] setting to cast summon spell ({{summon}} not found)' debug_msg_color
                        endif
                        setvar! cast_summon_spell 1
                    endif
        
                    #########################
                    # prepare to cast the summon spell for this summon
                    if cast_summon_spell == 1
        
        
                        foreach summonspell in 'summonspells'
        
                            sysmsg 'inside summonspell {{summonspell}}'
                            if summonspell in summon
                                sysmsg 'inside if summon {{summonspell}} in {{summon}}'
        
                                # first make a mana check for this specific summon spell
                                unsetvar! summon_spell_required_mana
                                setvar! summon_spell_required_mana 50


                                if 'creature' in summonspell or 'blade' in summonspell
                                    setvar! summon_spell_required_mana 14
                                endif
        
                                if varexist summon_spell_required_mana
                                    if mana < summon_spell_required_mana
        
                                        if timer 'low_mana_for_summoning_warning_msg_timer' >= 2000
                                            if verbose == 1
                                                sysmsg "!!! LOW MANA FOR SUMMONING {{summon}}. (NEEDS {{summon_spell_required_mana}})..." alert_msg_color
                                                overhead "low mana for summoning" alert_msg_color
                                            endif
        
                                            settimer 'low_mana_for_summoning_warning_msg_timer' 0
                                        endif
                                    else
                                        if verbose == 1
                                            sysmsg ">>> SUMMONING {{summon}}..." action_msg_color
                                        endif

                                        # temporary fix for bug when char keeps trying to cast a 2 slot summon when only 1 slot available
                                        if followers == 4 and inlist 'summons' 'summ. creature'
                                            cast 'Summ. Creature'
                                        else
                                            cast summonspell
                                        endif
        
                                        if 'blade' in summonspell or 'vortex' in summonspell
                                            if verbose == 1
                                                sysmsg 'WAITING FOR {{summonspell}} TARGET..' alert_msg_color
                                                overhead 'Waiting for {{summonspell}} target..' alert_msg_color
                                            endif
        
                                            @settimer 'waiting_summon_timer' 0
                                            while not targetexists 'neutral' and timer 'waiting_summon_timer' < cast_summons_delay
                                                wft 10
                                                if insysmsg 'disturbed'
                                                    @settimer 'waiting_summon_timer' 0
                                                    if verbose == 1
                                                        sysmsg 'BREAKING WHILE WAITING FOR SUMMONING {{summon}}' alert_msg_color
                                                    endif
        
                                                    wait spell_recovery_delay
                                                    break
                                                endif
                                            endwhile
        
                                            if targetexists 'neutral'
                                                if verbose == 1
                                                    sysmsg 'CASTING BLADE OR VORTEX IN GROUND' 55
                                                endif
        
                                                targetrelloc 0 1
                                                break
                                            endif
                                        else
                                            @settimer 'waiting_summon_timer' 0
                                            while timer 'waiting_summon_timer' < cast_summons_delay
                                                wait 10
                                                if insysmsg 'disturbed'
                                                    @settimer 'waiting_summon_timer' 0
                                                    if verbose == 1
                                                        sysmsg 'BREAKING WHILE WAITING FOR SUMMONING {{summon}}' alert_msg_color
                                                    endif
        
                                                    wait spell_recovery_delay
                                                    break
                                                endif
                                            endwhile
        
                                            say 'all guard me'
                                        endif
        
                                        break
        
                                    endif
                                endif
                            endif
                        endfor

                        setvar! reset_last_sysmsg_timer 1
                    # CLOSES if varexist cast_summon_spell
                    endif
                endfor
            # CLOSES auto_summon
            endif
    

            #####################################
            # KEEP MOBS GUARDING PLAYER
            #####################################
        
            # TESTING also checking if dead so it doenst all guard before the 2 all follows for luring current lasttarget
            # if auto_all_guard == 1 and timer 'all_guard_timer' >= all_guard_delay
            # if auto_all_guard == 1 and timer 'all_guard_timer' >= all_guard_delay
            #     say 'all guard me'
            #     settimer 'all_guard_timer' 0
            #     # setvar! reset_last_sysmsg_timer 1
            # endif


            ########################################
            # KEEP CHAR BUFFED UP
            ########################################
        
            # reflect buff
            if followers >= summon_max_limit and diffhits < max_diffhits_before_buffing
                if use_magic_reflection == 1 and not findbuff 'magic reflection' and mana >= 4th_circle_spell_mana_cost
                    sysmsg '>>> MAGIC REFLECT' spell_msg_color
                    cast 'magic reflection'
    
                    @settimer 'waiting_spell_timer' 0
                    while not findbuff 'magic reflection' and timer 'waiting_spell_timer' < 3000
                        wait 10
                        if insysmsg 'disturbed' or insysmsg 'spell will not adhere' or insysmsg 'cannot cast a spell'
                            sysmsg 'BREAKING WHILE WAITING FOR MAGIC REFLECTION' warning_msg_color
                            wait spell_recovery_delay
                            break
                        endif
                    endwhile
    
                    wait spell_recovery_delay
    
                    if findbuff 'magic reflection'
                        overhead '+MAGIC REFLECT' buff_msg_color
                    endif

                    setvar! reset_last_sysmsg_timer 1
                endif

            endif

            # reactive armor buff
            if followers >= summon_max_limit and diffhits < max_diffhits_before_buffing
                if use_reactive_armor == 1 and not findbuff 'reactive armor' and mana >= 3rd_circle_spell_mana_cost
                    if verbose == 1
                        sysmsg '>>> REACTIVE ARMOR' spell_msg_color
                    endif
    
                    cast 'reactive armor'
                    @settimer 'waiting_spell_timer' 0
                    while not findbuff 'reactive armor' and timer 'waiting_spell_timer' < 2000
                        wait 10
                        if insysmsg 'disturbed' or insysmsg 'spell will not adhere' or insysmsg 'cannot cast a spell'
                            if verbose == 1
                                sysmsg 'BREAKING WHILE WAITING FOR REACTIVE ARMOR' warning_msg_color
                            endif
    
                            wait spell_recovery_delay
                            break
                        endif
                    endwhile
    
                    wait spell_recovery_delay
    
                    if findbuff 'reactive armor'
                        overhead '+reactive' buff_msg_color
                    endif

                    # setvar! reset_last_sysmsg_timer 1
                endif
            endif


            ########################################
            # CHECK FOR THIEFS
            ########################################

            if is_detecter == 1
                useskill 'detectinghidden'
                wait action_delay
                if targetexists 'neutral'
                    target self
                endif

                if insysmsg 'you reveal what was hidden.'
                    sysmsg '!FOUND HIDDEN PLAYER!' alert_msg_color
                    sysmsg '> FOUND HIDDEN PLAYER! PROBABLY THIEF!' alert_msg_color
                endif
            endif

            # this piece has to run after using detecting hiden to find the player revealed
            if auto_escape_thiefs == 1
                # sysmsg '▷ SEARCHING FOR GREY PLAYERS ON SCREEN'
                # hotkey 'Next Grey Player Target'
                if insysmsg 'New target'
                    sysmsg '> FOUND THIEF! ESCAPING!' alert_msg_color
                    setvar! recall_home_now 1
                endif
            endif

            ########################################
            # CHECK FOR PKS
            ########################################

            # try to get pks that already appeared on screen and couldnt get tracked first
            if auto_escape_pks == 1
                # sysmsg '▷ SEARCHING FOR PKS ON SCREEN'
                # @hotkey 'Next Murderer Player Target'
                if insysmsg 'New target'
                    sysmsg '!!!!!!! FOUND PK! RUN!!!!!!!' alert_msg_color
                    sysmsg '!!!!!!! FOUND PK! RUN!!!!!!!' alert_msg_color
                    sysmsg '!!!!!!! FOUND PK! RUN!!!!!!!' alert_msg_color
                    sysmsg '!!!!!!! FOUND PK! RUN!!!!!!!' alert_msg_color

                    overhead '!!!!!!! FOUND PK! RUN!!!!!!!' alert_msg_color
                    overhead '!!!!!!! FOUND PK! RUN!!!!!!!' alert_msg_color
                    overhead '!!!!!!! FOUND PK! RUN!!!!!!!' alert_msg_color
                    overhead '!!!!!!! FOUND PK! RUN!!!!!!!' alert_msg_color

                    setvar! recall_home_now 1
                endif

                if cooldown 'UNDER ATTACK' or insysmsg 'Attacking you'
                    if verbose == 1
                        sysmsg '>>> BEING ATTACKED! TRYING TO ESCAPE...' alert_msg_color
                        sysmsg '>>> BEING ATTACKED! TRYING TO ESCAPE...' alert_msg_color
                        sysmsg '>>> BEING ATTACKED! TRYING TO ESCAPE...' alert_msg_color
                        sysmsg '>>> BEING ATTACKED! TRYING TO ESCAPE...' alert_msg_color
                    endif

                    setvar! recall_home_now 1
                endif
            endif
        
            if cooldown 'OUT OF REGS' > 0
                sysmsg 'OUT OF REGS! GONNA TRAVEL HOME TO RESSUPLY' 54
                setvar! recall_home_now 1
            endif
    
    
            ########################################
            # MAIN LUMBER ROUTINE
            ########################################

            # if we dont suspect gump, start lumbering and monitor char weight
            # update: if we are coming from summoning or buffing above, we need to make sure we didnt set to reset the sysmsg timer, or else even if theres no sysmsg
            # the timer will be reset and it will not detect a gump

            # if reset_last_sysmsg_timer == 0 and timer 'last_sysmsg_timer' < max_wait_for_last_sysmsg_to_suspect_gump


            if cooldown RESOURCES and recall_home_now != 1

                if possible_captcha_detected == 1
                    setvar! possible_captcha_detected 0
                endif
                # sysmsg 'Timer low...' 65
        
                if lhandempty
                    if not findtype 'hatchet' backpack
                        overhead "| You are out of hatchets|"
                        sysmsg "OUT OF HATCHETS! GOING HOME TO RESSUPLY!" warning_msg_color
                        setvar! recall_home_now 1
                        # script "WaitAndWatch"
                    else
                        dclicktype 'hatchet'
                        overhead "|equipped new hatchet|"
                        wait action_delay
                    endif
                endif
        
                # if timer 'last_sysmsg_timer' < max_wait_for_last_sysmsg_to_use_hatchet and not lhandempty
    
                settimer 'waiting_hatchet_target_timer' 0

                while not lhandempty and not targetexists 'neutral' and cooldown RESOURCES
                    if timer 'waiting_hatchet_target_timer' > max_wait_for_hatchet_target
                        sysmsg 'BREAKING CLICKING HATCHET' 37
                        break
                    endif

                    # sysmsg 'USING ITEM IN HAND'
                    hotkey 'Use item in Hand'
                    waitfortarget action_delay
                    # waitfortarget max_wait_for_last_sysmsg_to_use_hatchet
                endwhile
    
                if targetexists 'neutral' and followers >= summon_max_limit
                    # sysmsg 'Lumbering...' 65
                    cooldown RESOURCES 0
                    target 'self'
                endif
    
                # TESTING: REMOVING THIS WAIT
                # wait max_wait_for_last_sysmsg_to_use_hatchet
                # endif
        
    
                ##############################################
                # LUMBER MAPS ROUTINE
                # if heavy and there are packies nearby, unload
    
                if findtype 'map' backpack 2799 any as lumber_map
                    getlabel lumber_map lumber_map_label
                    if "completed by" in lumber_map_label
                        overhead 'LUMBER MAP COMPLETE!' 90
    
                        # drop completed ore map
                        lift lumber_map 1
                        wait action_delay
                        overhead "dropping completed lumber map"
                        if findtype 'barrel' ground 0 1 2 as trashcan
                            sysmsg "Dropping Completed Map On Trash Barrel" sysmsgs_color
                            drop trashcan -1 -1 0
                        else
                            sysmsg "Dropping Completed Map On The Ground" sysmsgs_color
                            droprelloc 0 0
                        endif
    
                        clearsysmsg
                        stop
                    else
                        sysmsg 'Doing Lumber Map...' 49
                        # setvar! reset_last_sysmsg_timer 1
                        # cooldown RESOURCES resource_cooldown_value
                    endif
                endif
        
    
            endif
    
            ##############################################
            # CHECK IF CHAR NEEDS TO UNLOAD
            if diffweight <= max_diffweight_before_unloading and findtype LOGS backpack
                sysmsg 'HEAVY. GOING HOME TO UNLOAD WEIGTH' 54
                setvar recall_home_now 1
            endif
            if counttype LOGS >= max_boards_before_unloading or counttype BOARDS >= max_boards_before_unloading
                sysmsg 'OVER 1k LOGS OR BOARDS. GOING HOME TO UNLOAD WEIGTH' 54
                setvar recall_home_now 1
            endif

            ##############################################
            # HIDE COLORED WOOD IN CHAR_LOOT_POUCH
            if recall_home_now != 1 and hide_colored_resources_in_char_loot_pouch == 1 and varexist CHAR_LOOT_POUCH
                # sysmsg 'ENTERING HIDING COLORED WOOD'
                while findtype 7133|7127 backpack as found
                    if hue found != 0
                        getlabel found flabel

                        if not find found CHAR_LOOT_POUCH
                            sysmsg 'HIDING {{flabel}}'
                            lift found 60000
                            wait 50
                            while queued
                            endwhile

                            drop CHAR_LOOT_POUCH
                            wait 50
                            while queued
                            endwhile
                        endif
                    endif
                    @ignore found
                endwhile
                @clearignore
            endif
    
            ####################################
            # RE-TRAP LOOT TRAP POUCH WHEN NEEDED
            if recall_home_now != 1 and varexist CHAR_LOOT_POUCH
                if find CHAR_LOOT_POUCH backpack
                    while hue CHAR_LOOT_POUCH == 0
                        sysmsg '>>> RE-TRAPING LOOT POUCH' warning_msg_color
                        overhead '*re-traping loot pouch*' warning_msg_color
                
                        cast 'magic trap'
                        wft 1500
                        target CHAR_LOOT_POUCH
                        wait action_delay
                
                        # @setvar pouches_organized 0
                    endwhile
                endif
            endif
    
    
            # ALL FOLLOWING ROUTINES ONLY IF NOT FLAGGED TO GO HOME
            if recall_home_now != 1

                ###############################################
                # JOURNAL MESSAGES CHECKS
                ###############################################

                # we need to first check for pks or else the other msgs might not allow us to get to this check
                if insysmsg 'now tracking'
                    sysmsg '>>> PK...' 19
                    sysmsg '>>> PK...' 49
                    sysmsg '>>> PK...' 54
                    overhead '!! PK !!' 19
                    overhead '!! PK !!' 49
                    overhead '!! PK !!' 54
            
                    if auto_escape_pks == 1
                        sysmsg '>>> ESCAPING PK!!!' 41
                        overhead '!! ESCAPING PK !!' 41

                        setvar! recall_home_now 1
                    endif
            
        
            
            
                # handle world saves
                elseif insysmsg "The world is saving"
                    overhead '*WORLD SAVING*' 90
                    settimer 'waiting_world_save_timer' 0
                    while not insysmsg 'World save complete'
                        wait 100
                        if timer 'waiting_world_save_timer' >= world_save_delay
                            sysmsg 'BREAKING WAITING FOR SAVE' 49
                            break
                        endif
                    endwhile
            
                    if insysmsg 'World save complete'
                        overhead '*save complete!*' 90
                        # setvar! reset_last_sysmsg_timer 1
                        # cooldown RESOURCES resource_cooldown_value
                    endif
            
                # handle tools breaking
                elseif insysmsg "You broke your axe"
                    overhead 'HATCHET BROKE!' 90
        
                    if not lhandempty and not findtype 'hatchet' lefthand
                        overhead 'undressing hands for hatchet'
                        hotkey "Undress Both Hands"
                        wait action_delay
                    endif
        
                    if rhandempty
                        if findtype 'hatchet' backpack
                            dclicktype 'hatchet'
                            overhead "✩equipped new hatchet✩"
                        else
                            overhead "✩ You are out of hatchet✩"
                            setvar! recall_home_now 0
                        endif
                    endif
        
                    # setvar! reset_last_sysmsg_timer 1
                    # cooldown RESOURCES resource_cooldown_value
            
            
                # no resources where char is
                elseif insysmsg "You do not see any harvestable resources nearby"
                    # track how many empty trees we hit to decide whether to go to next rune

                    # update attempt number
                    if attempts_to_find_new_tree_with_logs == 0
                        setvar! attempts_to_find_new_tree_with_logs 1
                    elseif attempts_to_find_new_tree_with_logs == 1
                        setvar! attempts_to_find_new_tree_with_logs 2
                    elseif attempts_to_find_new_tree_with_logs == 2
                        setvar! attempts_to_find_new_tree_with_logs 3
                    elseif attempts_to_find_new_tree_with_logs == 3
                        setvar! attempts_to_find_new_tree_with_logs 4
                    elseif attempts_to_find_new_tree_with_logs == 4
                        setvar! attempts_to_find_new_tree_with_logs 5
                    elseif attempts_to_find_new_tree_with_logs == 5
                        setvar! attempts_to_find_new_tree_with_logs 6
                    elseif attempts_to_find_new_tree_with_logs == 6
                        setvar! attempts_to_find_new_tree_with_logs 7
                    elseif attempts_to_find_new_tree_with_logs == 7
                        setvar! attempts_to_find_new_tree_with_logs 8
                    elseif attempts_to_find_new_tree_with_logs == 8
                        setvar! attempts_to_find_new_tree_with_logs 9
                    elseif attempts_to_find_new_tree_with_logs == 9
                        setvar! attempts_to_find_new_tree_with_logs 10
                    elseif attempts_to_find_new_tree_with_logs == 10
                        setvar! attempts_to_find_new_tree_with_logs 11
                    elseif attempts_to_find_new_tree_with_logs == 11
                        setvar! attempts_to_find_new_tree_with_logs 12
                    elseif attempts_to_find_new_tree_with_logs == 12
                        setvar! attempts_to_find_new_tree_with_logs 13
                    elseif attempts_to_find_new_tree_with_logs == 13
                        setvar! attempts_to_find_new_tree_with_logs 14
                    elseif attempts_to_find_new_tree_with_logs == 14
                        setvar! attempts_to_find_new_tree_with_logs 15
                    elseif attempts_to_find_new_tree_with_logs == 15
                        setvar! attempts_to_find_new_tree_with_logs 16
                    elseif attempts_to_find_new_tree_with_logs == 16
                        setvar! attempts_to_find_new_tree_with_logs 17
                    elseif attempts_to_find_new_tree_with_logs == 17
                        setvar! attempts_to_find_new_tree_with_logs 18
                    elseif attempts_to_find_new_tree_with_logs == 18
                        setvar! attempts_to_find_new_tree_with_logs 19
                    elseif attempts_to_find_new_tree_with_logs == 19
                        setvar! attempts_to_find_new_tree_with_logs 20
                    endif

                    if attempts_to_find_new_tree_with_logs == max_walk_attempts_per_rune
                        # sysmsg 'ATTEMPT 11'
                        sysmsg '[RUNEBOOK {{runebook}} | RUNE {{rune_number}}] MAX ATTEMPTS REACHED: {{attempts_to_find_new_tree_with_logs}}' 40
                        setvar! go_to_next_rune 1
                    else
                        sysmsg '[RUNEBOOK {{runebook}} | RUNE {{rune_number}}] ATTEMPT {{attempts_to_find_new_tree_with_logs}}' 90
                    endif

                    if auto_walk_to_direction == 1
                        foreach direction in 'direction_to_walk'
                            walk direction
                            break
                        endfor
                    endif
            
                    # setvar! reset_last_sysmsg_timer 1
                    # cooldown RESOURCES resource_cooldown_value
                    overhead '| NO WOOD HERE |' 54
            
                    if auto_walk_randomly == 1
                        random 8
                        if insysmsg 'Random: 1'
                            foreach x in number_of_steps_per_walk
                                walk 'south'
                            endfor
                        elseif insysmsg  'Random: 2'
                            foreach x in number_of_steps_per_walk
                                walk 'down'
                            endfor
                        elseif insysmsg  'Random: 3'
                            foreach x in number_of_steps_per_walk
                                walk 'east'
                            endfor
                        elseif insysmsg  'Random: 4'
                            foreach x in number_of_steps_per_walk
                                walk 'right'
                            endfor
                        elseif insysmsg  'Random: 5'
                            foreach x in number_of_steps_per_walk
                                walk 'north'    
                            endfor
                        elseif insysmsg  'Random: 6'
                            foreach x in number_of_steps_per_walk
                                walk 'up'
                            endfor
                        elseif insysmsg  'Random: 7'
                            foreach x in  number_of_steps_per_walk
                                walk 'west'
                            endfor
                        elseif insysmsg  'Random: 8'
                            foreach x in  number_of_steps_per_walk
                                walk 'left'
                            endfor
                        endif
                    endif
            
            
            
        #         # lumber fail message
        #         elseif insysmsg "You hack"
        #             setvar! reset_last_sysmsg_timer 1
        #             overhead '| hacked |'
        #     
        #     
        #     
        #         # when char is on cooldown for having traveled recently
                elseif insysmsg 'You have recently traveled and must wait'
        #             setvar! reset_last_sysmsg_timer 1
                    overhead '!travel cooldown!' 43
        #     
        #     
        #         # action cooldowns (when sysmsg prints 'You must wait...') will break the macro, so we need to get them as well
                elseif insysmsg "You must wait to perform another action"
        #             setvar! reset_last_sysmsg_timer 1
                    overhead '! action cooldown !' 54
        # 
        #         # skill cooldowns will break the macro, so we need to get them as well
                elseif insysmsg "You must wait a few moments before using another skill"
        #             setvar! reset_last_sysmsg_timer 1
                    overhead '! skill cooldown !' 54
        #     
        #         # areas where harvesting is not allowed have a different sysmsg
                elseif insysmsg "Harvesting is not allowed in this area"
        #             setvar! reset_last_sysmsg_timer 1
                    overhead 'harvest not allowed. move!' 53
        # 
        # 
        # 
        #     # this msg is overhead, not sysmsg, thus we cant know if a char is doing a lumbermap
                elseif insysmsg 'You gather some'
                    overhead '| lumber map |' 15
        #             setvar! reset_last_sysmsg_timer 1
        
        
                # I TRIED LOOPING THROUGH A LIST INSTEAD OF USING MULTIPLE IF/ELSE AND DIDNT WORK, THE LOOP BREAKS THE MACRO
                elseif insysmsg 'Dullwood'
                    overhead '| DULLWOOD |' 248
                    # setvar! reset_last_sysmsg_timer 1
                elseif insysmsg 'shadowwood'
                    overhead '| SHADOWWOOD |' 193
                    # setvar! reset_last_sysmsg_timer 1
                elseif insysmsg 'Copperwood'
                    overhead '| COPPERWOOD |' 248
                    # setvar! reset_last_sysmsg_timer 1
                elseif insysmsg 'Bronzewood'
                    overhead '| BRONZEWOOD |' 248
                    # setvar! reset_last_sysmsg_timer 1
                elseif insysmsg 'Goldenwood'
                    overhead '| GOLDENWOOD |' 55
                    # setvar! reset_last_sysmsg_timer 1
                elseif insysmsg 'Rosewood'
                    overhead '| ROSEWOOD |' 55
                    # setvar! reset_last_sysmsg_timer 1
                elseif insysmsg 'Verewood'
                    overhead '| VEREWOOD |' 55
                    # setvar! reset_last_sysmsg_timer 1
                elseif insysmsg 'Valewood'
                    overhead '| VALEWOOD |' 33
                    # setvar! reset_last_sysmsg_timer 1
                elseif insysmsg 'Avarwood'
                    overhead '| AVARWOOD |' 33
                    # setvar! reset_last_sysmsg_timer 1
                # regular logs have to be checked last because all of the above also have the word 'logs'
                # so it was always thinking it got regular logs, even when getting colored
                elseif insysmsg 'Logs'
                    overhead '| logs |' 15
                    # setvar! reset_last_sysmsg_timer 1
        
        
        
        
                # # catch captcha successful msgs
                # elseif insysmsg "Captcha successful"
                #     overhead 'captcha anwsered succesfully' 90
                #     sysmsg 'Captcha Anwsered Succesfully!' 90
        
        
                # catch captcha failure msgs
                elseif insysmsg "Due to previous captcha failures"
                    overhead '! resource locked !' 33
                    sysmsg 'CAPTCHA FAILED AND CHAR IS RESOURCE LOCKED. STOPPING MACRO...' 33
                    stop
        
        
                endif
        
        
        
        
        
                ########################################
                # HANDLE POISON
                ########################################
        
                if poisoned
                    if findtype 'orange potion' backpack
                        sysmsg 'Curing poison with potion...' 90
                        hotkey 'Drink Cure'
                    elseif magery >= 50 and counttype 'Garlic' > 0 and counttype 'Ginseng' > 0
                        sysmsg 'Curing poison with magery...' 90
                        cast 'Cure'
        
                        @settimer 'waiting_target_timer' 0
                        while not targetexists 'beneficial' and timer 'waiting_target_timer' < 1500
                            wait 100
                            if insysmsg 'disturbed' or insysmsg 'cannot cast a spell while frozen'
                                sysmsg 'BREAKING WHILE WAITING FOR GREATER HEAL TARGET'
                                break
                            endif
                        endwhile
        
                        if targetexists 'beneficial'
                            target 'self'
                        endif
                    endif

                    if healing >= 50 and counttype 'clean bandage%s%' > 0
                        # if not bandaging
                        if bandaging == 0
                            sysmsg '[DEBUG] bandage 001'
                            overhead '*applying bandages*' 65
                            hotkey 'Bandage Self'
        
                            wait action_delay
                        elseif bandaging > 10
                            overhead '10+ secs till next bandage!' 52
                        elseif bandaging > 5
                            overhead '5+ secs till next bandage!' 52
                        else
                            overhead 'less than 5 secs till next bandage!' 52
                        endif
                    endif
                endif
        
        
        
                ########################################
                # MAINTAIN CHAR HP
                ########################################
        
                if diffhits > max_diffhits_before_starting_heal_routine
                    # heal with pots
                    if diffhits > max_diffhits_before_healing_with_potion
                        if findtype 'yellow potion' backpack
                            hotkey 'Drink Heal'
                            wait action_delay
                        endif
                    endif
        
                    # heal with healing
                    if diffhits > max_diffhits_before_healing_with_bandages and skill 'healing' >= min_healing_to_use_bandages
                        # if not bandaging
                        if bandaging == 0
                            sysmsg '[DEBUG] bandage 002'
                            overhead '*applying bandages*' 65
                            hotkey 'Bandage Self'
        
                            wait action_delay
                        elseif bandaging > 10
                            overhead '10+ secs till next bandage!' 52
                        elseif bandaging > 5
                            overhead '5+ secs till next bandage!' 52
                        else
                            overhead 'less than 5 secs till next bandage!' 52
                        endif
                    endif
        
                    # heal with magery
                    if diffhits > max_diffhits_before_healing_with_magery and skill 'magery' >= 50 and mana >= 11
                        cast 'greater heal'
        
                        @settimer 'waiting_target_timer' 0
                        while not targetexists 'beneficial' and timer 'waiting_target_timer' < 3500
                            wait 100
                            if insysmsg 'disturbed' or insysmsg 'cannot cast a spell while frozen'
                                sysmsg 'BREAKING WHILE WAITING FOR GREATER HEAL TARGET'
                                break
                            endif
                        endwhile
        
                        if targetexists 'beneficial'
                            hotkey 'Target Self'
                        endif
                    endif
                endif
        
        
        
                ########################################
                # DEFEND AGAINST MONSTERS ROUTINE
                ########################################
        
                if diffhits > max_diffhits_before_starting_defense_routine
                    if not find 'last' ground any any 2 or not dead 'last' or noto 'last' != hostile
                        overhead 'searching for mobs to kill...' 52
                        hotkey 'Target Closest Non-Friendly Monster'
                        wait action_delay
        
                        # TESTING REMOVING THIS
                        # if there is not a captcha present already, reset timer to make sure the script wont bug after killing the mob
                        # if timer 'last_sysmsg_timer' < max_wait_for_last_sysmsg_to_suspect_gump
                        #     sysmsg 'Flaging to reset catpcha timer while searching for mobs...' 54
                        #     setvar! reset_last_sysmsg_timer 1
                        # endif
        
                    endif
        
                    while find 'last' ground any any max_mob_range_to_attack and not dead 'last'
                    # if lasttarget is self or friendly, we cancel the target
                        if lasttarget == self or noto lasttarget == friendly
                            overhead 'cancelling self or friendly as target!' 52
                            hotkey 'Cancel Current Target'
                            setvar! reset_last_sysmsg_timer 1
                        endif

                        # elseif noto lasttarget != friend and noto lasttarget != friendly
                        if noto lasttarget == hostile and lasttarget != self
                            overhead '|| LUMBER TARGET ||' 90 'last'

                            sysmsg '[RUNE {{rune_number}}]: ENEMY FOUND!'
                            setvar! found_mob 1

                            if use_strength == 1 and not findbuff 'Strength' or str < 110
                                sysmsg '>>> STRENGTH' spell_msg_color
                
                                cast 'Strength'
                
                                @settimer 'waiting_target_timer' 0
                                while not findbuff 'strength' and not targetexists 'beneficial' and not insysmsg 'disturbed' and not insysmsg 'cannot cast a spell' and timer 'waiting_target_timer' < 1500
                                    wft 10
                                    if insysmsg 'disturbed' or insysmsg 'spell will not adhere' or insysmsg 'cannot cast a spell'
                                        if verbose == 1
                                            sysmsg 'BREAKING WHILE WAITING FOR STRENGTH TARGET' warning_msg_color
                                        endif
                
                                        wait spell_recovery_delay
                                        break
                                    endif
                                endwhile
                
                                if targetexists 'beneficial'
                                    hotkey 'Target Self'
                                    wait spell_recovery_delay
                                endif
                
                                if findbuff 'strength'
                                    overhead '+strength' buff_msg_color
                                endif
                            endif

        
                            if not varexist entered_combat_mode
                                setvar! entered_combat_mode 1
                            endif
        
                            #make sure we dont have a captcha gump before trying to arm for fightning
                            # if timer 'last_sysmsg_timer' < max_wait_for_last_sysmsg_to_suspect_gump
                            # TESTING: i think this is why the char isnt equiping the hatchet to fight anymore
                                setvar! reset_last_sysmsg_timer 1
        
                                overhead '*ATTACKING*' 39 lasttarget
                                sysmsg 'Hostile Last Target Detected! Entering Defense Routine...' 56
        
                                # equip hatchet if needed
                                if not findtype 'hatchet' lefthand
    
                                    if findtype 'hatchet' backpack as hatchet
                                        # undress hands if necessary to equip pickaxe found
                                        if not lhandempty and not rhandempty
                                            overhead 'undressing hands to put hatchet' 54
                                            hotkey "Undress Both Hands"
                                            wait action_delay
                                        endif
    
                                        if debug == 1
                                            sysmsg '[DEBUG]: EQUIPING HATCHET' debug_msg_color
                                        endif
    
                                        setvar! found_weapon 1
                                        dclick hatchet
                                        wait action_delay
                                    else
                                        overhead 'OUT OF HATCHETS!' 39
                                    endif
                                endif

                                # if above attempt to equip hatchet failed, try another weapon
                                if not findtype 'hatchet' lefthand
                                    foreach weapon_type in 'char_combat_skill_weapons'
                                        if findtype weapon_type backpack as weap
                                            if not lhandempty and not rhandempty
                                                overhead 'undressing hands to put combat weaopn' 54
                                                hotkey "Undress Both Hands"
                                                wait action_delay
                                            endif

                                            setvar! found_weapon 1
                                            dclick weap
                                            overhead "|equipped {{weapon_type}} weapon|"
                                            wait action_delay
                                            break
                                        endif
                                    endfor
        
                                    if not varexist found_weapon and lhandempty and rhandempty
                                        overhead 'CANT FIND WEAPON'
                                    endif
        
                                    unsetvar! found_weapon
                                endif
        
                                if not rhandempty or not lhandempty
                                    sysmsg 'Attacking last target'
                                    hotkey 'Attack Last Target'
                                endif
                            # endif
        
        
                            # HANDLE POISON
                            if poisoned
                                if findtype 'orange potion' backpack
                                    sysmsg 'Curing poison with potion...' 90
                                    hotkey 'Drink Cure'
                                elseif magery >= 50 and counttype 'Garlic' > 0 and counttype 'Ginseng' > 0
                                    sysmsg 'Curing poison with magery...' 90
                                    cast 'Cure'
        
                                    @settimer 'waiting_target_timer' 0
                                    while not targetexists 'beneficial' and timer 'waiting_target_timer' < 1500
                                        wait 100
                                        if insysmsg 'disturbed' or insysmsg 'cannot cast a spell while frozen'
                                            sysmsg 'BREAKING WHILE WAITING FOR GREATER HEAL TARGET'
                                            break
                                        endif
                                    endwhile
        
                                    if targetexists 'beneficial'
                                        target 'self'
                                    endif
                                elseif healing >= 50 and counttype 'clean bandage%s%' > 0
                                    # if not bandaging
                                    if bandaging == 0
                                        overhead '*applying bandages*' 65
                                        if debug == 1
                                            sysmsg '[DEBUG] bandage 003'
                                        endif
                                        hotkey 'Bandage Self'
        
                                        wait action_delay
                                    elseif bandaging > 10
                                        overhead '10+ secs till next bandage!' 52
                                    elseif bandaging > 5
                                        overhead '5+ secs till next bandage!' 52
                                    else
                                        overhead 'less than 5 secs till next bandage!' 52
                                    endif
                                endif
                            endif
        
                            # MAINTAIN CHAR HP
                            if diffhits > 0
                                # heal with pots
                                if diffhits > max_diffhits_before_healing_with_potion
                                    if findtype 'yellow potion' backpack
                                        hotkey 'Drink Heal'
                                        wait action_delay
                                    endif
                                endif
        
                                # heal with healing
                                if diffhits > max_diffhits_before_healing_with_bandages and skill 'healing' >= min_healing_to_use_bandages
                                    # if not bandaging
                                    if bandaging == 0
                                        overhead '*applying bandages*' 65
                                        if debug == 1
                                            sysmsg '[DEBUG] bandage 003'
                                        endif
                                        hotkey 'Bandage Self'
        
                                        wait action_delay
                                    elseif bandaging > 10
                                        overhead '10+ secs till next bandage!' 52
                                    elseif bandaging > 5
                                        overhead '5+ secs till next bandage!' 52
                                    else
                                        overhead 'less than 5 secs till next bandage!' 52
                                    endif
                                endif
        
                                # heal with magery
                                if diffhits > max_diffhits_before_healing_with_magery and skill 'magery' >= 50 and mana >= 11
                                    cast 'greater heal'
        
                                    @settimer 'waiting_target_timer' 0
                                    while not targetexists 'beneficial' and timer 'waiting_target_timer' < 3500
                                        wait 100
                                        if insysmsg 'disturbed' or insysmsg 'cannot cast a spell while frozen'
                                            sysmsg 'BREAKING WHILE WAITING FOR GREATER HEAL TARGET'
                                            break
                                        endif
                                    endwhile
        
                                    if targetexists 'beneficial'
                                        hotkey 'Target Self'
                                    endif
                                endif
                            endif
        
                        # END elseif noto lasttarget != friend and noto lasttarget != friendly
                        endif
        
                    endwhile
        
                    if dead 'last' and varexist found_mob
                        unsetvar found_mob
                        setvar! reset_last_sysmsg_timer 1
                    endif
                    # setvar! reset_last_sysmsg_timer 1
          
                # END if diffhits > max_diffhits_before_starting_defense_routine
                endif
    
            # END if recall_home_now != 1
            endif
    
    
            ########################################
            # GO HOME AND UNLOAD ROUTINE
            ########################################
            if recall_home_now == 1 and cooldown RESOURCES
    
                setvar! use_charges 0
                if skill 'magery' == 0 or counttype "Black Pearl%s%" == 0 or counttype "Blood Moss" == 0 or counttype "Mandrake Root%s%" == 0
                    if counttype "Recall"
                        overhead 'no regs. trying scroll...' 54
                        setvar! use_recall_scroll 1
                    else
                        overhead 'no regs. trying charges...' 54
                        setvar! use_charges 1
                    endif
                endif
    
    
                if use_charges == 1
                    sysmsg 'TRAVELLING HOME VIA CHARGES. RUNEBOOK {{home_book}}'
                    dclick home_book
                    waitforgump recall_book_gump_id action_delay
                    gumpresponse recall_rune_btn_number recall_book_gump_id
                    setvar! use_charges 0
                else
                    # dclick recall_book
                    # waitforgump recall_book_gump_id action_delay
                    # gumpresponse recall_rune_btn_number recall_book_gump_id
                    sysmsg 'TRAVELLING HOME VIA SPELL. RUNEBOOK {{home_book}}'
                    hotkey 'Recall'

                    clearsysmsg
                    @settimer 'waiting_target_timer' 0
                    while not targetexists 'neutral' and not insysmsg 'disturbed' and not insysmsg 'cannot cast a spell' and timer 'waiting_target_timer' < recall_casting_time
                        wft 10
                        if insysmsg 'disturbed' or insysmsg 'spell will not adhere' or insysmsg 'cannot cast a spell'
                            if verbose == 1
                                overhead '▽▽ BREAKING RECALL ▽▽' warning_msg_color
                                sysmsg 'BREAKING WHILE WAITING FOR RECALL ' warning_msg_color
                            endif
        
                            wait spell_recovery_delay
                            break
                        endif

                        if diffhits >= max_diffhits_before_healing_with_potion
                            if findtype 'yellow potion' backpack as pot
                                sysmsg '>>> LOW HP! USING HEAL POTION.. ' action_msg_color
                                overhead '*using heal potion*' action_msg_color
                
                                useobject pot
                                wait action_delay
                            endif
                        endif

                    endwhile
        
                    if targetexists 'neutral'
                        sysmsg 'TARGETING HOME BOOK'
                        target home_book
                        wait spell_recovery_delay
                    endif
                endif

                # unsetvar! recall_book
    
                wait recall_travel_time
    
                sysmsg 'ASSUMING CHAR IS HOME. START UNLOADING'

                if use_hotel_room == 1
                    say 'room'
                    waitforgump 2393832411 1500
                    if gumpexists 2393832411
                        if use_own_room == 1
                            overhead 'entering own room'
                            gumpresponse 4 2393832411
                        else
                            overhead 'entering friend room'
                            gumpresponse 5 2393832411
                            waitforgump 2393832411 action_delay
                            gumpresponse 100 2393832411
                        endif
                    endif
    
                    wait 1500
                endif
    
    
    
                # after escaping, smelt ores from char
                while findtype LOGS backpack as boards
                    overhead '*cutting boards*' 49
                    sysmsg '> Cutting Boards' 49
                    dclick boards
                    wait action_delay
                endwhile
    
    
                # unload everything on resource stockpile
                if findtype 'resource container' ground any any 2 as stockpile
                    setvar! resource_stockpile stockpile
                    menu resource_stockpile 0
                    wft 600
                    if targetexists 'neutral'
                        sysmsg '> Restocking Resource Stockpile...' sysmsgs_color
                        target 'self'
                    endif
    
                    if gumpexists 1859005118
                        gumpclose 1859005118
                    endif
                endif
    
                if findtype 'storage shelf' ground any any 2 as shelf
                    sysmsg 'RESSUPLYING...' 55
                    menu shelf 1
                    waitforgump 3232825965 600
                else
                    overhead 'NO SHELFS FOUND TO RESSUPLY!'
                endif
    
                sysmsg 'SETTING TO TRAVEL TO NEXT RUNE' 54
                setvar! go_to_next_rune 1
    
                setvar! recall_home_now 0
    
            endif
            # END GO HOME AND UNLOAD ROUTINE
            ########################################
    
            # check if we got any sysmsg that should reset the timer in each iteration
            # if reset_last_sysmsg_timer == 1
            #     setvar! reset_last_sysmsg_timer 0
            #     # RESET THE TIMER
            #     settimer 'last_sysmsg_timer' 0
            #     clearsysmsg
            # endif
            clearsysmsg
    
            
    
    
            # breaks from the loop and pops the current rune from front of list into the back, so we can
            # bypass the razor bug that keeps on same iteration when you from from a while inside a for
            if go_to_next_rune == 1
                setvar! go_to_next_rune 0
                sysmsg 'GOING TO NEXT RUNE' 54
                # poplist 'runebook_rune_btns' 'front'
                # pushlist 'runebook_rune_btns' rune_number 'back'
                # say 'all follow me'


                ########################################
                # SET NEXT RUNE TO TRAVEL
                ########################################
                if rune_number == 10
                    setvar! rune_number 20
                elseif rune_number == 20
                    setvar! rune_number 10
                endif


                ########################################
                # SET NEXT RUNETOME PAGE
                ########################################

                poplist 'runetome_page_numbers' 'front'
                pushlist 'runetome_page_numbers' page_number 'back'

                ########################################
                # SET NEXT RUNETOME IF LAST PAGE OF CURRENT ONE
                ########################################

                if page_number == 224
                    sysmsg 'GOING TO NEXT RUNETOME'
                    poplist 'lumber_runetomes' 'front'
                    pushlist 'lumber_runetomes' runebook 'back'
                    say 'all follow me'
                    break
                endif


                break
            endif
    
        endwhile
    endfor
    # CLOSES foreach runebook in 'lumber_runetomes'
endfor


#################################
# CHANGELOG

# v0.2.1
# - Removes 'backpack' from reagents sources on findtype in case they are in the new reagent satchel so recall wont fail
# - No longer unequips hatchet to equip combat weapon since now hatchets have the same dmg/level as other axes and benefit from Lumberjacking
#
# v0.2.0
# - Switches from list configs back to variables using setvar!
# - Adds gump serial to gumpresponse command on recall routine
# - Adds Archery to supported weapon skills when defending against monsters
#
# v0.0.10
# - Fixed bug where char would keep equipping all combat weaopns found in backpack while fightning mobs
# - Added startup warnings about script requirements
#
# v0.0.9
# - Handles 'You broke your axe' sysmsgs
#
# v0.0.8
# - Fixes error happening on chars without healing due to script trying to access a variable that is only created on chars with healing (tkx to @BaLLa#7588 for finding and reporting it)
# - Fixed blue chars not finding packies (tkx to @renatoestevao#8568  for subimitting a PR)
#
# v0.0.7
# - Makes char remove hatchet to equip combat weapon to fight monsters
# - Fixes calling to wrong variable name in some parts of the code
#
# v0.0.6
# - Searches a list of weapons intead of using just hatchets and clubs
#
# v0.0.5
# - Fix missing endif that was breaking the macro when i captcha was detected

# v0.0.4
# - Adds missing list 'use_charges' for using charges when escaping PKs
# - Enhances unloading routine (based on my miner script unload routine)
#
# v0.0.3
# - Fix captcha pause check
# - Stops double clicking packie to open packpack when unloading logs while heavy
# - Adds variables to control rune slot button numbers while escaping PKs
# - Adds checks if char has magery or regs before trying to cast recall, or use scrolls / charges to escape PK
# - Fix colored logs check on journal messages
#
# v0.0.2
# - Adds unloading routine after escaping PKs and turn logs into boards
# - Makes sysmsgs checks even when gump is detected (so char can escape PKs even when answering gumps)
#
# v0.0.1
# - Initial release
#
