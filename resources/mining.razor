sysmsg '#########################' 90
sysmsg '>>> MINING BOT' 55
sysmsg 'by gugutz' 45
sysmsg 'version v0.3.2' 31
sysmsg '########################' 90

#################################
# IN GAME INSTRUCTIONS / OBSERVATIONS
#################################
sysmsg '************************' 90
sysmsg 'FOR THIS SCRIPT TO WORK PROPERLY, YOU MUST:' 53
sysmsg "* uncheck option 'filter repeating system messages' on razor" 55
sysmsg "* uncheck option 'Auto Stack Ore/Fish/Logs at feet' on razor" 55
sysmsg "* first run far from other friends pack animals" 55
sysmsg '***********************' 90


###################################
# SCRIPT CONFIGURATION
###################################

sysmsg 'Applying configuration...'

setvar! debug 0

setvar! auto_smelt_ores_when_close_to_forges 1
setvar! smelt_colored_ores 1
setvar! recall_to_escape_pks 1

# escape rune button number on runebook
setvar! runetome_rune_position 100
# escape rune button number on runebook
setvar! runebook_rune_position 2

setvar! action_delay 600

setvar! auto_walk_randomly 0

setvar! auto_walk_to_direction 0
# direction to walk to when 'auto_walk_to_direction' is ON!
if auto_walk_to_direction == 1 and not listexists 'direction_to_walk'
    createlist 'direction_to_walk'
    pushlist 'direction_to_walk' 'right'
endif

setvar! debug_msg_color 40

###################################
# SCRIPT ROUTINE RELATED VARIABLES
# (USUALLY THERES NO NEED TO EDIT THESE)
###################################

# delay between pickaxes uses
setvar! max_wait_for_last_sysmsg_to_use_pickaxe  1000
# delay before suspecting captcha gump
setvar! max_wait_for_last_sysmsg_to_suspect_gump 8000
# max ores a packie can have before being set as full
# the actual value is 1000 ores, but we set a little bit less to char doenst try to fill it, which could result in exceeding the limit and droping ores on the ground
# the value set a bit less than the actual max works as a safety to make sure it will skip to next packie before trying to unload and risking droping ores on the ground
setvar! max_ores_in_packie 900

setvar! max_diffhits_before_starting_heal_routine 0
setvar! max_diffhits_before_starting_defense_routine 2

setvar! max_diffhits_before_healing_with_potion 20
setvar! max_diffhits_before_healing_with_magery 20
setvar! max_diffhits_before_healing_with_bandages 10
setvar! min_healing_to_use_bandages 30

setvar! max_diffweight_before_unloading 50

setvar! ORES 6585
setvar! INGOTS 7125

# if its Jiu's char, unset autosmelt and autorun from pks cause he doenst use it
if name == 'Darren'
    setvar! auto_smelt_ores_when_close_to_forges 0
    setvar! smelt_colored_ores 0
    setvar! recall_to_escape_pks 0
endif


setvar! max_mob_range_to_attack 2
if skill 'archery' >= 50
    setvar! max_mob_range_to_attack 12
endif

###################################
# TIMERS
###################################
sysmsg 'Creating timers...'

createlist 'mining_script_timers'
pushlist 'mining_script_timers' 'waiting_save'
pushlist 'mining_script_timers' 'last_sysmsg_timer'
pushlist 'mining_script_timers' 'waiting_target_timer'
pushlist 'mining_script_timers' 'loop_on_warning_msg'
pushlist 'mining_script_timers' 'last_gump_warning_timer'
pushlist 'mining_script_timers' 'mining_uptime'



foreach timer in 'mining_script_timers'
    if not timerexists timer
        createtimer timer
        settimer timer 100000
    endif
endfor


###################################
# POPULATE SOME LISTS
###################################

if not listexists 'resource_types'
    createlist 'resource_types'
    pushlist 'resource_types' ORES
    pushlist 'resource_types' INGOTS
endif


# CREATE A LIST WITH ALL POSSIBLE WEAPONS CHAR
# CAN EQUIP BASED ON HIS WEAPON SKILL
if not listexists 'char_combat_skill_weapons'
    createlist 'char_combat_skill_weapons'
    if skill 'archery' >= 50
        pushlist 'char_combat_skill_weapons' 'bow'
        pushlist 'char_combat_skill_weapons' 'crossbow'
        pushlist 'char_combat_skill_weapons' 'heavy crossbow'
    elseif skill 'swordsmanship' >= 50
        pushlist 'char_combat_skill_weapons' 'halberd'
        pushlist 'char_combat_skill_weapons' 'bardiche'
        pushlist 'char_combat_skill_weapons' 'katana'
        pushlist 'char_combat_skill_weapons' 'axe'
        pushlist 'char_combat_skill_weapons' 'viking sword'
        pushlist 'char_combat_skill_weapons' 'longsword'
        pushlist 'char_combat_skill_weapons' 'broadsword'
        pushlist 'char_combat_skill_weapons' 'double axe'
        pushlist 'char_combat_skill_weapons' "executioner's axe"
    # elseif skill 'mace fighting' >= 50
    #     pushlist 'char_combat_skill_weapons' 'war mace'
    #     pushlist 'char_combat_skill_weapons' 'mace'
    #     pushlist 'char_combat_skill_weapons' 'club'
    #     pushlist 'char_combat_skill_weapons' 'black staff'
    #     pushlist 'char_combat_skill_weapons' 'gnarled staff'
    #     pushlist 'char_combat_skill_weapons' 'war hammer'
    endif
endif

###################################
# PACK ANIMALS
###################################

sysmsg 'Searching for pack animals...' 87

if not listexists 'packies'
    createlist 'packies'
endif

# if we cant find the saved packies, its time to remake the list
# this also prevents the script from re-adding the same packies over and over
# when player re-plays the script several times with the same client open

if list 'packies' == 0
    setvar! remake_packies_list 1
else
    foreach packie in 'packies'
        if find packie ground any any 20
            overhead '*found previous saved packie*' 72 packie
        else
            overhead '*cant find packie {{packie}}. resetting list*' 54
            setvar! remake_packies_list 1
        endif
    endfor
endif


if varexist remake_packies_list
    unsetvar! remake_packies_list
    clearlist 'packies'
    sysmsg 'POPULATING PACKIES LIST...' 54

    while findtype 292 ground any any 2 as packie
        if noto packie = friend
            pushlist 'packies' packie
            overhead '*adding to packies list*' 56 packie
        endif
        @ignore packie
    endwhile

    while findtype 291 ground any any 2 as packie
        if noto packie = friend
            pushlist 'packies' packie
            overhead '*adding to packies list*' 56 packie
        endif
        @ignore packie
    endwhile

    clearignore
endif

foreach packanimal in 'packies'
    overhead '*opening bag*' 91 packanimal
    dclick packanimal
    wait action_delay

    # check packie weight to determine if its full or not
    if counttype ORES packanimal >= max_ores_in_packie
        # sysmsg 'COUNT ORE 1' 92
        setvar! packie_heavy 1
    elseif counttype ORES packanimal >= 200 and counttype INGOTS packanimal >= 500
        # sysmsg 'COUNT ORE 2' 92
        setvar! packie_heavy 1
    elseif counttype ORES packanimal >= 150 and counttype INGOTS packanimal >= 800
        # sysmsg 'COUNT ORE 3' 92
        setvar! packie_heavy 1
    elseif counttype ORES packanimal >= 100 and counttype INGOTS packanimal >= 1100
        # sysmsg 'COUNT ORE 4' 92
        setvar! packie_heavy 1

    # check if packie is actually empty
    elseif counttype ORES packanimal == 0 and counttype INGOTS packanimal == 0
        overhead '*empty*' 56 packanimal
        rename packanimal 'emptypackie'
    # if its not heavy and its not empty, its "light"
    elseif counttype ORES packanimal > 0 or counttype INGOTS packanimal >= 0
        overhead '*empty*' 56 packanimal
        rename packanimal 'lightpackie'
    endif

    # add or remove packie to full 0packies list based on if its heavy or not
    if varexist packie_heavy
        overhead '*heavy*' 56 packanimal
        unsetvar! packie_heavy
        rename packie 'fullpackie'
    endif
endfor

###################################
# PREPARING TO START
###################################





if list 'packies' >= 1
    say 'all follow me'
endif

if list 'packies' == 0
    overhead '!COULDNT FIND ANY PACKIES!' 43
    overhead '!COULDNT FIND ANY PACKIES!' 43
    sysmsg '!COULDNT FIND ANY PACKIES!' 43
    sysmsg '!COULDNT FIND ANY PACKIES!' 43
endif

# check and equip pickaxe if needed before starting so we dont waist the main timer equiping the axe
# which was causing the timer to be greater then the mining value and the char wouldnt mine when that happened
#
if not rhandempty and not findtype 'pickaxe' righthand
    overhead 'undressing hands for pickaxe'
    hotkey "Undress Both Hands"
    wait action_delay
endif

if rhandempty
    if findtype 'pickaxe' backpack
        dclicktype 'pickaxe'
        overhead "✩equipped new pickaxe✩"
    else
        overhead "✩ You are out of pickaxes✩"
        sysmsg "YOU ARE OUT OF PICKAXES!!!" 37
        sysmsg "YOU ARE OUT OF PICKAXES!!!" 37
        stop
    endif
endif

###################################
# TRACKING - BEGIN HUNTING
###################################


if not varexist tracking_gump_id
    @setvar tracking_gump_id 4267467659
endif


if not findbuff 'Tracking Hunting'
    while not gumpexists tracking_gump_id
        sysmsg 'Opening tracking gump...' 53
        skill 'tracking'
        waitforgump tracking_gump_id 600
    endwhile

    if gumpexists tracking_gump_id
        if not ingump 'Stop Hunting' 4267467659
            overhead 'STARTING HUNTING' 65
            gumpresponse 6 tracking_gump_id
            waitforgump tracking_gump_id action_delay
        else
            overhead 'already hunting' 55
        endif

        gumpclose tracking_gump_id
    endif

else
    overhead 'Tracking already ON!' 55
endif
# endif

###################################
sysmsg 'Opening Reg Bag...' 18
###################################


if findtype 'bag' backpack as reg_bag
    sysmsg 'Opening reagent bag first time...' 91
    overhead 'opening reg bag...' 91
    dclick reg_bag
    wait 550
    if insysmsg 'You must wait to perform another action'
        overhead 'failed to open reg bag!' 41
        while insysmsg 'You must wait to perform another action'
            dclick reg_bag
            wait 550
        endwhile
    endif
    setvar! reg_bag_opened_once 1
endif

###################################
sysmsg 'STARTING...' 18
###################################

wait action_delay

clearsysmsg
settimer 'mining_uptime' 0
settimer 'last_sysmsg_timer' 0

while not dead 'self'
    setvar! main_loop_index index

    # remember player the loop is active every 30s
    if timer 'loop_on_warning_msg' >= 30000
        settimer 'loop_on_warning_msg' 0

        # sysmsg '************************' 90

        sysmsg 'Mining Bot by gugutz' 89

        # if timerexists 'last_gump_tracking_timer' and timer 'last_gump_warning_timer' >= 60000
        if timerexists 'last_gump_tracking_timer'
            sysmsg 'Last captcha was: {{last_gump_tracking_timer}} ago' 90
            # settimer 'last_gump_warning_timer' 0
        endif

        # sysmsg 'Uptime: {{mining_uptime}}'

        # sysmsg '************************' 90
    endif

    if timer 'last_sysmsg_timer' > max_wait_for_last_sysmsg_to_suspect_gump
        if not timerexists 'last_gump_tracking_timer'
            createtimer 'last_gump_tracking_timer'
        endif

        settimer 'last_gump_tracking_timer' 0
        overhead "✩ GUMP PRESENT or LAGGED ✩" 33
    endif

    # inform player every 1 minute when was the last gump detected

    if timer 'last_sysmsg_timer' < max_wait_for_last_sysmsg_to_suspect_gump
        # check and equip pickaxe if needed
        if rhandempty
            if findtype 'pickaxe' true
                dclicktype 'pickaxe'
                overhead "✩equipped new pickaxe✩"
                if debug == 1
                   sysmsg '[DEBUG]: RESET 001' debug_msg_color
                endif
                setvar! reset_last_sysmsg_timer 1
            else
                overhead "✩OUT OF PICKAXES✩" 40
                sysmsg "OUT OF PICKAXES! GET SOME AND REPLAY THE SCRIPT." 40
                sysmsg "OUT OF PICKAXES! GET SOME AND REPLAY THE SCRIPT." 40
                stop
            endif
        endif

        # mine
        if timer 'last_sysmsg_timer' < max_wait_for_last_sysmsg_to_use_pickaxe and not rhandempty and diffweight > 10
            # sysmsg '>>> Mining... ' 87
            # clearsysmsg
            # settimer 'last_sysmsg_timer' 0
            hotkey 'Use item in Hand'
            wait max_wait_for_last_sysmsg_to_use_pickaxe
        endif

        #############################################
        # SMELTING ROUTINE
        #
        # smelt if close to a forge

        if auto_smelt_ores_when_close_to_forges == 1

            # only start smelting routine if either char or packies have ores in them
            if findtype ORES backpack
                setvar! enter_smelting_routine 1
            else
                # smelt ores in pack animals
                foreach packanimal in 'packies'
                    if findtype ORES packanimal
                        setvar! enter_smelting_routine 1
                        break
                    endif
                endfor
            endif

            if varexist enter_smelting_routine
                unsetvar! enter_smelting_routine

                if findtype 'forge' ground any any 2 as forg
                    setvar! smelt_ores_now 1
                elseif findtype 0x1996 ground any any 2 as forg
                    setvar! smelt_ores_now 1

                # shelter island forge
                elseif position 1979 2554
                    setvar! smelt_ores_now 1
                # mining cave near andaria
                elseif position 1916 744 or position 1916 743
                    setvar! smelt_ores_now 1
                # placeholder
                elseif position 1916 744 or position 1916 743
                    setvar! smelt_ores_now 1
                # brigand camp 2 mine 1, near Horseshoe 01
                elseif position 2108 2220 or position 2108 2221 or position 2108 2222 or position 2108 2223 or position 2108 2224
                    setvar! smelt_ores_now 1
                elseif position 2107 2220 or position 2107 2221 or position 2107 2222 or position 2107 2223 or position 2107 2224
                    setvar! smelt_ores_now 1
                elseif position 2106 2220 or position 2106 2221 or position 2106 2222 or position 2106 2223 or position 2106 2224
                    setvar! smelt_ores_now 1
                elseif position 2105 2220 or position 2105 2221 or position 2105 2222 or position 2105 2223 or position 2105 2224
                    setvar! smelt_ores_now 1
                elseif position 2104 2220 or position 2104 2221 or position 2104 2222 or position 2104 2223 or position 2104 2224
                    setvar! smelt_ores_now 1
                # brigand camp 2 mine 1, near Horseshoe 02
                elseif position 2115 2177 or position 2115 2176 or position 2115 2175 or position 2115 2174 or position 2115 2173
                    setvar! smelt_ores_now 1
                elseif position 2114 2177 or position 2114 2176 or position 2114 2175 or position 2114 2174 or position 2114 2173
                    setvar! smelt_ores_now 1
                elseif position 2113 2177 or position 2113 2176 or position 2113 2175 or position 2113 2174 or position 2113 2173
                    setvar! smelt_ores_now 1
                elseif position 2112 2177 or position 2112 2176 or position 2112 2175 or position 2112 2174 or position 2112 2173
                    setvar! smelt_ores_now 1
                elseif position 2111 2177 or position 2111 2176 or position 2111 2175 or position 2111 2174 or position 2111 2173
                    setvar! smelt_ores_now 1
                # brigand camp 2 mine 1, near Horseshoe 03
                elseif position 2143 2166 or position 2143 2165 or position 2143 2164 or position 2143 2163 or position 2143 2162
                    setvar! smelt_ores_now 1
                elseif position 2142 2166 or position 2142 2165 or position 2142 2164 or position 2142 2163 or position 2142 2162
                    setvar! smelt_ores_now 1
                elseif position 2141 2166 or position 2141 2165 or position 2141 2164 or position 2141 2163 or position 2141 2162
                    setvar! smelt_ores_now 1
                elseif position 2140 2166 or position 2140 2165 or position 2140 2164 or position 2140 2163 or position 2140 2162
                    setvar! smelt_ores_now 1
                elseif position 2139 2166 or position 2139 2165 or position 2139 2164 or position 2139 2163 or position 2139 2162
                    setvar! smelt_ores_now 1
                elseif position 2105 2222 or position 2104 2222 or position 2104 2223 or position 2104 2224
                    setvar! smelt_ores_now 1
                # brigand camp 2 mine 1, near cambria
                elseif position 1531 2708 or position 1530 2709 or position 1532 2710
                    setvar! smelt_ores_now 1
                elseif position 1524 2699 or position 1525 2698
                    setvar! smelt_ores_now 1
                # brigand camp 2 mine 2, near cambria
                elseif position 1560 2670 or position 1561 2672
                    setvar! smelt_ores_now 1
                elseif position 1564 2654 or position 1563 2653
                    setvar! smelt_ores_now 1
                # mine 1, near cambria 01
                elseif position 1565 2652 or position 1565 2653 or position 1565 2654 or position 1565 2655 or position 1565 2656
                    setvar! smelt_ores_now 1
                elseif position 1564 2652 or position 1564 2653 or position 1564 2654 or position 1564 2655 or position 1564 2656
                    setvar! smelt_ores_now 1
                elseif position 1563 2652 or position 1563 2653 or position 1563 2654 or position 1563 2655 or position 1563 2656
                    setvar! smelt_ores_now 1
                elseif position 1562 2652 or position 1562 2653 or position 1562 2654 or position 1562 2655 or position 1562 2656
                    setvar! smelt_ores_now 1
                elseif position 1561 2652 or position 1561 2653 or position 1561 2654 or position 1561 2655 or position 1561 2656
                    setvar! smelt_ores_now 1
                elseif position 1562 2669 or position 1562 2670 or position 1562 2671 or position 1562 2672 or position 1562 2673
                    setvar! smelt_ores_now 1
                elseif position 1561 2669 or position 1561 2670 or position 1561 2671 or position 1561 2672 or position 1561 2673
                    setvar! smelt_ores_now 1
                elseif position 1560 2669 or position 1560 2670 or position 1560 2671 or position 1560 2672 or position 1560 2673
                    setvar! smelt_ores_now 1
                elseif position 1559 2669 or position 1559 2670 or position 1559 2671 or position 1559 2672 or position 1559 2673
                    setvar! smelt_ores_now 1
                elseif position 1558 2669 or position 1558 2670 or position 1558 2671 or position 1558 2672 or position 1558 2673
                    setvar! smelt_ores_now 1
                # mine 2, near cambria
                elseif position 1533 2707 or position 1533 2708 or position 1533 2709 or position 1533 2710 or position 1533 2711
                    setvar! smelt_ores_now 1
                elseif position 1532 2707 or position 1532 2708 or position 1532 2709 or position 1532 2710 or position 1532 2711
                    setvar! smelt_ores_now 1
                elseif position 1531 2707 or position 1531 2708 or position 1531 2709 or position 1531 2710 or position 1531 2711
                    setvar! smelt_ores_now 1
                elseif position 1530 2707 or position 1530 2708 or position 1530 2709 or position 1530 2710 or position 1530 2711
                    setvar! smelt_ores_now 1
                elseif position 1529 2707 or position 1529 2708 or position 1529 2709 or position 1529 2710 or position 1529 2711
                    setvar! smelt_ores_now 1

                elseif position 1526 2696 or position 1526 2697 or position 1526 2698 or position 1526 2699 or position 1526 2700
                    setvar! smelt_ores_now 1
                elseif position 1525 2696 or position 1525 2697 or position 1525 2698 or position 1525 2699 or position 1525 2700
                    setvar! smelt_ores_now 1
                elseif position 1524 2696 or position 1524 2697 or position 1524 2698 or position 1524 2699 or position 1524 2700
                    setvar! smelt_ores_now 1
                elseif position 1523 2696 or position 1523 2697 or position 1523 2698 or position 1523 2699 or position 1523 2700
                    setvar! smelt_ores_now 1
                elseif position 1522 2696 or position 1522 2697 or position 1522 2698 or position 1522 2699 or position 1522 2700
                    setvar! smelt_ores_now 1
                # necromancers swamp nearby mines
                elseif position 1916 713 or position 1916 714 or position 1915 715
                    setvar! smelt_ores_now 1
                elseif position 1935 700 or position 1937 700 or position 1937 699
                    setvar! smelt_ores_now 1
                elseif position 1889 739 or position 1889 740 or position 1888 740
                    setvar! smelt_ores_now 1
                # orc fort mines (near orc fort / honor shrine)
                elseif position 1194 1066 or position 1194 1065 or position 1193 1065
                    setvar! smelt_ores_now 1
                elseif position 1340 1189 or position 1340 1188 or position 1339 1188
                    setvar! smelt_ores_now 1

                endif



                if varexist smelt_ores_now
                    unsetvar! smelt_ores_now
                    overhead 'close to forge!'

                    # smelt ores in backpack
                    while findtype ORES backpack as ores
                        if insysmsg 'You do not see any nearby forges to smelt this ore on'
                            overhead 'got far from forge!' 41
                            sysmsg 'Got Far From Forge! Breaking smelting loop...' 41
                            break
                        endif

                        if smelt_colored_ores == 0
                            if hue ores == 0
                                setvar! smelt_this_ore true
                            endif
                        else
                            setvar! smelt_this_ore true
                        endif

                        if varexist smelt_this_ore
                            unsetvar! smelt_this_ore
                            overhead 'smelting!'
                            dclick ores
                            wait action_delay
                            if debug == 1
                              sysmsg '[DEBUG]: RESET 002' debug_msg_color
                            endif
                            setvar! reset_last_sysmsg_timer 1
                        endif
                    endwhile

                    # smelt ores in pack animals
                    foreach packanimal in 'packies'
                        dclick packanimal
                        wait action_delay

                        if findtype ORES packanimal as ores and diffweight > 10
                            overhead 'smelting ores in animal' 56 packanimal
                            while findtype ORES packanimal as ores and diffweight > 10
                                if insysmsg 'You do not see any nearby forges to smelt this ore on'
                                    overhead 'got far from forge!' 41
                                    sysmsg 'Got Far From Forge! Breaking smelting loop...' 41
                                    setvar! escape_parent_loop 1
                                    break
                                endif

                                if smelt_colored_ores == 0
                                    if hue ores == 0
                                        setvar! smelt_this_ore true
                                    endif
                                else
                                    setvar! smelt_this_ore true
                                endif

                                if varexist smelt_this_ore
                                    unsetvar! smelt_this_ore
                                    sysmsg 'smelting ore in packie' 56
                                    overhead 'smelting ores' 56 packanimal
                                    dclick ores
                                    wait action_delay
                                    if debug == 1
                                      sysmsg '[DEBUG]: RESET 003' debug_msg_color
                                    endif
                                    setvar! reset_last_sysmsg_timer 1
                                endif
                            endwhile
                        endif

                        if varexist escape_parent_loop
                            unsetvar escape_parent_loop
                            break
                        endif

                    endfor
                endif
            endif
        endif


        ##############################################
        # GRAB ORES FROM GROUND
        ##############################################


        while findtype ORES ground any any 1 as ore and diffweight > 50
            hotkey 'Grab Item'
            wft action_delay
            # if targetexists 'neutral'
            sysmsg 'Getting ore from ground' 51
            overhead '* ore from ground *' 51
            target ore
            # endif
            if debug == 1
                sysmsg '[DEBUG]: RESET 004' debug_msg_color
            endif
            setvar! reset_last_sysmsg_timer 1
            # settimer 'last_sysmsg_timer' 0
        endwhile


        ##############################################
        # ORE MAPS ROUTINE
        ##############################################

        # if heavy and there are packies nearby, unload

        if findtype 'map' backpack 2796 any as ore_map
            getlabel ore_map ore_map_label
            if "completed by" in ore_map_label
                overhead 'ORE MAP COMPLETE!' 90
                sysmsg 'ORE MAP COMPLETE!' 90

                # drop completed ore map
                lift ore_map 1
                wait action_delay
                overhead "dropping completed ore map"
                if findtype 'barrel' ground 0 1 2 as trashcan
                    sysmsg "Dropping Completed Map On Trash Barrel" sysmsgs_color
                    drop trashcan -1 -1 0
                else
                    sysmsg "Dropping Completed Map On The Ground" sysmsgs_color
                    droprelloc 0 0
                endif

                clearsysmsg
                sysmsg 'STOPPING SCRIPT...' 90
                stop
            else
                sysmsg 'Doing Ore Map...' 49
                if debug == 1
                   sysmsg '[DEBUG]: RESET 005' debug_msg_color
                endif
                setvar! reset_last_sysmsg_timer 1
            endif
        endif


        ##############################################
        # UNLOADING ROUTINE
        ##############################################

        # if heavy and there are packies nearby, unload
        if diffweight <= max_diffweight_before_unloading and findtype ORES backpack

            if not listexists 'full_packies'
                createlist 'full_packies'
            endif

            if list 'packies' > 0 and list 'full_packies' > 0 and list 'packies' == list 'full_packies'
                overhead 'all packies full! going home!' 53
                sysmsg 'ALL PACKIES FULL! GOING HOME!' 53
                sysmsg 'ALL PACKIES FULL! GOING HOME!' 53
                setvar! recall_home_now true

            elseif list 'packies' > 0
                foreach packanimal in 'packies'

                    unsetvar! packie_heavy

                    dclick packanimal
                    wait action_delay

                    # if razor thinks there are no resources at all, we might need to open the packie bag so razor can "see" whats inside first
                    if counttype ORES packanimal == 0 and counttype INGOTS packanimal == 0
                        overhead '*opening backpack to count resources*' 54
                        dclick packanimal
                        wait action_delay
                    endif

                    # check packie weight to determine if its full or not
                    if counttype ORES packanimal any any >= max_ores_in_packie
                        sysmsg 'COUNT ORE 1' 92
                        setvar! packie_heavy 1
                    elseif counttype ORES packanimal any any >= 200 and counttype INGOTS packanimal any any >= 500
                        sysmsg 'COUNT ORE 2' 92
                        setvar! packie_heavy 1
                    elseif counttype ORES packanimal any any >= 150 and counttype INGOTS packanimal any any >= 800
                        sysmsg 'COUNT ORE 3' 92
                        setvar! packie_heavy 1
                    elseif counttype ORES packanimal any any >= 100 and counttype INGOTS packanimal any any >= 1100
                        sysmsg 'COUNT ORE 4' 92
                        setvar! packie_heavy 1

                    # check if packie is actually empty
                    elseif counttype ORES packanimal any any == 0 and counttype INGOTS packanimal any any == 0
                        sysmsg 'COUNT ORE EMPTY' 92
                        rename packanimal 'emptypackie'
                    # if its not heavy and its not empty, its "light"
                    elseif counttype ORES packanimal any any > 0 or counttype INGOTS packanimal any any >= 0
                        sysmsg 'COUNT ORE LIGHT' 92
                        rename packanimal 'lightpackie'
                    endif

                    # add or remove packie to full 0packies list based on if its heavy or not
                    if varexist packie_heavy
                        overhead '! packie heavy !' 34 packanimal
                        rename packanimal 'fullpackie'

                        if poplist 'packies' packanimal as removed_packie
                            overhead 'moved to end of packies list' 54 removed_packie
                            pushlist 'packies' packanimal 'back'
                        endif

                        if not inlist 'full_packies' packanimal
                            overhead 'adding to full list' 54 packanimal
                            pushlist 'full_packies' packanimal
                        endif
                    else
                        if inlist 'full_packies' packanimal
                            # poplist 'full_packies' packanimal
                            overhead 'clearing full_packies list' 52
                            sysmsg 'Clearing Full_Packies List...' 52
                            clearlist 'full_packies'
                        endif
                    endif


                    if not inlist 'full_packies' packanimal
                        # getlabel packanimal packie_label
                        # sysmsg packie_label 99


                        # call packies if they are not within 2 tiles
                        while not find packanimal ground any any 2
                            say 'all follow me'
                            wait action_delay
                        endwhile


                        foreach resource_type in 'resource_types'
                            if resource_type == ORES
                                setvar! max_resource_in_packie max_ores_in_packie
                            elseif resource_type == INGOTS
                                setvar! max_resource_in_packie 2000
                            endif

                            while findtype resource_type backpack as resource_serial and counttype resource_type packanimal < max_resource_in_packie
                                getlabel resource_serial resource_label

                                sysmsg '>>> MOVING {{resource_label}} TO PACKIE' 56
                                sysmsg 'Unloading {{resource_label}} in packie {{packanimal}}' 56
                                overhead '*unloading {{resource_label}}*' 56 packanimal

                                lift resource_serial 999
                                wait action_delay
                                drop packanimal -1 -1 0
                                wait action_delay

                                if findtype resource_type ground any any 1
                                    # put this animal to the end of the list so we use the next one next time
                                    overhead 'heavy?? moving to end of list' 53 packanimal
                                    # poplist 'packies' packanimal
                                    # pushlist 'packies' packanimal 'back'

                                    sysmsg 'Found {{resource_label}} on ground. Pet is probably heavy...' 53

                                    # we open the packies bag here to make sure in the next iteration the script will be able
                                    # to count the resources it in.
                                    dclick packanimal
                                    wait action_delay

                                    rename packanimal 'fullpackie'
                                    pushlist 'full_packies' packanimal

                                    while findtype resource_type ground any any 1 as ground_resouce_serial and diffweight > 50
                                        getlabel ground_resource_serial ground_resource_label
                                        hotkey 'Grab Item'
                                        wft action_delay
                                        sysmsg 'Getting {{ground_resource_label}} from ground' 51
                                        overhead '* {{ground_resource_label}} from ground *' 51
                                        target ground_resouce_serial
                                        if debug == 1
                                          sysmsg '[DEBUG]: RESET 005' debug_msg_color
                                        endif
                                        setvar! reset_last_sysmsg_timer 1
                                    endwhile
                                endif

                            endwhile

                            # check packie weight to determine if its full or not
                            if counttype ORES packanimal any any >= max_ores_in_packie
                                setvar! packie_heavy 1
                            elseif counttype ORES packanimal any any >= 200 and counttype INGOTS packanimal any any >= 500
                                setvar! packie_heavy 1
                            elseif counttype ORES packanimal any any >= 150 and counttype INGOTS packanimal any any >= 800
                                setvar! packie_heavy 1
                            elseif counttype ORES packanimal any any >= 100 and counttype INGOTS packanimal any any >= 1100
                                setvar! packie_heavy 1

                            # check if packie is actually empty
                            elseif counttype ORES packanimal any any == 0 and counttype INGOTS packanimal any any == 0
                                rename packanimal 'emptypackie'
                            # if its not heavy and its not empty, its "light"
                            elseif counttype ORES packanimal any any > 0 or counttype INGOTS packanimal any any >= 0
                                rename packanimal 'lightpackie'
                            endif

                            # add or remove packie to full 0packies list based on if its heavy or not
                            if varexist packie_heavy
                                overhead '! packie heavy !' 37 packanimal
                                rename packanimal 'fullpackie'

                                if not inlist 'full_packies' packanimal
                                    overhead 'adding to full list' 54 packanimal
                                    pushlist 'full_packies' packanimal
                                endif
                            endif

                        endfor

                    endif

                    # dont iterate thgouth other packies if theres no need
                    if diffweight > max_diffweight_before_unloading or not findtype ORES backpack
                        overhead "*no more resources to unload*" 52
                        sysmsg "No More Resources To Unload. Breaking..." 52
                        break
                    endif
                endfor

                if debug == 1
                   sysmsg '[DEBUG]: RESET 006' debug_msg_color
                endif
                setvar! reset_last_sysmsg_timer 1

            else
                overhead '! HEAVY !' 90
            endif
        endif
    endif


    ###############################################
    # JOURNAL MESSAGES CHECKS

    # we need to first check for pks or else the other msgs might not allow us to get to this check
    if insysmsg 'now tracking'
        sysmsg '>>> PK...' 19
        sysmsg '>>> PK...' 49
        sysmsg '>>> PK...' 54
        overhead '!! PK !!' 19
        overhead '!! PK !!' 49
        overhead '!! PK !!' 54

        if recall_to_escape_pks == 1
            # make sure char wont get stuck due to overweighting
            # while weigth > maxweigth
            #     if weigth > maxweigth and findtype ORES backpack 0 as ore_serial
            #         lift ore_serial 20
            #         wait action_delay
            #         drop ground
            #         wait action_delay
            #     elseif weigth > maxweigth and findtype ORES backpack any as ore_serial
            #         lift ore_serial 20
            #         wait action_delay
            #         drop ground
            #         wait action_delay
            #     elseif weigth > maxweigth
            #         overhead '*HEAVY BUT NO ORES*' 54
            #         break
            #     endif
            # endwhile

            sysmsg '>>> ESCAPING PK!!!' 41
            overhead '!! ESCAPING PK !!' 41

            setvar! recall_home_now true

        endif



    # handle world saves
    elseif insysmsg "The world is saving"
        settimer 'waiting_save' 0
        overhead '*WORLD SAVING*' 90
        while not insysmsg 'World save complete'
            wait 100
            if timer 'waiting_save' >= 5000
                sysmsg 'BREAKING WAITING FOR SAVE' 49
                break
            endif
        endwhile

        if insysmsg 'World save complete'
            overhead '*save complete!*' 90
            if debug == 1
                sysmsg '[DEBUG]: RESET 007 WORLD SAVE' debug_msg_color
            endif
            setvar! reset_last_sysmsg_timer 1
        endif

    # handle tools breaking
    elseif insysmsg "You have worn out your tool"
        overhead 'PICKAXE BROKE!' 90

        if not rhandempty and not findtype 'pickaxe' righthand
            overhead 'undressing hands for pickaxe'
            hotkey "Undress Both Hands"
            wait action_delay
        endif

        if rhandempty
            if findtype 'pickaxe' backpack
                dclicktype 'pickaxe'
                overhead "✩equipped new pickaxe✩"
            else
                overhead "✩ You are out of pickaxes✩"
                setvar! recall_home_now 1
                # stop
            endif
        endif

        if debug == 1
            sysmsg '[DEBUG]: RESET 008 TOOL BROKE' debug_msg_color
        endif
        setvar! reset_last_sysmsg_timer 1



    # no resources where char is
    elseif insysmsg "You do not see any harvestable resources nearby"
        if auto_walk_to_direction == 1
            foreach direction in 'direction_to_walk'
                walk direction
                break
            endfor
        endif

        if debug == 1
            sysmsg '[DEBUG]: RESET 009 NO RESOURCES' debug_msg_color
        endif
        setvar! reset_last_sysmsg_timer 1
        # overhead '| NO ORES HERE |' 54
        overhead '! NO ORES HERE !' 54

        if auto_walk_randomly == 1
            random 8
            if insysmsg 'Random: 1'
                walk 'south'
                walk 'south'
                walk 'south'
            elseif insysmsg  'Random: 2'
                walk 'down'
                walk 'down'
                walk 'down'
            elseif insysmsg  'Random: 3'
                walk 'east'
                walk 'east'
                walk 'east'
            elseif insysmsg  'Random: 4'
                walk 'right'
                walk 'right'
                walk 'right'
            elseif insysmsg  'Random: 5'
                walk 'north'
                walk 'north'
                walk 'north'
            elseif insysmsg  'Random: 6'
                walk 'up'
                walk 'up'
                walk 'up'
            elseif insysmsg  'Random: 7'
                walk 'west'
                walk 'west'
                walk 'west'
            elseif insysmsg  'Random: 8'
                walk 'left'
                walk 'left'
                walk 'left'
            endif
        endif


    # mining fail message
    elseif insysmsg "loosen some rocks but fail"
        if debug == 1
            sysmsg '[DEBUG]: RESET 010 MINING FAIL' debug_msg_color
        endif
        setvar! reset_last_sysmsg_timer 1
        overhead ': fail :' 43


    # when char is on cooldown for having traveled recently
    elseif insysmsg "You have recently traveled"
        if debug == 1
            sysmsg '[DEBUG]: RESET 011 TRAVEL COOLDOWN ' debug_msg_color
        endif
        setvar! reset_last_sysmsg_timer 1
        overhead '! travel harvest cooldown !' 43


    # action cooldown
    elseif insysmsg "You must wait to perform another action"
        if debug == 1
            sysmsg '[DEBUG]: RESET 012 ACTION COOLDOWN ' debug_msg_color
        endif
        setvar! reset_last_sysmsg_timer 1
        overhead '! action cooldown !' 54


    # action cooldowns (when sysmsg prints 'You must wait...') will break the macro, so we need to get them as well
    elseif insysmsg "Harvesting is not allowed in this area"
        if debug == 1
            sysmsg '[DEBUG]: RESET 013 HARVEST NOW ALLOWED' debug_msg_color
        endif
        setvar! reset_last_sysmsg_timer 1
        overhead 'harvest not allowed. move!' 53


    # I TRIED LOOPING THROUGH A LIST INSTEAD OF USING MULTIPLE IF/ELSE AND DIDNT WORK, THE LOOP BREAKS THE MACRO
    elseif insysmsg 'some Iron'
        overhead '⥏ iron ⥑' 15
        setvar! reset_last_sysmsg_timer 1
    elseif insysmsg 'Dull Copper'
        overhead '✩ dull cooper ✩' 245
        setvar! reset_last_sysmsg_timer 1
    elseif insysmsg 'shadow Iron'
        overhead '✩ shadow iron ✩' 193
        setvar! reset_last_sysmsg_timer 1
    elseif insysmsg 'Copper'
        overhead '✩ copper ✩' 248
        setvar! reset_last_sysmsg_timer 1
    elseif insysmsg 'Bronze'
        overhead '✩ bronze ✩' 248
        setvar! reset_last_sysmsg_timer 1
    elseif insysmsg 'Gold'
        overhead '✩ gold ✩' 53
        setvar! reset_last_sysmsg_timer 1
    elseif insysmsg 'Agapite'
        overhead '✩ agapite ✩' 58
        setvar! reset_last_sysmsg_timer 1
    elseif insysmsg 'Verite'
        overhead '✩ verite ✩' 70
        setvar! reset_last_sysmsg_timer 1
    elseif insysmsg 'Valorite'
        overhead '✩ valorite ✩' 80
        setvar! reset_last_sysmsg_timer 1
    elseif insysmsg 'Avarite'
        overhead '✩ avarite ✩' 17
        setvar! reset_last_sysmsg_timer 1


    # catch captcha successful msgs
    elseif insysmsg "Captcha successful"
        overhead 'captcha anwsered succesfully' 90
        sysmsg 'Captcha Anwsered Succesfully!' 90


    # catch captcha failure msgs
    elseif insysmsg "Due to previous captcha failures"
        overhead '! resource locked !' 33
        sysmsg 'CAPTCHA FAILED AND CHAR IS RESOURCE LOCKED. STOPPING MACRO...' 33
        stop


    endif


    ########################################
    # GO HOME AND UNLOAD ROUTINE
    ########################################

    if varexist recall_home_now
        unsetvar! recall_home_now
        if skill 'magery' == 0 or counttype "Black Pearl%s%" == 0 or counttype "Blood Moss" == 0 or counttype "Mandrake Root%s%" == 0
            if counttype "Recall" backpack
                overhead 'no regs. trying scroll...'
                setvar! use_recall_scroll true
            else
                overhead 'no regs. trying charges...'
                setvar! use_charges true
            endif
        endif

        # pick which book should script recall to
        if findtype 'runetome' backpack as rtome
            setvar! recall_book rtome
            setvar! recall_book_gump_id 167090027
            setvar! recall_by_charge_btn_number runetome_rune_position
        elseif findtype 'runebook' backpack as rbook
            setvar! recall_book rbook
            setvar! recall_book_gump_id 1551740969
            setvar! recall_by_charge_btn_number runebook_rune_position
        elseif findtype 'recall rune' backpack as recall_rune
            setvar! recall_book recall_rune
            setvar! recall_book_gump_id 1551740969
            setvar! recall_by_charge_btn_number runebook_rune_position
        endif

        if varexist recall_book
            if not varexist use_charges
                unsetvar! use_charges
                hotkey 'Recall'
                waitfortarget 3500
                target recall_book
            else
                dclick recall_book
                waitforgump recall_book_gump_id 600
                gumpresponse recall_by_charge_btn_number recall_book_gump_id
            endif

            unsetvar! recall_book
        endif

        wait 2500


        # after escaping, smelt ores from char
        while findtype ORES backpack as ores_from_backpack
            # check if char is close to a player or a static map forge to smelt
            if findtype 'forge' ground any any 2 or findtype 'large forge' ground any any 2
                setvar! smelt_ores_now 1
            # outpost forge
            elseif position 3031 539 or position 3031 540 or position 3031 541
                setvar! smelt_ores_now 1
            endif

            if varexist smelt_ores_now
                unsetvar! smelt_ores_now
                overhead '*smelting ores*' 49
                sysmsg '> Smelting Ores In Pack Animal' 49
                dclick ores_from_backpack
                wait action_delay
            else
                sysmsg 'Found Ores in backpack but no forge nearby to smelt it...' 40
                break
            endif
        endwhile


        # after escaping, smelt ores from all packies
        if list 'packies' > 0
            foreach packanimal in 'packies'

                dclick packanimal
                wait action_delay
                # smelt ores
                while findtype ORES packanimal any any 2 as ores_from_packie

                    # check if char is close to a player or a static map forge to smelt
                    if findtype 'forge' ground any any 2 or findtype 'large forge' ground any any 2
                        setvar! smelt_ores_now 1
                    # outpost forge
                    elseif position 3031 539 or position 3031 540 or position 3031 541
                        setvar! smelt_ores_now 1
                    endif

                    if varexist smelt_ores_now
                        unsetvar! smelt_ores_now
                        overhead '*smelting ores*' 49 packanimal
                        sysmsg '> Smelting Ores In Pack Animal' 49
                        dclick ores_from_packie
                        wait action_delay
                    else
                        sysmsg 'Found Ores in pack animal but no forge nearby to smelt it...' 40
                        overhead 'found ores but no forge' 40 packanimal
                        break
                    endif
                endwhile
            endfor
        endif

        # unload everything on resource stockpile
        if findtype 'resource container' ground any any 2 as stockpile
            if not varexist resource_stockpile
                @setvar resource_stockpile stockpile
            endif
            menu resource_stockpile 0
            wft 600
            if targetexists 'neutral'
                sysmsg '> Restocking Resource Stockpile...' sysmsgs_color
                target 'self'
            endif

            # restock stockpile from packies
            if list 'packies' > 0 and varexist resource_stockpile
                foreach packanimal in 'packies'
                    if noto packanimal = friend
                        sysmsg '> Restocking Stockpile From Pack Animal...' sysmsgs_color
                        menu resource_stockpile 0
                        wft 600
                        if targetexists 'neutral'
                            overhead "unloading on stockpile" 56 packanimal
                            target packanimal
                        endif
                    endif
                endfor
            endif
            if gumpexists 1859005118
                gumpclose
            endif
        endif

    endif
    # END GO HOME AND UNLOAD ROUTINE
    ########################################


    ########################################
    # HANDLE POISON
    ########################################
    if poisoned
        if findtype 'orange potion' backpack
            sysmsg 'Curing poison with potion...' 90
            hotkey 'Drink Cure'
        elseif magery >= 50 and counttype 'Garlic' > 0 and counttype 'Ginseng' > 0
            sysmsg 'Curing poison with magery...' 90
            cast 'Cure'

            @settimer 'waiting_target_timer' 0
            while not targetexists 'beneficial' and timer 'waiting_target_timer' < 1500
                wait 100
                if insysmsg 'disturbed' or insysmsg 'cannot cast a spell while frozen'
                    sysmsg 'BREAKING WHILE WAITING FOR GREATER HEAL TARGET'
                    break
                endif
            endwhile

            if targetexists 'beneficial'
                target 'self'
            endif
        elseif healing >= 30 and counttype 'clean bandage%s%' > 0
            if bandaging == 0
                overhead '*applying bandages*' 65
                hotkey 'Bandage Self'

                wait action_delay
            elseif bandaging > 10
                overhead '10+ secs till next bandage!' 52
            elseif bandaging > 5
                overhead '5+ secs till next bandage!' 52
            else
                overhead 'less than 5 secs till next bandage!' 52
            endif
        endif
    endif


    ########################################
    # MAINTAIN CHAR HP
    ########################################

    if diffhits > max_diffhits_before_starting_heal_routine
        # heal with pots
        if diffhits > max_diffhits_before_healing_with_potion
            if findtype 'yellow potion' backpack
                hotkey 'Drink Heal'
                wait action_delay
            endif
        endif

        # heal with healing
        if diffhits > max_diffhits_before_healing_with_bandages and skill 'healing' >= min_healing_to_use_bandages
            if bandaging == 0
                overhead '*applying bandages*' 65
                hotkey 'Bandage Self'

                wait action_delay
            elseif bandaging > 10
                overhead '10+ secs till next bandage!' 52
            elseif bandaging > 5
                overhead '5+ secs till next bandage!' 52
            else
                overhead 'less than 5 secs till next bandage!' 52
            endif
        endif

        # heal with magery
        if diffhits > max_diffhits_before_healing_with_magery and skill 'magery' >= 50 and mana >= 11
            cast 'greater heal'

            @settimer 'waiting_target_timer' 0
            while not targetexists 'beneficial' and timer 'waiting_target_timer' < 3500
                wait 100
                if insysmsg 'disturbed' or insysmsg 'cannot cast a spell while frozen'
                    sysmsg 'BREAKING WHILE WAITING FOR GREATER HEAL TARGET'
                    break
                endif
            endwhile

            if targetexists 'beneficial'
                hotkey 'Target Self'
            endif
        endif
    endif



    ########################################
    # DEFEND AGAINST MONSTERS ROUTINE
    ########################################

    if diffhits > max_diffhits_before_starting_defense_routine
        if not find 'last' ground any any 2 or not dead 'last' or noto 'last' != hostile
            overhead 'searching for mobs to kill...' 52
            hotkey 'Next Non-Friendly Monster Target'
            wait action_delay

            # if there is not a captcha present already, reset timer to make sure the script wont bug after killing the mob
            if timer 'last_sysmsg_timer' < max_wait_for_last_sysmsg_to_suspect_gump

                if debug == 1
                    sysmsg '[DEBUG]: RESET 014 DEFEND 1' debug_msg_color
                endif

                sysmsg 'Flaging to reset catpcha timer while searching for mobs...' 54
                setvar! reset_last_sysmsg_timer 1
            endif

        endif


        if debug == 1
            sysmsg '[DEBUG]: RESET 014 AFTER DEFEND 1' debug_msg_color
        endif

        while find 'last' ground any any max_mob_range_to_attack and not dead 'last'

            if debug == 1
                sysmsg '[DEBUG]: INSIDE WHILE DEFEND LOOP' debug_msg_color
            endif


            if noto lasttarget == friendly
                overhead 'cancelling friendly target!' 52
                hotkey 'Cancel Current Target'

                if debug == 1
                    sysmsg '[DEBUG]: RESET 015 DEFEND 2 CANCEL TARGET' debug_msg_color
                endif

                setvar! reset_last_sysmsg_timer 1
            elseif noto lasttarget != friend and noto lasttarget != friendly
            # elseif noto lasttarget == hostile
                overhead '|| MINER TARGET ||' 90 'last'
                setvar found_mob 1

                if not varexist entered_combat_mode
                    setvar! entered_combat_mode 1
                endif

                #make sure we dont have a captcha gump before trying to arm for fightning
                if timer 'last_sysmsg_timer' < max_wait_for_last_sysmsg_to_suspect_gump
                    if debug == 1
                        sysmsg '[DEBUG]: RESET 016 DEFEND 3 CATCHA CHECK' debug_msg_color
                    endif

                    setvar! reset_last_sysmsg_timer 1

                    overhead '*ATTACKING*' 39 lasttarget
                    sysmsg 'Hostile Last Target Detected! Entering Defense Routine...' 56

                    # equip pickaxe if needed
                    if skill 'mace fighting' > 0
                        if not findtype 'pickaxe' righthand

                            if findtype 'pickaxe' backpack as pickaxe
                                # undress hands if necessary to equip pickaxe found
                                if not lhandempty and not rhandempty
                                    overhead 'undressing hands to put pickaxe' 54
                                    hotkey "Undress Both Hands"
                                    wait action_delay
                                endif

                                if debug == 1
                                    sysmsg '[DEBUG]: EQUIPING PICKAXE' debug_msg_color
                                endif

                                setvar! found_weapon 1
                                dclick pickaxe
                                wait_action_delay
                            else
                                overhead 'OUT OF PICKAXES!' 39
                            endif
                        endif
                    else
                        # first make sure char is empty handed to equip the weapon afterwards
                        if not lhandempty and not rhandempty
                            overhead 'undressing hands to put combat weaopn' 54
                            hotkey "Undress Both Hands"
                            wait action_delay

                        # if char is not macer, we got to equip a different weaopn equip weapon if needed according to weaopn skill
                        else
                            foreach weapon_type in 'char_combat_skill_weapons'
                                if findtype weapon_type backpack as weap
                                    setvar! found_weapon 1
                                    dclick weap
                                    overhead "::equipped {{weapon_type}} weapon::"
                                    wait action_delay
                                    break
                                endif
                            endfor
                        endif

                        if not varexist found_weapon and lhandempty and rhandempty
                            overhead 'CANT FIND WEAPON'
                        endif

                        unsetvar! found_weapon
                    endif


                    if not rhandempty or not lhandempty
                        sysmsg 'Attacking last target'
                        hotkey 'Attack Last Target'
                    endif

                endif

                # HANDLE POISON
                if poisoned
                    if findtype 'orange potion' backpack
                        sysmsg 'Curing poison with potion...' 90
                        hotkey 'Drink Cure'
                    elseif magery >= 50 and counttype 'Garlic' > 0 and counttype 'Ginseng' > 0
                        sysmsg 'Curing poison with magery...' 90
                        cast 'Cure'

                        @settimer 'waiting_target_timer' 0
                        while not targetexists 'beneficial' and timer 'waiting_target_timer' < 1500
                            wait 100
                            if insysmsg 'disturbed' or insysmsg 'cannot cast a spell while frozen'
                                sysmsg 'BREAKING WHILE WAITING FOR GREATER HEAL TARGET'
                                break
                            endif
                        endwhile

                        if targetexists 'beneficial'
                            target 'self'
                        endif
                    elseif healing >= 50 and counttype 'clean bandage%s%' > 0
                        if bandaging == 0
                            overhead '*applying bandages*' 65
                            hotkey 'Bandage Self'

                            wait action_delay
                        elseif bandaging > 10
                            overhead '10+ secs till next bandage!' 52
                        elseif bandaging > 5
                            overhead '5+ secs till next bandage!' 52
                        else
                            overhead 'less than 5 secs till next bandage!' 52
                        endif
                    endif
                endif

                # MAINTAIN CHAR HP
                if diffhits > 0
                    # heal with pots
                    if diffhits > max_diffhits_before_healing_with_potion
                        if findtype 'yellow potion' backpack
                            hotkey 'Drink Heal'
                            wait action_delay
                        endif
                    endif

                    # heal with healing
                    if diffhits > max_diffhits_before_healing_with_bandages and skill 'healing' >= min_healing_to_use_bandages
                        if bandaging == 0
                            overhead '*applying bandages*' 65
                            hotkey 'Bandage Self'

                            wait action_delay
                        elseif bandaging > 10
                            overhead '10+ secs till next bandage!' 52
                        elseif bandaging > 5
                            overhead '5+ secs till next bandage!' 52
                        else
                            overhead 'less than 5 secs till next bandage!' 52
                        endif
                    endif

                    # heal with magery
                    if diffhits > max_diffhits_before_healing_with_magery and skill 'magery' >= 50 and mana >= 11
                        cast 'greater heal'

                        @settimer 'waiting_target_timer' 0
                        while not targetexists 'beneficial' and timer 'waiting_target_timer' < 3500
                            wait 100
                            if insysmsg 'disturbed' or insysmsg 'cannot cast a spell while frozen'
                                sysmsg 'BREAKING WHILE WAITING FOR GREATER HEAL TARGET'
                                break
                            endif
                        endwhile

                        if targetexists 'beneficial'
                            hotkey 'Target Self'
                        endif
                    endif
                endif
            # end if last == hostile
            endif


        endwhile

        # clearsysmsg

        if dead 'last' and varexist found_mob
            unsetvar found_mob

            if debug == 1
                sysmsg '[DEBUG]: RESET 017 DEFEND 4 AFTER LOOP' debug_msg_color
            endif

            setvar! reset_last_sysmsg_timer 1
        endif

        if debug == 1
            sysmsg '[DEBUG]: LAST ENDIF DEFEND ROUTINE' debug_msg_color
        endif

    # END if diffhits > max_diffhits_before_starting_defense_routine
    endif

    if debug == 1
        sysmsg '[DEBUG]: AFTER DEFEND ROUTINE' debug_msg_color
    endif


    # check if we got any sysmsg that should reset the timer in each iteration
    if varexist reset_last_sysmsg_timer
        if debug == 1
            sysmsg '[DEBUG]: RESETTING LAST SYSMSG TIMER' debug_msg_color
        endif
        unsetvar! reset_last_sysmsg_timer
        # RESET THE TIMER
        settimer 'last_sysmsg_timer' 0

        clearsysmsg
    elseif varexist entered_combat_mode
        unsetvar! entered_combat_mode

        if debug == 1
            sysmsg '[DEBUG]: RESETING SYSMSG TIMER AFTER FLAGING COMBAT MODE' debug_msg_color
        endif
        sysmsg 'Reseting sysmsg timer after flaging combat mode...' 52
        settimer 'last_sysmsg_timer' 0

        clearsysmsg
    endif


    # sysmsg 'ITERATION: {{main_loop_index}}' 90
    # sysmsg 'UPTIME: {{mining_uptime}}' 90

endwhile



#################################
# CHANGELOG
#################################
#
# v0.3.2
# - Script now recalls home when cant find pickaxes to equip
#
# v0.3.1
# - Disables autounload to free weigth before recalling home until i find a fix for it
#
# v0.3.0
# - Opens regs bag when starting to make sure razor will detect pots and regs inside loadout bag
# - Switches bandage timers for the new 'bandaging' command
# - Updates packies weight check to conform to new material weight changes
#
# v0.2.1
# - Adds gump serial to gumpresponse command on recall routine
# - Adds Archery to supported weapon skills when defending against monsters
# - Fix bug where script would keep trying to smelt packies ores, even if char got far from forge
# - Fix bug where char would enter defense routine even without monsters nearby
# - Adds missing gump serial to tracking gumpresponse and gumpclose calls
# - Script now closes the tracking gump after Starting Hunting
# - Script will now rename packies according to their weight status: 'full packie' and 'light packie', to make it easier to track which one is full or not
# - Add weigth check on each packie unloading so char doenst try to iterate thought all packies even after completely unloaded
# - Improves weight check logic to determine when packie is heavy
# - Fix bandage delay reseting when full restoring hp while atacking mobs
#
# v0.2.0
# - Switches from list configs back to variables using setvar!
# - Script should now do ore maps as well when finding ore maps in backpack
# - Temporary fix for the "removing from full packies list" bug that happened when a packie got full and then was unloaded, which would make script stop working
# - Adds outpost forge position to smelt after recalling routine for players that dont have a house and use the outpost forge when escaping PKs/recalling
#
# v0.1.4-rc1
# - Fix sysmsg that was mistakenly assuming char got iron instead of shadow iron (tkx GCinco!)
# - Makes 'go home and unload' routine reusable and triggered in different parts of the script
# - Tries to detect when all packies are heavy and takes char home and unload
#
# v0.1.3
# - Fixed bug where char would keep equipping all combat weaopns found in backpack while fightning mobs
# - Added some missing lists that were causing script to crash while fighting mobs
# - Added startup warnings about script requirements
#
# v0.1.2
# - Fixes bug where char would constantly use bandages when finding multiple mobs to kill
#
# v0.1.1
# - Check for ores in char or packies before starting smelting routine
# - addresses grab bug when ore fell on ground
#
# v0.1.0
# - Adds more checks of ore and ingots on packie to determine if its heavy
# - Improves combat and weapon equipping logic to fight monsters
# - Fix bug where char would count ingots from its backpack while checking packies weight (tkx @Guga#1138 for noticing!)
# - Fix some calls  to wrong variable name (tkx @daniel_#6593 for noticing!)
#
# v0.0.9
# - Fixes error happening on chars without healing due to script trying to access a variable that is only created on chars with healing (tkx to @BaLLa#7588 for finding and reporting it)
#
# v0.0.8
# - Makes char undress pickaxe to fight monsters with appropriate combat weapon
# - Fixes error when char tried to heal himself when attacked
# - Handles 'You have worn out your tool' sysmsgs
# - Fixed blue chars not finding packies (tkx to @renatoestevao#8568 for subimitting a PR)
#
# v0.0.7
# - Adds missing variables containing rune positions in runetome and runebook
#
# v0.0.6
# - Adds survival routine to defend char against closed-ranged combat creatures
# - Adds sysmsg check to see if char got far from forge while inside the smelting loop
#
# v0.0.5
# - Stops double clicking packie to open packpack when unloading ores while heavy
# - Adds wait timer after recalling and before unloading when getting home
#
# v0.0.4
# - Adds setting to choose if script will auto smelt ores when close to forge
#
# v0.0.3
# - Makes sysmsgs checks even when gump is detected (so char can escape PKs even when answering gumps)
#
# v0.0.2
# - Adds checks for several map-forges around the world
# - Adds option to not smelt colored ores (makes it hard for PKS to take them)
#
# v0.0.1
# - Initial release
